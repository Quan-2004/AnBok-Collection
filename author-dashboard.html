<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Studio Tác Giả - Bảng Điều Khiển Chuyên Nghiệp</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --sidebar-width: 300px;
            --topbar-height: 70px;
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: var(--dark-color);
            line-height: 1.6;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, var(--dark-color) 0%, #334155 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            overflow-y: auto;
        }

        #sidebar .sidebar-brand {
            height: var(--topbar-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
        }

        #sidebar .sidebar-brand i {
            color: var(--primary-color);
            margin-right: 0.75rem;
            font-size: 1.5rem;
        }

        #sidebar .nav-item {
            margin: 0.25rem 1rem;
        }

        #sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            border-radius: 0.75rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        #sidebar .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(4px);
        }

        #sidebar .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        #sidebar .nav-link.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 0 2px 2px 0;
        }

        #sidebar .nav-link i {
            margin-right: 0.875rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        #sidebar .nav-link .badge {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.75rem;
        }

        #sidebar .nav-item.mt-auto {
            margin-top: auto !important;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 1rem;
        }

        #sidebar .nav-link.text-danger {
            color: #dc2626 !important;
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        #sidebar .nav-link.text-danger:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626 !important;
        }

        #sidebar .nav-link.text-danger:active {
            background: rgba(220, 38, 38, 0.2);
            transform: scale(0.98);
        }

        #sidebar .nav-link.text-danger {
            cursor: pointer;
            user-select: none;
        }

        /* Main Content */
        #content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Topbar */
        #topbar {
            height: var(--topbar-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            margin-bottom: 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #topbar .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        #topbar .search-container input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            background: white;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        #topbar .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        #topbar .search-container i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }



        /* Stats Cards */
        .stat-card {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--primary-dark));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card-primary::before { background: linear-gradient(180deg, var(--primary-color), var(--primary-dark)); }
        .stat-card-success::before { background: linear-gradient(180deg, var(--success-color), #059669); }
        .stat-card-info::before { background: linear-gradient(180deg, var(--info-color), #0891b2); }
        .stat-card-warning::before { background: linear-gradient(180deg, var(--warning-color), #d97706); }
        .stat-card-danger::before { background: linear-gradient(180deg, var(--danger-color), #dc2626); }

        .stat-card .card-body {
            padding: 1.5rem;
        }

        .stat-card .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-card-primary .stat-icon { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
        .stat-card-success .stat-icon { background: linear-gradient(135deg, var(--success-color), #059669); }
        .stat-card-info .stat-icon { background: linear-gradient(135deg, var(--info-color), #0891b2); }
        .stat-card-warning .stat-icon { background: linear-gradient(135deg, var(--warning-color), #d97706); }
        .stat-card-danger .stat-icon { background: linear-gradient(135deg, var(--danger-color), #dc2626); }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .stat-change {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .stat-card .stat-change.positive {
            color: var(--success-color);
        }

        .stat-card .stat-change.negative {
            color: var(--danger-color);
        }

        /* Charts */
        .chart-container {
            height: 350px;
            position: relative;
        }

        /* Tables */
        .table-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }

        .table-container .table-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .table-responsive {
            padding: 0;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            background: rgba(248, 250, 252, 0.8);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-color);
            padding: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        /* Story cover preview */
        .story-cover {
            width: 70px;
            height: 90px;
            object-fit: cover;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .story-cover:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* Status badges */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-published {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .status-draft {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .status-review {
            background: linear-gradient(135deg, var(--info-color), #0891b2);
            color: white;
        }

        .status-rejected {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .status-ongoing {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .status-completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* Action buttons */
        .btn-action {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-action.btn-edit {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-action.btn-add {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-action.btn-view {
            background: linear-gradient(135deg, var(--info-color), #0891b2);
            color: white;
        }

        .btn-action.btn-delete {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        /* Story form */
        .story-form {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Chapter indicator */
        .chapter-count {
            font-size: 0.875rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        /* Word count */
        .word-count {
            font-size: 0.75rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        /* Progress bars */
        .progress {
            height: 8px;
            border-radius: 1rem;
            background: rgba(99, 102, 241, 0.1);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            border-radius: 1rem;
        }

        /* Content sections */
        .content-section {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        /* Event date styling */
        .event-date {
            min-width: 50px;
        }

        /* Comment item styling */
        .comment-item {
            transition: all 0.2s ease;
        }

        .comment-item:hover {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: -1rem;
        }

        /* Story card styling */
        .story-card {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .story-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .story-card.deleting {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        /* Cover Upload Styles */
        .cover-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .cover-upload-container:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .cover-preview {
            text-align: center;
        }

        .cover-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cover-upload-btn button {
            height: 60px;
            font-size: 16px;
        }

        .story-card-image {
            position: relative;
            overflow: hidden;
        }

        .story-card-image img {
            transition: transform 0.3s ease;
        }

        .story-card:hover .story-card-image img {
            transform: scale(1.05);
        }

        .story-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .story-card:hover .story-card-overlay {
            opacity: 1;
        }

        .story-status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
        }

        .story-stats {
            margin-top: 1rem;
        }

        .story-stats .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .story-stats .stat-label {
            font-size: 0.75rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
            }
            
            #content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .sidebar-open #sidebar {
                transform: translateX(0);
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .table-responsive {
                font-size: 0.875rem;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* View Modal Styles */
        .story-cover-section,
        .book-cover-section {
            text-align: center;
        }

        .story-cover-section img,
        .book-cover-section img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .story-info,
        .book-info {
            text-align: left;
        }

        .story-info h4,
        .book-info h4 {
            color: #2c3e50;
            font-weight: 600;
        }

        .story-stats,
        .book-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-item .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .stat-item .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .story-content-section,
        .book-content-section {
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .story-content-section h5,
        .book-content-section h5 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .story-content-text,
        .book-content-text {
            line-height: 1.8;
            color: #495057;
            font-size: 1rem;
        }

        .story-content,
        .book-content {
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        /* Chapter display styles */
        .chapters-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .chapter-item {
            background: white;
            border: 1px solid #e9ecef !important;
            transition: all 0.2s ease;
        }

        .chapter-item:hover {
            border-color: var(--primary-color) !important;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .chapter-item .chapter-content {
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
        }

        .chapter-text {
            color: #495057;
            line-height: 1.6;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .chapter-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 20px;
            background: linear-gradient(transparent, #f8f9fa);
        }

        .chapter-actions {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
            margin-top: 15px;
        }

        .chapter-actions .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        /* Full chapter modal styles */
        .content-text {
            font-family: 'Georgia', serif;
            line-height: 1.8;
            color: #2c3e50;
        }

        .chapter-meta {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .chapter-notes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }

        /* Analytics specific styles */
        .analytics-insights {
            background: rgba(248, 250, 252, 0.8);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .insight-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .hover-bg:hover {
            background: rgba(99, 102, 241, 0.05) !important;
        }

        /* Chart container improvements */
        .chart-container canvas {
            max-height: 350px;
        }

        /* Revenue and earnings styling */
        .earnings-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Transaction status badges */
        .status-completed {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .status-pending {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .status-failed {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-pen-fancy"></i>
            <span>Studio Tác Giả</span>
        </div>
        <div class="nav flex-column" style="height: calc(100vh - 120px); display: flex; flex-direction: column;">

            <div class="nav-item">
                <a href="#" class="nav-link active" data-section="stories">
                    <i class="fas fa-book-open"></i>
                    <span>Quản lý truyện (<span id="sidebar-stories-count">0</span>)</span>
                    <span class="badge">0</span>
                </a>
            </div>

            <div class="nav-item">
                <a href="#" class="nav-link" data-section="books">
                    <i class="fas fa-book"></i>
                    <span>Quản lý sách (<span id="sidebar-books-count">0</span>)</span>
                    <span class="badge">0</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" data-section="analytics">
                    <i class="fas fa-chart-bar"></i>
                    <span>Phân tích</span>
                </a>
            </div>
            <!-- <div class="nav-item mt-auto">
                <a href="#" class="nav-link text-danger" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Đăng xuất</span>
                </a>
            </div> -->
        </div>
    </nav>

    <!-- Main Content -->
    <div id="content">
        <!-- Topbar -->
        <div id="topbar">
            <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Tìm kiếm truyện, chương, hoặc nội dung...">
            </div>
            
            <div class="ms-auto d-flex align-items-center gap-3">
                <!-- Notifications -->
                <div class="dropdown">
                    <button class="btn btn-link position-relative" data-bs-toggle="dropdown">
                        <i class="fas fa-bell text-secondary"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                            0
                        </span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Thông báo</h6></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-check-circle text-success me-2"></i>Truyện "Cuộc phiêu lưu" đã được duyệt</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-comment text-info me-2"></i>Có 5 bình luận mới</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-star text-warning me-2"></i>Nhận được 4.8⭐ đánh giá</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center" href="#">Xem tất cả</a></li>
                    </ul>
                </div>
                
                <!-- User Profile -->
                <div class="dropdown">
                    <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown">
                        <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face" 
                             alt="Author Profile" 
                             class="rounded-circle me-2" 
                             width="40" height="40">
                                                <div class="d-none d-lg-block">
                            <div class="fw-semibold">Nguyễn Văn Tác Giả</div>
                            <div class="small text-muted">Tác Giả Chuyên Nghiệp</div>
            </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
            </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container-fluid">


            <!-- Stories Management Section -->
            <div id="stories-section" class="content-section active">
                <!-- Header with Actions -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h1 class="h3 mb-0 text-gray-800">Quản lý truyện (<span id="header-stories-count">0</span>)</h1>
                        <p class="text-muted mb-0">Quản lý tất cả truyện của bạn tại một nơi</p>
                    </div>
                    <div class="d-flex gap-2">
                       
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-filter me-1"></i>Bộ lọc
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStoryModal">
                            <i class="fas fa-plus me-1"></i>Thêm truyện mới
                        </button>
                    </div>
                </div>

                <!-- Quick Stats Cards -->
                <!-- <div class="row mb-4" id="stories-stats">
                    <div class="col-md-3">
                        <div class="card stat-card stat-card-primary h-100">
                            <div class="card-body text-center">
                                <div class="stat-icon mx-auto mb-3">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <div class="stat-value" id="total-stories">0</div>
                                <div class="stat-label">Tổng số truyện</div>
                                <div class="stat-change">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card stat-card-success h-100">
                            <div class="card-body text-center">
                                <div class="stat-icon mx-auto mb-3">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-value" id="published-stories">0</div>
                                <div class="stat-label">Đã xuất bản</div>
                                <div class="stat-change">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card stat-card-warning h-100">
                            <div class="card-body text-center">
                                <div class="stat-icon mx-auto mb-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-value" id="review-stories">0</div>
                                <div class="stat-label">Đang duyệt</div>
                                <div class="stat-change">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card stat-card-info h-100">
                            <div class="card-body text-center">
                                <div class="stat-icon mx-auto mb-3">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="stat-value" id="total-views">0</div>
                                <div class="stat-label">Tổng lượt đọc</div>
                                <div class="stat-change">-</div>
                            </div>
                        </div>
                    </div>
                </div> -->

                <!-- Filters and Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Trạng thái</label>
                                <select class="form-select" id="stories-status-filter">
                                    <option value="">Tất cả trạng thái</option>
                                    <!-- Status options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Thể loại</label>
                                <select class="form-select" id="stories-category-filter">
                                    <option value="">Tất cả thể loại</option>
                                    <!-- Category options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Sắp xếp</label>
                                <select class="form-select" id="stories-sort-filter">
                                    <option value="latest">Mới nhất</option>
                                    <option value="oldest">Cũ nhất</option>
                                    <option value="popular">Phổ biến</option>
                                    <option value="views">Lượt đọc</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Tìm kiếm</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="stories-search-input" placeholder="Tìm truyện...">
                                    <button class="btn btn-outline-secondary" id="stories-search-btn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stories Grid View -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Danh sách truyện (<span id="stories-count">0</span>)</h5>
                        </div>
                    </div>
                </div>

                <!-- Stories Cards Container -->
                <div class="row" id="stories-container">
                    <!-- Stories will be loaded here dynamically -->
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-book-open fa-3x mb-3"></i>
                            <h5>Chưa có truyện nào</h5>
                            <p>Bắt đầu tạo truyện đầu tiên của bạn!</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStoryModal">
                                <i class="fas fa-plus me-1"></i>Thêm truyện mới
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4" id="stories-pagination" style="display: none;">
                    <div class="text-muted">
                        Hiển thị <span id="pagination-start">0</span>-<span id="pagination-end">0</span> của <span id="pagination-total">0</span> truyện
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                            <!-- Pagination controls will be generated here -->
                        </ul>
                    </nav>
                </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" class="content-section">
        <!-- Header with Actions -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">Phân tích dữ liệu</h1>
                <p class="text-muted mb-0">Theo dõi hiệu suất và thống kê của bạn</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select" id="analytics-period" style="width: auto;">
                    <option value="7">7 ngày qua</option>
                    <option value="30" selected>30 ngày qua</option>
                    <option value="90">3 tháng qua</option>
                    <option value="365">1 năm qua</option>
                </select>
                <button class="btn btn-outline-primary" onclick="exportAnalytics()">
                    <i class="fas fa-download me-1"></i>Xuất báo cáo
                </button>
            </div>
        </div>

        <!-- Overview Stats Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-primary h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-value" id="analytics-total-views">0</div>
                        <div class="stat-label">Tổng lượt xem</div>
                        <div class="stat-change positive" id="analytics-views-change">+0%</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-success h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="analytics-unique-readers">0</div>
                        <div class="stat-label">Độc giả duy nhất</div>
                        <div class="stat-change positive" id="analytics-readers-change">+0%</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-info h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-value" id="analytics-engagement">0%</div>
                        <div class="stat-label">Tỷ lệ tương tác</div>
                        <div class="stat-change positive" id="analytics-engagement-change">+0%</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-warning h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="analytics-revenue">0₫</div>
                        <div class="stat-label">Doanh thu</div>
                        <div class="stat-change positive" id="analytics-revenue-change">+0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Views Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-line me-2"></i>Biểu đồ lượt xem theo thời gian
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="viewsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Content -->
            <div class="col-lg-4 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-trophy me-2"></i>Nội dung phổ biến nhất
                    </div>
                    <div class="card-body">
                        <div id="top-content-list">
                            <!-- Top content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Performance & Reader Demographics -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-pie me-2"></i>Hiệu suất theo thể loại
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-bar me-2"></i>Thống kê độc giả
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="readerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics Tables -->
        <div class="row mb-4">
            <!-- Content Performance Table -->
            <div class="col-lg-8 mb-4">
                <div class="card table-container">
                    <div class="table-header">
                        <i class="fas fa-table me-2"></i>Hiệu suất chi tiết từng tác phẩm
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tác phẩm</th>
                                    <th>Loại</th>
                                    <th>Lượt xem</th>
                                    <th>Lượt thích</th>
                                    <th>Bình luận</th>
                                    <th>Đánh giá</th>
                                    <th>Tăng trưởng</th>
                                </tr>
                            </thead>
                            <tbody id="content-performance-table">
                                <!-- Content performance data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="col-lg-4 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-clock me-2"></i>Hoạt động gần đây
                    </div>
                    <div class="card-body">
                        <div id="recent-activity-list" style="max-height: 400px; overflow-y: auto;">
                            <!-- Recent activities will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reading Patterns & Engagement -->
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card table-container">
                    <div class="table-header">
                        <i class="fas fa-chart-area me-2"></i>Mẫu đọc và tương tác
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="chart-container">
                                    <canvas id="engagementChart"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="analytics-insights">
                                    <h6 class="mb-3">Thông tin chi tiết</h6>
                                    <div class="insight-item mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Thời gian đọc trung bình</span>
                                            <strong id="avg-reading-time">0 phút</strong>
                                        </div>
                                    </div>
                                    <div class="insight-item mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Tỷ lệ hoàn thành đọc</span>
                                            <strong id="completion-rate">0%</strong>
                                        </div>
                                    </div>
                                    <div class="insight-item mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Giờ đọc phổ biến</span>
                                            <strong id="peak-hours">20:00 - 22:00</strong>
                                        </div>
                                    </div>
                                    <div class="insight-item mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Thiết bị phổ biến</span>
                                            <strong id="popular-device">Mobile (65%)</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings Section -->
    <div id="earnings-section" class="content-section">
        <!-- Header with Actions -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">Thu nhập</h1>
                <p class="text-muted mb-0">Theo dõi doanh thu và thu nhập từ tác phẩm</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select" id="earnings-period" style="width: auto;">
                    <option value="7">7 ngày qua</option>
                    <option value="30" selected>30 ngày qua</option>
                    <option value="90">3 tháng qua</option>
                    <option value="365">1 năm qua</option>
                </select>
                <button class="btn btn-outline-success" onclick="requestPayout()">
                    <i class="fas fa-money-bill-wave me-1"></i>Rút tiền
                </button>
            </div>
        </div>

        <!-- Earnings Overview -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-success h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-value" id="total-earnings">0₫</div>
                        <div class="stat-label">Tổng thu nhập</div>
                        <div class="stat-change positive" id="earnings-change">+0%</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-info h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-value" id="available-balance">0₫</div>
                        <div class="stat-label">Số dư khả dụng</div>
                        <div class="stat-change" id="balance-change">0₫</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-warning h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="monthly-revenue">0₫</div>
                        <div class="stat-label">Doanh thu tháng này</div>
                        <div class="stat-change positive" id="monthly-change">+0%</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card stat-card stat-card-danger h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="stat-value" id="pending-payout">0₫</div>
                        <div class="stat-label">Chờ thanh toán</div>
                        <div class="stat-change" id="payout-change">0₫</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Chart & Top Earning Content -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-area me-2"></i>Biểu đồ doanh thu
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-star me-2"></i>Tác phẩm thu nhập cao nhất
                    </div>
                    <div class="card-body">
                        <div id="top-earning-content">
                            <!-- Top earning content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Breakdown & Payment Methods -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-pie me-2"></i>Phân tích nguồn thu nhập
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueBreakdownChart"></canvas>
                        </div>
                        <div class="revenue-breakdown mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Truyện dài</span>
                                <span class="fw-bold text-primary">45%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Truyện ngắn</span>
                                <span class="fw-bold text-success">30%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Tiểu thuyết</span>
                                <span class="fw-bold text-warning">20%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Khác</span>
                                <span class="fw-bold text-info">5%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-credit-card me-2"></i>Phương thức thanh toán
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="payment-method-item d-flex align-items-center justify-content-between p-3 mb-3 rounded bg-light">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-credit-card text-primary me-3 fa-lg"></i>
                                    <div>
                                        <h6 class="mb-1">Thẻ ngân hàng</h6>
                                        <small class="text-muted">Visa, Mastercard, JCB</small>
                                    </div>
                                </div>
                                <span class="badge bg-success">Đã kích hoạt</span>
                            </div>
                            
                            <div class="payment-method-item d-flex align-items-center justify-content-between p-3 mb-3 rounded bg-light">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-university text-info me-3 fa-lg"></i>
                                    <div>
                                        <h6 class="mb-1">Chuyển khoản ngân hàng</h6>
                                        <small class="text-muted">Chuyển khoản trực tiếp</small>
                                    </div>
                                </div>
                                <span class="badge bg-success">Đã kích hoạt</span>
                            </div>
                            
                            <div class="payment-method-item d-flex align-items-center justify-content-between p-3 mb-3 rounded bg-light">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-mobile-alt text-warning me-3 fa-lg"></i>
                                    <div>
                                        <h6 class="mb-1">Ví điện tử</h6>
                                        <small class="text-muted">Momo, ZaloPay, VNPay</small>
                                    </div>
                                </div>
                                <span class="badge bg-secondary">Chưa kích hoạt</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-primary w-100 mt-3" onclick="addPaymentMethod()">
                            <i class="fas fa-plus me-2"></i>Thêm phương thức thanh toán
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card table-container">
                    <div class="table-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-history me-2"></i>Lịch sử giao dịch
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="transaction-filter" style="width: auto;">
                                <option value="">Tất cả giao dịch</option>
                                <option value="completed">Hoàn thành</option>
                                <option value="pending">Đang xử lý</option>
                                <option value="failed">Thất bại</option>
                            </select>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportTransactions()">
                                <i class="fas fa-download me-1"></i>Xuất CSV
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã GD</th>
                                    <th>Ngày</th>
                                    <th>Tác phẩm</th>
                                    <th>Loại giao dịch</th>
                                    <th>Số tiền</th>
                                    <th>Phương thức</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-history-table">
                                <!-- Transaction history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payout History & Settings -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card table-container">
                    <div class="table-header">
                        <i class="fas fa-money-bill-wave me-2"></i>Lịch sử rút tiền
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã rút tiền</th>
                                    <th>Ngày yêu cầu</th>
                                    <th>Số tiền</th>
                                    <th>Phương thức</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày hoàn thành</th>
                                </tr>
                            </thead>
                            <tbody id="payout-history-table">
                                <!-- Payout history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-cog me-2"></i>Cài đặt thanh toán
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ngưỡng rút tiền tối thiểu</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="min-payout" value="50000" min="10000">
                                <span class="input-group-text">₫</span>
                            </div>
                            <small class="text-muted">Số tiền tối thiểu để yêu cầu rút</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tự động rút tiền</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-payout">
                                <label class="form-check-label" for="auto-payout">
                                    Tự động rút tiền khi đạt ngưỡng
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tần suất rút tiền</label>
                            <select class="form-select" id="payout-frequency">
                                <option value="weekly">Hàng tuần</option>
                                <option value="monthly" selected>Hàng tháng</option>
                                <option value="quarterly">Hàng quý</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="savePaymentSettings()">
                            <i class="fas fa-save me-2"></i>Lưu cài đặt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tax Information & Reports -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Thông tin thuế
                    </div>
                    <div class="card-body">
                        <div class="tax-info">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Thu nhập chịu thuế (năm 2024)</span>
                                <span class="fw-bold" id="taxable-income">0₫</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Thuế TNCN (10%)</span>
                                <span class="fw-bold text-danger" id="tax-amount">0₫</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Thu nhập sau thuế</span>
                                <span class="fw-bold text-success" id="net-income">0₫</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Tổng thu nhập thực nhận</span>
                                <span class="fw-bold text-primary" id="total-net-income">0₫</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-info w-100 mt-3" onclick="downloadTaxReport()">
                            <i class="fas fa-download me-2"></i>Tải báo cáo thuế
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card table-container h-100">
                    <div class="table-header">
                        <i class="fas fa-chart-line me-2"></i>Dự báo thu nhập
                    </div>
                    <div class="card-body">
                        <div class="forecast-info">
                            <div class="text-center mb-4">
                                <h4 class="text-primary mb-2" id="forecast-amount">0₫</h4>
                                <p class="text-muted mb-0">Dự kiến thu nhập tháng tới</p>
                            </div>
                            
                            <div class="forecast-chart mb-3">
                                <div class="chart-container" style="height: 200px;">
                                    <canvas id="forecastChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="forecast-factors">
                                <h6 class="mb-3">Các yếu tố ảnh hưởng:</h6>
                                <div class="factor-item d-flex align-items-center mb-2">
                                    <i class="fas fa-arrow-up text-success me-2"></i>
                                    <span>Tăng trưởng độc giả: <strong>+15%</strong></span>
                                </div>
                                <div class="factor-item d-flex align-items-center mb-2">
                                    <i class="fas fa-arrow-up text-success me-2"></i>
                                    <span>Nội dung mới: <strong>+8%</strong></span>
                                </div>
                                <div class="factor-item d-flex align-items-center mb-2">
                                    <i class="fas fa-arrow-down text-warning me-2"></i>
                                    <span>Mùa thấp điểm: <strong>-5%</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Books Management Section -->
    <div id="books-section" class="content-section">
        <!-- Header with Actions -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">Quản lý sách (<span id="header-books-count">0</span>)</h1>
                <p class="text-muted mb-0">Quản lý tất cả sách của bạn tại một nơi</p>
            </div>
            <div class="d-flex gap-2">
               
                <button class="btn btn-outline-primary">
                    <i class="fas fa-filter me-1"></i>Bộ lọc
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                    <i class="fas fa-plus me-1"></i>Thêm sách mới
                </button>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <!-- <div class="row mb-4" id="books-stats">
            <div class="col-md-3">
                <div class="card stat-card stat-card-primary h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-value" id="total-books">0</div>
                        <div class="stat-label">Tổng số sách</div>
                        <div class="stat-change">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-success h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="published-books">0</div>
                        <div class="stat-label">Đã xuất bản</div>
                        <div class="stat-change">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-warning h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" id="review-books">0</div>
                        <div class="stat-label">Đang duyệt</div>
                        <div class="stat-change">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card stat-card-info h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mx-auto mb-3">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-value" id="total-book-views">0</div>
                        <div class="stat-label">Tổng lượt đọc</div>
                        <div class="stat-change">-</div>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- Filters and Search -->
                        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Trạng thái</label>
                        <select class="form-select" id="books-status-filter">
                            <option value="">Tất cả trạng thái</option>
                            <!-- Status options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Thể loại</label>
                        <select class="form-select" id="books-category-filter">
                            <option value="">Tất cả thể loại</option>
                            <!-- Category options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Sắp xếp</label>
                        <select class="form-select" id="books-sort-filter">
                            <option value="latest">Mới nhất</option>
                            <option value="oldest">Cũ nhất</option>
                            <option value="popular">Phổ biến</option>
                            <option value="views">Lượt đọc</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Tìm kiếm</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="books-search-input" placeholder="Tìm sách...">
                            <button class="btn btn-outline-secondary" id="books-search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Books Grid View -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Danh sách sách (<span id="books-count">0</span>)</h5>
                </div>
            </div>
        </div>

        <!-- Books Cards Container -->
        <div class="row" id="books-container">
            <!-- Books will be loaded here dynamically -->
            <div class="col-12 text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-book fa-3x mb-3"></i>
                    <h5>Chưa có sách nào</h5>
                    <p>Bắt đầu tạo sách đầu tiên của bạn!</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                        <i class="fas fa-plus me-1"></i>Thêm sách mới
                    </button>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-4" id="books-pagination" style="display: none;">
            <div class="text-muted">
                Hiển thị <span id="books-pagination-start">0</span>-<span id="books-pagination-end">0</span> của <span id="books-pagination-total">0</span> sách
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="books-pagination-controls">
                    <!-- Pagination controls will be generated here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div class="modal fade" id="addStoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm truyện mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="story-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storyTitle" class="form-label">Tên truyện *</label>
                                    <input type="text" class="form-control" id="storyTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="storyAuthor" class="form-label">Tác giả</label>
                                    <input type="text" class="form-control" id="storyAuthor" value="Tác giả hiện tại" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="storyCategory" class="form-label">Thể loại *</label>
                                    <select class="form-select" id="storyCategory" required>
                                        <option value="">Chọn thể loại</option>
                                        <option value="romance">Lãng mạn</option>
                                        <option value="adventure">Phiêu lưu</option>
                                        <option value="mystery">Huyền bí</option>
                                        <option value="scifi">Khoa học viễn tưởng</option>
                                        <option value="fantasy">Giả tưởng</option>
                                        <option value="horror">Kinh dị</option>
                                        <option value="comedy">Hài hước</option>
                                        <option value="drama">Tâm lý</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="storyStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="storyStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="ongoing">Đang viết</option>
                                        <option value="review">Gửi duyệt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storyCover" class="form-label">Bìa truyện</label>
                                    <div class="cover-upload-container">
                                        <div id="coverPreview" class="cover-preview" style="display: none;">
                                            <img id="coverPreviewImg" src="" alt="Cover Preview" class="img-fluid rounded">
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeCover()">
                                                <i class="fas fa-trash me-1"></i>Xóa ảnh
                                            </button>
                                        </div>
                                        <div id="coverUploadBtn" class="cover-upload-btn">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="openCloudinaryUpload()">
                                                <i class="fas fa-cloud-upload-alt me-2"></i>Tải ảnh lên Cloudinary
                                            </button>
                                            <small class="text-muted d-block mt-1">Hỗ trợ: JPG, PNG, GIF (Tối đa 10MB)</small>
                                        </div>
                                        <input type="hidden" id="storyCoverUrl" value="">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="storyDescription" class="form-label">Mô tả</label>
                                    <textarea class="form-control" id="storyDescription" rows="4"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="storyTags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="storyTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="storyType" class="form-label">Loại truyện</label>
                                    <select class="form-select" id="storyType">
                                        <option value="series">Truyện dài</option>
                                        <option value="oneshot">Truyện ngắn</option>
                                        <option value="novel">Tiểu thuyết</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewStory()">Lưu truyện</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal fade" id="addBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm sách mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="book-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bookTitle" class="form-label">Tên sách *</label>
                                    <input type="text" class="form-control" id="bookTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bookAuthor" class="form-label">Tác giả</label>
                                    <input type="text" class="form-control" id="bookAuthor" value="Tác giả hiện tại" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="bookCategory" class="form-label">Thể loại *</label>
                                    <select class="form-select" id="bookCategory" required>
                                        <option value="">Chọn thể loại</option>
                                        <option value="romance">Lãng mạn</option>
                                        <option value="adventure">Phiêu lưu</option>
                                        <option value="mystery">Huyền bí</option>
                                        <option value="scifi">Khoa học viễn tưởng</option>
                                        <option value="fantasy">Giả tưởng</option>
                                        <option value="horror">Kinh dị</option>
                                        <option value="comedy">Hài hước</option>
                                        <option value="drama">Tâm lý</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="bookStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="bookStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="ongoing">Đang viết</option>
                                        <option value="review">Gửi duyệt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bookCover" class="form-label">Bìa sách</label>
                                    <div class="cover-upload-container">
                                        <div id="bookCoverPreview" class="cover-preview" style="display: none;">
                                            <img id="bookCoverPreviewImg" src="" alt="Cover Preview" class="img-fluid rounded">
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeBookCover()">
                                                <i class="fas fa-trash me-1"></i>Xóa ảnh
                                            </button>
                                        </div>
                                        <div id="bookCoverUploadBtn" class="cover-upload-btn">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="openBookCloudinaryUpload()">
                                                <i class="fas fa-cloud-upload-alt me-2"></i>Tải ảnh lên Cloudinary
                                            </button>
                                            <small class="text-muted d-block mt-1">Hỗ trợ: JPG, PNG, GIF (Tối đa 10MB)</small>
                                        </div>
                                        <input type="hidden" id="bookCoverUrl" value="">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="bookDescription" class="form-label">Mô tả</label>
                                    <textarea class="form-control" id="bookDescription" rows="4"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="bookTags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="bookTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="bookType" class="form-label">Loại sách</label>
                                    <select class="form-select" id="bookType">
                                        <option value="novel">Tiểu thuyết</option>
                                        <option value="short_story">Truyện ngắn</option>
                                        <option value="poetry">Thơ</option>
                                        <option value="essay">Tiểu luận</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewBook()">Lưu sách</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Chapter Modal for Stories -->
    <div class="modal fade" id="addChapterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm chương mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="chapter-form">
                        <input type="hidden" id="chapterStoryId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="chapterTitle" class="form-label">Tên chương *</label>
                                    <input type="text" class="form-control" id="chapterTitle" required placeholder="Nhập tên chương">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterNumber" class="form-label">Số chương</label>
                                    <input type="number" class="form-control" id="chapterNumber" min="1" placeholder="Tự động">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="chapterStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="completed">Hoàn thành</option>
                                        <option value="published">Đã xuất bản</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="chapterWordCount" class="form-label">Số từ</label>
                                    <input type="number" class="form-control" id="chapterWordCount" min="0" placeholder="Tự động tính">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterTags" class="form-label">Tags chương</label>
                                    <input type="text" class="form-control" id="chapterTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterNotes" class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="chapterNotes" rows="3" placeholder="Ghi chú cho chương này"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="chapterContent" class="form-label">Nội dung chương *</label>
                            <textarea class="form-control" id="chapterContent" rows="12" required placeholder="Nhập nội dung chương..."></textarea>
                            <div class="form-text">
                                <span id="wordCountDisplay">0 từ</span> • 
                                <span id="charCountDisplay">0 ký tự</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewChapter()">Lưu chương</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Chapter Modal for Books -->
    <div class="modal fade" id="addBookChapterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm chương mới cho sách</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="book-chapter-form">
                        <input type="hidden" id="bookChapterBookId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="chapterTitle" class="form-label">Tên chương *</label>
                                    <input type="text" class="form-control" id="bookChapterTitle" required placeholder="Nhập tên chương">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterNumber" class="form-label">Số chương</label>
                                    <input type="number" class="form-control" id="bookChapterNumber" min="1" placeholder="Tự động">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="bookChapterStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="completed">Hoàn thành</option>
                                        <option value="published">Đã xuất bản</option>
                                        <option value="review">Gửi duyệt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="chapterWordCount" class="form-label">Số từ</label>
                                    <input type="number" class="form-control" id="bookChapterWordCount" min="0" placeholder="Tự động tính">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterTags" class="form-label">Tags chương</label>
                                    <input type="text" class="form-control" id="bookChapterTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="chapterNotes" class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="bookChapterNotes" rows="3" placeholder="Ghi chú cho chương này"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="chapterContent" class="form-label">Nội dung chương *</label>
                            <textarea class="form-control" id="bookChapterContent" rows="12" required placeholder="Nhập nội dung chương..."></textarea>
                            <div class="form-text">
                                <span id="bookWordCountDisplay">0 từ</span> • 
                                <span id="bookCharCountDisplay">0 ký tự</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewBookChapter()">Lưu chương</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Story Modal -->
    <div class="modal fade" id="editStoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa truyện</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="story-form">
                        <input type="hidden" id="editStoryId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStoryTitle" class="form-label">Tên truyện *</label>
                                    <input type="text" class="form-control" id="editStoryTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryAuthor" class="form-label">Tác giả</label>
                                    <input type="text" class="form-control" id="editStoryAuthor" value="Tác giả hiện tại" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryCategory" class="form-label">Thể loại *</label>
                                    <select class="form-select" id="editStoryCategory" required>
                                        <option value="">Chọn thể loại</option>
                                        <option value="romance">Lãng mạn</option>
                                        <option value="adventure">Phiêu lưu</option>
                                        <option value="mystery">Huyền bí</option>
                                        <option value="scifi">Khoa học viễn tưởng</option>
                                        <option value="fantasy">Giả tưởng</option>
                                        <option value="horror">Kinh dị</option>
                                        <option value="comedy">Hài hước</option>
                                        <option value="drama">Tâm lý</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editStoryStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="ongoing">Đang viết</option>
                                        <option value="review">Gửi duyệt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStoryCover" class="form-label">Bìa truyện</label>
                                    <div class="cover-upload-container">
                                        <div id="editStoryCoverPreview" class="cover-preview" style="display: none;">
                                            <img id="editStoryCoverPreviewImg" src="" alt="Cover Preview" class="img-fluid rounded">
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeEditStoryCover()">
                                                <i class="fas fa-trash me-1"></i>Xóa ảnh
                                            </button>
                                        </div>
                                        <div id="editStoryCoverUploadBtn" class="cover-upload-btn">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="openEditStoryCloudinaryUpload()">
                                                <i class="fas fa-cloud-upload-alt me-2"></i>Tải ảnh lên Cloudinary
                                            </button>
                                            <small class="text-muted d-block mt-1">Hỗ trợ: JPG, PNG, GIF (Tối đa 10MB)</small>
                                        </div>
                                        <input type="hidden" id="editStoryCoverUrl" value="">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryDescription" class="form-label">Mô tả</label>
                                    <textarea class="form-control" id="editStoryDescription" rows="4"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryTags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="editStoryTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="editStoryType" class="form-label">Loại truyện</label>
                                    <select class="form-select" id="editStoryType">
                                        <option value="series">Truyện dài</option>
                                        <option value="oneshot">Truyện ngắn</option>
                                        <option value="novel">Tiểu thuyết</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="updateStory()">Cập nhật truyện</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div class="modal fade" id="editBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa sách</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="book-form">
                        <input type="hidden" id="editBookId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBookTitle" class="form-label">Tên sách *</label>
                                    <input type="text" class="form-control" id="editBookTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editBookAuthor" class="form-label">Tác giả</label>
                                    <input type="text" class="form-control" id="editBookAuthor" value="Tác giả hiện tại" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="editBookCategory" class="form-label">Thể loại *</label>
                                    <select class="form-select" id="editBookCategory" required>
                                        <option value="">Chọn thể loại</option>
                                        <option value="romance">Lãng mạn</option>
                                        <option value="adventure">Phiêu lưu</option>
                                        <option value="mystery">Huyền bí</option>
                                        <option value="scifi">Khoa học viễn tưởng</option>
                                        <option value="fantasy">Giả tưởng</option>
                                        <option value="horror">Kinh dị</option>
                                        <option value="comedy">Hài hước</option>
                                        <option value="drama">Tâm lý</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editBookStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editBookStatus">
                                        <option value="draft">Bản thảo</option>
                                        <option value="ongoing">Đang viết</option>
                                        <option value="review">Gửi duyệt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBookCover" class="form-label">Bìa sách</label>
                                    <div class="cover-upload-container">
                                        <div id="editBookCoverPreview" class="cover-preview" style="display: none;">
                                            <img id="editBookCoverPreviewImg" src="" alt="Cover Preview" class="img-fluid rounded">
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeEditBookCover()">
                                                <i class="fas fa-trash me-1"></i>Xóa ảnh
                                            </button>
                                        </div>
                                        <div id="editBookCoverUploadBtn" class="cover-upload-btn">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="openEditBookCloudinaryUpload()">
                                                <i class="fas fa-cloud-upload-alt me-2"></i>Tải ảnh lên Cloudinary
                                            </button>
                                            <small class="text-muted d-block mt-1">Hỗ trợ: JPG, PNG, GIF (Tối đa 10MB)</small>
                                        </div>
                                        <input type="hidden" id="editBookCoverUrl" value="">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editBookDescription" class="form-label">Mô tả</label>
                                    <textarea class="form-control" id="editBookDescription" rows="4"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editBookTags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="editBookTags" placeholder="Nhập tags, phân cách bằng dấu phẩy">
                                </div>
                                <div class="mb-3">
                                    <label for="editBookType" class="form-label">Loại sách</label>
                                    <select class="form-select" id="editBookType">
                                        <option value="novel">Tiểu thuyết</option>
                                        <option value="short_story">Truyện ngắn</option>
                                        <option value="poetry">Thơ</option>
                                        <option value="essay">Tiểu luận</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="updateBook()">Cập nhật sách</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Story Modal -->
    <div class="modal fade" id="viewStoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem truyện</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="story-cover-section">
                                <img id="viewStoryCover" src="" alt="Story Cover" class="img-fluid rounded shadow">
                                <div class="story-info mt-3">
                                    <h4 id="viewStoryTitle" class="mb-2"></h4>
                                    <p class="text-muted mb-1"><strong>Tác giả:</strong> <span id="viewStoryAuthor"></span></p>
                                    <p class="text-muted mb-1"><strong>Thể loại:</strong> <span id="viewStoryCategory"></span></p>
                                    <p class="text-muted mb-1"><strong>Trạng thái:</strong> <span id="viewStoryStatus"></span></p>
                                    <p class="text-muted mb-1"><strong>Loại truyện:</strong> <span id="viewStoryType"></span></p>
                                    <p class="text-muted mb-1"><strong>Ngày tạo:</strong> <span id="viewStoryCreatedAt"></span></p>
                                    <p class="text-muted mb-1"><strong>Cập nhật:</strong> <span id="viewStoryUpdatedAt"></span></p>
                                    <div class="story-stats mt-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewStoryViews">0</span>
                                                    <span class="stat-label">Lượt đọc</span>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewStoryLikes">0</span>
                                                    <span class="stat-label">Lượt thích</span>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewStoryRating">0</span>
                                                    <span class="stat-label">Đánh giá</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="story-content-section">
                                <h5>Mô tả</h5>
                                <p id="viewStoryDescription" class="text-muted"></p>
                                
                                <h5>Tags</h5>
                                <div id="viewStoryTags" class="mb-3"></div>
                                
                                <h5>Nội dung</h5>
                                <div id="viewStoryContent" class="story-content">
                                    <div class="text-center py-5">
                                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">Chưa có nội dung</h6>
                                        <p class="text-muted">Truyện này chưa có nội dung để hiển thị.</p>
                                        <button class="btn btn-primary mt-2" onclick="addChapterFromView()">
                                            <i class="fas fa-plus me-1"></i>Thêm chương
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="editStoryFromView()">Chỉnh sửa</button>
                    <button type="button" class="btn btn-success" onclick="addChapterFromView()">
                        <i class="fas fa-plus me-1"></i>Thêm chương
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Book Modal -->
    <div class="modal fade" id="viewBookModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem sách</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="book-cover-section">
                                <img id="viewBookCover" src="" alt="Book Cover" class="img-fluid rounded shadow">
                                <div class="book-info mt-3">
                                    <h4 id="viewBookTitle" class="mb-2"></h4>
                                    <p class="text-muted mb-1"><strong>Tác giả:</strong> <span id="viewBookAuthor"></span></p>
                                    <p class="text-muted mb-1"><strong>Thể loại:</strong> <span id="viewBookCategory"></span></p>
                                    <p class="text-muted mb-1"><strong>Trạng thái:</strong> <span id="viewBookStatus"></span></p>
                                    <p class="text-muted mb-1"><strong>Loại sách:</strong> <span id="viewBookType"></span></p>
                                    <p class="text-muted mb-1"><strong>Số trang:</strong> <span id="viewBookPages">0</span></p>
                                    <p class="text-muted mb-1"><strong>Số từ:</strong> <span id="viewBookWords">0</span></p>
                                    <p class="text-muted mb-1"><strong>Ngày tạo:</strong> <span id="viewBookCreatedAt"></span></p>
                                    <p class="text-muted mb-1"><strong>Cập nhật:</strong> <span id="viewBookUpdatedAt"></span></p>
                                    <div class="book-stats mt-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewBookViews">0</span>
                                                    <span class="stat-label">Lượt đọc</span>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewBookLikes">0</span>
                                                    <span class="stat-label">Lượt thích</span>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-item">
                                                    <span class="stat-number" id="viewBookRating">0</span>
                                                    <span class="stat-label">Đánh giá</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="book-content-section">
                                <h5>Mô tả</h5>
                                <p id="viewBookDescription" class="text-muted"></p>
                                
                                <h5>Tags</h5>
                                <div id="viewBookTags" class="mb-3"></div>
                                
                                <h5>Nội dung sách</h5>
                                <div id="viewBookContent" class="book-content">
                                    <div class="text-center py-5">
                                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">Chưa có nội dung</h6>
                                        <p class="text-muted">Sách này chưa có nội dung để hiển thị.</p>
                                        <button class="btn btn-primary mt-2" onclick="addBookChapterFromView()">
                                            <i class="fas fa-plus me-1"></i>Thêm chương
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="editBookFromView()">Chỉnh sửa</button>
                    <button type="button" class="btn btn-success" onclick="addBookChapterFromView()">
                        <i class="fas fa-plus me-1"></i>Thêm chương
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <!-- Custom Scripts -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYLKQprHcGWDUo4TNOvDzTqTbqUFG4FkA",
            authDomain: "anbok-collection.firebaseapp.com",
            databaseURL: "https://anbok-collection-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anbok-collection",
            storageBucket: "anbok-collection.firebasestorage.app",
            messagingSenderId: "835844957818",
            appId: "1:835844957818:web:33fc3d03875d49fc5c3dc3",
            measurementId: "G-MS5FT355WW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dvcebine7',
            uploadPreset: 'Noi luu anh cua anbook',
            apiKey: '113583348471635'
        };

        // Initialize Cloudinary Upload Widget
        let cloudinaryWidget = null;

        // Auto-load mock data for demo
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Cloudinary widget
            initializeCloudinaryWidget();
            
            // Check Firebase initialization
            if (!checkFirebaseInitialization()) {
                console.error('Firebase not properly initialized, cannot load data');
                showNotification('Lỗi: Firebase chưa được khởi tạo đúng cách', 'error');
                return;
            }
            
            // Wait a bit for Firebase to initialize, then load mock data
            setTimeout(() => {
                if (!currentUser) {
                    console.log('No authenticated user, loading mock data...');
                    loadMockUserData();
                }
            }, 1000);
        });

        // Initialize Cloudinary Widget
        function initializeCloudinaryWidget() {
            // Check if Cloudinary is loaded
            if (typeof cloudinary !== 'undefined') {
                console.log('Cloudinary SDK loaded successfully');
            } else {
                console.warn('Cloudinary SDK not loaded, upload functionality may not work');
            }
        }

        // Check if Firebase is properly initialized
        function checkFirebaseInitialization() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK not loaded');
                    return false;
                }
                
                if (!database) {
                    console.error('Firebase database not initialized');
                    return false;
                }
                
                if (!auth) {
                    console.error('Firebase auth not initialized');
                    return false;
                }
                
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Error checking Firebase initialization:', error);
                return false;
            }
        }

        // Test Firebase database connection
        async function testFirebaseConnection(userId) {
            try {
                if (!userId) {
                    throw new Error('User ID is required');
                }
                
                console.log('Testing Firebase connection for user:', userId);
                const testRef = database.ref(`users/${userId}`);
                const snapshot = await testRef.once('value');
                console.log('Firebase connection successful');
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                return false;
            }
        }

        // Global variables for user data
        let currentUser = null;
        let userProfile = null;
        let authorRegistration = null;

        // Check authentication state
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                // For demo purposes, use mock data instead of redirecting
                console.log('No user authenticated, using mock data');
                loadMockUserData();
            }
        });

        // Load mock user data for demo
        function loadMockUserData() {
            try {
                console.log('Loading mock user data...');
                
                userProfile = {
                    "createdAt": "2025-08-05T08:19:43.980Z",
                    "displayName": "Quân Phạm",
                    "email": "phamhongquan9117@gmail.com",
                    "lastUpdated": "2025-08-08T19:26:20.452Z",
                    "membership": {
                        "endDate": "2025-11-06T06:34:34.354Z",
                        "features": ["unlimited_books"],
                        "isActive": true,
                        "packageName": "Gói 3 Tháng",
                        "startDate": "2025-08-06T06:34:34.354Z",
                        "type": "basic"
                    },
                    "orders": {
                        "lastOrderDate": "2025-08-06T12:06:56.310Z",
                        "lastOrderId": "ORD_1754482016310_GI83FO977",
                        "orderHistory": [
                            "ORD_1754481644793_GXDW15H2K",
                            "ORD_1754481804780_M709L31LK",
                            "ORD_1754482016310_GI83FO977"
                        ],
                        "totalOrders": 3
                    },
                    "personalInfo": {
                        "address": "111111111",
                        "dateOfBirth": "01/01/1900",
                        "fullName": "Quân Phạm",
                        "gender": "Khác",
                        "phone": "111111111",
                        "userId": "UVZ8L9EPFO",
                        "username": "phamhongquan9117"
                    },
                    "photoURL": "https://res.cloudinary.com/dvcebine7/image/upload/v1754384811/h58yymy2wotwvrvkvvqr.jpg",
                    "uid": "Tt50hFcTNLNZB1tggdFzKWCFcvB3"
                };

                authorRegistration = {
                    "agreeOriginal": true,
                    "agreePublish": true,
                    "agreeTerms": true,
                    "bio": "Tác giả chuyên viết truyện phiêu lưu và khoa học viễn tưởng",
                    "contactEmail": "phamhongquan9117@gmail.com",
                    "contactPhone": "111111111",
                    "notes": "",
                    "penName": "LEO",
                    "registrationId": "-OXANgVOK7RaGj0N1Vkz",
                    "reviewed": false,
                    "sampleWork": "Cuộc phiêu lưu của anh hùng",
                    "specialization": "Phiêu lưu, Khoa học viễn tưởng",
                    "status": "approved",
                    "submittedAt": "2025-08-08T20:32:43.526Z",
                    "userEmail": "phamhongquan9117@gmail.com",
                    "userId": "Tt50hFcTNLNZB1tggdFzKWCFcvB3",
                    "website": "https://anbokcollection.netlify.app/"
                };

                // Update UI with mock data
                updateUserInterface();
                
                // Load data with mock user ID
                const mockUserId = "Tt50hFcTNLNZB1tggdFzKWCFcvB3";
                console.log('Loading data for mock user:', mockUserId);
                loadStoriesFromFirebase(mockUserId);
                loadBooksFromFirebase(mockUserId);
                
            } catch (error) {
                console.error('Error loading mock user data:', error);
                showNotification('Lỗi khi tải dữ liệu demo: ' + error.message, 'error');
            }
        }

        // Load user data from Firebase
        async function loadUserData(userId) {
            try {
                // Get user profile
                const profileRef = database.ref(`users/${userId}/profile`);
                const profileSnapshot = await profileRef.once('value');
                userProfile = profileSnapshot.val();

                // Get author registration
                const authorRef = database.ref(`users/${userId}/authorRegistration`);
                const authorSnapshot = await authorRef.once('value');
                authorRegistration = authorSnapshot.val();

                // Update UI with user data
                updateUserInterface();
                
                // Load data
                loadStoriesFromFirebase(userId);
                loadBooksFromFirebase(userId);
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Lỗi khi tải dữ liệu người dùng', 'danger');
            }
        }

        // Update user interface with Firebase data
        function updateUserInterface() {
            if (userProfile) {
                // Update user profile in topbar
                const userDropdown = document.getElementById('userDropdown');
                if (userDropdown) {
                    const userImage = userDropdown.querySelector('img');
                    const userName = userDropdown.querySelector('.fw-semibold');
                    const userRole = userDropdown.querySelector('.small.text-muted');

                    if (userImage && userProfile.photoURL) {
                        userImage.src = userProfile.photoURL;
                    }
                    if (userName) {
                        userName.textContent = userProfile.displayName || userProfile.personalInfo?.fullName || 'Tác giả';
                    }
                    if (userRole) {
                        userRole.textContent = authorRegistration ? 'Tác Giả Chuyên Nghiệp' : 'Tác Giả';
                    }
                }

                // Update sidebar brand with user name
                const sidebarBrand = document.querySelector('.sidebar-brand span');
                if (sidebarBrand && userProfile.displayName) {
                    sidebarBrand.textContent = userProfile.displayName + ' Studio';
                }

                // Update page title
                document.title = userProfile.displayName + ' - Studio Tác Giả';

                // Update settings form
                updateSettingsForm();
            }
        }





        // Load stories from Firebase
        async function loadStoriesFromFirebase(userId) {
            try {
                // Validate userId
                if (!userId) {
                    console.error('Invalid userId for loadStoriesFromFirebase:', userId);
                    throw new Error('Không có ID người dùng hợp lệ');
                }
                
                console.log('Loading stories for user:', userId);
                const storiesRef = database.ref(`users/${userId}/stories`);
                const snapshot = await storiesRef.once('value');
                const stories = snapshot.val();

                if (stories) {
                    console.log('Stories loaded from Firebase:', stories);
                    // Store stories in global variable for later use
                    window.userStories = stories;
                    // Display stories in the UI
                    displayStories(stories);
                    // Update stats
                    updateStoriesStats(stories);
                    // Populate filters with real data
                    populateStoriesFilters(stories);
                } else {
                    console.log('No stories found for user:', userId);
                    window.userStories = {};
                    // Show empty state
                    displayEmptyStories();
                    // Reset stats
                    resetStoriesStats();
                }
            } catch (error) {
                console.error('Error loading stories from Firebase:', error);
                showNotification('Lỗi khi tải truyện: ' + error.message, 'error');
                window.userStories = {};
                displayEmptyStories();
                resetStoriesStats();
            }
        }

        // Load books from Firebase
        async function loadBooksFromFirebase(userId) {
            try {
                // Validate userId
                if (!userId) {
                    console.error('Invalid userId for loadBooksFromFirebase:', userId);
                    throw new Error('Không có ID người dùng hợp lệ');
                }
                
                console.log('Loading books for user:', userId);
                const booksRef = database.ref(`users/${userId}/books`);
                const snapshot = await booksRef.once('value');
                const books = snapshot.val();

                if (books) {
                    console.log('Books loaded from Firebase:', books);
                    // Store books in global variable for later use
                    window.userBooks = books;
                    // Display books in the UI
                    displayBooks(books);
                    // Update stats
                    updateBooksStats(books);
                    // Populate filters with real data
                    populateBooksFilters(books);
                } else {
                    console.log('No books found for user:', userId);
                    window.userBooks = {};
                    // Show empty state
                    displayEmptyBooks();
                    // Reset stats
                    resetBooksStats();
                }
            } catch (error) {
                console.error('Error loading books from Firebase:', error);
                showNotification('Lỗi khi tải sách: ' + error.message, 'error');
                window.userBooks = {};
                displayEmptyBooks();
                resetBooksStats();
            }
        }

        // Display stories in the UI
        function displayStories(stories) {
            const container = document.getElementById('stories-container');
            
            if (!stories || Object.keys(stories).length === 0) {
                displayEmptyStories();
                return;
            }

            // Clear container
            container.innerHTML = '';
            
            // Convert stories object to array and sort by creation date
            const storiesArray = Object.entries(stories).map(([id, story]) => ({
                id,
                ...story
            })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Update all story counts
            updateStoryCount();

            // Create story cards
            storiesArray.forEach(story => {
                const storyCard = createStoryCardFromData(story);
                container.appendChild(storyCard);
            });

            // Show pagination if needed
            if (storiesArray.length > 6) {
                showPagination(storiesArray.length);
            } else {
                hidePagination();
            }
        }

        // Display books in the UI
        function displayBooks(books) {
            const container = document.getElementById('books-container');
            
            if (!books || Object.keys(books).length === 0) {
                displayEmptyBooks();
                return;
            }

            // Clear container
            container.innerHTML = '';
            
            // Convert books object to array and sort by creation date
            const booksArray = Object.entries(books).map(([id, book]) => ({
                id,
                ...book
            })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Update all book counts
            updateBookCount(booksArray.length);

            // Create book cards
            booksArray.forEach(book => {
                const bookCard = createBookCardFromData(book);
                container.appendChild(bookCard);
            });

            // Show pagination if needed
            if (booksArray.length > 6) {
                showBooksPagination(booksArray.length);
            } else {
                hideBooksPagination();
            }
        }

        // Create story card from Firebase data
        function createStoryCardFromData(story) {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 mb-4';
            
            const progressPercentage = story.totalChapters > 0 ? 
                Math.round((story.totalChapters / (story.totalChapters + 5)) * 100) : 0;
            
            const timeAgo = getTimeAgo(story.updatedAt || story.createdAt);
            
            col.innerHTML = `
                <div class="card story-card h-100">
                    <div class="story-card-image">
                        <img src="${story.coverImage || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=250&fit=crop'}" 
                             class="card-img-top" alt="Story Cover">
                        <div class="story-card-overlay">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light" title="Chỉnh sửa" onclick="editStory('${story.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Thêm chương" onclick="addChapter('${story.id}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xem" onclick="viewStory('${story.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xóa" onclick="deleteStory('${story.id}', '${story.title}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="story-status-badge status-${story.status}">
                            <i class="${getStatusIcon(story.status)}"></i>${getStatusText(story.status)}
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title fw-bold">${story.title}</h6>
                        <p class="card-text text-muted small">${story.description || 'Chưa có mô tả...'}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary">${getCategoryText(story.category)}</span>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <div class="story-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-number">${story.totalChapters || 0}</div>
                                    <div class="stat-label">Chương</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">${formatNumber(story.totalViews || 0)}</div>
                                    <div class="stat-label">Lượt đọc</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">${story.rating ? story.rating.toFixed(1) : '-'}</div>
                                    <div class="stat-label">Đánh giá</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress mb-2" style="height: 4px;">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">Tiến độ: ${story.totalChapters || 0}/${story.totalChapters + 5} chương (${progressPercentage}%)</small>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Display empty state
        function displayEmptyStories() {
            const container = document.getElementById('stories-container');
            
            // Update all story counts to 0
            updateStoryCount();
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-book-open fa-3x mb-3"></i>
                        <h5>Chưa có truyện nào</h5>
                        <p>Bắt đầu tạo truyện đầu tiên của bạn!</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStoryModal">
                            <i class="fas fa-plus me-1"></i>Thêm truyện mới
                        </button>
                    </div>
                </div>
            `;
            
            hidePagination();
        }

        function displayEmptyBooks() {
            const container = document.getElementById('books-container');
            
            // Update all book counts to 0
            updateBookCount(0);
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-book fa-3x mb-3"></i>
                        <h5>Chưa có sách nào</h5>
                        <p>Bắt đầu tạo sách đầu tiên của bạn!</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                            <i class="fas fa-plus me-1"></i>Thêm sách mới
                        </button>
                    </div>
                </div>
            `;
            
            hideBooksPagination();
        }

        // Update stories statistics
        function updateStoriesStats(stories) {
            if (!stories) {
                resetStoriesStats();
                return;
            }

            const storiesArray = Object.values(stories);
            const totalStories = storiesArray.length;
            const publishedStories = storiesArray.filter(s => s.status === 'published').length;
            const reviewStories = storiesArray.filter(s => s.status === 'review').length;
            const totalViews = storiesArray.reduce((sum, s) => sum + (s.totalViews || 0), 0);

            // Check if elements exist before updating
            const totalStoriesEl = document.getElementById('total-stories');
            const publishedStoriesEl = document.getElementById('published-stories');
            const reviewStoriesEl = document.getElementById('review-stories');
            const totalViewsEl = document.getElementById('total-views');

            if (totalStoriesEl) totalStoriesEl.textContent = totalStories;
            if (publishedStoriesEl) publishedStoriesEl.textContent = publishedStories;
            if (reviewStoriesEl) reviewStoriesEl.textContent = reviewStories;
            if (totalViewsEl) totalViewsEl.textContent = formatNumber(totalViews);
            
            // Update story counts in all locations
            updateStoryCount();
        }

        // Reset stories statistics
        function resetStoriesStats() {
            // Check if elements exist before updating
            const totalStoriesEl = document.getElementById('total-stories');
            const publishedStoriesEl = document.getElementById('published-stories');
            const reviewStoriesEl = document.getElementById('review-stories');
            const totalViewsEl = document.getElementById('total-views');

            if (totalStoriesEl) totalStoriesEl.textContent = '0';
            if (publishedStoriesEl) publishedStoriesEl.textContent = '0';
            if (reviewStoriesEl) reviewStoriesEl.textContent = '0';
            if (totalViewsEl) totalViewsEl.textContent = '0';
            
            // Update story counts to 0 in all locations
            updateStoryCount();
        }

        // Update books statistics
        function updateBooksStats(books) {
            if (!books) {
                resetBooksStats();
                return;
            }

            const booksArray = Object.values(books);
            const totalBooks = booksArray.length;
            const publishedBooks = booksArray.filter(b => b.status === 'published').length;
            const reviewBooks = booksArray.filter(b => b.status === 'review').length;
            const totalViews = booksArray.reduce((sum, b) => sum + (b.totalViews || 0), 0);

            // Check if elements exist before updating
            const totalBooksEl = document.getElementById('total-books');
            const publishedBooksEl = document.getElementById('published-books');
            const reviewBooksEl = document.getElementById('review-books');
            const totalViewsEl = document.getElementById('total-book-views');

            if (totalBooksEl) totalBooksEl.textContent = totalBooks;
            if (publishedBooksEl) publishedBooksEl.textContent = publishedBooks;
            if (reviewBooksEl) reviewBooksEl.textContent = reviewBooks;
            if (totalViewsEl) totalViewsEl.textContent = formatNumber(totalViews);
            
            // Update book counts in all locations
            updateBookCount(totalBooks);
        }

        // Reset books statistics
        function resetBooksStats() {
            // Check if elements exist before updating
            const totalBooksEl = document.getElementById('total-books');
            const publishedBooksEl = document.getElementById('published-books');
            const reviewBooksEl = document.getElementById('review-books');
            const totalViewsEl = document.getElementById('total-book-views');

            if (totalBooksEl) totalBooksEl.textContent = '0';
            if (publishedBooksEl) publishedBooksEl.textContent = '0';
            if (reviewBooksEl) reviewBooksEl.textContent = '0';
            if (totalViewsEl) totalViewsEl.textContent = '0';
            
            // Update book counts to 0 in all locations
            updateBookCount(0);
        }

        // Helper functions
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Vừa cập nhật';
            if (diffInHours < 24) return `${diffInHours} giờ trước`;
            if (diffInHours < 168) return `${Math.floor(diffInHours / 24)} ngày trước`;
            if (diffInHours < 720) return `${Math.floor(diffInHours / 168)} tuần trước`;
            return `${Math.floor(diffInHours / 720)} tháng trước`;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function showPagination(totalItems) {
            document.getElementById('stories-pagination').style.display = 'flex';
            document.getElementById('pagination-total').textContent = totalItems;
        }

        function hidePagination() {
            document.getElementById('stories-pagination').style.display = 'none';
        }

        function showBooksPagination(totalItems) {
            document.getElementById('books-pagination').style.display = 'flex';
            document.getElementById('books-pagination-total').textContent = totalItems;
        }

        function hideBooksPagination() {
            document.getElementById('books-pagination').style.display = 'none';
        }

        // Cloudinary Upload Functions
        function openCloudinaryUpload() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: 10485760, // 10MB
                    allowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    styles: {
                        palette: {
                            window: "#FFFFFF",
                            windowBorder: "#90A0B3",
                            tabIcon: "#0078FF",
                            menuIcons: "#5A616A",
                            textDark: "#000000",
                            textLight: "#FFFFFF",
                            link: "#0078FF",
                            action: "#FF620C",
                            inactiveTabIcon: "#0E2F5A",
                            error: "#F44235",
                            inProgress: "#0078FF",
                            complete: "#20B832",
                            sourceBg: "#E4EBF1"
                        },
                        fonts: {
                            default: null,
                            "'Fira Sans', sans-serif": {
                                url: "https://fonts.googleapis.com/css?family=Fira+Sans",
                                active: true
                            }
                        }
                    }
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        handleCloudinaryUpload(result);
                    }
                });
            }
            
            cloudinaryWidget.open();
        }

        function handleCloudinaryUpload(result) {
            const imageUrl = result.info.secure_url;
            const publicId = result.info.public_id;
            
            // Update hidden input
            document.getElementById('storyCoverUrl').value = imageUrl;
            
            // Show preview
            document.getElementById('coverPreviewImg').src = imageUrl;
            document.getElementById('coverPreview').style.display = 'block';
            document.getElementById('coverUploadBtn').style.display = 'none';
            
            // Show success notification
            showNotification('Ảnh đã được tải lên Cloudinary thành công!', 'success');
            
            console.log('Image uploaded to Cloudinary:', {
                url: imageUrl,
                publicId: publicId,
                size: result.info.bytes,
                format: result.info.format
            });
        }

        function removeCover() {
            // Clear hidden input
            document.getElementById('storyCoverUrl').value = '';
            
            // Hide preview and show upload button
            document.getElementById('coverPreview').style.display = 'none';
            document.getElementById('coverUploadBtn').style.display = 'block';
            
            // Clear preview image
            document.getElementById('coverPreviewImg').src = '';
        }

        // Book Management Functions
        function openBookCloudinaryUpload() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: 10485760, // 10MB
                    allowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    styles: {
                        palette: {
                            window: "#FFFFFF",
                            windowBorder: "#90A0B3",
                            tabIcon: "#0078FF",
                            menuIcons: "#5A616A",
                            textDark: "#000000",
                            textLight: "#FFFFFF",
                            link: "#0078FF",
                            action: "#FF620C",
                            inactiveTabIcon: "#0E2F5A",
                            error: "#F44235",
                            inProgress: "#0078FF",
                            complete: "#20B832",
                            sourceBg: "#E4EBF1"
                        },
                        fonts: {
                            default: null,
                            "'Fira Sans', sans-serif": {
                                url: "https://fonts.googleapis.com/css?family=Fira+Sans",
                                active: true
                            }
                        }
                    }
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        handleBookCloudinaryUpload(result);
                    }
                });
            }
            
            cloudinaryWidget.open();
        }

        function handleBookCloudinaryUpload(result) {
            const imageUrl = result.info.secure_url;
            const publicId = result.info.public_id;
            
            // Update hidden input
            document.getElementById('bookCoverUrl').value = imageUrl;
            
            // Show preview
            document.getElementById('bookCoverPreviewImg').src = imageUrl;
            document.getElementById('bookCoverPreview').style.display = 'block';
            document.getElementById('bookCoverUploadBtn').style.display = 'none';
            
            // Show success notification
            showNotification('Ảnh bìa sách đã được tải lên Cloudinary thành công!', 'success');
            
            console.log('Book cover uploaded to Cloudinary:', {
                url: imageUrl,
                publicId: publicId,
                size: result.info.bytes,
                format: result.info.format
            });
        }

        function removeBookCover() {
            // Clear hidden input
            document.getElementById('bookCoverUrl').value = '';
            
            // Hide preview and show upload button
            document.getElementById('bookCoverPreview').style.display = 'none';
            document.getElementById('bookCoverUploadBtn').style.display = 'block';
            
            // Clear preview image
            document.getElementById('bookCoverPreviewImg').src = '';
        }

        // Edit Story Cover Upload Functions
        function openEditStoryCloudinaryUpload() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: 10485760, // 10MB
                    allowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    styles: {
                        palette: {
                            window: "#FFFFFF",
                            windowBorder: "#90A0B3",
                            tabIcon: "#0078FF",
                            menuIcons: "#5A616A",
                            textDark: "#000000",
                            textLight: "#FFFFFF",
                            link: "#0078FF",
                            action: "#FF620C",
                            inactiveTabIcon: "#0E2F5A",
                            error: "#F44235",
                            inProgress: "#0078FF",
                            complete: "#20B832",
                            sourceBg: "#E4EBF1"
                        },
                        fonts: {
                            default: null,
                            "'Fira Sans', sans-serif": {
                                url: "https://fonts.googleapis.com/css?family=Fira+Sans",
                                active: true
                            }
                        }
                    }
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        handleEditStoryCloudinaryUpload(result);
                    }
                });
            }
            
            cloudinaryWidget.open();
        }

        function handleEditStoryCloudinaryUpload(result) {
            const imageUrl = result.info.secure_url;
            const publicId = result.info.public_id;
            
            // Update hidden input
            document.getElementById('editStoryCoverUrl').value = imageUrl;
            
            // Show preview
            document.getElementById('editStoryCoverPreviewImg').src = imageUrl;
            document.getElementById('editStoryCoverPreview').style.display = 'block';
            document.getElementById('editStoryCoverUploadBtn').style.display = 'none';
            
            // Show success notification
            showNotification('Ảnh bìa truyện đã được tải lên Cloudinary thành công!', 'success');
            
            console.log('Edit story cover uploaded to Cloudinary:', {
                url: imageUrl,
                publicId: publicId,
                size: result.info.bytes,
                format: result.info.format
            });
        }

        function removeEditStoryCover() {
            // Clear hidden input
            document.getElementById('editStoryCoverUrl').value = '';
            
            // Hide preview and show upload button
            document.getElementById('editStoryCoverPreview').style.display = 'none';
            document.getElementById('editStoryCoverUploadBtn').style.display = 'block';
            
            // Clear preview image
            document.getElementById('editStoryCoverPreviewImg').src = '';
        }

        // Edit Book Cover Upload Functions
        function openEditBookCloudinaryUpload() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: cloudinaryConfig.cloudName,
                    uploadPreset: cloudinaryConfig.uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    maxFileSize: 10485760, // 10MB
                    allowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    styles: {
                        palette: {
                            window: "#FFFFFF",
                            windowBorder: "#90A0B3",
                            tabIcon: "#0078FF",
                            menuIcons: "#5A616A",
                            textDark: "#000000",
                            textLight: "#FFFFFF",
                            link: "#0078FF",
                            action: "#FF620C",
                            inactiveTabIcon: "#0E2F5A",
                            error: "#F44235",
                            inProgress: "#0078FF",
                            complete: "#20B832",
                            sourceBg: "#E4EBF1"
                        },
                        fonts: {
                            default: null,
                            "'Fira Sans', sans-serif": {
                                url: "https://fonts.googleapis.com/css?family=Fira+Sans",
                                active: true
                            }
                        }
                    }
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        handleEditBookCloudinaryUpload(result);
                    }
                });
            }
            
            cloudinaryWidget.open();
        }

        function handleEditBookCloudinaryUpload(result) {
            const imageUrl = result.info.secure_url;
            const publicId = result.info.public_id;
            
            // Update hidden input
            document.getElementById('editBookCoverUrl').value = imageUrl;
            
            // Show preview
            document.getElementById('editBookCoverPreviewImg').src = imageUrl;
            document.getElementById('editBookCoverPreview').style.display = 'block';
            document.getElementById('editBookCoverUploadBtn').style.display = 'none';
            
            // Show success notification
            showNotification('Ảnh bìa sách đã được tải lên Cloudinary thành công!', 'success');
            
            console.log('Edit book cover uploaded to Cloudinary:', {
                url: imageUrl,
                publicId: publicId,
                size: result.info.bytes,
                format: result.info.format
            });
        }

        function removeEditBookCover() {
            // Clear hidden input
            document.getElementById('editBookCoverUrl').value = '';
            
            // Hide preview and show upload button
            document.getElementById('editBookCoverPreview').style.display = 'none';
            document.getElementById('editBookCoverUploadBtn').style.display = 'block';
            
            // Clear preview image
            document.getElementById('editBookCoverPreviewImg').src = '';
        }



        // Logout function
        async function logout() {
            // Show confirmation dialog
            const confirmed = confirm('Bạn có chắc chắn muốn đăng xuất?');
            if (!confirmed) {
                return; // User cancelled
            }
            
            try {
                console.log('Logout function called');
                
                // Check if Firebase auth is available
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        console.log('Signing out user:', currentUser.uid);
                        await firebase.auth().signOut();
                        console.log('User signed out successfully');
                    } else {
                        console.log('No current user to sign out');
                    }
                } else {
                    console.log('Firebase auth not available');
                }
                
                // Clear any local storage or session data
                localStorage.removeItem('userProfile');
                localStorage.removeItem('authorRegistration');
                sessionStorage.clear();
                
                showNotification('Đăng xuất thành công', 'success');
                
                // Redirect to auth.html after successful logout
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error during logout:', error);
                showNotification('Lỗi khi đăng xuất: ' + error.message, 'danger');
                
                // Force redirect to auth.html even if there's an error
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 2000);
            }
        }

        // Book Management Functions
        async function saveNewBook() {
            try {
                // Get form data
                const bookTitle = document.getElementById('bookTitle').value.trim();
                const bookCategory = document.getElementById('bookCategory').value;
                const bookStatus = document.getElementById('bookStatus').value;
                const bookDescription = document.getElementById('bookDescription').value.trim();
                const bookTags = document.getElementById('bookTags').value.trim();
                const bookType = document.getElementById('bookType').value;
                
                // Validation
                if (!bookTitle) {
                    showNotification('Vui lòng nhập tên sách', 'error');
                    return;
                }
                if (!bookCategory) {
                    showNotification('Vui lòng chọn thể loại sách', 'error');
                    return;
                }
                
                // Show loading state
                const saveBtn = document.querySelector('#addBookModal .btn-primary');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...';
                saveBtn.disabled = true;
                
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3'; // Fallback to mock user ID
                
                // Get cover image URL from Cloudinary or use default
                const coverImageUrl = document.getElementById('bookCoverUrl').value || 
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=250&fit=crop';
                
                // Create book data object
                const bookData = {
                    title: bookTitle,
                    category: bookCategory,
                    status: bookStatus,
                    description: bookDescription,
                    tags: bookTags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    type: bookType,
                    coverImage: coverImageUrl,
                    authorId: userId,
                    authorName: userProfile ? userProfile.displayName : 'Quân Phạm',
                    penName: authorRegistration ? authorRegistration.penName : 'LEO',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    content: '',
                    totalPages: 0,
                    totalWords: 0,
                    totalViews: 0,
                    totalLikes: 0,
                    rating: 0,
                    ratingCount: 0,
                    isPublished: bookStatus === 'published',
                    isCompleted: false
                };
                
                // Save to Firebase
                const booksRef = database.ref(`users/${userId}/books`);
                const newBookRef = booksRef.push();
                await newBookRef.set(bookData);
                
                // Create and append new book card
                const bookCard = createBookCardFromData({
                    id: newBookRef.key,
                    ...bookData
                });
                
                const booksContainer = document.getElementById('books-container');
                if (booksContainer.querySelector('.text-muted')) {
                    // Clear empty state
                    booksContainer.innerHTML = '';
                }
                booksContainer.appendChild(bookCard);
                
                // Reset form
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookCategory').value = '';
                document.getElementById('bookStatus').value = 'draft';
                document.getElementById('bookDescription').value = '';
                document.getElementById('bookTags').value = '';
                document.getElementById('bookType').value = 'novel';
                
                // Reset cover image
                removeBookCover();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBookModal'));
                modal.hide();
                
                // Show success notification
                showNotification('Sách đã được tạo thành công!', 'success');
                
                // Update stats
                updateBookStats();
                
            } catch (error) {
                console.error('Error saving book:', error);
                showNotification('Lỗi khi lưu sách: ' + error.message, 'error');
            } finally {
                // Reset button
                const saveBtn = document.querySelector('#addBookModal .btn-primary');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function createBookCardFromData(book) {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 mb-4';
            
            const progressPercentage = book.totalChapters > 0 ? 
                Math.round((book.totalChapters / (book.totalChapters + 5)) * 100) : 0;
            
            const timeAgo = getTimeAgo(book.updatedAt || book.createdAt);
            
            col.innerHTML = `
                <div class="card story-card h-100">
                    <div class="story-card-image">
                        <img src="${book.coverImage || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=250&fit=crop'}" 
                             class="card-img-top" alt="Book Cover">
                        <div class="story-card-overlay">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light" title="Chỉnh sửa" onclick="editBook('${book.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Thêm chương" onclick="addBookContent('${book.id}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xem" onclick="viewBook('${book.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xóa" onclick="deleteBook('${book.id}', '${book.title}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="story-status-badge status-${book.status}">
                            <i class="${getStatusIcon(book.status)}"></i>${getStatusText(book.status)}
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title fw-bold">${book.title}</h6>
                        <p class="card-text text-muted small">${book.description || 'Chưa có mô tả...'}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary">${getCategoryText(book.category)}</span>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <div class="story-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-number">${book.totalChapters || 0}</div>
                                    <div class="stat-label">Chương</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">${formatNumber(book.totalViews || 0)}</div>
                                    <div class="stat-label">Lượt đọc</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">${book.rating ? book.rating.toFixed(1) : '-'}</div>
                                    <div class="stat-label">Đánh giá</div>
                                </div>
                            </div>
                        </div>
                                </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress mb-2" style="height: 4px;">
                            <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                            </div>
                        <small class="text-muted">Tiến độ: ${book.totalChapters || 0}/${book.totalChapters + 5} chương (${progressPercentage}%)</small>
                    </div>
                </div>
            `;
            return col;
        }

        async function deleteBook(bookId, bookTitle) {
            if (confirm(`Bạn có chắc chắn muốn xóa sách "${bookTitle}"?`)) {
                try {
                    const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                    
                    // Delete from Firebase
                    await database.ref(`users/${userId}/books/${bookId}`).remove();
                    
                    // Remove from UI with animation
                    const bookCard = document.querySelector(`[onclick*="deleteBook('${bookId}')"]`).closest('.col-lg-4');
                    bookCard.classList.add('deleting');
                    
                    setTimeout(() => {
                        bookCard.remove();
                        updateBookStats();
                        showNotification('Sách đã được xóa thành công!', 'success');
                    }, 300);
                    
                } catch (error) {
                    console.error('Error deleting book:', error);
                    showNotification('Lỗi khi xóa sách: ' + error.message, 'error');
                }
            }
        }

        async function editBook(bookId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get book data from Firebase
                const bookRef = database.ref(`users/${userId}/books/${bookId}`);
                const snapshot = await bookRef.once('value');
                const bookData = snapshot.val();
                
                if (!bookData) {
                    showNotification('Không tìm thấy dữ liệu sách', 'error');
                    return;
                }
                
                // Populate edit form
                document.getElementById('editBookId').value = bookId;
                document.getElementById('editBookTitle').value = bookData.title || '';
                document.getElementById('editBookCategory').value = bookData.category || '';
                document.getElementById('editBookStatus').value = bookData.status || 'draft';
                document.getElementById('editBookDescription').value = bookData.description || '';
                document.getElementById('editBookTags').value = bookData.tags ? bookData.tags.join(', ') : '';
                document.getElementById('editBookType').value = bookData.type || 'novel';
                document.getElementById('editBookCoverUrl').value = bookData.coverImage || '';
                
                // Show cover preview if exists
                if (bookData.coverImage) {
                    document.getElementById('editBookCoverPreviewImg').src = bookData.coverImage;
                    document.getElementById('editBookCoverPreview').style.display = 'block';
                    document.getElementById('editBookCoverUploadBtn').style.display = 'none';
                } else {
                    document.getElementById('editBookCoverPreview').style.display = 'none';
                    document.getElementById('editBookCoverUploadBtn').style.display = 'block';
                }
                
                // Open edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editBookModal'));
                editModal.show();
                
            } catch (error) {
                console.error('Error loading book for edit:', error);
                showNotification('Lỗi khi tải dữ liệu sách', 'error');
            }
        }

        // Hàm viewBook đã được cập nhật ở dòng 4716

        // Update story function
        async function updateStory() {
            let originalText = '';
            try {
                const storyId = document.getElementById('editStoryId').value;
                const storyTitle = document.getElementById('editStoryTitle').value.trim();
                const storyCategory = document.getElementById('editStoryCategory').value;
                const storyStatus = document.getElementById('editStoryStatus').value;
                const storyDescription = document.getElementById('editStoryDescription').value.trim();
                const storyTags = document.getElementById('editStoryTags').value.trim();
                const storyType = document.getElementById('editStoryType').value;
                const coverImageUrl = document.getElementById('editStoryCoverUrl').value;
                
                // Validation
                if (!storyTitle) {
                    showNotification('Vui lòng nhập tên truyện', 'error');
                    return;
                }
                if (!storyCategory) {
                    showNotification('Vui lòng chọn thể loại truyện', 'error');
                    return;
                }
                
                // Show loading state
                const updateBtn = document.querySelector('#editStoryModal .btn-primary');
                originalText = updateBtn.textContent;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang cập nhật...';
                updateBtn.disabled = true;
                
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Update story data
                const updatedStoryData = {
                    title: storyTitle,
                    category: storyCategory,
                    status: storyStatus,
                    description: storyDescription,
                    tags: storyTags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    type: storyType,
                    coverImage: coverImageUrl,
                    updatedAt: new Date().toISOString()
                };
                
                // Update in Firebase
                const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                await storyRef.update(updatedStoryData);
                
                // Update the story card in UI
                const storyCard = document.querySelector(`[onclick*="editStory('${storyId}')"]`).closest('.col-lg-4');
                if (storyCard) {
                    const titleElement = storyCard.querySelector('.card-title');
                    const descriptionElement = storyCard.querySelector('.card-text');
                    const statusBadge = storyCard.querySelector('.story-status-badge');
                    const coverImage = storyCard.querySelector('.story-card-image img');
                    
                    if (titleElement) titleElement.textContent = storyTitle;
                    if (descriptionElement) descriptionElement.textContent = storyDescription || 'Chưa có mô tả';
                    if (statusBadge) {
                        statusBadge.className = `story-status-badge ${storyStatus}`;
                        statusBadge.innerHTML = `<i class="fas fa-${getStatusIcon(storyStatus)}"></i> ${getStatusText(storyStatus)}`;
                    }
                    if (coverImage && coverImageUrl) coverImage.src = coverImageUrl;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStoryModal'));
                modal.hide();
                
                // Show success notification
                showNotification('Truyện đã được cập nhật thành công!', 'success');
                
            } catch (error) {
                console.error('Error updating story:', error);
                showNotification('Lỗi khi cập nhật truyện: ' + error.message, 'error');
            } finally {
                // Reset button
                const updateBtn = document.querySelector('#editStoryModal .btn-primary');
                if (updateBtn && originalText) {
                    updateBtn.innerHTML = originalText;
                    updateBtn.disabled = false;
                }
            }
        }

        // Update book function
        async function updateBook() {
            let originalText = '';
            try {
                const bookId = document.getElementById('editBookId').value;
                const bookTitle = document.getElementById('editBookTitle').value.trim();
                const bookCategory = document.getElementById('editBookCategory').value;
                const bookStatus = document.getElementById('editBookStatus').value;
                const bookDescription = document.getElementById('editBookDescription').value.trim();
                const bookTags = document.getElementById('editBookTags').value.trim();
                const bookType = document.getElementById('editBookType').value;
                const coverImageUrl = document.getElementById('editBookCoverUrl').value;
                
                // Validation
                if (!bookTitle) {
                    showNotification('Vui lòng nhập tên sách', 'error');
                    return;
                }
                if (!bookCategory) {
                    showNotification('Vui lòng chọn thể loại sách', 'error');
                    return;
                }
                
                // Show loading state
                const updateBtn = document.querySelector('#editBookModal .btn-primary');
                originalText = updateBtn.textContent;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang cập nhật...';
                updateBtn.disabled = true;
                
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Update book data
                const updatedBookData = {
                    title: bookTitle,
                    category: bookCategory,
                    status: bookStatus,
                    description: bookDescription,
                    tags: bookTags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    type: bookType,
                    coverImage: coverImageUrl,
                    updatedAt: new Date().toISOString()
                };
                
                // Update in Firebase
                const bookRef = database.ref(`users/${userId}/books/${bookId}`);
                await bookRef.update(updatedBookData);
                
                // Update the book card in UI
                const bookCard = document.querySelector(`[onclick*="editBook('${bookId}')"]`).closest('.col-lg-4');
                if (bookCard) {
                    const titleElement = bookCard.querySelector('.card-title');
                    const descriptionElement = bookCard.querySelector('.card-text');
                    const statusBadge = bookCard.querySelector('.story-status-badge');
                    const coverImage = bookCard.querySelector('.story-card-image img');
                    
                    if (titleElement) titleElement.textContent = bookTitle;
                    if (descriptionElement) descriptionElement.textContent = bookDescription || 'Chưa có mô tả';
                    if (statusBadge) {
                        statusBadge.className = `story-status-badge ${bookStatus}`;
                        statusBadge.innerHTML = `<i class="fas fa-${getStatusIcon(bookStatus)}"></i> ${getStatusText(bookStatus)}`;
                    }
                    if (coverImage && coverImageUrl) coverImage.src = coverImageUrl;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editBookModal'));
                modal.hide();
                
                // Show success notification
                showNotification('Sách đã được cập nhật thành công!', 'success');
                
            } catch (error) {
                console.error('Error updating book:', error);
                showNotification('Lỗi khi cập nhật sách: ' + error.message, 'error');
            } finally {
                // Reset button
                const updateBtn = document.querySelector('#editBookModal .btn-primary');
                if (updateBtn && originalText) {
                    updateBtn.innerHTML = originalText;
                    updateBtn.disabled = false;
                }
            }
        }

        function updateBookStats() {
            const bookCards = document.querySelectorAll('#books-container .story-card');
            const totalBooks = bookCards.length;
            
            // Update total books count
            const totalBooksElement = document.querySelector('#books-section .stat-card-primary .stat-value');
            if (totalBooksElement) {
                totalBooksElement.textContent = totalBooks;
            }

            // Update books list count
            const listCountElement = document.querySelector('#books-section h5');
            if (listCountElement) {
                listCountElement.textContent = `Danh sách sách (${totalBooks})`;
            }

            // Update pagination info
            const paginationInfo = document.querySelector('#books-section .text-muted');
            if (paginationInfo) {
                paginationInfo.textContent = `Hiển thị 1-${Math.min(totalBooks, 3)} của ${totalBooks} sách`;
            }
        }

        // Update settings form with user data
        function updateSettingsForm() {
            if (userProfile) {
                // Update personal info form
                const fullNameInput = document.querySelector('#settings-section input[type="text"]');
                const emailInput = document.querySelector('#settings-section input[type="email"]');
                const phoneInput = document.querySelector('#settings-section input[type="tel"]');
                const bioTextarea = document.querySelector('#settings-section textarea');

                if (fullNameInput) {
                    fullNameInput.value = userProfile.personalInfo?.fullName || userProfile.displayName || '';
                }
                if (emailInput) {
                    emailInput.value = userProfile.email || userProfile.personalInfo?.email || '';
                }
                if (phoneInput) {
                    phoneInput.value = userProfile.personalInfo?.phone || '';
                }
                if (bioTextarea) {
                    bioTextarea.value = authorRegistration?.bio || '';
                }
            }
        }



        // Sidebar toggle for mobile
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.body.classList.toggle('sidebar-open');
        });

        // Enhanced Navigation with smooth transitions
        document.querySelectorAll('#sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('#sidebar .nav-link').forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Get section to show
                const section = this.getAttribute('data-section');
                console.log('Switching to section:', section);
                
                // Hide all content sections
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                
                // Show selected section
                const targetSection = document.getElementById(section + '-section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Add loading state
                document.getElementById('content').classList.add('loading');
                
                // Simulate content loading
                setTimeout(() => {
                    document.getElementById('content').classList.remove('loading');
                }, 300);
            });
        });

        // Search functionality
        const searchInput = document.querySelector('#topbar input[type="text"]');
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Action button handlers
        document.querySelectorAll('.btn-action').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const action = this.title;
                const storyName = this.closest('tr').querySelector('td:nth-child(2) .fw-semibold').textContent;
                
                // Add click animation
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
                
                console.log(`${action} cho truyện: ${storyName}`);
                
                // Show notification
                showNotification(`${action} thành công!`, 'success');
            });
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Real-time updates simulation
        setInterval(() => {
            const randomStat = document.querySelectorAll('.stat-value');
            const randomIndex = Math.floor(Math.random() * randomStat.length);
            const currentValue = parseInt(randomStat[randomIndex].textContent.replace(/[^\d]/g, ''));
            const newValue = currentValue + Math.floor(Math.random() * 10);
            
            if (randomStat[randomIndex].textContent.includes('M')) {
                randomStat[randomIndex].textContent = (newValue / 1000).toFixed(1) + 'M';
            } else {
                randomStat[randomIndex].textContent = newValue;
            }
        }, 10000);

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Add smooth scroll behavior
        document.documentElement.style.scrollBehavior = 'smooth';

        // Performance optimization: Lazy load images
        const images = document.querySelectorAll('img[src*="unsplash"]');
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.src;
                    observer.unobserve(img);
                }
            });
        });

        images.forEach(img => imageObserver.observe(img));

        // Story Management Functions
        async function editStory(storyId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get story data from Firebase
                const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                const snapshot = await storyRef.once('value');
                const storyData = snapshot.val();
                
                if (!storyData) {
                    showNotification('Không tìm thấy dữ liệu truyện', 'error');
                    return;
                }
                
                // Populate edit form
                document.getElementById('editStoryId').value = storyId;
                document.getElementById('editStoryTitle').value = storyData.title || '';
                document.getElementById('editStoryCategory').value = storyData.category || '';
                document.getElementById('editStoryStatus').value = storyData.status || 'draft';
                document.getElementById('editStoryDescription').value = storyData.description || '';
                document.getElementById('editStoryTags').value = storyData.tags ? storyData.tags.join(', ') : '';
                document.getElementById('editStoryType').value = storyData.type || 'series';
                document.getElementById('editStoryCoverUrl').value = storyData.coverImage || '';
                
                // Show cover preview if exists
                if (storyData.coverImage) {
                    document.getElementById('editStoryCoverPreviewImg').src = storyData.coverImage;
                    document.getElementById('editStoryCoverPreview').style.display = 'block';
                    document.getElementById('editStoryCoverUploadBtn').style.display = 'none';
                } else {
                    document.getElementById('editStoryCoverPreview').style.display = 'none';
                    document.getElementById('editStoryCoverUploadBtn').style.display = 'block';
                }
                
                // Open edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editStoryModal'));
                editModal.show();
                
            } catch (error) {
                console.error('Error loading story for edit:', error);
                showNotification('Lỗi khi tải dữ liệu truyện', 'error');
            }
        }

        async function addChapter(storyId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get story data from Firebase
                const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                const snapshot = await storyRef.once('value');
                const storyData = snapshot.val();
                
                if (!storyData) {
                    showNotification('Không tìm thấy dữ liệu truyện', 'error');
                    return;
                }
                
                // Set story ID in modal
                document.getElementById('chapterStoryId').value = storyId;
                
                // Auto-fill chapter number
                const chapterNumberInput = document.getElementById('chapterNumber');
                if (chapterNumberInput) {
                    // Get current chapter count and add 1
                    const chaptersRef = database.ref(`users/${userId}/stories/${storyId}/chapters`);
                    const chaptersSnapshot = await chaptersRef.once('value');
                    const currentChapters = chaptersSnapshot.val() || {};
                    const nextChapterNumber = Object.keys(currentChapters).length + 1;
                    chapterNumberInput.value = nextChapterNumber;
                }
                
                // Clear form
                document.getElementById('chapterTitle').value = '';
                document.getElementById('chapterContent').value = '';
                document.getElementById('chapterTags').value = '';
                document.getElementById('chapterNotes').value = '';
                document.getElementById('chapterStatus').value = 'draft';
                document.getElementById('chapterWordCount').value = '';
                document.getElementById('wordCountDisplay').textContent = '0 từ';
                document.getElementById('charCountDisplay').textContent = '0 ký tự';
                
                // Open add chapter modal
                const addChapterModal = new bootstrap.Modal(document.getElementById('addChapterModal'));
                addChapterModal.show();
                
            } catch (error) {
                console.error('Error loading story for chapter:', error);
                showNotification('Lỗi khi tải dữ liệu truyện', 'error');
            }
        }

        async function viewStory(storyId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get story data from Firebase
                const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                const snapshot = await storyRef.once('value');
                const storyData = snapshot.val();
                
                if (!storyData) {
                    showNotification('Không tìm thấy dữ liệu truyện', 'error');
                    return;
                }
                
                // Populate view modal
                document.getElementById('viewStoryTitle').textContent = storyData.title || 'Không có tiêu đề';
                document.getElementById('viewStoryAuthor').textContent = storyData.authorName || 'Không có tác giả';
                document.getElementById('viewStoryCategory').textContent = getCategoryText(storyData.category) || 'Không có thể loại';
                document.getElementById('viewStoryStatus').textContent = getStatusText(storyData.status) || 'Không có trạng thái';
                document.getElementById('viewStoryType').textContent = storyData.type || 'Không có loại';
                document.getElementById('viewStoryCreatedAt').textContent = storyData.createdAt ? new Date(storyData.createdAt).toLocaleDateString('vi-VN') : 'Không có';
                document.getElementById('viewStoryUpdatedAt').textContent = storyData.updatedAt ? new Date(storyData.updatedAt).toLocaleDateString('vi-VN') : 'Không có';
                document.getElementById('viewStoryDescription').textContent = storyData.description || 'Chưa có mô tả';
                document.getElementById('viewStoryViews').textContent = storyData.totalViews || 0;
                document.getElementById('viewStoryLikes').textContent = storyData.totalLikes || 0;
                document.getElementById('viewStoryRating').textContent = storyData.rating || 0;
                
                // Set cover image
                const coverImage = document.getElementById('viewStoryCover');
                if (storyData.coverImage) {
                    coverImage.src = storyData.coverImage;
                    coverImage.style.display = 'block';
                } else {
                    coverImage.style.display = 'none';
                }
                
                // Set tags
                const tagsContainer = document.getElementById('viewStoryTags');
                if (storyData.tags && storyData.tags.length > 0) {
                    tagsContainer.innerHTML = storyData.tags.map(tag => 
                        `<span class="badge bg-primary me-1">${tag}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '<span class="text-muted">Chưa có tags</span>';
                }
                
                // Set content
                const contentContainer = document.getElementById('viewStoryContent');
                if (storyData.chapters && Object.keys(storyData.chapters).length > 0) {
                    // Get chapters and sort by number
                    const chapters = Object.values(storyData.chapters).sort((a, b) => a.number - b.number);
                    
                    let chaptersHtml = '';
                    chapters.forEach((chapter, index) => {
                        const chapterKey = Object.keys(storyData.chapters)[index];
                        chaptersHtml += `
                            <div class="chapter-item mb-4 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 fw-bold">Chương ${chapter.number}: ${chapter.title}</h6>
                                    <span class="badge bg-${chapter.status === 'published' ? 'success' : 'warning'}">${getStatusText(chapter.status)}</span>
                                </div>
                                <div class="chapter-content mb-2">
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-calendar me-1"></i>${new Date(chapter.createdAt).toLocaleDateString('vi-VN')}
                                        <span class="ms-3"><i class="fas fa-word-count me-1"></i>${chapter.wordCount || 0} từ</span>
                                    </p>
                                    <div class="chapter-text">
                                        ${chapter.content.length > 300 ? chapter.content.substring(0, 300) + '...' : chapter.content}
                                    </div>
                                </div>
                                <div class="chapter-actions">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editChapterFromView('${storyId}', '${chapterKey}')">
                                        <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewFullChapter('${storyId}', '${chapterKey}')">
                                        <i class="fas fa-eye me-1"></i>Xem đầy đủ
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    contentContainer.innerHTML = `
                        <div class="chapters-list">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Danh sách chương (${chapters.length})</h6>
                                <button class="btn btn-primary btn-sm" onclick="addChapterFromView()">
                                    <i class="fas fa-plus me-1"></i>Thêm chương
                                </button>
                            </div>
                            ${chaptersHtml}
                        </div>
                    `;
                } else {
                    contentContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Chưa có nội dung</h6>
                            <p class="text-muted">Truyện này chưa có chương nào để hiển thị.</p>
                            <button class="btn btn-primary mt-2" onclick="addChapterFromView()">
                                <i class="fas fa-plus me-1"></i>Thêm chương đầu tiên
                            </button>
                        </div>
                    `;
                }
                
                // Store story ID for edit function
                document.getElementById('viewStoryModal').setAttribute('data-story-id', storyId);
                
                // Open view modal
                const viewModal = new bootstrap.Modal(document.getElementById('viewStoryModal'));
                viewModal.show();
                
            } catch (error) {
                console.error('Error loading story for view:', error);
                showNotification('Lỗi khi tải dữ liệu truyện', 'error');
            }
        }

        async function deleteStory(storyId, storyName) {
            // Show confirmation dialog
            if (confirm(`Bạn có chắc chắn muốn xóa truyện "${storyName}"?\n\nHành động này không thể hoàn tác!`)) {
                showNotification(`Đang xóa truyện: ${storyName}`, 'warning');
                
                try {
                    // Get current user ID
                    const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                    
                    // Delete from Firebase
                    const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                    await storyRef.remove();
                    
                    console.log(`Story deleted from Firebase: ${storyId} - ${storyName}`);
                    
                    // Remove the story card from DOM
                    const storyCard = document.querySelector(`[onclick*="${storyId}"]`).closest('.col-lg-4');
                    if (storyCard) {
                        storyCard.style.opacity = '0';
                        storyCard.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            storyCard.remove();
                            showNotification(`Đã xóa thành công truyện: ${storyName}`, 'success');
                            
                            // Update story count
                            updateStoryCount();
                            updateStoryStats();
                        }, 300);
                    }
                } catch (error) {
                    console.error('Error deleting story from Firebase:', error);
                    showNotification('Lỗi khi xóa truyện từ Firebase', 'danger');
                }
            }
        }

        function updateStoryCount() {
            const storyCards = document.querySelectorAll('.story-card');
            const count = storyCards.length;
            
            // Update all story count displays
            const countElements = [
                document.getElementById('stories-count'),
                document.getElementById('sidebar-stories-count'),
                document.getElementById('header-stories-count')
            ];
            
            countElements.forEach(element => {
                if (element) {
                    element.textContent = count;
                }
            });
            
            // Update sidebar badge
            const sidebarBadge = document.querySelector('#sidebar .nav-link[data-section="stories"] .badge');
            if (sidebarBadge) {
                sidebarBadge.textContent = count;
            }
        }

        // Update book count function
        function updateBookCount(count) {
            // Update all book count displays
            const countElements = [
                document.getElementById('books-count'),
                document.getElementById('sidebar-books-count'),
                document.getElementById('header-books-count')
            ];
            
            countElements.forEach(element => {
                if (element) {
                    element.textContent = count;
                }
            });
            
            // Update sidebar badge
            const sidebarBadge = document.querySelector('#sidebar .nav-link[data-section="books"] .badge');
            if (sidebarBadge) {
                sidebarBadge.textContent = count;
            }
        }

        // Update story stats after adding new story
        function updateStoryStats() {
            // Reload stories from Firebase to get updated data
            const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
            loadStoriesFromFirebase(userId);
            
            // Also reload books to update book counts
            loadBooksFromFirebase(userId);
            
            // Update story counts immediately
            updateStoryCount();
            
            // Update book counts immediately
            updateBookCount(0);
        }

        // Add New Story Function
        async function saveNewStory() {
            // Get form data
            const storyTitle = document.getElementById('storyTitle').value;
            const storyCategory = document.getElementById('storyCategory').value;
            const storyStatus = document.getElementById('storyStatus').value;
            const storyDescription = document.getElementById('storyDescription').value;
            const storyTags = document.getElementById('storyTags').value;
            const storyType = document.getElementById('storyType').value;

            // Validate required fields
            if (!storyTitle.trim()) {
                showNotification('Vui lòng nhập tên truyện', 'danger');
                return;
            }

            if (!storyCategory) {
                showNotification('Vui lòng chọn thể loại', 'danger');
                return;
            }

            // Show loading state
            const saveButton = document.querySelector('#addStoryModal .btn-primary');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...';
            saveButton.disabled = true;

            try {
                // Get current user ID
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3'; // Fallback to mock user ID
                
                // Get cover image URL from Cloudinary or use default
                const coverImageUrl = document.getElementById('storyCoverUrl').value || 
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=250&fit=crop';
                
                // Create story data object
                const storyData = {
                    title: storyTitle,
                    category: storyCategory,
                    status: storyStatus,
                    description: storyDescription,
                    tags: storyTags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    type: storyType,
                    coverImage: coverImageUrl,
                    authorId: userId,
                    authorName: userProfile ? userProfile.displayName : 'Quân Phạm',
                    penName: authorRegistration ? authorRegistration.penName : 'LEO',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    chapters: [],
                    totalChapters: 0,
                    totalWords: 0,
                    totalViews: 0,
                    totalLikes: 0,
                    rating: 0,
                    ratingCount: 0,
                    isPublished: storyStatus === 'published',
                    isCompleted: false
                };

                // Save to Firebase
                const storiesRef = database.ref(`users/${userId}/stories`);
                const newStoryRef = storiesRef.push();
                const storyId = newStoryRef.key;
                
                await newStoryRef.set(storyData);

                // Create new story card with Firebase ID
                const newStoryCard = createStoryCard({
                    id: storyId,
                    title: storyTitle,
                    category: storyCategory,
                    status: storyStatus,
                    description: storyDescription,
                    tags: storyTags,
                    type: storyType,
                    coverImage: storyData.coverImage
                });

                // Add to stories grid
                const storiesRow = document.querySelector('#stories-section .row:last-of-type');
                if (storiesRow) {
                    storiesRow.appendChild(newStoryCard);
                }

                // Reset form
                document.getElementById('storyTitle').value = '';
                document.getElementById('storyCategory').value = '';
                document.getElementById('storyStatus').value = 'draft';
                document.getElementById('storyDescription').value = '';
                document.getElementById('storyTags').value = '';
                document.getElementById('storyType').value = 'series';
                
                // Reset cover image
                removeCover();

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addStoryModal'));
                if (modal) {
                    modal.hide();
                }

                // Reset button
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;

                // Show success message
                showNotification(`Đã tạo thành công truyện: ${storyTitle}`, 'success');

                // Update stats
                updateStoryStats();

                console.log('Story saved to Firebase:', storyId, storyData);

            } catch (error) {
                console.error('Error saving story to Firebase:', error);
                showNotification('Lỗi khi lưu truyện vào Firebase', 'danger');
                
                // Reset button
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        function createStoryCard(storyData) {
            const storyDiv = document.createElement('div');
            storyDiv.className = 'col-lg-4 col-md-6 mb-4';
            storyDiv.innerHTML = `
                <div class="card story-card h-100">
                    <div class="story-card-image">
                        <img src="${storyData.coverImage}" class="card-img-top" alt="Story Cover">
                        <div class="story-card-overlay">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light" title="Chỉnh sửa" onclick="editStory('${storyData.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Thêm chương" onclick="addChapter('${storyData.id}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xem" onclick="viewStory('${storyData.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Xóa" onclick="deleteStory('${storyData.id}', '${storyData.title}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="story-status-badge status-${storyData.status}">
                            <i class="fas fa-${getStatusIcon(storyData.status)}"></i>${getStatusText(storyData.status)}
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title fw-bold">${storyData.title}</h6>
                        <p class="card-text text-muted small">${storyData.description || 'Mô tả truyện sẽ được hiển thị ở đây...'}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary">${getCategoryText(storyData.category)}</span>
                            <small class="text-muted">Vừa tạo</small>
                        </div>
                        <div class="story-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Chương</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Lượt đọc</div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-number">-</div>
                                    <div class="stat-label">Đánh giá</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress mb-2" style="height: 4px;">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Tiến độ: 0/0 chương (0%)</small>
                    </div>
                </div>
            `;
            return storyDiv;
        }

        function getStatusIcon(status) {
            const icons = {
                'draft': 'file-alt',
                'ongoing': 'pen',
                'review': 'clock',
                'published': 'check'
            };
            return icons[status] || 'file-alt';
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'Bản thảo',
                'ongoing': 'Đang viết',
                'review': 'Đang duyệt',
                'published': 'Đã xuất bản'
            };
            return texts[status] || 'Bản thảo';
        }

        function getCategoryText(category) {
            const categories = {
                'romance': 'Lãng mạn',
                'adventure': 'Phiêu lưu',
                'mystery': 'Huyền bí',
                'scifi': 'Khoa học viễn tưởng',
                'fantasy': 'Giả tưởng',
                'horror': 'Kinh dị',
                'comedy': 'Hài hước',
                'drama': 'Tâm lý'
            };
            return categories[category] || category;
        }

        function updateStoryStats() {
            const storyCards = document.querySelectorAll('.story-card');
            const totalStories = storyCards.length;
            
            // Update total stories count
            const totalStoriesElement = document.querySelector('#stories-section .stat-card-primary .stat-value');
            if (totalStoriesElement) {
                totalStoriesElement.textContent = totalStories;
            }

            // Update stories list count
            const listCountElement = document.querySelector('#stories-section h5');
            if (listCountElement) {
                listCountElement.textContent = `Danh sách truyện (${totalStories})`;
            }

            // Update pagination info
            const paginationInfo = document.querySelector('#stories-section .text-muted');
            if (paginationInfo) {
                paginationInfo.textContent = `Hiển thị 1-${Math.min(totalStories, 3)} của ${totalStories} truyện`;
            }
            
            // Also update book counts
            const bookCards = document.querySelectorAll('.book-card');
            const totalBooks = bookCards.length;
            updateBookCount(totalBooks);
            
            // Update story counts in all locations
            updateStoryCount();
        }

        // Enhanced Navigation with content switching
        document.querySelectorAll('#sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('#sidebar .nav-link').forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Hide all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show the corresponding content section
                const section = this.getAttribute('data-section');
                const targetSection = document.getElementById(section + '-section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Add loading state
                document.getElementById('content').classList.add('loading');
                
                // Simulate content loading
                setTimeout(() => {
                    document.getElementById('content').classList.remove('loading');
                }, 300);
                
                console.log('Switching to section:', section);
            });
        });

        async function viewBook(bookId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get book data from Firebase
                const bookRef = database.ref(`users/${userId}/books/${bookId}`);
                const snapshot = await bookRef.once('value');
                const bookData = snapshot.val();
                
                if (!bookData) {
                    showNotification('Không tìm thấy dữ liệu sách', 'error');
                    return;
                }
                
                // Populate view modal
                document.getElementById('viewBookTitle').textContent = bookData.title || 'Không có tiêu đề';
                document.getElementById('viewBookAuthor').textContent = bookData.authorName || 'Không có tác giả';
                document.getElementById('viewBookCategory').textContent = getCategoryText(bookData.category) || 'Không có thể loại';
                document.getElementById('viewBookStatus').textContent = getStatusText(bookData.status) || 'Không có trạng thái';
                document.getElementById('viewBookType').textContent = bookData.type || 'Không có loại';
                document.getElementById('viewBookPages').textContent = bookData.totalPages || 0;
                document.getElementById('viewBookWords').textContent = bookData.totalWords || 0;
                document.getElementById('viewBookCreatedAt').textContent = bookData.createdAt ? new Date(bookData.createdAt).toLocaleDateString('vi-VN') : 'Không có';
                document.getElementById('viewBookUpdatedAt').textContent = bookData.updatedAt ? new Date(bookData.updatedAt).toLocaleDateString('vi-VN') : 'Không có';
                document.getElementById('viewBookDescription').textContent = bookData.description || 'Chưa có mô tả';
                document.getElementById('viewBookViews').textContent = bookData.totalViews || 0;
                document.getElementById('viewBookLikes').textContent = bookData.totalLikes || 0;
                document.getElementById('viewBookRating').textContent = bookData.rating || 0;
                
                // Set cover image
                const coverImage = document.getElementById('viewBookCover');
                if (bookData.coverImage) {
                    coverImage.src = bookData.coverImage;
                    coverImage.style.display = 'block';
                } else {
                    coverImage.style.display = 'none';
                }
                
                // Set tags
                const tagsContainer = document.getElementById('viewBookTags');
                if (bookData.tags && bookData.tags.length > 0) {
                    tagsContainer.innerHTML = bookData.tags.map(tag => 
                        `<span class="badge bg-primary me-1">${tag}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '<span class="text-muted">Chưa có tags</span>';
                }
                
                // Set content
                const contentContainer = document.getElementById('viewBookContent');
                if (bookData.chapters && Object.keys(bookData.chapters).length > 0) {
                    // Get chapters and sort by number
                    const chapters = Object.values(bookData.chapters).sort((a, b) => a.number - b.number);
                    
                    let chaptersHtml = '';
                    chapters.forEach((chapter, index) => {
                        const chapterKey = Object.keys(bookData.chapters)[index];
                        chaptersHtml += `
                            <div class="chapter-item mb-4 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 fw-bold">Chương ${chapter.number}: ${chapter.title}</h6>
                                    <span class="badge bg-${chapter.status === 'published' ? 'success' : 'warning'}">${getStatusText(chapter.status)}</span>
                                </div>
                                <div class="chapter-content mb-2">
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-calendar me-1"></i>${new Date(chapter.createdAt).toLocaleDateString('vi-VN')}
                                        <span class="ms-3"><i class="fas fa-word-count me-1"></i>${chapter.wordCount || 0} từ</span>
                                    </p>
                                    <div class="chapter-text">
                                        ${chapter.content.length > 300 ? chapter.content.substring(0, 300) + '...' : chapter.content}
                                    </div>
                                </div>
                                <div class="chapter-actions">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editBookChapterFromView('${bookId}', '${chapterKey}')">
                                        <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewFullBookChapter('${bookId}', '${chapterKey}')">
                                        <i class="fas fa-eye me-1"></i>Xem đầy đủ
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    contentContainer.innerHTML = `
                        <div class="chapters-list">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Danh sách chương (${chapters.length})</h6>
                                <button class="btn btn-primary btn-sm" onclick="addBookChapterFromView()">
                                    <i class="fas fa-plus me-1"></i>Thêm chương
                                </button>
                            </div>
                            ${chaptersHtml}
                        </div>
                    `;
                } else {
                    contentContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-book fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Chưa có nội dung</h6>
                            <p class="text-muted">Sách này chưa có chương nào để hiển thị.</p>
                            <button class="btn btn-primary mt-2" onclick="addBookChapterFromView()">
                                <i class="fas fa-plus me-1"></i>Thêm chương đầu tiên
                            </button>
                        </div>
                    `;
                }
                
                // Store book ID for edit function
                document.getElementById('viewBookModal').setAttribute('data-book-id', bookId);
                
                // Open view modal
                const viewModal = new bootstrap.Modal(document.getElementById('viewBookModal'));
                viewModal.show();
                
            } catch (error) {
                console.error('Error loading book for view:', error);
                showNotification('Lỗi khi tải dữ liệu sách', 'error');
            }
        }

        // Function to edit story from view modal
        function editStoryFromView() {
            const storyId = document.getElementById('viewStoryModal').getAttribute('data-story-id');
            if (storyId) {
                // Close view modal completely
                const viewModal = document.getElementById('viewStoryModal');
                if (viewModal) {
                    // Remove modal classes and backdrop
                    viewModal.classList.remove('show');
                    viewModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    
                    console.log('View story modal closed manually');
                }
                
                // Wait for modal to close completely before opening edit modal
                setTimeout(() => {
                    editStory(storyId);
                }, 500);
            }
        }

        // Function to edit book from view modal
        function editBookFromView() {
            const bookId = document.getElementById('viewBookModal').getAttribute('data-book-id');
            if (bookId) {
                // Close view modal completely
                const viewModal = document.getElementById('viewBookModal');
                if (viewModal) {
                    // Remove modal classes and backdrop
                    viewModal.classList.remove('show');
                    viewModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    
                    console.log('View book modal closed manually');
                }
                
                // Wait for modal to close completely before opening edit modal
                setTimeout(() => {
                    editBook(bookId);
                }, 500);
            }
        }

        // Function to add content to book
        async function addBookContent(bookId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get book data from Firebase
                const bookRef = database.ref(`users/${userId}/books/${bookId}`);
                const snapshot = await bookRef.once('value');
                const bookData = snapshot.val();
                
                if (!bookData) {
                    showNotification('Không tìm thấy dữ liệu sách', 'error');
                    return;
                }
                
                // Set book ID in modal
                document.getElementById('bookChapterBookId').value = bookId;
                
                // Auto-fill chapter number
                const chapterNumberInput = document.getElementById('bookChapterNumber');
                if (chapterNumberInput) {
                    // Get current chapter count and add 1
                    const chaptersRef = database.ref(`users/${userId}/books/${bookId}/chapters`);
                    const chaptersSnapshot = await chaptersRef.once('value');
                    const currentChapters = chaptersSnapshot.val() || {};
                    const nextChapterNumber = Object.keys(currentChapters).length + 1;
                    chapterNumberInput.value = nextChapterNumber;
                }
                
                // Clear form
                document.getElementById('bookChapterTitle').value = '';
                document.getElementById('bookChapterContent').value = '';
                document.getElementById('bookChapterTags').value = '';
                document.getElementById('bookChapterNotes').value = '';
                document.getElementById('bookChapterStatus').value = 'draft';
                document.getElementById('bookChapterWordCount').value = '';
                document.getElementById('bookWordCountDisplay').textContent = '0 từ';
                document.getElementById('bookCharCountDisplay').textContent = '0 ký tự';
                
                // Open add chapter modal
                const addBookChapterModal = new bootstrap.Modal(document.getElementById('addBookChapterModal'));
                addBookChapterModal.show();
                
            } catch (error) {
                console.error('Error loading book for chapter:', error);
                showNotification('Lỗi khi tải dữ liệu sách', 'error');
            }
        }

        // Function to add chapter to book from view modal
        function addBookChapterFromView() {
            console.log('addBookChapterFromView called');
            try {
                const bookId = document.getElementById('viewBookModal').getAttribute('data-book-id');
                console.log('Book ID:', bookId);
                
                if (bookId) {
                    // Simple modal closing
                    const viewModal = document.getElementById('viewBookModal');
                    if (viewModal) {
                        // Remove modal classes and backdrop
                        viewModal.classList.remove('show');
                        viewModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        
                        // Remove backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                        
                        console.log('Modal closed manually');
                    }
                    
                    // Wait for modal to close completely before opening add chapter modal
                    setTimeout(() => {
                        console.log('Calling addBookContent with ID:', bookId);
                        addBookContent(bookId);
                    }, 300);
                } else {
                    console.error('No book ID found');
                    showNotification('Không tìm thấy ID sách', 'error');
                }
            } catch (error) {
                console.error('Error in addBookChapterFromView:', error);
                showNotification('Lỗi khi thêm chương sách: ' + error.message, 'error');
            }
        }

        // Function to add chapter from view modal
        function addChapterFromView() {
            console.log('addChapterFromView called');
            try {
                const storyId = document.getElementById('viewStoryModal').getAttribute('data-story-id');
                console.log('Story ID:', storyId);
                
                if (storyId) {
                    // Simple modal closing
                    const viewModal = document.getElementById('viewStoryModal');
                    if (viewModal) {
                        // Remove modal classes and backdrop
                        viewModal.classList.remove('show');
                        viewModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        
                        // Remove backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                        
                        console.log('Modal closed manually');
                    }
                    
                    // Wait for modal to close completely before opening add chapter modal
                    setTimeout(() => {
                        console.log('Calling addChapter with ID:', storyId);
                        addChapter(storyId);
                    }, 300);
                } else {
                    console.error('No story ID found');
                    showNotification('Không tìm thấy ID truyện', 'error');
                }
            } catch (error) {
                console.error('Error in addChapterFromView:', error);
                showNotification('Lỗi khi thêm chương truyện: ' + error.message, 'error');
            }
        }

        // Function to save new chapter for story
        async function saveNewChapter() {
            try {
                const storyId = document.getElementById('chapterStoryId').value;
                const chapterTitle = document.getElementById('chapterTitle').value.trim();
                const chapterContent = document.getElementById('chapterContent').value.trim();
                const chapterNumber = document.getElementById('chapterNumber').value;
                const chapterStatus = document.getElementById('chapterStatus').value;
                const chapterTags = document.getElementById('chapterTags').value.trim();
                const chapterNotes = document.getElementById('chapterNotes').value.trim();
                
                if (!chapterTitle || !chapterContent) {
                    showNotification('Vui lòng nhập tên chương và nội dung', 'error');
                    return;
                }
                
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Calculate word count
                const wordCount = chapterContent.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = chapterContent.length;
                
                // Create chapter data
                const chapterData = {
                    title: chapterTitle,
                    content: chapterContent,
                    number: parseInt(chapterNumber) || 1,
                    status: chapterStatus,
                    tags: chapterTags ? chapterTags.split(',').map(tag => tag.trim()) : [],
                    notes: chapterNotes,
                    wordCount: wordCount,
                    charCount: charCount,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Save to Firebase
                const chapterRef = database.ref(`users/${userId}/stories/${storyId}/chapters`);
                const newChapterRef = chapterRef.push();
                await newChapterRef.set(chapterData);
                
                // Update story stats
                const storyRef = database.ref(`users/${userId}/stories/${storyId}`);
                await storyRef.update({
                    totalChapters: (await chapterRef.once('value')).numChildren(),
                    updatedAt: Date.now()
                });
                
                showNotification('Chương mới đã được lưu thành công!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addChapterModal'));
                modal.hide();
                
                // Refresh story list
                loadStoriesFromFirebase(userId);
                
            } catch (error) {
                console.error('Error saving chapter:', error);
                showNotification('Lỗi khi lưu chương: ' + error.message, 'error');
            }
        }

        // Function to save new chapter for book
        async function saveNewBookChapter() {
            try {
                const bookId = document.getElementById('bookChapterBookId').value;
                const chapterTitle = document.getElementById('bookChapterTitle').value.trim();
                const chapterContent = document.getElementById('bookChapterContent').value.trim();
                const chapterNumber = document.getElementById('bookChapterNumber').value;
                const chapterStatus = document.getElementById('bookChapterStatus').value;
                const chapterTags = document.getElementById('bookChapterTags').value.trim();
                const chapterNotes = document.getElementById('bookChapterNotes').value.trim();
                
                if (!chapterTitle || !chapterContent) {
                    showNotification('Vui lòng nhập tên chương và nội dung', 'error');
                    return;
                }
                
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Calculate word count
                const wordCount = chapterContent.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = chapterContent.length;
                
                // Create chapter data
                const chapterData = {
                    title: chapterTitle,
                    content: chapterContent,
                    number: parseInt(chapterNumber) || 1,
                    status: chapterStatus,
                    tags: chapterTags ? chapterTags.split(',').map(tag => tag.trim()) : [],
                    notes: chapterNotes,
                    wordCount: wordCount,
                    charCount: charCount,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Save to Firebase
                const chapterRef = database.ref(`users/${userId}/books/${bookId}/chapters`);
                const newChapterRef = chapterRef.push();
                await newChapterRef.set(chapterData);
                
                // Update book stats
                const bookRef = database.ref(`users/${userId}/books/${bookId}`);
                await bookRef.update({
                    totalChapters: (await chapterRef.once('value')).numChildren(),
                    updatedAt: Date.now()
                });
                
                showNotification('Chương mới đã được lưu thành công!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBookChapterModal'));
                modal.hide();
                
                // Refresh book list
                loadBooksFromFirebase(userId);
                
            } catch (error) {
                console.error('Error saving book chapter:', error);
                showNotification('Lỗi khi lưu chương: ' + error.message, 'error');
            }
        }

        // Add event listeners for word count
        document.addEventListener('DOMContentLoaded', function() {
            // Story chapter word count
            const chapterContent = document.getElementById('chapterContent');
            if (chapterContent) {
                chapterContent.addEventListener('input', function() {
                    const content = this.value;
                    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
                    const charCount = content.length;
                    
                    document.getElementById('wordCountDisplay').textContent = wordCount + ' từ';
                    document.getElementById('charCountDisplay').textContent = charCount + ' ký tự';
                    document.getElementById('chapterWordCount').value = wordCount;
                });
            }
            
            // Book chapter word count
            const bookChapterContent = document.getElementById('bookChapterContent');
            if (bookChapterContent) {
                bookChapterContent.addEventListener('input', function() {
                    const content = this.value;
                    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
                    const charCount = content.length;
                    
                    document.getElementById('bookWordCountDisplay').textContent = wordCount + ' từ';
                    document.getElementById('bookCharCountDisplay').textContent = charCount + ' ký tự';
                    document.getElementById('bookChapterWordCount').value = wordCount;
                });
            }
        });

        // Helper functions for chapter management
        async function editChapter(storyId, chapterId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get chapter data from Firebase
                const chapterRef = database.ref(`users/${userId}/stories/${storyId}/chapters/${chapterId}`);
                const snapshot = await chapterRef.once('value');
                const chapterData = snapshot.val();
                
                if (!chapterData) {
                    showNotification('Không tìm thấy dữ liệu chương', 'error');
                    return;
                }
                
                // Close any open modals first
                const viewStoryModal = bootstrap.Modal.getInstance(document.getElementById('viewStoryModal'));
                if (viewStoryModal) {
                    viewStoryModal.hide();
                }
                
                const fullChapterModal = bootstrap.Modal.getInstance(document.getElementById('fullChapterModal'));
                if (fullChapterModal) {
                    fullChapterModal.hide();
                }
                
                // Wait a bit for modals to close
                setTimeout(() => {
                    // Populate edit form
                    document.getElementById('chapterStoryId').value = storyId;
                    document.getElementById('chapterNumber').value = chapterData.number || 1;
                    document.getElementById('chapterTitle').value = chapterData.title || '';
                    document.getElementById('chapterContent').value = chapterData.content || '';
                    document.getElementById('chapterStatus').value = chapterData.status || 'draft';
                    document.getElementById('chapterTags').value = chapterData.tags ? chapterData.tags.join(', ') : '';
                    document.getElementById('chapterNotes').value = chapterData.notes || '';
                    document.getElementById('chapterWordCount').value = chapterData.wordCount || 0;
                    document.getElementById('wordCountDisplay').textContent = (chapterData.wordCount || 0) + ' từ';
                    document.getElementById('charCountDisplay').textContent = (chapterData.charCount || 0) + ' ký tự';
                    
                    // Open edit modal
                    const editModal = new bootstrap.Modal(document.getElementById('addChapterModal'));
                    editModal.show();
                }, 300);
                
            } catch (error) {
                console.error('Error loading chapter for edit:', error);
                showNotification('Lỗi khi tải dữ liệu chương', 'error');
            }
        }

        async function viewFullChapter(storyId, chapterId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get chapter data from Firebase
                const chapterRef = database.ref(`users/${userId}/stories/${storyId}/chapters/${chapterId}`);
                const snapshot = await chapterRef.once('value');
                const chapterData = snapshot.val();
                
                if (!chapterData) {
                    showNotification('Không tìm thấy dữ liệu chương', 'error');
                    return;
                }
                
                // Create and show full chapter modal
                const modalHtml = `
                    <div class="modal fade" id="fullChapterModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Chương ${chapterData.number}: ${chapterData.title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="chapter-meta mb-3">
                                        <div class="row text-muted small">
                                            <div class="col-md-3">
                                                <i class="fas fa-calendar me-1"></i>${new Date(chapterData.createdAt).toLocaleDateString('vi-VN')}
                                            </div>
                                            <div class="col-md-3">
                                                <i class="fas fa-word-count me-1"></i>${chapterData.wordCount || 0} từ
                                            </div>
                                            <div class="col-md-3">
                                                <i class="fas fa-tag me-1"></i>${chapterData.tags ? chapterData.tags.join(', ') : 'Không có tags'}
                                            </div>
                                            <div class="col-md-3">
                                                <span class="badge bg-${chapterData.status === 'published' ? 'success' : 'warning'}">${getStatusText(chapterData.status)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-content">
                                        <div class="content-text" style="line-height: 1.8; font-size: 16px;">
                                            ${chapterData.content.replace(/\n/g, '<br>')}
                                        </div>
                                    </div>
                                    ${chapterData.notes ? `
                                        <div class="chapter-notes mt-4 p-3 bg-light rounded">
                                            <h6><i class="fas fa-sticky-note me-2"></i>Ghi chú:</h6>
                                            <p class="mb-0">${chapterData.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="editChapterFromView('${storyId}', '${chapterId}')">
                                        <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('fullChapterModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add new modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('fullChapterModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading full chapter:', error);
                showNotification('Lỗi khi tải chương đầy đủ', 'error');
            }
        }

        // Function to edit book chapter from view modal
        function editBookChapterFromView(bookId, chapterId) {
            // Close view modal completely
            const viewModal = document.getElementById('viewBookModal');
            if (viewModal) {
                // Remove modal classes and backdrop
                viewModal.classList.remove('show');
                viewModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // Remove backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
                
                console.log('View book modal closed manually for chapter edit');
            }
            
            // Wait for modal to close completely before opening edit chapter modal
            setTimeout(() => {
                editBookChapter(bookId, chapterId);
            }, 500);
        }

        async function editBookChapter(bookId, chapterId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get chapter data from Firebase
                const chapterRef = database.ref(`users/${userId}/books/${bookId}/chapters/${chapterId}`);
                const snapshot = await chapterRef.once('value');
                const chapterData = snapshot.val();
                
                if (!chapterData) {
                    showNotification('Không tìm thấy dữ liệu chương', 'error');
                    return;
                }
                
                // Populate edit form
                document.getElementById('bookChapterBookId').value = bookId;
                document.getElementById('bookChapterNumber').value = chapterData.number || 1;
                document.getElementById('bookChapterTitle').value = chapterData.title || '';
                document.getElementById('bookChapterContent').value = chapterData.content || '';
                document.getElementById('bookChapterStatus').value = chapterData.status || 'draft';
                document.getElementById('bookChapterTags').value = chapterData.tags ? chapterData.tags.join(', ') : '';
                document.getElementById('bookChapterNotes').value = chapterData.notes || '';
                document.getElementById('bookChapterWordCount').value = chapterData.wordCount || 0;
                document.getElementById('bookWordCountDisplay').textContent = (chapterData.wordCount || 0) + ' từ';
                document.getElementById('bookCharCountDisplay').textContent = (chapterData.charCount || 0) + ' ký tự';
                
                // Open edit modal
                const editModal = new bootstrap.Modal(document.getElementById('addBookChapterModal'));
                editModal.show();
                
            } catch (error) {
                console.error('Error loading book chapter for edit:', error);
                showNotification('Lỗi khi tải dữ liệu chương sách', 'error');
            }
        }

        async function viewFullBookChapter(bookId, chapterId) {
            try {
                const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                
                // Get chapter data from Firebase
                const chapterRef = database.ref(`users/${userId}/books/${bookId}/chapters/${chapterId}`);
                const snapshot = await chapterRef.once('value');
                const chapterData = snapshot.val();
                
                if (!chapterData) {
                    showNotification('Không tìm thấy dữ liệu chương', 'error');
                    return;
                }
                
                // Create and show full chapter modal
                const modalHtml = `
                    <div class="modal fade" id="fullBookChapterModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Chương ${chapterData.number}: ${chapterData.title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="chapter-meta mb-3">
                                        <div class="row text-muted small">
                                            <div class="col-md-3">
                                                <i class="fas fa-calendar me-1"></i>${new Date(chapterData.createdAt).toLocaleDateString('vi-VN')}
                                            </div>
                                            <div class="col-md-3">
                                                <i class="fas fa-word-count me-1"></i>${chapterData.wordCount || 0} từ
                                            </div>
                                            <div class="col-md-3">
                                                <i class="fas fa-tag me-1"></i>${chapterData.tags ? chapterData.tags.join(', ') : 'Không có tags'}
                                            </div>
                                            <div class="col-md-3">
                                                <span class="badge bg-${chapterData.status === 'published' ? 'success' : 'warning'}">${getStatusText(chapterData.status)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-content">
                                        <div class="content-text" style="line-height: 1.8; font-size: 16px;">
                                            ${chapterData.content.replace(/\n/g, '<br>')}
                                        </div>
                                    </div>
                                    ${chapterData.notes ? `
                                        <div class="chapter-notes mt-4 p-3 bg-light rounded">
                                            <h6><i class="fas fa-sticky-note me-2"></i>Ghi chú:</h6>
                                            <p class="mb-0">${chapterData.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="editBookChapterFromView('${bookId}', '${chapterId}')">
                                        <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('fullBookChapterModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add new modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('fullBookChapterModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading full book chapter:', error);
                showNotification('Lỗi khi tải chương sách đầy đủ', 'error');
            }
        }

        // Dynamic Filter Population Functions
        function populateStoriesFilters(stories) {
            if (!stories) return;
            
            const storiesArray = Object.values(stories);
            
            // Populate status filter
            const statusFilter = document.getElementById('stories-status-filter');
            if (statusFilter) {
                const statuses = [...new Set(storiesArray.map(s => s.status).filter(Boolean))];
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = getStatusText(status);
                    statusFilter.appendChild(option);
                });
            }
            
            // Populate category filter
            const categoryFilter = document.getElementById('stories-category-filter');
            if (categoryFilter) {
                const categories = [...new Set(storiesArray.map(s => s.category).filter(Boolean))];
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = getCategoryText(category);
                    categoryFilter.appendChild(option);
                });
            }
        }

        function populateBooksFilters(books) {
            if (!books) return;
            
            const booksArray = Object.values(books);
            
            // Populate status filter
            const statusFilter = document.getElementById('books-status-filter');
            if (statusFilter) {
                const statuses = [...new Set(booksArray.map(b => b.status).filter(Boolean))];
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = getStatusText(status);
                    statusFilter.appendChild(option);
                });
            }
            
            // Populate category filter
            const categoryFilter = document.getElementById('books-category-filter');
            if (categoryFilter) {
                const categories = [...new Set(booksArray.map(b => b.category).filter(Boolean))];
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = getCategoryText(category);
                    categoryFilter.appendChild(option);
                });
            }
        }

        // Filter and Search Functions
        function filterStories() {
            const statusFilter = document.getElementById('stories-status-filter')?.value;
            const categoryFilter = document.getElementById('stories-category-filter')?.value;
            const sortFilter = document.getElementById('stories-sort-filter')?.value;
            const searchInput = document.getElementById('stories-search-input')?.value.toLowerCase();
            
            if (!window.userStories) return;
            
            let filteredStories = Object.values(window.userStories);
            
            // Apply status filter
            if (statusFilter) {
                filteredStories = filteredStories.filter(s => s.status === statusFilter);
            }
            
            // Apply category filter
            if (categoryFilter) {
                filteredStories = filteredStories.filter(s => s.category === categoryFilter);
            }
            
            // Apply search filter
            if (searchInput) {
                filteredStories = filteredStories.filter(s => 
                    s.title.toLowerCase().includes(searchInput) ||
                    s.description.toLowerCase().includes(searchInput) ||
                    (s.tags && s.tags.some(tag => tag.toLowerCase().includes(searchInput)))
                );
            }
            
            // Apply sorting
            switch (sortFilter) {
                case 'latest':
                    filteredStories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredStories.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'popular':
                    filteredStories.sort((a, b) => (b.totalLikes || 0) - (a.totalLikes || 0));
                    break;
                case 'views':
                    filteredStories.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    break;
            }
            
            // Display filtered stories
            displayStories(filteredStories);
        }

        function filterBooks() {
            const statusFilter = document.getElementById('books-status-filter')?.value;
            const categoryFilter = document.getElementById('books-category-filter')?.value;
            const sortFilter = document.getElementById('books-sort-filter')?.value;
            const searchInput = document.getElementById('books-search-input')?.value.toLowerCase();
            
            if (!window.userBooks) return;
            
            let filteredBooks = Object.values(window.userBooks);
            
            // Apply status filter
            if (statusFilter) {
                filteredBooks = filteredBooks.filter(b => b.status === statusFilter);
            }
            
            // Apply category filter
            if (categoryFilter) {
                filteredBooks = filteredBooks.filter(b => b.category === categoryFilter);
            }
            
            // Apply search filter
            if (searchInput) {
                filteredBooks = filteredBooks.filter(b => 
                    b.title.toLowerCase().includes(searchInput) ||
                    b.description.toLowerCase().includes(searchInput) ||
                    (b.tags && b.tags.some(tag => tag.toLowerCase().includes(searchInput)))
                );
            }
            
            // Apply sorting
            switch (sortFilter) {
                case 'latest':
                    filteredBooks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredBooks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'popular':
                    filteredBooks.sort((a, b) => (b.totalLikes || 0) - (a.totalLikes || 0));
                    break;
                case 'views':
                    filteredBooks.sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0));
                    break;
            }
            
            // Display filtered books
            displayBooks(filteredBooks);
        }

        // Add event listeners for filters and logout
        document.addEventListener('DOMContentLoaded', function() {
            // Logout button event listener
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    logout();
                });
            }
            
            // Stories filters
            // Stories filters
            const storiesStatusFilter = document.getElementById('stories-status-filter');
            const storiesCategoryFilter = document.getElementById('stories-category-filter');
            const storiesSortFilter = document.getElementById('stories-sort-filter');
            const storiesSearchInput = document.getElementById('stories-search-input');
            const storiesSearchBtn = document.getElementById('stories-search-btn');
            
            if (storiesStatusFilter) storiesStatusFilter.addEventListener('change', filterStories);
            if (storiesCategoryFilter) storiesCategoryFilter.addEventListener('change', filterStories);
            if (storiesSortFilter) storiesSortFilter.addEventListener('change', filterStories);
            if (storiesSearchInput) storiesSearchInput.addEventListener('input', filterStories);
            if (storiesSearchBtn) storiesSearchBtn.addEventListener('click', filterStories);
            
            // Books filters
            const booksStatusFilter = document.getElementById('books-status-filter');
            const booksCategoryFilter = document.getElementById('books-category-filter');
            const booksSortFilter = document.getElementById('books-sort-filter');
            const booksSearchInput = document.getElementById('books-search-input');
            const booksSearchBtn = document.getElementById('books-search-btn');
            
            if (booksStatusFilter) booksStatusFilter.addEventListener('change', filterBooks);
            if (booksCategoryFilter) booksCategoryFilter.addEventListener('change', filterBooks);
            if (booksSortFilter) booksSortFilter.addEventListener('change', filterBooks);
            if (booksSearchInput) booksSearchInput.addEventListener('input', filterBooks);
            if (booksSearchBtn) booksSearchBtn.addEventListener('click', filterBooks);
        });

        // Function to edit story chapter from view modal
        function editChapterFromView(storyId, chapterId) {
            // Close view modal completely
            const viewModal = document.getElementById('viewStoryModal');
            if (viewModal) {
                // Remove modal classes and backdrop
                viewModal.classList.remove('show');
                viewModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // Remove backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
                
                console.log('View story modal closed manually for chapter edit');
            }
            
            // Wait for modal to close completely before opening edit chapter modal
            setTimeout(() => {
                editChapter(storyId, chapterId);
            }, 500);
        }

        // Analytics Functions
        let analyticsCharts = {};

        // Load analytics data
        async function loadAnalyticsData(userId, period = 30) {
            try {
                console.log('Loading analytics data for user:', userId, 'period:', period);
                
                // Get user stories and books for analytics
                const [storiesSnapshot, booksSnapshot] = await Promise.all([
                    database.ref(`users/${userId}/stories`).once('value'),
                    database.ref(`users/${userId}/books`).once('value')
                ]);
                
                const stories = storiesSnapshot.val() || {};
                const books = booksSnapshot.val() || {};
                
                // Generate analytics data
                const analyticsData = generateAnalyticsData(stories, books, period);
                
                // Update analytics UI
                updateAnalyticsUI(analyticsData);
                
                // Initialize charts
                initializeAnalyticsCharts(analyticsData);
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showNotification('Lỗi khi tải dữ liệu phân tích: ' + error.message, 'error');
            }
        }

        // Generate analytics data from stories and books
        function generateAnalyticsData(stories, books, period) {
            const now = new Date();
            const startDate = new Date(now.getTime() - (period * 24 * 60 * 60 * 1000));
            
            const allContent = [
                ...Object.entries(stories).map(([id, story]) => ({id, type: 'story', ...story})),
                ...Object.entries(books).map(([id, book]) => ({id, type: 'book', ...book}))
            ];
            
            // Calculate total metrics
            const totalViews = allContent.reduce((sum, item) => sum + (item.totalViews || 0), 0);
            const totalLikes = allContent.reduce((sum, item) => sum + (item.totalLikes || 0), 0);
            const uniqueReaders = Math.floor(totalViews * 0.7); // Estimate unique readers
            const engagementRate = totalViews > 0 ? Math.round((totalLikes / totalViews) * 100) : 0;
            
            // Generate daily views data for chart
            const dailyViews = [];
            const labels = [];
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                labels.push(date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' }));
                // Simulate daily views with some randomness
                const baseViews = Math.floor(totalViews / period);
                const randomVariation = Math.floor(Math.random() * baseViews * 0.5);
                dailyViews.push(Math.max(0, baseViews + randomVariation - (baseViews * 0.25)));
            }
            
            // Category performance
            const categoryStats = {};
            allContent.forEach(item => {
                if (item.category) {
                    if (!categoryStats[item.category]) {
                        categoryStats[item.category] = { views: 0, likes: 0, count: 0 };
                    }
                    categoryStats[item.category].views += item.totalViews || 0;
                    categoryStats[item.category].likes += item.totalLikes || 0;
                    categoryStats[item.category].count += 1;
                }
            });
            
            // Top performing content
            const topContent = allContent
                .sort((a, b) => (b.totalViews || 0) - (a.totalViews || 0))
                .slice(0, 5);
            
            // Generate revenue data (mock)
            const revenue = Math.floor(totalViews * 0.1); // 0.1₫ per view
            const monthlyRevenue = Math.floor(revenue * 0.3);
            const availableBalance = Math.floor(revenue * 0.8);
            const pendingPayout = Math.floor(revenue * 0.2);
            
            // Generate recent activities
            const recentActivities = generateRecentActivities(allContent, 10);
            
            return {
                overview: {
                    totalViews,
                    uniqueReaders,
                    engagementRate,
                    revenue
                },
                charts: {
                    dailyViews: { labels, data: dailyViews },
                    categoryStats,
                    readerDemographics: generateReaderDemographics()
                },
                topContent,
                recentActivities,
                earnings: {
                    total: revenue,
                    monthly: monthlyRevenue,
                    available: availableBalance,
                    pending: pendingPayout
                }
            };
        }

        // Generate reader demographics data
        function generateReaderDemographics() {
            return {
                ageGroups: [
                    { label: '18-25', value: 35 },
                    { label: '26-35', value: 40 },
                    { label: '36-45', value: 20 },
                    { label: '46+', value: 5 }
                ],
                devices: [
                    { label: 'Mobile', value: 65 },
                    { label: 'Desktop', value: 25 },
                    { label: 'Tablet', value: 10 }
                ]
            };
        }

        // Generate recent activities
        function generateRecentActivities(content, limit) {
            const activities = [];
            const activityTypes = [
                { type: 'view', icon: 'eye', color: 'primary', text: 'đã xem' },
                { type: 'like', icon: 'heart', color: 'danger', text: 'đã thích' },
                { type: 'comment', icon: 'comment', color: 'info', text: 'đã bình luận' },
                { type: 'share', icon: 'share', color: 'success', text: 'đã chia sẻ' }
            ];
            
            content.forEach(item => {
                const numActivities = Math.min(3, Math.floor(Math.random() * 4) + 1);
                for (let i = 0; i < numActivities; i++) {
                    const activity = activityTypes[Math.floor(Math.random() * activityTypes.length)];
                    const timeAgo = Math.floor(Math.random() * 24) + 1;
                    activities.push({
                        content: item.title,
                        type: activity.type,
                        icon: activity.icon,
                        color: activity.color,
                        text: activity.text,
                        timeAgo: `${timeAgo} giờ trước`
                    });
                }
            });
            
            return activities.slice(0, limit);
        }

        // Update analytics UI
        function updateAnalyticsUI(data) {
            // Update overview stats
            document.getElementById('analytics-total-views').textContent = formatNumber(data.overview.totalViews);
            document.getElementById('analytics-unique-readers').textContent = formatNumber(data.overview.uniqueReaders);
            document.getElementById('analytics-engagement').textContent = data.overview.engagementRate + '%';
            document.getElementById('analytics-revenue').textContent = formatCurrency(data.overview.revenue);
            
            // Update earnings
            document.getElementById('total-earnings').textContent = formatCurrency(data.earnings.total);
            document.getElementById('available-balance').textContent = formatCurrency(data.earnings.available);
            document.getElementById('monthly-revenue').textContent = formatCurrency(data.earnings.monthly);
            document.getElementById('pending-payout').textContent = formatCurrency(data.earnings.pending);
            
            // Update top content list
            updateTopContentList(data.topContent);
            
            // Update recent activities
            updateRecentActivities(data.recentActivities);
            
            // Update content performance table
            updateContentPerformanceTable(data.topContent);
            
            // Update insights
            updateAnalyticsInsights(data);
        }

        // Initialize analytics charts
        function initializeAnalyticsCharts(data) {
            // Destroy existing charts
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            analyticsCharts = {};
            
            // Views Chart
            const viewsCtx = document.getElementById('viewsChart');
            if (viewsCtx) {
                analyticsCharts.views = new Chart(viewsCtx, {
                    type: 'line',
                    data: {
                        labels: data.charts.dailyViews.labels,
                        datasets: [{
                            label: 'Lượt xem',
                            data: data.charts.dailyViews.data,
                            borderColor: 'rgb(99, 102, 241)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                const categoryLabels = Object.keys(data.charts.categoryStats).map(cat => getCategoryText(cat));
                const categoryData = Object.values(data.charts.categoryStats).map(stat => stat.views);
                
                analyticsCharts.category = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(6, 182, 212, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Reader Demographics Chart
            const readerCtx = document.getElementById('readerChart');
            if (readerCtx) {
                analyticsCharts.reader = new Chart(readerCtx, {
                    type: 'bar',
                    data: {
                        labels: data.charts.readerDemographics.ageGroups.map(group => group.label),
                        datasets: [{
                            label: 'Độc giả (%)',
                            data: data.charts.readerDemographics.ageGroups.map(group => group.value),
                            backgroundColor: 'rgba(99, 102, 241, 0.6)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 50 }
                        }
                    }
                });
            }
            
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const revenueLabels = data.charts.dailyViews.labels;
                const revenueData = data.charts.dailyViews.data.map(views => views * 0.1);
                
                analyticsCharts.revenue = new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            label: 'Doanh thu (₫)',
                            data: revenueData,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Engagement Chart
            const engagementCtx = document.getElementById('engagementChart');
            if (engagementCtx) {
                analyticsCharts.engagement = new Chart(engagementCtx, {
                    type: 'line',
                    data: {
                        labels: data.charts.dailyViews.labels,
                        datasets: [
                            {
                                label: 'Lượt xem',
                                data: data.charts.dailyViews.data,
                                borderColor: 'rgb(99, 102, 241)',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Lượt thích',
                                data: data.charts.dailyViews.data.map(views => Math.floor(views * 0.1)),
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
        }

        // Update top content list
        function updateTopContentList(topContent) {
            const container = document.getElementById('top-content-list');
            if (!container) return;
            
            if (topContent.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <p>Chưa có dữ liệu</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = topContent.map((item, index) => `
                <div class="d-flex align-items-center mb-3 p-2 rounded ${index < 3 ? 'bg-light' : ''}">
                    <div class="me-3">
                        <span class="badge bg-${index === 0 ? 'warning' : index === 1 ? 'secondary' : index === 2 ? 'info' : 'light'} rounded-circle" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                            ${index + 1}
                        </span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-bold" style="font-size: 0.875rem;">${item.title}</h6>
                        <small class="text-muted">${item.type === 'story' ? 'Truyện' : 'Sách'} • ${formatNumber(item.totalViews || 0)} lượt xem</small>
                    </div>
                    <div class="text-end">
                        <small class="text-success fw-bold">+${Math.floor(Math.random() * 20) + 5}%</small>
                    </div>
                </div>
            `).join('');
        }

        // Update recent activities
        function updateRecentActivities(activities) {
            const container = document.getElementById('recent-activity-list');
            if (!container) return;
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p>Chưa có hoạt động</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="d-flex align-items-center mb-3 p-2 rounded hover-bg">
                    <div class="me-3">
                        <i class="fas fa-${activity.icon} text-${activity.color}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-1" style="font-size: 0.875rem;">
                            Độc giả <strong>${activity.text}</strong> "${activity.content}"
                        </p>
                        <small class="text-muted">${activity.timeAgo}</small>
                    </div>
                </div>
            `).join('');
        }

        // Update content performance table
        function updateContentPerformanceTable(content) {
            const tbody = document.getElementById('content-performance-table');
            if (!tbody) return;
            
            if (content.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p>Chưa có dữ liệu hiệu suất</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = content.map(item => {
                const growth = Math.floor(Math.random() * 30) + 5;
                const isPositive = Math.random() > 0.3;
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${item.coverImage || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=50&h=50&fit=crop'}" 
                                     class="story-cover me-2" alt="Cover">
                                <div>
                                    <div class="fw-semibold">${item.title}</div>
                                    <small class="text-muted">${item.authorName || 'Tác giả'}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-primary bg-opacity-10 text-primary">${item.type === 'story' ? 'Truyện' : 'Sách'}</span></td>
                        <td>${formatNumber(item.totalViews || 0)}</td>
                        <td>${formatNumber(item.totalLikes || 0)}</td>
                        <td>${Math.floor(Math.random() * 50)}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2">${item.rating ? item.rating.toFixed(1) : '0.0'}</span>
                                <div class="text-warning">
                                    ${'★'.repeat(Math.floor(item.rating || 0))}${'☆'.repeat(5 - Math.floor(item.rating || 0))}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="stat-change ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : '-'}${growth}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update analytics insights
        function updateAnalyticsInsights(data) {
            const avgReadingTime = Math.floor(Math.random() * 15) + 5;
            const completionRate = Math.floor(Math.random() * 40) + 60;
            
            document.getElementById('avg-reading-time').textContent = avgReadingTime + ' phút';
            document.getElementById('completion-rate').textContent = completionRate + '%';
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Export analytics function
        function exportAnalytics() {
            showNotification('Đang chuẩn bị báo cáo...', 'info');
            
            // Simulate export process
            setTimeout(() => {
                showNotification('Báo cáo đã được xuất thành công!', 'success');
            }, 2000);
        }

        // Request payout function
        function requestPayout() {
            const availableBalance = document.getElementById('available-balance').textContent;
            
            if (confirm(`Bạn có muốn yêu cầu rút ${availableBalance} không?`)) {
                showNotification('Yêu cầu rút tiền đã được gửi!', 'success');
                
                // Update pending payout
                document.getElementById('pending-payout').textContent = availableBalance;
                document.getElementById('available-balance').textContent = '0₫';
            }
        }

        // Load analytics when section is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Analytics period change handler
            const analyticsPeriod = document.getElementById('analytics-period');
            if (analyticsPeriod) {
                analyticsPeriod.addEventListener('change', function() {
                    const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                    loadAnalyticsData(userId, parseInt(this.value));
                });
            }
            
            // Load analytics data when switching to analytics section
            const analyticsNavLink = document.querySelector('[data-section="analytics"]');
            if (analyticsNavLink) {
                analyticsNavLink.addEventListener('click', function() {
                    setTimeout(() => {
                        const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                        loadAnalyticsData(userId, 30);
                    }, 300);
                });
            }

            // Load earnings data when switching to earnings section
            const earningsNavLink = document.querySelector('[data-section="earnings"]');
            if (earningsNavLink) {
                earningsNavLink.addEventListener('click', function() {
                    setTimeout(() => {
                        const userId = currentUser ? currentUser.uid : 'Tt50hFcTNLNZB1tggdFzKWCFcvB3';
                        loadEarningsData(userId);
                    }, 300);
                });
            }

            // Initialize earnings components
            initializeEarningsComponents();
        });

        // Earnings Functions
        let earningsCharts = {};

        // Load earnings data
        async function loadEarningsData(userId) {
            try {
                console.log('Loading earnings data for user:', userId);
                
                // Get user stories and books for earnings calculation
                const [storiesSnapshot, booksSnapshot] = await Promise.all([
                    database.ref(`users/${userId}/stories`).once('value'),
                    database.ref(`users/${userId}/books`).once('value')
                ]);
                
                const stories = storiesSnapshot.val() || {};
                const books = booksSnapshot.val() || {};
                
                // Generate earnings data
                const earningsData = generateEarningsData(stories, books);
                
                // Update earnings UI
                updateEarningsUI(earningsData);
                
                // Initialize earnings charts
                initializeEarningsCharts(earningsData);
                
                // Load transaction history
                loadTransactionHistory(userId);
                
                // Load payout history
                loadPayoutHistory(userId);
                
            } catch (error) {
                console.error('Error loading earnings data:', error);
                showNotification('Lỗi khi tải dữ liệu thu nhập: ' + error.message, 'error');
            }
        }

        // Generate earnings data
        function generateEarningsData(stories, books) {
            const allContent = [
                ...Object.entries(stories).map(([id, story]) => ({id, type: 'story', ...story})),
                ...Object.entries(books).map(([id, book]) => ({id, type: 'book', ...book}))
            ];
            
            // Calculate earnings by content type
            const earningsByType = {
                'series': 0,      // Truyện dài
                'oneshot': 0,     // Truyện ngắn
                'novel': 0,       // Tiểu thuyết
                'other': 0        // Khác
            };
            
            allContent.forEach(item => {
                const views = item.totalViews || 0;
                const earnings = Math.floor(views * 0.1); // 0.1₫ per view
                
                if (item.type === 'story') {
                    if (item.storyType === 'series') earningsByType.series += earnings;
                    else if (item.storyType === 'oneshot') earningsByType.oneshot += earnings;
                    else earningsByType.other += earnings;
                } else if (item.type === 'book') {
                    if (item.bookType === 'novel') earningsByType.novel += earnings;
                    else earningsByType.other += earnings;
                }
            });
            
            const totalEarnings = Object.values(earningsByType).reduce((sum, val) => sum + val, 0);
            const monthlyRevenue = Math.floor(totalEarnings * 0.3);
            const availableBalance = Math.floor(totalEarnings * 0.8);
            const pendingPayout = Math.floor(totalEarnings * 0.2);
            
            // Calculate tax information
            const taxableIncome = totalEarnings;
            const taxAmount = Math.floor(taxableIncome * 0.1); // 10% tax
            const netIncome = taxableIncome - taxAmount;
            
            // Generate forecast data
            const forecastAmount = Math.floor(monthlyRevenue * 1.15); // 15% growth
            
            return {
                overview: {
                    total: totalEarnings,
                    monthly: monthlyRevenue,
                    available: availableBalance,
                    pending: pendingPayout
                },
                breakdown: earningsByType,
                tax: {
                    taxable: taxableIncome,
                    amount: taxAmount,
                    net: netIncome
                },
                forecast: forecastAmount
            };
        }

        // Update earnings UI
        function updateEarningsUI(data) {
            // Update overview stats
            document.getElementById('total-earnings').textContent = formatCurrency(data.overview.total);
            document.getElementById('available-balance').textContent = formatCurrency(data.overview.available);
            document.getElementById('monthly-revenue').textContent = formatCurrency(data.overview.monthly);
            document.getElementById('pending-payout').textContent = formatCurrency(data.overview.pending);
            
            // Update tax information
            document.getElementById('taxable-income').textContent = formatCurrency(data.tax.taxable);
            document.getElementById('tax-amount').textContent = formatCurrency(data.tax.amount);
            document.getElementById('net-income').textContent = formatCurrency(data.tax.net);
            document.getElementById('total-net-income').textContent = formatCurrency(data.tax.net);
            
            // Update forecast
            document.getElementById('forecast-amount').textContent = formatCurrency(data.forecast);
        }

        // Initialize earnings charts
        function initializeEarningsCharts(data) {
            // Destroy existing charts
            Object.values(earningsCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            earningsCharts = {};
            
            // Revenue Breakdown Chart
            const breakdownCtx = document.getElementById('revenueBreakdownChart');
            if (breakdownCtx) {
                const labels = ['Truyện dài', 'Truyện ngắn', 'Tiểu thuyết', 'Khác'];
                const values = [
                    data.breakdown.series,
                    data.breakdown.oneshot,
                    data.breakdown.novel,
                    data.breakdown.other
                ];
                
                earningsCharts.breakdown = new Chart(breakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(6, 182, 212, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Forecast Chart
            const forecastCtx = document.getElementById('forecastChart');
            if (forecastCtx) {
                const months = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
                const actualData = [data.overview.monthly * 0.8, data.overview.monthly * 0.9, data.overview.monthly];
                const forecastData = [data.overview.monthly, data.overview.monthly * 1.05, data.forecast];
                
                earningsCharts.forecast = new Chart(forecastCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Thực tế',
                                data: actualData,
                                borderColor: 'rgb(99, 102, 241)',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                borderWidth: 3,
                                fill: false
                            },
                            {
                                label: 'Dự báo',
                                data: forecastData,
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 3,
                                borderDash: [5, 5],
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        // Load transaction history
        async function loadTransactionHistory(userId) {
            try {
                // Generate mock transaction data
                const transactions = generateMockTransactions(userId);
                
                // Update transaction table
                updateTransactionTable(transactions);
                
            } catch (error) {
                console.error('Error loading transaction history:', error);
            }
        }

        // Generate mock transaction data
        function generateMockTransactions(userId) {
            const transactionTypes = [
                { type: 'view_revenue', name: 'Thu nhập từ lượt xem', icon: 'eye' },
                { type: 'subscription', name: 'Thuê bao Premium', icon: 'crown' },
                { type: 'donation', name: 'Ủng hộ từ độc giả', icon: 'heart' },
                { type: 'ad_revenue', name: 'Quảng cáo', icon: 'ad' }
            ];
            
            const paymentMethods = ['Thẻ ngân hàng', 'Chuyển khoản', 'Ví điện tử'];
            const statuses = ['completed', 'pending', 'failed'];
            
            const transactions = [];
            const now = new Date();
            
            for (let i = 0; i < 20; i++) {
                const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                const type = transactionTypes[Math.floor(Math.random() * transactionTypes.length)];
                const amount = Math.floor(Math.random() * 50000) + 1000;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const method = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                
                transactions.push({
                    id: `TXN_${Date.now()}_${i}`,
                    date: date,
                    content: `Truyện ${i + 1}`,
                    type: type,
                    amount: amount,
                    method: method,
                    status: status
                });
            }
            
            return transactions.sort((a, b) => b.date - a.date);
        }

        // Update transaction table
        function updateTransactionTable(transactions) {
            const tbody = document.getElementById('transaction-history-table');
            if (!tbody) return;
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>Chưa có giao dịch nào</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = transactions.map(txn => `
                <tr>
                    <td><code class="small">${txn.id}</code></td>
                    <td>${txn.date.toLocaleDateString('vi-VN')}</td>
                    <td>${txn.content}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${txn.type.icon} me-2 text-primary"></i>
                            <span>${txn.type.name}</span>
                        </div>
                    </td>
                    <td class="fw-bold">${formatCurrency(txn.amount)}</td>
                    <td>${txn.method}</td>
                    <td>
                        <span class="status-badge status-${txn.status}">
                            ${getTransactionStatusText(txn.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTransactionDetails('${txn.id}')">
                            <i class="fas fa-eye"></i>
                        </td>
                </tr>
            `).join('');
        }

        // Load payout history
        async function loadPayoutHistory(userId) {
            try {
                // Generate mock payout data
                const payouts = generateMockPayouts(userId);
                
                // Update payout table
                updatePayoutTable(payouts);
                
            } catch (error) {
                console.error('Error loading payout history:', error);
            }
        }

        // Generate mock payout data
        function generateMockPayouts(userId) {
            const payouts = [];
            const now = new Date();
            
            for (let i = 0; i < 10; i++) {
                const requestDate = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
                const amount = Math.floor(Math.random() * 200000) + 50000;
                const status = i < 3 ? 'completed' : i < 6 ? 'pending' : 'processing';
                const completedDate = status === 'completed' ? new Date(requestDate.getTime() + (3 * 24 * 60 * 60 * 1000)) : null;
                
                payouts.push({
                    id: `PAY_${Date.now()}_${i}`,
                    requestDate: requestDate,
                    amount: amount,
                    method: 'Chuyển khoản ngân hàng',
                    status: status,
                    completedDate: completedDate
                });
            }
            
            return payouts.sort((a, b) => b.requestDate - a.requestDate);
        }

        // Update payout table
        function updatePayoutTable(payouts) {
            const tbody = document.getElementById('payout-history-table');
            if (!tbody) return;
            
            if (payouts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                            <p>Chưa có lịch sử rút tiền</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = payouts.map(payout => `
                <tr>
                    <td><code class="small">${payout.id}</code></td>
                    <td>${payout.requestDate.toLocaleDateString('vi-VN')}</td>
                    <td class="fw-bold">${formatCurrency(payout.amount)}</td>
                    <td>${payout.method}</td>
                    <td>
                        <span class="status-badge status-${payout.status}">
                            ${getPayoutStatusText(payout.status)}
                        </span>
                    </td>
                    <td>${payout.completedDate ? payout.completedDate.toLocaleDateString('vi-VN') : '-'}</td>
                </tr>
            `).join('');
        }

        // Initialize earnings components
        function initializeEarningsComponents() {
            // Transaction filter handler
            const transactionFilter = document.getElementById('transaction-filter');
            if (transactionFilter) {
                transactionFilter.addEventListener('change', function() {
                    filterTransactions(this.value);
                });
            }
        }

        // Filter transactions
        function filterTransactions(status) {
            const rows = document.querySelectorAll('#transaction-history-table tr');
            
            rows.forEach(row => {
                if (status === '') {
                    row.style.display = '';
                } else {
                    const statusCell = row.querySelector('.status-badge');
                    if (statusCell && statusCell.classList.contains(`status-${status}`)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Helper functions
        function getTransactionStatusText(status) {
            const statusTexts = {
                'completed': 'Hoàn thành',
                'pending': 'Đang xử lý',
                'failed': 'Thất bại'
            };
            return statusTexts[status] || status;
        }

        function getPayoutStatusText(status) {
            const statusTexts = {
                'completed': 'Hoàn thành',
                'pending': 'Chờ xử lý',
                'processing': 'Đang xử lý'
            };
            return statusTexts[status] || status;
        }

        // Payment method functions
        function addPaymentMethod() {
            showNotification('Chức năng thêm phương thức thanh toán sẽ được cập nhật sớm!', 'info');
        }

        // Export functions
        function exportTransactions() {
            showNotification('Đang xuất dữ liệu giao dịch...', 'info');
            setTimeout(() => {
                showNotification('Đã xuất dữ liệu giao dịch thành công!', 'success');
            }, 2000);
        }

        function downloadTaxReport() {
            showNotification('Đang tạo báo cáo thuế...', 'info');
            setTimeout(() => {
                showNotification('Báo cáo thuế đã được tải xuống!', 'success');
            }, 2000);
        }

        // Payment settings functions
        function savePaymentSettings() {
            const minPayout = document.getElementById('min-payout').value;
            const autoPayout = document.getElementById('auto-payout').checked;
            const frequency = document.getElementById('payout-frequency').value;
            
            // Save to Firebase or local storage
            localStorage.setItem('paymentSettings', JSON.stringify({
                minPayout: parseInt(minPayout),
                autoPayout: autoPayout,
                frequency: frequency
            }));
            
            showNotification('Cài đặt thanh toán đã được lưu!', 'success');
        }

        // View transaction details
        function viewTransactionDetails(transactionId) {
            showNotification(`Xem chi tiết giao dịch: ${transactionId}`, 'info');
            // Implement transaction details modal here
        }
    </script>

</body>
</html>
