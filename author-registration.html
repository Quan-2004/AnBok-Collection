<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký tác giả - AnBok Collection</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --primary-color: #4A6366;
            --secondary-color: #F4A261;
            --accent-color: #E76F51;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --bg-light: #F8F9FA;
            --border-color: #E9ECEF;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .author-registration-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .registration-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .registration-header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .registration-header p {
            color: var(--text-light);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .registration-form {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .form-section {
            margin-bottom: 35px;
        }
        
        .form-section h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-group .required {
            color: #e74c3c;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 99, 102, 0.1);
        }
        
        .form-control.textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .file-upload {
            position: relative;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: var(--bg-light);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
        }
        
        .file-label i {
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 8px;
            font-size: 12px;
            color: #28a745;
            display: none;
        }
        
        .checkbox-group {
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background 0.3s ease;
            margin-bottom: 10px;
        }
        
        .checkbox-item:hover {
            background: var(--bg-light);
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 99, 102, 0.3);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            color: white;
        }
        
        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }
        
        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }
        
        .info-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .info-card h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-card li {
            margin-bottom: 8px;
            color: var(--text-dark);
            line-height: 1.5;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            color: var(--secondary-color);
            transform: translateX(-5px);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .registration-form {
                padding: 25px;
            }
            
            .registration-header h1 {
                font-size: 2rem;
            }
        }
        
        /* Loading Animation */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="author-registration-container">
        <a href="profile.html" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay lại trang cá nhân
        </a>
        
        <div class="registration-header">
            <h1><i class="fas fa-pencil-alt"></i> Đăng ký tác giả</h1>
            <p>Hoàn thành form đăng ký để trở thành tác giả và chia sẻ tác phẩm của bạn với cộng đồng</p>
        </div>
        
        <form class="registration-form" id="authorRegistrationForm">
            <div class="form-section">
                <h3>Thông tin cá nhân</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bút danh <span class="required">*</span></label>
                        <input type="text" class="form-control" name="penName" placeholder="Nhập bút danh của bạn" required>
                    </div>
                    <div class="form-group">
                        <label>Chuyên môn chính</label>
                        <input type="text" class="form-control" name="specialization" placeholder="Ví dụ: Tiểu thuyết, Thơ ca, Truyện thiếu nhi...">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Tiểu sử tác giả</label>
                    <textarea class="form-control textarea" name="bio" rows="4" placeholder="Giới thiệu về bản thân, kinh nghiệm viết lách, thành tựu..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Thông tin liên hệ</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email liên hệ <span class="required">*</span></label>
                        <input type="email" class="form-control" name="contactEmail" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Số điện thoại</label>
                        <input type="tel" class="form-control" name="contactPhone" placeholder="0123456789">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Website cá nhân</label>
                    <input type="url" class="form-control" name="website" placeholder="https://example.com">
                </div>
            </div>
            
            <div class="form-section">
                <h3>Tác phẩm mẫu</h3>
                <div class="form-group">
                    <label>Mô tả tác phẩm đầu tay</label>
                    <textarea class="form-control textarea" name="sampleWork" rows="5" placeholder="Mô tả ngắn gọn về tác phẩm bạn muốn xuất bản (tên sách, thể loại, nội dung chính, số từ dự kiến...)"></textarea>
                </div>
                
                <div class="form-group">
                    <label>File mẫu (PDF, DOC, DOCX)</label>
                    <div class="file-upload">
                        <input type="file" name="sampleFile" accept=".pdf,.doc,.docx" id="sampleFile">
                        <label for="sampleFile" class="file-label">
                            <i class="fas fa-upload"></i>
                            <span>Chọn file</span>
                        </label>
                        <div class="file-info" id="fileInfo"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Điều khoản và cam kết</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" name="agreeTerms" required>
                        <span>Tôi đồng ý với <a href="#" class="link">Điều khoản sử dụng</a> và <a href="#" class="link">Chính sách bảo mật</a></span>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" name="agreeOriginal" required>
                        <span>Tôi cam kết tác phẩm là sáng tác gốc, không vi phạm bản quyền</span>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" name="agreePublish" required>
                        <span>Tôi đồng ý cho phép xuất bản tác phẩm trên nền tảng</span>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Lưu nháp
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetToUserData()">
                    <i class="fas fa-user"></i>
                    Lấy thông tin tài khoản
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Gửi đăng ký
                </button>
            </div>
        </form>
        
        <div class="info-card">
            <h4><i class="fas fa-info-circle"></i> Lưu ý quan trọng</h4>
            <ul>
                <li>Đơn đăng ký sẽ được xem xét trong vòng 3-5 ngày làm việc</li>
                <li>Chúng tôi sẽ liên hệ qua email để thông báo kết quả</li>
                <li>Tác giả được chấp nhận sẽ có quyền đăng tác phẩm lên nền tảng</li>
                <li>Hỗ trợ xuất bản và marketing cho tác phẩm chất lượng</li>
            </ul>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYLKQprHcGWDUo4TNOvDzTqTbqUFG4FkA",
            authDomain: "anbok-collection.firebaseapp.com",
            databaseURL: "https://anbok-collection-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anbok-collection",
            storageBucket: "anbok-collection.firebasestorage.app",
            messagingSenderId: "835844957818",
            appId: "1:835844957818:web:33fc3d03875d49fc5c3dc3",
            measurementId: "G-MS5FT355WW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebaseDatabase = database;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User is signed in:', user.uid);
                window.currentUser = user;
                
                // Load user profile data from Firebase
                try {
                    const userProfileRef = ref(database, `users/${user.uid}/profile`);
                    const { get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
                    const profileSnapshot = await get(userProfileRef);
                    
                    if (profileSnapshot.exists()) {
                        const userProfile = profileSnapshot.val();
                        window.userProfile = userProfile;
                        
                        // Auto-fill form with user data
                        autoFillFormWithUserData(userProfile);
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            } else {
                console.log('User is signed out');
                // Redirect to login if not authenticated
                Swal.fire({
                    icon: 'warning',
                    title: 'Cần đăng nhập',
                    text: 'Vui lòng đăng nhập để đăng ký tác giả',
                    confirmButtonText: 'Đăng nhập'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'auth.html';
                    }
                });
            }
        });
    </script>
    
    <script>
        // File upload handling
        document.getElementById('sampleFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileInfo = document.getElementById('fileInfo');
            
            if (file) {
                // Validate file type
                const allowedTypes = ['.pdf', '.doc', '.docx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Chỉ chấp nhận file PDF, DOC, DOCX'
                    });
                    this.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }
                
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'File quá lớn. Vui lòng chọn file nhỏ hơn 10MB'
                    });
                    this.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }
                
                // Show file info
                fileInfo.style.display = 'block';
                fileInfo.textContent = `Đã chọn: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            } else {
                fileInfo.style.display = 'none';
            }
        });
        
        // Save draft function
        async function saveDraft() {
            try {
                const formData = collectFormData();
                
                // Save to localStorage
                localStorage.setItem('authorRegistrationDraft', JSON.stringify(formData));
                
                // Save to Firebase if user is authenticated
                if (window.currentUser) {
                    const draftData = {
                        ...formData,
                        userId: window.currentUser.uid,
                        savedAt: new Date().toISOString()
                    };
                    
                    const userDraftRef = window.firebaseRef(
                        window.firebaseDatabase, 
                        `users/${window.currentUser.uid}/authorRegistrationDraft`
                    );
                    
                    await window.firebaseSet(userDraftRef, draftData);
                }
                
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: 'Đã lưu nháp thành công!'
                });
                
            } catch (error) {
                console.error('Error saving draft:', error);
                
                // Check if it's a permission error
                if (error.message && error.message.includes('PERMISSION_DENIED')) {
                    console.warn('Permission denied for draft, using localStorage only');
                    // Still save to localStorage even if Firebase fails
                    Swal.fire({
                        icon: 'warning',
                        title: 'Lưu nháp cục bộ',
                        text: 'Đã lưu nháp vào trình duyệt. Dữ liệu sẽ không đồng bộ với tài khoản.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra khi lưu nháp. Vui lòng thử lại!'
                    });
                }
            }
        }
        
        // Collect form data
        function collectFormData() {
            const form = document.getElementById('authorRegistrationForm');
            const formData = {
                penName: form.querySelector('[name="penName"]').value,
                specialization: form.querySelector('[name="specialization"]').value,
                bio: form.querySelector('[name="bio"]').value,
                contactEmail: form.querySelector('[name="contactEmail"]').value,
                contactPhone: form.querySelector('[name="contactPhone"]').value,
                website: form.querySelector('[name="website"]').value,
                sampleWork: form.querySelector('[name="sampleWork"]').value,
                agreeTerms: form.querySelector('[name="agreeTerms"]').checked,
                agreeOriginal: form.querySelector('[name="agreeOriginal"]').checked,
                agreePublish: form.querySelector('[name="agreePublish"]').checked
            };
            
            return formData;
        }
        
        // Validate form
        function validateForm() {
            const form = document.getElementById('authorRegistrationForm');
            const requiredFields = ['penName', 'contactEmail'];
            const requiredCheckboxes = ['agreeTerms', 'agreeOriginal', 'agreePublish'];
            
            // Check required fields
            for (const fieldName of requiredFields) {
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (!field.value.trim()) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: `Vui lòng điền ${field.previousElementSibling.textContent.replace('*', '').trim()}`
                    });
                    field.focus();
                    return false;
                }
            }
            
            // Check required checkboxes
            for (const checkboxName of requiredCheckboxes) {
                const checkbox = form.querySelector(`[name="${checkboxName}"]`);
                if (!checkbox.checked) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Vui lòng đồng ý với tất cả điều khoản'
                    });
                    checkbox.focus();
                    return false;
                }
            }
            
            // Validate email
            const email = form.querySelector('[name="contactEmail"]').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Email không hợp lệ'
                });
                form.querySelector('[name="contactEmail"]').focus();
                return false;
            }
            
            return true;
        }
        
        // Form submission
        document.getElementById('authorRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            // Check if user is authenticated
            if (!window.currentUser) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Vui lòng đăng nhập để đăng ký tác giả'
                });
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';
            submitBtn.disabled = true;
            this.classList.add('loading');
            
            try {
                const formData = collectFormData();
                
                // Create author registration data
                const authorRegistrationData = {
                    ...formData,
                    userId: window.currentUser.uid,
                    userEmail: window.currentUser.email,
                    submittedAt: new Date().toISOString(),
                    status: 'pending',
                    reviewed: false,
                    reviewedAt: null,
                    reviewedBy: null,
                    notes: ''
                };
                
                // Save to Firebase
                const authorRegistrationsRef = window.firebaseRef(window.firebaseDatabase, 'authorRegistrations');
                const newRegistrationRef = window.firebasePush(authorRegistrationsRef);
                
                await window.firebaseSet(newRegistrationRef, authorRegistrationData);
                
                // Also save to user's profile
                const userAuthorRegistrationRef = window.firebaseRef(
                    window.firebaseDatabase, 
                    `users/${window.currentUser.uid}/authorRegistration`
                );
                
                await window.firebaseSet(userAuthorRegistrationRef, {
                    ...authorRegistrationData,
                    registrationId: newRegistrationRef.key
                });
                
                // Save to localStorage for backup
                localStorage.setItem('authorRegistration', JSON.stringify(authorRegistrationData));
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: 'Đăng ký tác giả đã được gửi thành công! Chúng tôi sẽ liên hệ sớm nhất.',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redirect back to profile
                        window.location.href = 'profile.html';
                    }
                });
                
                // Reset form
                this.reset();
                document.getElementById('fileInfo').style.display = 'none';
                
                // Clear draft
                localStorage.removeItem('authorRegistrationDraft');
                
            } catch (error) {
                console.error('Error submitting author registration:', error);
                
                // Check if it's a permission error
                if (error.message && error.message.includes('PERMISSION_DENIED')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi quyền truy cập',
                        text: 'Không có quyền lưu dữ liệu. Vui lòng liên hệ admin hoặc thử lại sau.',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra khi gửi đăng ký. Vui lòng thử lại!'
                    });
                }
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                this.classList.remove('loading');
            }
        });
        
        // Load draft if exists
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                let draft = localStorage.getItem('authorRegistrationDraft');
                
                // If no local draft, try to load from Firebase
                if (!draft && window.currentUser) {
                    const userDraftRef = window.firebaseRef(
                        window.firebaseDatabase, 
                        `users/${window.currentUser.uid}/authorRegistrationDraft`
                    );
                    
                    const { get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
                    const draftSnapshot = await get(userDraftRef);
                    
                    if (draftSnapshot.exists()) {
                        const firebaseDraft = draftSnapshot.val();
                        // Remove Firebase-specific fields
                        const { userId, savedAt, ...formData } = firebaseDraft;
                        draft = JSON.stringify(formData);
                        localStorage.setItem('authorRegistrationDraft', draft);
                    }
                }
                
                if (draft) {
                    const formData = JSON.parse(draft);
                    loadFormData(formData);
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'Nháp đã tải',
                        text: 'Đã tải nháp đăng ký tác giả của bạn'
                    });
                }
            } catch (error) {
                console.error('Error loading author draft:', error);
            }
        });
        
        // Auto-fill form with user data
        function autoFillFormWithUserData(userProfile) {
            const form = document.getElementById('authorRegistrationForm');
            if (!form) return;
            
            // Fill contact information
            if (userProfile.email) {
                const emailField = form.querySelector('[name="contactEmail"]');
                if (emailField && !emailField.value) {
                    emailField.value = userProfile.email;
                }
            }
            
            // Fill phone number if available
            if (userProfile.personalInfo && userProfile.personalInfo.phone) {
                const phoneField = form.querySelector('[name="contactPhone"]');
                if (phoneField && !phoneField.value) {
                    phoneField.value = userProfile.personalInfo.phone;
                }
            }
            
            // Fill address if available
            if (userProfile.personalInfo && userProfile.personalInfo.address) {
                // We could add an address field if needed
                console.log('User address available:', userProfile.personalInfo.address);
            }
            
            // Fill full name as pen name suggestion
            if (userProfile.personalInfo && userProfile.personalInfo.fullName) {
                const penNameField = form.querySelector('[name="penName"]');
                if (penNameField && !penNameField.value) {
                    // Don't auto-fill pen name, but show suggestion
                    penNameField.placeholder = `Gợi ý: ${userProfile.personalInfo.fullName}`;
                }
            }
            
            // Show notification that form has been auto-filled
            if (userProfile.email) {
                Swal.fire({
                    icon: 'info',
                    title: 'Thông tin đã được điền sẵn',
                    text: 'Thông tin liên hệ đã được lấy từ tài khoản của bạn',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        }
        
        // Reset form to user data
        function resetToUserData() {
            if (!window.userProfile) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể lấy thông tin tài khoản'
                });
                return;
            }
            
            Swal.fire({
                icon: 'question',
                title: 'Xác nhận',
                text: 'Bạn có muốn lấy lại thông tin từ tài khoản? Thông tin hiện tại sẽ bị ghi đè.',
                showCancelButton: true,
                confirmButtonText: 'Có, lấy thông tin',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    autoFillFormWithUserData(window.userProfile);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Đã lấy thông tin từ tài khoản của bạn'
                    });
                }
            });
        }
        
        // Load form data with user data priority
        function loadFormData(formData) {
            const form = document.getElementById('authorRegistrationForm');
            
            Object.keys(formData).forEach(key => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = formData[key];
                    } else {
                        // Don't override user data with draft data for contact info
                        if ((key === 'contactEmail' || key === 'contactPhone') && window.userProfile) {
                            // Keep user data, don't override with draft
                            return;
                        }
                        field.value = formData[key];
                    }
                }
            });
        }
    </script>
</body>
</html> 