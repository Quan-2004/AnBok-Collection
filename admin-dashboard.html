<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard • AnBok</title>
  <link rel="icon" href="images/logo-Photoroom.png" />
  <!-- Local icon font -->
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/normalize.css" />
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getDatabase, ref, onValue, set, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDYLKQprHcGWDUo4TNOvDzTqTbqUFG4FkA",
      authDomain: "anbok-collection.firebaseapp.com",
      databaseURL: "https://anbok-collection-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "anbok-collection",
      storageBucket: "anbok-collection.firebasestorage.app",
      messagingSenderId: "835844957818",
      appId: "1:835844957818:web:33fc3d03875d49fc5c3dc3",
      measurementId: "G-MS5FT355WW"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const auth = getAuth(app);

    // Make Firebase available globally
    window.firebase = {
      app,
      analytics,
      database,
      auth,
      ref,
      onValue,
      set,
      push,
      remove,
      get,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    };

    console.log('Firebase initialized successfully');
  </script>

  <!-- Cloudinary SDK -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <script>
    // Wait for Cloudinary to load
    window.addEventListener('load', function() {
      console.log('Page loaded, checking Cloudinary...');
      if (typeof cloudinary !== 'undefined') {
        console.log('Cloudinary loaded successfully');
        console.log('Available methods:', Object.keys(cloudinary));
      } else {
        console.error('Cloudinary not loaded');
      }
    });
  </script>
  <script>
    // Cloudinary configuration
    window.cloudinary = {
      cloudName: 'dvcebine7',
      uploadPreset: 'Noi luu anh cua anbook',
      apiKey: '113583348471635'
    };

    // Initialize Cloudinary upload widget
    function initCloudinaryWidget() {
      console.log('Cloudinary SDK loaded successfully');
      console.log('cloudinary object:', cloudinary);
      
      // Check if cloudinary is available
      if (typeof cloudinary === 'undefined') {
        console.error('Cloudinary SDK not loaded');
        return;
      }
      
      console.log('Cloudinary is ready to use');
    }

    // Update image preview
    function updateImagePreview(imageUrl) {
      // Update all possible preview elements
      const previewElements = [
        document.getElementById('imagePreview'),
        document.getElementById('addBookImagePreview'),
        document.getElementById('addStoryImagePreview'),
        document.getElementById('newsImagePreview')
      ];
      
      previewElements.forEach(previewElement => {
        if (previewElement) {
          previewElement.innerHTML = `
            <img src="${imageUrl}" alt="Uploaded image" style="max-width: 100px; max-height: 60px; border-radius: 4px;">
            <p style="margin-top: 4px; font-size: 12px; color: var(--success);">✓ Ảnh đã upload thành công!</p>
          `;
        }
      });
      
      // Update all possible hidden input fields
      const coverInputs = [
        document.getElementById('bookCoverImage'),
        document.getElementById('storyCoverImage'),
        document.getElementById('addBookCoverImage'),
        document.getElementById('addStoryCoverImage'),
        document.getElementById('newsImageUrl')
      ];
      
      coverInputs.forEach(input => {
        if (input) {
          input.value = imageUrl;
        }
      });
    }

        // Open Cloudinary upload widget
    function openImageUpload() {
      console.log('Opening Cloudinary upload widget...');
      
      // Create a modal for upload
      Swal.fire({
        title: 'Upload ảnh',
        html: `
          <div style="text-align: center;">
            <p>Chọn cách upload ảnh:</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button id="uploadLocal" class="btn" style="background: var(--primary); padding: 10px 20px;">
                <i class="fa fa-upload"></i> Từ máy tính
              </button>
              <button id="uploadUrl" class="btn" style="background: var(--accent); padding: 10px 20px;">
                <i class="fa fa-link"></i> Từ URL
              </button>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: '500px'
      });
      
      // Add event listeners
      document.getElementById('uploadLocal').addEventListener('click', function() {
        Swal.close();
        uploadFromLocal();
      });
      
      document.getElementById('uploadUrl').addEventListener('click', function() {
        Swal.close();
        uploadFromUrl();
      });
    }
    
    // Upload from local file
    function uploadFromLocal() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.style.display = 'none';
      
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          // Show loading
          Swal.fire({
            title: 'Đang upload ảnh...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Upload to Cloudinary using FormData
          uploadToCloudinary(file);
        }
      };
      
      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }
    
    // Upload file to Cloudinary
    function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'Noi luu anh cua anbook');
      formData.append('cloud_name', 'dvcebine7');
      
      fetch(`https://api.cloudinary.com/v1_1/dvcebine7/image/upload`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.secure_url) {
          // Upload successful
          Swal.fire({
            title: 'Upload thành công!',
            text: 'Ảnh đã được upload lên Cloudinary',
            icon: 'success',
            timer: 2000
          });
          
          // Update image preview
          updateImagePreview(data.secure_url);
          
          console.log('Image uploaded to Cloudinary:', data);
        } else {
          // Upload failed
          Swal.fire({
            title: 'Upload thất bại',
            text: 'Không thể upload ảnh. Vui lòng thử lại.',
            icon: 'error'
          });
        }
      })
      .catch(error => {
        console.error('Upload error:', error);
        Swal.fire({
          title: 'Lỗi upload',
          text: 'Có lỗi xảy ra khi upload ảnh. Vui lòng thử lại.',
          icon: 'error'
        });
      });
    }
    
    // Upload from URL
    function uploadFromUrl() {
      Swal.fire({
        title: 'Nhập URL ảnh',
        input: 'url',
        inputLabel: 'URL ảnh bìa',
        inputPlaceholder: 'https://example.com/image.jpg',
        showCancelButton: true,
        confirmButtonText: 'Lưu',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
          if (!value) {
            return 'Vui lòng nhập URL ảnh!';
          }
          if (!value.startsWith('http')) {
            return 'URL phải bắt đầu bằng http:// hoặc https://';
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const imageUrl = result.value;
          updateImagePreview(imageUrl);
          console.log('Image URL set:', imageUrl);
        }
      });
    }



    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initCloudinaryWidget();
    });
  </script>
  <style>
    :root {
      --bg: #0b0b12;
      --bg-2: #0f0f18;
      --card: rgba(255, 255, 255, 0.08);
      --card-strong: rgba(255, 255, 255, 0.12);
      --stroke: rgba(255, 255, 255, 0.12);
      --text: #e9e9f1;
      --muted: #9aa3b2;
      --primary: #7c5cff;
      --primary-2: #22e4ff;
      --accent: #ff7ad9;
      --success: #22d3a3;
      --warning: #ffb020;
      --danger: #ff5e73;
      --glass: blur(10px) saturate(1.15);
      --radius: 18px;
      --shadow-3d: 0 20px 60px rgba(0, 0, 0, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.04);
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(1000px 700px at -10% 110%, rgba(34,228,255,.18), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      overflow: hidden;
    }

    /* Subtle grid overlay */
    .gridfx { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: .18; }
    .gridfx::before {
      content: ""; position: absolute; inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 36px 36px, 36px 36px;
      background-position: 0 0, 0 0;
      -webkit-mask-image: radial-gradient(1200px 800px at 50% 10%, #000 60%, transparent 70%);
      mask-image: radial-gradient(1200px 800px at 50% 10%, #000 60%, transparent 70%);
    }

    /* Floating orbs background */
    .orbs {
      position: fixed; inset: -10% -10% -10% -10%;
      pointer-events: none; z-index: 0;
      filter: blur(40px) saturate(1.1);
    }
    .orb { position: absolute; width: 380px; height: 380px; border-radius: 50%; opacity: .25; mix-blend-mode: screen; }
    .orb.one { background: radial-gradient(circle at 30% 30%, #7c5cff, transparent 60%); top: 6%; left: 8%; animation: float1 18s ease-in-out infinite; }
    .orb.two { background: radial-gradient(circle at 70% 40%, #22e4ff, transparent 60%); bottom: 10%; right: 6%; animation: float2 22s ease-in-out infinite; }
    .orb.three { background: radial-gradient(circle at 50% 50%, #ff7ad9, transparent 60%); top: 40%; right: 32%; width: 260px; height: 260px; animation: float3 26s ease-in-out infinite; }
    @keyframes float1 { 0%,100%{transform:translateY(0)} 50%{transform:translateY(40px)} }
    @keyframes float2 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(-30px,-20px)} }
    @keyframes float3 { 0%,100%{transform:translateX(0)} 50%{transform:translateX(35px)} }

    .app {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: 22px;
      height: 100vh;
      padding: 22px;
      perspective: 1400px;
      -webkit-perspective: 1400px;
    }

    /* Sidebar */
    .sidebar {
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      backdrop-filter: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-3d);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .brand { display:flex; align-items:center; gap:12px; padding:18px 18px 14px; border-bottom: 1px solid var(--stroke); }
    .brand img { width: 36px; height: 36px; object-fit: contain; filter: drop-shadow(0 6px 12px rgba(124,92,255,.35)); }
    .brand .title { font-weight: 700; letter-spacing: .3px; }
    .brand .badge { margin-left: auto; font-size: 12px; padding: 6px 10px; border-radius: 999px; background: linear-gradient(90deg, var(--primary), var(--primary-2)); color: #0b0b12; font-weight: 700; box-shadow: 0 8px 20px rgba(124,92,255,.35); }

    .nav { padding: 14px; display: grid; gap: 8px; }
    .nav a {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 12px; border-radius: 12px;
      color: var(--text); text-decoration: none;
      border: 1px solid transparent; position: relative;
      transition: transform .2s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .nav a .fa { width: 22px; text-align: center; color: #cfcff9; text-shadow: 0 0 14px rgba(124,92,255,.5); }
  .nav a:hover { background: var(--card-strong); border-color: var(--stroke); transform: translateY(-1px); box-shadow: var(--shadow-soft);
    }
    .nav a.active { background: linear-gradient(180deg, rgba(124,92,255,.18), rgba(34,228,255,.12)); border-color: rgba(124,92,255,.4); }

    .spacer { flex: 1 1 auto; }
    .sidebar-footer { padding: 14px; border-top: 1px solid var(--stroke); display: grid; gap: 10px; }
    .mini { font-size: 12px; color: var(--muted); }
    .btn { display:inline-flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--stroke); background: var(--card); color: var(--text); text-decoration: none; transition: .2s ease; }
    .btn:hover { background: var(--card-strong); transform: translateY(-1px); }

    /* Main content */
    .main {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 18px;
      overflow: hidden;
    }

    /* Topbar */
    .topbar {
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      backdrop-filter: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-3d);
      display: flex; align-items: center; gap: 14px; padding: 14px;
    }
  /* Status ticker */
  .ticker { margin-top: -6px; border-radius: var(--radius); background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); backdrop-filter: var(--glass); border: 1px solid var(--stroke); box-shadow: var(--shadow-3d); height: 34px; display:flex; align-items:center; gap:8px; overflow:hidden; padding: 0 10px; }
  .ticker .dot { width:6px; height:6px; border-radius:50%; background: var(--success); box-shadow: 0 0 0 3px rgba(34,211,163,.18); }
  .ticker .marquee { position: relative; width: 100%; overflow: hidden; }
  .ticker .content { display:inline-block; white-space: nowrap; animation: ticker 28s linear infinite; }
  .ticker .content span { margin-right: 24px; color: #cfcff9; }
  @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .search { position: relative; flex: 1; }
    .search input {
      width: 100%; padding: 12px 44px 12px 40px; border-radius: 12px; border: 1px solid var(--stroke);
      background: rgba(0,0,0,.2); color: var(--text);
      outline: none; transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
    }
    .search input:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 6px rgba(124,92,255,.12); background: rgba(124,92,255,.06); }
    .search .fa-search { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #cfcff9; }

    .pill {
      display:inline-flex; align-items:center; gap:8px; padding: 10px 12px;
      border-radius: 999px; border: 1px solid var(--stroke);
      background: var(--card);
    }
  .nav a.active { box-shadow: 0 10px 24px rgba(124,92,255,.25), inset 0 1px rgba(255,255,255,.08); }
  .btn { position: relative; }
  .btn::before { content:""; position:absolute; inset:0; padding:1px; border-radius: 12px; background: linear-gradient(90deg, var(--primary), var(--primary-2)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: .9; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: url('images/img-01.jpg') center/cover no-repeat; border: 1px solid var(--stroke); box-shadow: var(--shadow-soft); }

    /* Grid */
    .grid {
      height: calc(100vh - 22px - 70px);
      overflow: auto;
      padding-right: 2px;
      display: grid; gap: 18px;
      grid-template-columns: 1.2fr .8fr;
      grid-auto-rows: minmax(140px, auto);
      align-content: start;
    }

    .panel {
      position: relative;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      backdrop-filter: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-3d);
      padding: 16px;
      transform-style: preserve-3d;
    }

    /* Animated gradient border ring */
    .panel::before { content:""; position:absolute; inset:0; padding:1px; border-radius: var(--radius);
      background: conic-gradient(from 0deg, var(--primary), var(--primary-2), var(--accent), var(--primary));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; opacity: .5; pointer-events: none;
    }

    .panel h3 { margin: 0 0 10px; font-size: 18px; letter-spacing: .2px; }
    .panel h3::after { content:""; display:block; width:64px; height:3px; margin-top:8px; border-radius:3px;
      background: linear-gradient(90deg, var(--primary), var(--primary-2)); box-shadow: 0 6px 18px rgba(124,92,255,.35);
    }
    .muted { color: var(--muted); font-size: 13px; }

    /* KPI cards */
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .kpi { padding: 16px; border-radius: 14px; border: 1px solid var(--stroke); background: var(--card); position: relative; overflow: hidden; transform-style: preserve-3d; }
  .kpi::after { content:""; position:absolute; inset:auto -40% 0 -40%; height: 6px; background: repeating-linear-gradient(45deg, rgba(124,92,255,.4) 0 8px, rgba(34,228,255,.35) 8px 16px); filter: blur(6px); opacity:.35; animation: stripes 8s linear infinite; }
  @keyframes stripes { from { transform: translateX(-20%);} to { transform: translateX(20%);} }
    .kpi .value { font-size: 28px; font-weight: 800; letter-spacing: .3px; }
    .kpi .delta { font-size: 12px; margin-top: 6px; }
    .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); }
    .chip .dot { width:8px; height:8px; border-radius:50%; }
    .dot.green { background: var(--success); box-shadow: 0 0 0 3px rgba(34,211,163,.18); }
    .dot.red { background: var(--danger); box-shadow: 0 0 0 3px rgba(255,94,115,.2); }
    .kpi .bgglow { position:absolute; inset:auto -30% -50% -30%; height: 120%; background: radial-gradient(50% 60% at 50% 90%, rgba(124,92,255,.18), transparent 60%); transform: translateZ(-40px); }
  .kpi .spark { position:absolute; right: -6px; bottom: -8px; width: 130px; height: 64px; opacity: .75; }

    /* 3D Bar block */
    .bars3d { height: 280px; display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; }
    .bars-canvas { position: relative; border-radius: 12px; background: rgba(0,0,0,.25); border: 1px solid var(--stroke); overflow: hidden; transform: rotateX(50deg) rotateY(-18deg) translateZ(10px); transform-style: preserve-3d; perspective: 800px; }
  .bars-canvas::after { content:""; position:absolute; top:0; bottom:0; width: 80px; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.22), rgba(255,255,255,0)); transform: translateX(-120%); animation: sweep 5s linear infinite; }
  @keyframes sweep { 0%{ transform: translateX(-120%);} 100%{ transform: translateX(220%);} }
    .bars-canvas .gridline { position: absolute; left:0; right:0; height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); transform: translateZ(0); }
    .bar { position: absolute; bottom: 18px; width: 46px; border-radius: 10px 10px 4px 4px; background: linear-gradient(180deg, var(--primary), #3f2ca8); box-shadow: 0 12px 28px rgba(124,92,255,.28); transform-style: preserve-3d; }
    .bar::after { content:''; position:absolute; inset: 0; background: linear-gradient(180deg, rgba(255,255,255,.22), transparent 30% 70%, rgba(0,0,0,.25)); mix-blend-mode: screen; border-radius: inherit; }

  .legend { border:1px solid var(--stroke); border-radius: 12px; padding: 12px; background: rgba(255,255,255,.04); display:grid; gap:8px; box-shadow: inset 0 1px rgba(255,255,255,.06); }
    .legend-item { display:flex; align-items:center; gap:10px; font-size:13px; }
    .legend-swatch { width:12px; height:12px; border-radius:3px; }

    /* Area chart */
    .area { height: 280px; display: grid; grid-template-columns: 1fr; }
    .area svg { width: 100%; height: 100%; filter: drop-shadow(0 18px 30px rgba(124,92,255,.25)); }

    /* Activity & Users */
    .list { display: grid; gap: 10px; }
    .item { display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--stroke); border-radius: 12px; background: rgba(255,255,255,.05); }
    .item .ava { width:34px; height:34px; border-radius:50%; background: url('images/img-02.jpg') center/cover no-repeat; border:1px solid var(--stroke); }

    /* Donut */
    .donut-wrap { display:grid; grid-template-columns: 180px 1fr; gap: 16px; align-items:center; }
    .donut {
      --val: 72; /* percent */
      width: 180px; height: 180px; border-radius: 50%;
      background: conic-gradient(var(--primary) calc(var(--val)*1%), rgba(255,255,255,.1) 0);
      position: relative; box-shadow: var(--shadow-soft);
    }
    .donut::before { content:''; position:absolute; inset: 12px; border-radius: 50%; background: rgba(0,0,0,.45); border:1px solid var(--stroke); box-shadow: inset 0 10px 20px rgba(0,0,0,.55), inset 0 1px rgba(255,255,255,.08); }
    .donut::after { content: attr(data-label); position:absolute; inset: 0; display:grid; place-items:center; font-weight:800; font-size: 28px; color: #cfcff9; text-shadow: 0 2px 8px rgba(124,92,255,.35); }

  /* Tilt removed per request: keep static 3D styling only */
  .shine { display: none; }

    /* Responsiveness */
    @media (max-width: 1200px) {
      .kpis { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
      .bars3d { grid-template-columns: 1fr; height: auto; }
      .app { grid-template-columns: 86px 1fr; }
      .brand .title, .brand .badge { display:none; }
      .nav a span { display:none; }
    }
    @media (max-width: 720px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: 16px; right: 16px; bottom: 16px; top: auto; height: 70px; flex-direction: row; z-index: 5; }
      .brand { display:none; }
      .nav { grid-auto-flow: column; grid-auto-columns: 1fr; grid-template-columns: repeat(6,1fr); padding: 10px; }
      .sidebar-footer { display:none; }
      body { overflow: auto; }
      .grid { height: auto; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation: none !important; transition: none !important; }
    }

    /* Books and Stories Grid Styles */
    .books-grid, .stories-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .book-item, .story-item {
      transition: all 0.3s ease;
    }

    .book-item:hover, .story-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(124,92,255,.15);
      border-color: rgba(124,92,255,.2) !important;
    }

    .book-item img, .story-item img {
      transition: transform 0.3s ease;
    }

    .book-item:hover img, .story-item:hover img {
      transform: scale(1.05);
    }

    /* Status badges animation */
    .book-item span, .story-item span {
      transition: all 0.3s ease;
    }

    .book-item:hover span, .story-item:hover span {
      transform: scale(1.05);
    }

    /* Responsive design for books/stories */
    @media (max-width: 768px) {
      .book-item, .story-item {
        flex-direction: column;
      }
      
      .book-item img, .story-item img {
        width: 100% !important;
        height: 200px !important;
        object-fit: cover;
      }
    }
  </style>
</head>
<body>
  <div class="orbs" aria-hidden="true">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
  </div>
  <div class="gridfx" aria-hidden="true"></div>

  <div class="app">
  <aside class="sidebar">
      <div class="brand">
        <!-- <img src="images/logo-Photoroom.png" alt="AnBok" /> -->
        <div class="title">AnBok Admin</div>
        <span class="badge">PRO MAXX</span>
      </div>
             <nav class="nav">
         <a href="#" class="active"><i class="fa fa-home"></i><span>Tổng quan</span></a>
         <a href="#author-panel"><i class="fa fa-user"></i><span>Tác giả</span></a>
         <a href="book.html"><i class="fa fa-book"></i><span>Quản lý sách và truyện</span></a>
         <a href="#inventory-panel"><i class="fa fa-file-text"></i><span>Duyệt bản thảo</span></a>
         <a href="#news-panel"><i class="fa fa-newspaper-o"></i><span>Quản lý tin tức</span></a>
         <a href="#promotion-panel"><i class="fa fa-bell"></i><span>Quản lý mã khuyến mãi</span></a>
       </nav>
      <div class="spacer"></div>
      <div class="sidebar-footer">
        <div class="mini">Dung lượng</div>
        <div class="item" style="background: rgba(255,255,255,.04)">
          <div class="legend-swatch" style="background: linear-gradient(90deg, var(--primary), var(--primary-2)); width: 18px; height: 18px; border-radius: 4px;"></div>
          <div class="muted">58% đã dùng</div>
        </div>
        <a class="btn" href="#"><i class="fa fa-life-ring"></i> Hỗ trợ</a>
      </div>
    </aside>

    <section class="main">
      <header class="topbar">
        <div class="search">
          <i class="fa fa-search"></i>
          <input placeholder="Tìm kiếm mọi thứ..." />
        </div>
        <span class="pill"><i class="fa fa-sun-o"></i> 3D Static</span>
        <span class="pill"><i class="fa fa-bell-o"></i> 12</span>
        <span class="avatar" title="Quản trị viên"></span>
      </header>

      <div class="ticker">
        <span class="dot"></span>
        <div class="marquee">
          <div class="content" id="tickerContent">
            <span><i class="fa fa-bolt"></i> Máy chủ ổn định • uptime 99.99%</span>
            <span><i class="fa fa-line-chart"></i> Lượt đọc tăng +6.1% tuần này</span>
            <span><i class="fa fa-user-plus"></i> 12 tác giả mới đăng ký hôm nay</span>
            <span><i class="fa fa-shield"></i> Không có sự kiện bảo mật bất thường</span>
            <span><i class="fa fa-bolt"></i> Máy chủ ổn định • uptime 99.99%</span>
            <span><i class="fa fa-line-chart"></i> Lượt đọc tăng +6.1% tuần này</span>
            <span><i class="fa fa-user-plus"></i> 12 tác giả mới đăng ký hôm nay</span>
            <span><i class="fa fa-shield"></i> Không có sự kiện bảo mật bất thường</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- KPI row -->
  <div class="panel">
    <span class="sparkle" style="top:18px;left:22px;animation-delay:.2s"></span>
    <span class="sparkle" style="top:44px;right:32px;animation-delay:.8s"></span>
    <span class="sparkle" style="bottom:18px;left:38px;animation-delay:1.4s"></span>
    <span class="sparkle" style="top:18px;left:22px;animation-delay:.2s"></span>
    <span class="sparkle" style="top:44px;right:32px;animation-delay:.8s"></span>
    <span class="sparkle" style="bottom:18px;left:38px;animation-delay:1.4s"></span>
    <span class="sparkle" style="top:18px;left:22px;animation-delay:.2s"></span>
    <span class="sparkle" style="top:44px;right:32px;animation-delay:.8s"></span>
    <span class="sparkle" style="bottom:18px;left:38px;animation-delay:1.4s"></span>
          <h3>Chỉ số nhanh</h3>
          <div class="kpis">
            <div class="kpi" data-count="0" id="users-kpi">
              <div class="chip"><span class="dot green"></span>Người dùng</div>
              <div class="value" aria-label="Tổng người dùng">0</div>
              <div class="delta"><span style="color:var(--success)"><i class="fa fa-arrow-up"></i> +3.4%</span> tuần này</div>
              <div class="bgglow"></div>
            </div>
                                            <div class="kpi" data-count="0" id="views-kpi">
                                  <div class="chip"><span class="dot green"></span>Số doanh thu</div>
              <div class="value">0</div>
              <div class="delta"><span style="color:var(--success)"><i class="fa fa-arrow-up"></i> +6.1%</span> tuần này</div>
              <div class="bgglow"></div>
            </div>
            <div class="kpi" data-count="0" id="orders-kpi">
              <div class="chip"><span class="dot red"></span>Đơn hàng</div>
              <div class="value">0</div>
              <div class="delta"><span style="color:var(--danger)"><i class="fa fa-arrow-down"></i> -1.2%</span> tuần này</div>
              <div class="bgglow"></div>
            </div>
            <div class="kpi" data-count="0" id="authors-kpi">
                                                <div class="chip"><span class="dot green"></span>Tổng số tác giả</div>
              <div class="value">0</div>
              <div class="delta"><span style="color:var(--success)"><i class="fa fa-arrow-up"></i> +12</span> hôm nay</div>
              <div class="bgglow"></div>
            </div>
          </div>
        </div>



        <!-- Area chart full width (span both columns) -->
  <div class="panel" style="grid-column: 1 / -1;">
    <span class="sparkle" style="top:18px;left:22px;animation-delay:.2s"></span>
    <span class="sparkle" style="top:44px;right:32px;animation-delay:.8s"></span>
    <span class="sparkle" style="bottom:18px;left:38px;animation-delay:1.4s"></span>
          <h3>Xu hướng lượt đọc</h3>
          <div class="area">
            <svg viewBox="0 0 600 260" preserveAspectRatio="none" id="areaChart" aria-label="Biểu đồ xu hướng">
              <defs>
                <linearGradient id="gradArea" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#7c5cff" stop-opacity="0.85" />
                  <stop offset="100%" stop-color="#22e4ff" stop-opacity="0.15" />
                </linearGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="3.5" result="b" />
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <polyline id="areaStroke" fill="url(#gradArea)" stroke="#cfcff9" stroke-width="2" filter="url(#glow)" points=""/>
            </svg>
          </div>
        </div>


        <!-- Author Management -->
        <div class="panel" id="author-panel" style="grid-column: 1 / -1; min-height: 500px; display: none;">
          <h3>Quản lý Tác giả</h3>
          <div style="overflow-x:auto; margin-top: 20px;">
            <table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 2px 12px rgba(124,92,255,.08);">
              <thead style="background:rgba(124,92,255,.12);">
                <tr>
                  <th style="padding:16px 12px;text-align:left;color:var(--primary);font-weight:700;font-size:14px;">Tên</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;">Email</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;">Trạng thái</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;">Tác vụ</th>
                </tr>
              </thead>
              <tbody id="authorTableBody">
                <tr style="border-bottom:1px solid rgba(255,255,255,.08);">
                  <td style="padding:16px 12px;"><span class="ava" style="background-image:url('images/img-01.jpg');margin-right:12px;width:40px;height:40px;"></span> Linh Dev</td>
                  <td style="padding:16px 12px;">linhdev@email.com</td>
                  <td style="padding:16px 12px;"><span style="color:var(--success);font-weight:600;">Hoạt động</span></td>
                  <td style="padding:16px 12px;">
                    <button class="btn" onclick="alert('Xem chi tiết Linh Dev')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
                    <button class="btn" onclick="alert('Khóa tài khoản Linh Dev')"><i class="fa fa-lock"></i></button>
                  </td>
                </tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,.08);">
                  <td style="padding:16px 12px;"><span class="ava" style="background-image:url('images/img-03.jpg');margin-right:12px;width:40px;height:40px;"></span> An Bok</td>
                  <td style="padding:16px 12px;">anbok@email.com</td>
                  <td style="padding:16px 12px;"><span style="color:var(--warning);font-weight:600;">Chờ duyệt</span></td>
                  <td style="padding:16px 12px;">
                    <button class="btn" onclick="alert('Xem chi tiết An Bok')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
                    <button class="btn" onclick="alert('Duyệt An Bok')"><i class="fa fa-check"></i></button>
                  </td>
                </tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,.08);">
                  <td style="padding:16px 12px;"><span class="ava" style="background-image:url('images/img-04.jpg');margin-right:12px;width:40px;height:40px;"></span> Taka</td>
                  <td style="padding:16px 12px;">taka@email.com</td>
                  <td style="padding:16px 12px;"><span style="color:var(--danger);font-weight:600;">Bị khóa</span></td>
                  <td style="padding:16px 12px;">
                    <button class="btn" onclick="alert('Xem chi tiết Taka')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
                    <button class="btn" onclick="alert('Mở khóa Taka')"><i class="fa fa-unlock"></i></button>
                  </td>
                </tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,.08);">
                  <td style="padding:16px 12px;"><span class="ava" style="background-image:url('images/img-02.jpg');margin-right:12px;width:40px;height:40px;"></span> Mai Anh</td>
                  <td style="padding:16px 12px;">maianh@email.com</td>
                  <td style="padding:16px 12px;"><span style="color:var(--success);font-weight:600;">Hoạt động</span></td>
                  <td style="padding:16px 12px;">
                    <button class="btn" onclick="alert('Xem chi tiết Mai Anh')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
                    <button class="btn" onclick="alert('Khóa tài khoản Mai Anh')"><i class="fa fa-lock"></i></button>
                  </td>
                </tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,.08);">
                  <td style="padding:16px 12px;"><span class="ava" style="background-image:url('images/img-01.jpg');margin-right:12px;width:40px;height:40px;"></span> Hoàng Nam</td>
                  <td style="padding:16px 12px;">hoangnam@email.com</td>
                  <td style="padding:16px 12px;"><span style="color:var(--warning);font-weight:600;">Chờ duyệt</span></td>
                  <td style="padding:16px 12px;">
                    <button class="btn" onclick="alert('Xem chi tiết Hoàng Nam')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
                    <button class="btn" onclick="alert('Duyệt Hoàng Nam')"><i class="fa fa-check"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Manuscript Review Management -->
        <div class="panel" id="inventory-panel" style="grid-column: 1 / -1; min-height: 500px; display: none;">
          <h3>Duyệt Bản thảo</h3>
          
          <!-- Manuscript Stats -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div class="kpi" style="background: rgba(34,211,163,.1); border-color: var(--success);">
              <div class="chip"><span class="dot green"></span>Đã duyệt</div>
              <div class="value" id="approvedManuscripts">0</div>
              <div class="delta"><span style="color:var(--success)"><i class="fa fa-check"></i> Chấp nhận</span></div>
            </div>
            <div class="kpi" style="background: rgba(255,176,32,.1); border-color: var(--warning);">
              <div class="chip"><span class="dot" style="background: var(--warning);"></span>Chờ duyệt</div>
              <div class="value" id="pendingManuscripts">0</div>
              <div class="delta"><span style="color:var(--warning)"><i class="fa fa-clock-o"></i> Cần xem xét</span></div>
            </div>
            <div class="kpi" style="background: rgba(255,94,115,.1); border-color: var(--danger);">
              <div class="chip"><span class="dot red"></span>Từ chối</div>
              <div class="value" id="rejectedManuscripts">0</div>
              <div class="delta"><span style="color:var(--danger)"><i class="fa fa-times"></i> Không phù hợp</span></div>
            </div>
            <div class="kpi" style="background: rgba(124,92,255,.1); border-color: var(--primary);">
              <div class="chip"><span class="dot" style="background: var(--primary);"></span>Tổng bản thảo</div>
              <div class="value" id="totalManuscripts">0</div>
              <div class="delta"><span style="color:var(--primary)"><i class="fa fa-file-text"></i> Tất cả</span></div>
            </div>
          </div>

          <!-- Manuscript Controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="openAddManuscriptModal()" style="background: var(--success); color: white;">
                <i class="fa fa-plus"></i> Thêm bản thảo
              </button>
              <button class="btn" onclick="bulkApprove()" style="background: var(--primary); color: white;">
                <i class="fa fa-check"></i> Duyệt hàng loạt
              </button>
              <button class="btn" onclick="exportManuscripts()" style="background: var(--accent); color: white;">
                <i class="fa fa-download"></i> Xuất báo cáo
              </button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" id="manuscriptSearch" placeholder="Tìm kiếm bản thảo..." style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              <select id="manuscriptFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                <option value="">Tất cả</option>
                <option value="pending">Chờ duyệt</option>
                <option value="approved">Đã duyệt</option>
                <option value="rejected">Từ chối</option>
                <option value="books">Sách</option>
                <option value="stories">Truyện</option>
              </select>
            </div>
          </div>

          <!-- Manuscript Table -->
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 2px 12px rgba(124,92,255,.08);">
              <thead style="background:rgba(124,92,255,.12);">
                <tr>
                  <th style="padding:16px 12px;text-align:left;color:var(--primary);font-weight:700;font-size:14px;width:80px;">Bìa</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:200px;">Tên tác phẩm</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:120px;">Tác giả</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Loại</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:120px;">Ngày gửi</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Trạng thái</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Người duyệt</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:150px;">Tác vụ</th>
                </tr>
              </thead>
              <tbody id="manuscriptTableBody">
                <!-- Manuscript data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- News Management Panel -->
        <div class="panel" id="news-panel" style="grid-column: 1 / -1; min-height: 500px; display: none;">
          <h3>Quản lý Tin tức</h3>
          
          <!-- News Stats -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div class="kpi" style="background: rgba(34,211,163,.1); border-color: var(--success);">
              <div class="chip"><span class="dot green"></span>Đã xuất bản</div>
              <div class="value" id="publishedNews">0</div>
              <div class="delta"><span style="color:var(--success)"><i class="fa fa-check"></i> Hoạt động</span></div>
            </div>
            <div class="kpi" style="background: rgba(255,176,32,.1); border-color: var(--warning);">
              <div class="chip"><span class="dot" style="background: var(--warning);"></span>Bản nháp</div>
              <div class="value" id="draftNews">0</div>
              <div class="delta"><span style="color:var(--warning)"><i class="fa fa-edit"></i> Chờ hoàn thiện</span></div>
            </div>
            <div class="kpi" style="background: rgba(255,94,115,.1); border-color: var(--danger);">
              <div class="chip"><span class="dot red"></span>Đã ẩn</div>
              <div class="value" id="hiddenNews">0</div>
              <div class="delta"><span style="color:var(--danger)"><i class="fa fa-eye-slash"></i> Không hiển thị</span></div>
            </div>
            <div class="kpi" style="background: rgba(124,92,255,.1); border-color: var(--primary);">
              <div class="chip"><span class="dot" style="background: var(--primary);"></span>Tổng tin tức</div>
              <div class="value" id="totalNews">0</div>
              <div class="delta"><span style="color:var(--primary)"><i class="fa fa-newspaper-o"></i> Tất cả</span></div>
            </div>
          </div>

          <!-- Trending News Section -->
          <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 24px;">
            <div>
              <h4 style="margin: 0 0 15px; color: var(--primary); font-size: 16px;">
                <i class="fa fa-fire"></i> Tin tức nổi bật
              </h4>
              <div id="trendingNews" style="min-height: 120px;">
                <!-- Trending news will be loaded here -->
              </div>
            </div>
            <div>
              <h4 style="margin: 0 0 15px; color: var(--accent); font-size: 16px;">
                <i class="fa fa-chart-pie"></i> Thống kê nhanh
              </h4>
              <div style="background: rgba(255,255,255,.05); border-radius: 8px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Tin tức hôm nay:</span>
                  <span id="todayNews" style="color: var(--success); font-weight: 600;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Lượt xem trung bình:</span>
                  <span id="avgViews" style="color: var(--primary); font-weight: 600;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Tỷ lệ nổi bật:</span>
                  <span id="featuredRatio" style="color: var(--accent); font-weight: 600;">0%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- News Controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="openAddNewsModal()" style="background: var(--success); color: white;">
                <i class="fa fa-plus"></i> Thêm tin tức
              </button>
              <button class="btn" onclick="bulkPublishNews()" style="background: var(--primary); color: white;">
                <i class="fa fa-globe"></i> Xuất bản hàng loạt
              </button>
              <button class="btn" onclick="exportNewsReport()" style="background: var(--accent); color: white;">
                <i class="fa fa-download"></i> Xuất báo cáo
              </button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" id="newsSearch" placeholder="Tìm kiếm tin tức..." style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              <select id="newsFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                <option value="">Tất cả</option>
                <option value="published">Đã xuất bản</option>
                <option value="draft">Bản nháp</option>
                <option value="hidden">Đã ẩn</option>
                <option value="featured">Nổi bật</option>
              </select>
            </div>
          </div>

          <!-- News Table -->
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 2px 12px rgba(124,92,255,.08);">
              <thead style="background:rgba(124,92,255,.12);">
                <tr>
                  <th style="padding:16px 12px;text-align:left;color:var(--primary);font-weight:700;font-size:14px;width:80px;">Ảnh</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:250px;">Tiêu đề</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:120px;">Tác giả</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Danh mục</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:120px;">Ngày tạo</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Trạng thái</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:100px;">Lượt xem</th>
                  <th style="padding:16px 12px;text-align:left;font-size:14px;width:150px;">Tác vụ</th>
                </tr>
              </thead>
              <tbody id="newsTableBody">
                <!-- News data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Promotion Code Management Panel -->
        <div class="panel" id="promotion-panel" style="grid-column: 1 / -1; min-height: 600px; display: none;">
          <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 24px; font-weight: 600;">
            <i class="fa fa-gift" style="margin-right: 12px; color: var(--accent);"></i>Quản lý Mã khuyến mãi
          </h3>
          
          <!-- Promotion Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px;">
            <div class="kpi" style="background: linear-gradient(135deg, rgba(34,211,163,0.1) 0%, rgba(34,211,163,0.05) 100%); border: 2px solid var(--success); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(34,211,163,0.1);">
              <div class="chip" style="margin-bottom: 16px; font-weight: 600; color: var(--success);">
                <span class="dot green" style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); display: inline-block; margin-right: 8px;"></span>Đang hoạt động
              </div>
              <div class="value" id="activePromotions" style="font-size: 36px; font-weight: 700; color: var(--success); margin-bottom: 8px;">0</div>
              <div class="delta"><span style="color:var(--success); font-size: 14px;"><i class="fa fa-check"></i> Có hiệu lực</span></div>
              <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: rgba(34,211,163,0.1); border-radius: 50%;"></div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, rgba(255,176,32,0.1) 0%, rgba(255,176,32,0.05) 100%); border: 2px solid var(--warning); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(255,176,32,0.1);">
              <div class="chip" style="margin-bottom: 16px; font-weight: 600; color: var(--warning);">
                <span class="dot orange" style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning); display: inline-block; margin-right: 8px;"></span>Sắp hết hạn
              </div>
              <div class="value" id="expiringPromotions" style="font-size: 36px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">0</div>
              <div class="delta"><span style="color:var(--warning); font-size: 14px;"><i class="fa fa-clock-o"></i> Trong 7 ngày</span></div>
              <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: rgba(255,176,32,0.1); border-radius: 50%;"></div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, rgba(255,94,115,0.1) 0%, rgba(255,94,115,0.05) 100%); border: 2px solid var(--danger); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(255,94,115,0.1);">
              <div class="chip" style="margin-bottom: 16px; font-weight: 600; color: var(--danger);">
                <span class="dot red" style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger); display: inline-block; margin-right: 8px;"></span>Đã hết hạn
              </div>
              <div class="value" id="expiredPromotions" style="font-size: 36px; font-weight: 700; color: var(--danger); margin-bottom: 8px;">0</div>
              <div class="delta"><span style="color:var(--danger); font-size: 14px;"><i class="fa fa-times"></i> Hết hiệu lực</span></div>
              <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: rgba(255,94,115,0.1); border-radius: 50%;"></div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, rgba(124,92,255,0.1) 0%, rgba(124,92,255,0.05) 100%); border: 2px solid var(--primary); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(124,92,255,0.1);">
              <div class="chip" style="margin-bottom: 16px; font-weight: 600; color: var(--primary);">
                <span class="dot purple" style="width: 12px; height: 12px; border-radius: 50%; background: var(--primary); display: inline-block; margin-right: 8px;"></span>Tổng mã
              </div>
              <div class="value" id="totalPromotions" style="font-size: 36px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">0</div>
              <div class="delta"><span style="color:var(--primary); font-size: 14px;"><i class="fa fa-tags"></i> Tất cả mã</span></div>
              <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: rgba(124,92,255,0.1); border-radius: 50%;"></div>
            </div>
          </div>

          <!-- Chart and Featured Codes -->
          <div style="display: grid; grid-template-columns: 1fr 380px; gap: 24px; margin-bottom: 32px;">
            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 20px; padding: 32px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
              <h4 style="margin: 0 0 20px; color: var(--primary); font-size: 18px; font-weight: 600;">
                <i class="fa fa-bar-chart" style="margin-right: 12px; color: var(--accent);"></i>Biểu đồ hiệu quả sử dụng mã khuyến mãi
              </h4>
              <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                <i class="fa fa-chart-line" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3; color: var(--accent);"></i>
                <p style="font-size: 16px; margin: 0;">Dữ liệu sẽ được hiển thị khi có mã khuyến mãi</p>
                <small style="opacity: 0.7;">Biểu đồ sẽ hiển thị thống kê sử dụng theo thời gian</small>
              </div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(255,122,217,0.05) 0%, rgba(255,122,217,0.02) 100%); border-radius: 20px; padding: 24px; border: 1px solid rgba(255,122,217,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
              <h4 style="margin: 0 0 20px; color: var(--accent); font-size: 18px; font-weight: 600;">
                <i class="fa fa-star" style="margin-right: 12px; color: var(--accent);"></i>Mã nổi bật
              </h4>
              <div id="topPromotions" style="min-height: 200px;">
                <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                  <i class="fa fa-star" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3; color: var(--accent);"></i>
                  <p style="font-size: 14px; margin: 0;">Chưa có mã nổi bật</p>
                  <small style="opacity: 0.7;">Các mã được đánh dấu nổi bật sẽ hiển thị ở đây</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Promotion Controls -->
          <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn" onclick="openAddPromotionModal()" style="background: linear-gradient(135deg, var(--success) 0%, #1a9f7a 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 16px rgba(34,211,163,0.3); transition: all 0.3s ease; cursor: pointer;">
                  <i class="fa fa-plus" style="margin-right: 8px;"></i>Thêm mã khuyến mãi
                </button>
                <button class="btn" onclick="bulkActivatePromotions()" style="background: linear-gradient(135deg, var(--primary) 0%, #6b4fd8 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 16px rgba(124,92,255,0.3); transition: all 0.3s ease; cursor: pointer;">
                  <i class="fa fa-play" style="margin-right: 8px;"></i>Kích hoạt hàng loạt
                </button>
                <button class="btn" onclick="exportPromotionReport()" style="background: linear-gradient(135deg, var(--accent) 0%, #e65ac0 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 16px rgba(255,122,217,0.3); transition: all 0.3s ease; cursor: pointer;">
                  <i class="fa fa-download" style="margin-right: 8px;"></i>Xuất báo cáo
                </button>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="promotionSearch" placeholder="Tìm kiếm mã khuyến mãi..." style="padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text); min-width: 250px; font-size: 14px;">
                <select id="promotionFilter" style="padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text); font-size: 14px;">
                  <option value="">Tất cả</option>
                  <option value="active">Đang hoạt động</option>
                  <option value="expiring">Sắp hết hạn</option>
                  <option value="expired">Đã hết hạn</option>
                  <option value="percentage">Giảm theo %</option>
                  <option value="fixed">Giảm theo số tiền</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Promotion Table -->
          <div style="background: rgba(255,255,255,0.02); border-radius: 20px; padding: 24px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: transparent;">
                <thead>
                  <tr>
                    <th style="padding: 16px 12px; text-align: left; color: var(--primary); font-weight: 700; font-size: 14px; border-bottom: 2px solid rgba(124,92,255,0.3);">Mã</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Mô tả</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Loại</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Giá trị</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Ngày bắt đầu</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Ngày kết thúc</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Trạng thái</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Lượt sử dụng</th>
                    <th style="padding: 16px 12px; text-align: left; font-size: 14px; border-bottom: 2px solid rgba(255,255,255,0.1);">Tác vụ</th>
                  </tr>
                </thead>
                <tbody id="promotionTableBody">
                  <!-- Promotion data will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Donut + notes -->
  <!-- <div class="panel">
          <h3>Tỉ lệ chuyển đổi</h3>
          <div class="donut-wrap">
            <div class="donut" id="donut" data-label="72%" aria-label="Tỉ lệ chuyển đổi"></div>
            <div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--primary)"></span> Trang chủ ➜ Đăng ký</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--accent)"></span> Đăng ký ➜ Thanh toán</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--primary-2)"></span> Thanh toán ➜ Thành viên</div>
              <p class="muted">Tối ưu CTA và tốc độ tải giúp tăng 4.2% trong 7 ngày.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div> -->

  <script>
    // Utility: clamp
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // Navigation functionality
    function initNavigation() {
      const navLinks = document.querySelectorAll('.nav a');
      const panels = document.querySelectorAll('.panel');
      
      // Show only dashboard panels initially (hide author panel, inventory panel, news panel and promotion panel)
      panels.forEach(panel => {
        if (panel.id === 'author-panel' || panel.id === 'inventory-panel' || panel.id === 'news-panel' || panel.id === 'promotion-panel') {
          panel.style.display = 'none';
        } else {
          panel.style.display = 'block';
        }
      });

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          link.classList.add('active');
          
          // Show corresponding panel
          const targetId = link.getAttribute('href');
          if (targetId === '#') {
            // Show only dashboard panels (hide author panel, inventory panel, news panel, promotion panel and books-stories panel)
            panels.forEach(panel => {
              if (panel.id === 'author-panel' || panel.id === 'inventory-panel' || panel.id === 'news-panel' || panel.id === 'promotion-panel') {
                panel.style.display = 'none';
              } else {
                panel.style.display = 'block';
              }
            });
            
            // Also hide the dynamically created books-stories panel
            const booksStoriesPanel = document.getElementById('books-stories-panel');
            if (booksStoriesPanel) {
              booksStoriesPanel.style.display = 'none';
            }
          } else if (targetId === '#author-panel') {
            // Show only author management panel
            panels.forEach(panel => {
              if (panel.id === 'author-panel') {
                panel.style.display = 'block';
              } else {
                panel.style.display = 'none';
              }
            });
            
            // Also hide the dynamically created books-stories panel
            const booksStoriesPanel = document.getElementById('books-stories-panel');
            if (booksStoriesPanel) {
              booksStoriesPanel.style.display = 'none';
            }
          } else if (targetId === '#inventory-panel') {
            // Show only inventory management panel
            panels.forEach(panel => {
              if (panel.id === 'inventory-panel') {
                panel.style.display = 'block';
              } else {
                panel.style.display = 'none';
              }
            });
            
            // Also hide the dynamically created books-stories panel
            const booksStoriesPanel = document.getElementById('books-stories-panel');
            if (booksStoriesPanel) {
              booksStoriesPanel.style.display = 'none';
            }
            
            // Load inventory data
            loadInventoryData();
          } else if (targetId === '#news-panel') {
            // Show only news management panel
            panels.forEach(panel => {
              if (panel.id === 'news-panel') {
                panel.style.display = 'block';
              } else {
                panel.style.display = 'none';
              }
            });
            
            // Also hide the dynamically created books-stories panel
            const booksStoriesPanel = document.getElementById('books-stories-panel');
            if (booksStoriesPanel) {
              booksStoriesPanel.style.display = 'none';
            }
            
            // Load news data and initialize panel
            loadNewsData();
            initNewsPanel();
          } else if (targetId === '#promotion-panel') {
            // Show only promotion management panel
            panels.forEach(panel => {
              if (panel.id === 'promotion-panel') {
                panel.style.display = 'block';
              } else {
                panel.style.display = 'none';
              }
            });
            
            // Also hide the dynamically created books-stories panel
            const booksStoriesPanel = document.getElementById('books-stories-panel');
            if (booksStoriesPanel) {
              booksStoriesPanel.style.display = 'none';
            }
            
            // Load promotion data and initialize panel
            loadPromotionData();
            initPromotionPanel();
          } else if (targetId === 'book.html') {
            // Show books and stories management panel
            showBooksAndStoriesPanel();
          }
        });
      });
    }

    // Initialize navigation when page loads
    document.addEventListener('DOMContentLoaded', initNavigation);

    // Firebase functionality
    function initFirebaseFeatures() {
      // Wait for Firebase to be available
      if (typeof window.firebase === 'undefined') {
        setTimeout(initFirebaseFeatures, 100);
        return;
      }

      const { database, ref, onValue, set, push, auth, onAuthStateChanged, signOut } = window.firebase;

      // Listen for real-time data updates
      const statsRef = ref(database, 'dashboard/stats');
      onValue(statsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('Real-time stats updated:', data);
          // Update KPI values with real data
          updateKPIs(data);
        }
      });

      // Listen for author registrations data updates
      const authorRegistrationsRef = ref(database, 'authorRegistrations');
      const usersRef = ref(database, 'users');
      
      onValue(authorRegistrationsRef, (snapshot) => {
        const authorRegistrations = snapshot.val();
        if (authorRegistrations) {
          console.log('Author registrations updated:', authorRegistrations);
          // Get user data to combine with author registrations
          onValue(usersRef, (userSnapshot) => {
            const users = userSnapshot.val();
            if (users) {
              console.log('Users data updated:', users);
              updateAuthorTable(authorRegistrations, users);
            }
          }, { onlyOnce: true });
        }
      });

      // Check authentication state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log('User is signed in:', user.email);
          
          // Check if user email is authorized
          if (user.email === 'quantrianbokcollection@gmail.com') {
            // User is authorized, show dashboard
            document.body.style.display = 'block';
          document.querySelector('.avatar').title = `Quản trị viên: ${user.email}`;
            loadOverviewData();
            loadAuthorRegistrations();
            loadUsersData();
          } else {
            // User is not authorized
            console.log('Unauthorized access attempt by:', user.email);
            alert('Bạn không có quyền truy cập trang quản trị. Chỉ email quantrianbokcollection@gmail.com mới được phép.');
            signOut(auth).then(() => {
              window.location.href = 'auth.html';
            }).catch((error) => {
              console.error('Error signing out:', error);
              window.location.href = 'auth.html';
            });
          }
        } else {
          console.log('User is signed out');
          // User is signed out, redirect to auth page
          window.location.href = 'auth.html';
        }
      });
    }

    // Update KPI values with real data
    function updateKPIs(data) {
      const kpis = document.querySelectorAll('.kpi');
      kpis.forEach((kpi, index) => {
        const valueEl = kpi.querySelector('.value');
        if (valueEl && data[index]) {
          const newValue = data[index].value || 0;
          animateNumber(valueEl, newValue);
        }
      });
    }

    // Update author table with real data
    function updateAuthorTable(authorRegistrations, users) {
      const tbody = document.getElementById('authorTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(authorRegistrations).forEach(registrationId => {
        const registration = authorRegistrations[registrationId];
        const userId = registration.userId;
        const user = users[userId];
        
        // Get user profile data
        const userProfile = user?.profile || {};
        const userPhotoURL = userProfile.photoURL || 'images/img-01.jpg';
        const userDisplayName = userProfile.displayName || userProfile.personalInfo?.fullName || registration.penName;
        const userEmail = registration.contactEmail || registration.userEmail;
        
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.08)';
        
        row.innerHTML = `
          <td style="padding:16px 12px;">
            <span class="ava" style="background-image:url('${userPhotoURL}');margin-right:12px;width:40px;height:40px;display:inline-block;border-radius:50%;background-size:cover;background-position:center;"></span> 
            <strong>${registration.penName}</strong>
            <br><small style="color:var(--muted);">${userDisplayName}</small>
          </td>
          <td style="padding:16px 12px;">
            ${userEmail}
            <br><small style="color:var(--muted);">${registration.contactPhone || 'N/A'}</small>
          </td>
          <td style="padding:16px 12px;">
            <span style="color:${getStatusColor(registration.status)};font-weight:600;">${getStatusText(registration.status)}</span>
            <br><small style="color:var(--muted);">${registration.specialization || 'N/A'}</small>
          </td>
          <td style="padding:16px 12px;">
            <button class="btn" onclick="viewAuthorDetails('${registrationId}', '${userId}')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
            <button class="btn" onclick="toggleAuthorStatus('${registrationId}', '${registration.status}')" style="margin-right:8px;">
              <i class="fa fa-${getActionIcon(registration.status)}"></i>
            </button>
            <button class="btn" onclick="deleteAuthor('${registrationId}', '${userId}', '${registration.penName}')" style="background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Helper functions
    function getStatusColor(status) {
      switch(status) {
        case 'approved': return 'var(--success)';
        case 'pending': return 'var(--warning)';
        case 'rejected': return 'var(--danger)';
        case 'blocked': return 'var(--danger)';
        default: return 'var(--muted)';
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'approved': return 'Đã duyệt';
        case 'pending': return 'Chờ duyệt';
        case 'rejected': return 'Từ chối';
        case 'blocked': return 'Bị khóa';
        default: return 'Không xác định';
      }
    }

    function getActionIcon(status) {
      switch(status) {
        case 'approved': return 'lock';
        case 'pending': return 'check';
        case 'rejected': return 'check';
        case 'blocked': return 'unlock';
        default: return 'check';
      }
    }

    // Helper functions for generating books and stories HTML
    function generateBooksHTML(books) {
      if (Object.keys(books).length === 0) {
        return `
          <div style="text-align: center; padding: 20px; color: var(--muted);">
            <i class="fa fa-book" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Chưa có sách nào</p>
          </div>
        `;
      }

      let booksHTML = '<div class="books-grid">';
      Object.keys(books).forEach(bookId => {
        const book = books[bookId];
        const coverImage = book.coverImage || 'images/img-01.jpg';
        const statusColor = getBookStatusColor(book.status);
        const statusText = getBookStatusText(book.status);
        const publishStatus = book.isPublished ? 'Đã xuất bản' : 'Chưa xuất bản';
        const publishColor = book.isPublished ? 'var(--success)' : 'var(--warning)';
        
        booksHTML += `
          <div class="book-item" style="background: rgba(255,255,255,.04); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,.08);">
            <div style="display: flex; gap: 15px;">
              <img src="${coverImage}" alt="${book.title}" style="width: 80px; height: 120px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,.1);" onerror="this.src='images/img-01.jpg'">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 16px;">${book.title}</h4>
                <p style="margin: 0 0 8px 0; color: var(--muted); font-size: 14px; line-height: 1.4;">${book.description || 'Không có mô tả'}</p>
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                  <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${statusText}</span>
                  <span style="background: ${publishColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${publishStatus}</span>
                  <span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${book.type || 'novel'}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; color: var(--muted);">
                  <div><i class="fa fa-list"></i> ${book.totalChapters || 0} chương</div>
                  <div><i class="fa fa-eye"></i> ${book.totalViews || 0} lượt xem</div>
                  <div><i class="fa fa-heart"></i> ${book.totalLikes || 0} lượt thích</div>
                  <div><i class="fa fa-star"></i> ${book.rating || 0}/5 (${book.ratingCount || 0})</div>
                </div>
                
                <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                  <i class="fa fa-calendar"></i> Tạo: ${new Date(book.createdAt).toLocaleDateString('vi-VN')}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      booksHTML += '</div>';
      return booksHTML;
    }

    function generateStoriesHTML(stories) {
      if (Object.keys(stories).length === 0) {
        return `
          <div style="text-align: center; padding: 20px; color: var(--muted);">
            <i class="fa fa-pencil" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Chưa có truyện nào</p>
          </div>
        `;
      }

      let storiesHTML = '<div class="stories-grid">';
      Object.keys(stories).forEach(storyId => {
        const story = stories[storyId];
        const coverImage = story.coverImage || 'images/img-01.jpg';
        const statusColor = getStoryStatusColor(story.status);
        const statusText = getStoryStatusText(story.status);
        const publishStatus = story.isPublished ? 'Đã xuất bản' : 'Chưa xuất bản';
        const publishColor = story.isPublished ? 'var(--success)' : 'var(--warning)';
        
        storiesHTML += `
          <div class="story-item" style="background: rgba(255,255,255,.04); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,.08);">
            <div style="display: flex; gap: 15px;">
              <img src="${coverImage}" alt="${story.title}" style="width: 80px; height: 120px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,.1);" onerror="this.src='images/img-01.jpg'">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 16px;">${story.title}</h4>
                <p style="margin: 0 0 8px 0; color: var(--muted); font-size: 14px; line-height: 1.4;">${story.description || 'Không có mô tả'}</p>
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                  <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${statusText}</span>
                  <span style="background: ${publishColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${publishStatus}</span>
                  <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${story.type || 'series'}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; color: var(--muted);">
                  <div><i class="fa fa-list"></i> ${story.totalChapters || 0} chương</div>
                  <div><i class="fa fa-eye"></i> ${story.totalViews || 0} lượt xem</div>
                  <div><i class="fa fa-heart"></i> ${story.totalLikes || 0} lượt thích</div>
                  <div><i class="fa fa-star"></i> ${story.rating || 0}/5 (${story.ratingCount || 0})</div>
                </div>
                
                <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                  <i class="fa fa-calendar"></i> Tạo: ${new Date(story.createdAt).toLocaleDateString('vi-VN')}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      storiesHTML += '</div>';
      return storiesHTML;
    }

    function getBookStatusColor(status) {
      switch(status) {
        case 'completed': return 'var(--success)';
        case 'ongoing': return 'var(--primary)';
        case 'hiatus': return 'var(--warning)';
        case 'cancelled': return 'var(--danger)';
        default: return 'var(--muted)';
      }
    }

    function getBookStatusText(status) {
      switch(status) {
        case 'completed': return 'Hoàn thành';
        case 'ongoing': return 'Đang viết';
        case 'hiatus': return 'Tạm ngưng';
        case 'cancelled': return 'Đã hủy';
        default: return 'Không xác định';
      }
    }

    function getStoryStatusColor(status) {
      switch(status) {
        case 'completed': return 'var(--success)';
        case 'ongoing': return 'var(--primary)';
        case 'review': return 'var(--warning)';
        case 'draft': return 'var(--muted)';
        case 'cancelled': return 'var(--danger)';
        default: return 'var(--muted)';
      }
    }

    function getStoryStatusText(status) {
      switch(status) {
        case 'completed': return 'Hoàn thành';
        case 'ongoing': return 'Đang viết';
        case 'review': return 'Đang duyệt';
        case 'draft': return 'Bản nháp';
        case 'cancelled': return 'Đã hủy';
        default: return 'Không xác định';
      }
    }

    // Global functions for button actions
    window.viewAuthorDetails = function(registrationId, userId) {
      const { database, ref, get } = window.firebase;
      
      // Show loading in modal
      document.getElementById('modalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('modalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin tác giả...</p>
        </div>
      `;
      openAuthorModal();
      
      // Get registration details
      get(ref(database, `authorRegistrations/${registrationId}`)).then((registrationSnapshot) => {
        const registration = registrationSnapshot.val();
        
        // Get user details
        get(ref(database, `users/${userId}`)).then((userSnapshot) => {
          const user = userSnapshot.val();
          const userProfile = user?.profile || {};
          const userPhotoURL = userProfile.photoURL || 'images/img-01.jpg';
          const userDisplayName = userProfile.displayName || userProfile.personalInfo?.fullName || registration.penName;
          
          // Get books and stories data
          const books = user?.books || {};
          const stories = user?.stories || {};
          
          // Generate books HTML
          const booksHTML = generateBooksHTML(books);
          const storiesHTML = generateStoriesHTML(stories);
          
          // Update modal content
          document.getElementById('modalTitle').textContent = `Chi tiết tác giả: ${registration.penName}`;
          document.getElementById('modalBody').innerHTML = `
            <div class="author-header">
              <img src="${userPhotoURL}" alt="${registration.penName}" class="author-avatar" onerror="this.src='images/img-01.jpg'">
              <div class="author-details">
                <h1>${registration.penName}</h1>
                <p>${userDisplayName}</p>
                <span class="status-badge status-${registration.status}">
                  <i class="fa fa-${registration.status === 'approved' ? 'check' : registration.status === 'pending' ? 'clock-o' : 'ban'}"></i>
                  ${getStatusText(registration.status)}
                </span>
              </div>
            </div>
            
            <div class="author-info-grid">
              <div class="info-section">
                <h3><i class="fa fa-file-text"></i> Thông tin đăng ký</h3>
                <div class="info-item">
                  <span class="info-label">Bút danh</span>
                  <span class="info-value">${registration.penName}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Email</span>
                  <span class="info-value">${registration.contactEmail}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Điện thoại</span>
                  <span class="info-value">${registration.contactPhone || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Chuyên môn</span>
                  <span class="info-value">${registration.specialization || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Website</span>
                  <span class="info-value">${registration.website || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Bio</span>
                  <span class="info-value">${registration.bio || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Tác phẩm mẫu</span>
                  <span class="info-value">${registration.sampleWork || 'N/A'}</span>
                </div>
              </div>
              
              <div class="info-section">
                <h3><i class="fa fa-user"></i> Thông tin cá nhân</h3>
                <div class="info-item">
                  <span class="info-label">Họ tên</span>
                  <span class="info-value">${userProfile.personalInfo?.fullName || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Username</span>
                  <span class="info-value">${userProfile.personalInfo?.username || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Địa chỉ</span>
                  <span class="info-value">${userProfile.personalInfo?.address || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ngày sinh</span>
                  <span class="info-value">${userProfile.personalInfo?.dateOfBirth || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Giới tính</span>
                  <span class="info-value">${userProfile.personalInfo?.gender || 'N/A'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">User ID</span>
                  <span class="info-value">${userProfile.personalInfo?.userId || 'N/A'}</span>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h3><i class="fa fa-clock-o"></i> Thông tin hệ thống</h3>
              <div class="info-item">
                <span class="info-label">Ngày đăng ký</span>
                <span class="info-value">${new Date(registration.submittedAt).toLocaleString('vi-VN')}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Registration ID</span>
                <span class="info-value">${registrationId}</span>
              </div>
              <div class="info-item">
                <span class="info-label">User ID</span>
                <span class="info-value">${userId}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Đã duyệt</span>
                <span class="info-value">${registration.reviewed ? 'Có' : 'Chưa'}</span>
              </div>
            </div>
            
            <div class="info-section">
              <h3><i class="fa fa-book"></i> Sách của tác giả (${Object.keys(books).length})</h3>
              ${booksHTML}
            </div>
            
            <div class="info-section">
              <h3><i class="fa fa-pencil"></i> Truyện của tác giả (${Object.keys(stories).length})</h3>
              ${storiesHTML}
            </div>
          `;
        }).catch((error) => {
          console.error('Error getting user data:', error);
          document.getElementById('modalBody').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
              <h3>Lỗi!</h3>
              <p>Có lỗi khi lấy thông tin người dùng!</p>
            </div>
          `;
        });
      }).catch((error) => {
        console.error('Error getting registration data:', error);
        document.getElementById('modalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Có lỗi khi lấy thông tin đăng ký!</p>
          </div>
        `;
      });
    };

    window.toggleAuthorStatus = function(registrationId, currentStatus) {
      const { database, ref, set, get } = window.firebase;
      let newStatus;
      
      switch(currentStatus) {
        case 'approved':
          newStatus = 'blocked';
          break;
        case 'pending':
          newStatus = 'approved';
          break;
        case 'rejected':
          newStatus = 'approved';
          break;
        case 'blocked':
          newStatus = 'approved';
          break;
        default:
          newStatus = 'approved';
      }
      
      // Show confirmation dialog
      const actionText = newStatus === 'approved' ? 'duyệt' : 
                        newStatus === 'blocked' ? 'khóa' : 
                        newStatus === 'rejected' ? 'từ chối' : 'cập nhật';
      
      Swal.fire({
        title: 'Xác nhận hành động',
        text: `Bạn có chắc chắn muốn ${actionText} tác giả này?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Xác nhận',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73'
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang cập nhật...',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // First, get the registration data to find userId
          get(ref(database, `authorRegistrations/${registrationId}`)).then((snapshot) => {
            const regData = snapshot.val();
            if (regData && regData.userId) {
              const userId = regData.userId;
              
                             // Create promises for all updates
               // Note: Firebase rules prevent admin from writing to users/{userId}/authorRegistration
               // Only updating authorRegistrations node for now
               // TODO: Update Firebase rules to allow admin access to users node
               const updatePromises = [
                 set(ref(database, `authorRegistrations/${registrationId}/status`), newStatus)
               ];
               
               // Add reviewed field updates if approving
               if (newStatus === 'approved') {
                 updatePromises.push(
                   set(ref(database, `authorRegistrations/${registrationId}/reviewed`), true)
                 );
               }
              
              // Wait for all updates to complete
              Promise.all(updatePromises).then(() => {
                // Close loading and show success message
                loadingSwal.close();
                Swal.fire({
                  icon: 'success',
                  title: 'Thành công!',
                  html: `
                    <p>Đã ${actionText} tác giả thành công!</p>
                    <div style="text-align: left; margin-top: 15px; font-size: 12px; color: #666;">
                      <strong>Cập nhật:</strong><br>
                      • authorRegistrations/${registrationId}/status<br>
                      • users/${userId}/authorRegistration/status
                    </div>
                  `,
                  confirmButtonColor: '#22d3a3'
                });
              }).catch((updateError) => {
                console.error('Error updating status:', updateError);
                loadingSwal.close();
                Swal.fire({
                  icon: 'error',
                  title: 'Lỗi!',
                  text: 'Có lỗi xảy ra khi cập nhật trạng thái!',
                  confirmButtonColor: '#ff5e73'
                });
              });
            } else {
              // Close loading and show error
              loadingSwal.close();
              Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: 'Không tìm thấy thông tin đăng ký!',
                confirmButtonColor: '#ff5e73'
              });
            }
          }).catch((error) => {
            console.error('Error getting registration data:', error);
            // Close loading and show error
            loadingSwal.close();
            Swal.fire({
              icon: 'error',
              title: 'Lỗi!',
              text: 'Có lỗi xảy ra khi lấy thông tin đăng ký!',
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    };

    // Delete author function
    window.deleteAuthor = function(registrationId, userId, penName) {
      Swal.fire({
        title: 'Xác nhận xóa tác giả',
        html: `
          <div style="text-align: left;">
            <p><strong>Bạn có chắc chắn muốn xóa tác giả này?</strong></p>
            <p><strong>Bút danh:</strong> ${penName}</p>
            <p><strong>ID:</strong> ${registrationId}</p>
            <br>
            <p style="color: #ff5e73; font-weight: bold;">⚠️ Hành động này không thể hoàn tác!</p>
            <p style="font-size: 12px; color: #666;">
              Dữ liệu sẽ bị xóa vĩnh viễn khỏi:
              <br>• authorRegistrations/${registrationId}
              <br>• users/${userId}/authorRegistration
            </p>
          </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa vĩnh viễn',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang xóa...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          const { database, ref, remove } = window.firebase;

          // Delete from authorRegistrations first
          remove(ref(database, `authorRegistrations/${registrationId}`)).then(() => {
            console.log('Successfully deleted from authorRegistrations');
            
            // Try to delete from users/{userId}/authorRegistration
            return remove(ref(database, `users/${userId}/authorRegistration`)).catch((userError) => {
              console.log('User authorRegistration might not exist or already deleted:', userError);
              // Continue even if user deletion fails
              return Promise.resolve();
            });
          }).then(() => {
            // Close loading and show success
            loadingSwal.close();
            Swal.fire({
              icon: 'success',
              title: 'Đã xóa thành công!',
              html: `
                <p>Tác giả <strong>${penName}</strong> đã được xóa vĩnh viễn.</p>
                <div style="text-align: left; margin-top: 15px; font-size: 12px; color: #666;">
                  <strong>Đã xóa:</strong><br>
                  • authorRegistrations/${registrationId}<br>
                  • users/${userId}/authorRegistration (nếu tồn tại)
                </div>
              `,
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error deleting author:', error);
            loadingSwal.close();
            Swal.fire({
              icon: 'error',
              title: 'Lỗi khi xóa!',
              text: `Có lỗi xảy ra trong quá trình xóa: ${error.message}`,
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    };

    // Show books and stories management panel
    function showBooksAndStoriesPanel() {
      const panels = document.querySelectorAll('.panel');
      
      // Hide all panels
      panels.forEach(panel => {
        panel.style.display = 'none';
      });
      
      // Explicitly hide author panel
      const authorPanel = document.getElementById('author-panel');
      if (authorPanel) {
        authorPanel.style.display = 'none';
      }
      
      // Create or show books and stories panel
      let booksStoriesPanel = document.getElementById('books-stories-panel');
      if (!booksStoriesPanel) {
        booksStoriesPanel = createBooksStoriesPanel();
        document.querySelector('.grid').appendChild(booksStoriesPanel);
      }
      
      booksStoriesPanel.style.display = 'block';
      
      // Reset loaded flags to ensure fresh data loading
      resetLoadedFlags();
      
      // Load initial data
      loadBooksData();
      getBooksCount();
      getStoriesCount();
    }

    // Create books and stories management panel
    function createBooksStoriesPanel() {
      const panel = document.createElement('div');
      panel.id = 'books-stories-panel';
      panel.className = 'panel';
      panel.style.gridColumn = '1 / -1';
      panel.style.height = 'calc(100vh - 200px)';
      panel.style.minHeight = '600px';
      panel.style.maxHeight = 'calc(100vh - 200px)';
      panel.style.overflow = 'hidden';
      panel.style.borderRadius = 'var(--radius)';
      panel.style.background = 'var(--card)';
      panel.style.backdropFilter = 'var(--glass)';
      panel.style.border = '1px solid var(--stroke)';
      panel.style.boxShadow = 'var(--shadow-3d)';
      
      panel.innerHTML = `
        <div style="padding: 24px; height: 100%; display: flex; flex-direction: column;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--text); font-size: 1.5rem; font-weight: 600;">Quản lý Sách và Truyện</h3>
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="openAddBookModal()" style="background: var(--success); color: white;">
                <i class="fa fa-plus"></i> Thêm sách
              </button>
              <button class="btn" onclick="openAddStoryModal()" style="background: var(--success); color: white;">
                <i class="fa fa-plus"></i> Thêm truyện
              </button>
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <button class="btn" onclick="switchTab('books')" id="books-tab" style="margin-right: 10px; background: var(--primary); color: white;">
              <i class="fa fa-book"></i> Sách (${getBooksCount()})
            </button>
            <button class="btn" onclick="switchTab('stories')" id="stories-tab">
              <i class="fa fa-file-text"></i> Truyện (${getStoriesCount()})
            </button>
          </div>
        
                 <div id="books-content" class="tab-content" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; visibility: visible;">
           <div style="overflow: auto; flex: 1; padding: 0;">
             <table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 2px 12px rgba(124,92,255,.08);min-width:900px;">
               <thead style="background:rgba(124,92,255,.12);position:sticky;top:0;z-index:10;">
                 <tr>
                   <th style="padding:16px 12px;text-align:left;color:var(--primary);font-weight:700;width:80px;">Bìa</th>
                   <th style="padding:16px 12px;text-align:left;width:250px;">Tên sách</th>
                   <th style="padding:16px 12px;text-align:left;width:150px;">Tác giả</th>
                   <th style="padding:16px 12px;text-align:left;width:120px;">Thể loại</th>
                   <th style="padding:16px 12px;text-align:left;width:100px;">Giá</th>
                   <th style="padding:16px 12px;text-align:left;width:100px;">Trạng thái</th>
                   <th style="padding:16px 12px;text-align:left;width:150px;">Tác vụ</th>
                 </tr>
               </thead>
               <tbody id="booksTableBody" style="border-top: none;">
                 <!-- Books will be loaded here -->
               </tbody>
             </table>
           </div>
         </div>
        
                 <div id="stories-content" class="tab-content" style="display: none; flex: 1; overflow: hidden; flex-direction: column; visibility: hidden;">
           <div style="overflow: auto; flex: 1; padding: 0;">
             <table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,.04);border-radius:12px;box-shadow:0 2px 12px rgba(124,92,255,.08);min-width:900px;">
               <thead style="background:rgba(124,92,255,.12);position:sticky;top:0;z-index:10;">
                 <tr>
                   <th style="padding:16px 12px;text-align:left;color:var(--primary);font-weight:700;width:80px;">Bìa</th>
                   <th style="padding:16px 12px;text-align:left;width:250px;">Tên truyện</th>
                   <th style="padding:16px 12px;text-align:left;width:150px;">Tác giả</th>
                   <th style="padding:16px 12px;text-align:left;width:120px;">Thể loại</th>
                   <th style="padding:16px 12px;text-align:left;width:100px;">Giá</th>
                   <th style="padding:16px 12px;text-align:left;width:80px;">Chương</th>
                   <th style="padding:16px 12px;text-align:left;width:100px;">Trạng thái</th>
                   <th style="padding:16px 12px;text-align:left;width:150px;">Tác vụ</th>
                 </tr>
               </thead>
               <tbody id="storiesTableBody" style="border-top: none;">
                 <!-- Stories will be loaded here -->
               </tbody>
             </table>
           </div>
         </div>
      `;
      
      return panel;
    }

    // Switch between books and stories tabs
    window.switchTab = function(tab) {
      const booksContent = document.getElementById('books-content');
      const storiesContent = document.getElementById('stories-content');
      const booksTab = document.getElementById('books-tab');
      const storiesTab = document.getElementById('stories-tab');
      
      if (tab === 'books') {
        booksContent.style.display = 'flex';
        booksContent.style.visibility = 'visible';
        storiesContent.style.display = 'none';
        storiesContent.style.visibility = 'hidden';
        booksTab.style.background = 'var(--primary)';
        booksTab.style.color = 'white';
        storiesTab.style.background = 'var(--card)';
        storiesTab.style.color = 'var(--text)';
        
        // Always load books data when switching to books tab
        loadBooksData();
      } else {
        booksContent.style.display = 'none';
        booksContent.style.visibility = 'hidden';
        storiesContent.style.display = 'flex';
        storiesContent.style.visibility = 'visible';
        storiesTab.style.background = 'var(--primary)';
        storiesTab.style.color = 'white';
        booksTab.style.background = 'var(--card)';
        booksTab.style.color = 'var(--text)';
        
        // Always load stories data when switching to stories tab
        loadStoriesData();
      }
    }

    // Global variables to track if data is loaded
    let booksLoaded = false;
    let storiesLoaded = false;

    // Load books data from Firebase
    function loadBooksData() {
      const { database, ref, onValue, get } = window.firebase;
      const booksRef = ref(database, 'Books');
      
      // Only set up listener if not already loaded
      if (!booksLoaded) {
        booksLoaded = true;
        
        // Set up listener for real-time updates
        onValue(booksRef, (snapshot) => {
          const books = snapshot.val();
          if (books) {
            updateBooksTable(books);
          }
        });
      }
      
      // Always get current data for immediate display
      get(booksRef).then((snapshot) => {
        const books = snapshot.val();
        if (books) {
          updateBooksTable(books);
        }
      }).catch((error) => {
        console.error('Error loading books data:', error);
      });
    }

    // Load stories data from Firebase
    function loadStoriesData() {
      const { database, ref, onValue, get } = window.firebase;
      const storiesRef = ref(database, 'Stories');
      
      // Only set up listener if not already loaded
      if (!storiesLoaded) {
        storiesLoaded = true;
        
        // Set up listener for real-time updates
        onValue(storiesRef, (snapshot) => {
          const stories = snapshot.val();
          if (stories) {
            updateStoriesTable(stories);
          }
        });
      }
      
      // Always get current data for immediate display
      get(storiesRef).then((snapshot) => {
        const stories = snapshot.val();
        if (stories) {
          updateStoriesTable(stories);
        }
      }).catch((error) => {
        console.error('Error loading stories data:', error);
      });
    }

    // Update books table
    function updateBooksTable(books) {
      const tbody = document.getElementById('booksTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(books).forEach(bookId => {
        const book = books[bookId];
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.08)';
        
        const priceText = book.is_free ? 'Miễn phí' : `${book.price?.toLocaleString('vi-VN')}đ`;
        const statusText = book.is_member_only ? 'VIP' : book.is_featured ? 'Nổi bật' : 'Thường';
        const statusColor = book.is_member_only ? 'var(--danger)' : book.is_featured ? 'var(--warning)' : 'var(--success)';
        
                 row.innerHTML = `
           <td style="padding:16px 12px;">
             <img src="${book.cover_image}" alt="${book.title}" style="width:50px;height:70px;object-fit:cover;border-radius:8px;border:1px solid var(--stroke);">
           </td>
           <td style="padding:16px 12px;">
             <strong>${book.title}</strong>
             <br><small style="color:var(--muted);">${book.description?.substring(0, 50)}...</small>
           </td>
           <td style="padding:16px 12px;">${book.author}</td>
           <td style="padding:16px 12px;">${book.genre}</td>
           <td style="padding:16px 12px;">${priceText}</td>
           <td style="padding:16px 12px;">
             <span style="color:${statusColor};font-weight:600;">${statusText}</span>
           </td>
           <td style="padding:16px 12px;">
             <button class="btn" onclick="viewBookDetails('${bookId}')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
             <button class="btn" onclick="editBook('${bookId}')" style="margin-right:8px;"><i class="fa fa-edit"></i></button>
             <button class="btn" onclick="deleteBook('${bookId}', '${book.title}')" style="background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);">
               <i class="fa fa-trash"></i>
             </button>
           </td>
         `;
        
        tbody.appendChild(row);
      });
    }

    // Update stories table
    function updateStoriesTable(stories) {
      const tbody = document.getElementById('storiesTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(stories).forEach(storyId => {
        const story = stories[storyId];
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.08)';
        
        const statusText = story.is_member_only ? 'VIP' : story.is_featured ? 'Nổi bật' : 'Thường';
        const statusColor = story.is_member_only ? 'var(--danger)' : story.is_featured ? 'var(--warning)' : 'var(--success)';
        
                 row.innerHTML = `
           <td style="padding:16px 12px;">
             <img src="${story.cover_image}" alt="${story.title}" style="width:50px;height:70px;object-fit:cover;border-radius:8px;border:1px solid var(--stroke);">
           </td>
           <td style="padding:16px 12px;">
             <strong>${story.title}</strong>
             <br><small style="color:var(--muted);">${story.description?.substring(0, 50)}...</small>
           </td>
           <td style="padding:16px 12px;">${story.author}</td>
           <td style="padding:16px 12px;">${story.genre}</td>
           <td style="padding:16px 12px;">
             ${story.price > 0 ? `<span style="color:var(--success);font-weight:600;">${story.price.toLocaleString()}đ</span>` : '<span style="color:var(--success);font-weight:600;">Miễn phí</span>'}
           </td>
           <td style="padding:16px 12px;">${story.chapters}</td>
           <td style="padding:16px 12px;">
             <span style="color:${statusColor};font-weight:600;">${statusText}</span>
           </td>
           <td style="padding:16px 12px;">
             <button class="btn" onclick="viewStoryDetails('${storyId}')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
             <button class="btn" onclick="editStory('${storyId}')" style="margin-right:8px;"><i class="fa fa-edit"></i></button>
             <button class="btn" onclick="deleteStory('${storyId}', '${story.title}')" style="background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);">
               <i class="fa fa-trash"></i>
             </button>
           </td>
         `;
        
        tbody.appendChild(row);
      });
    }

    // Reset loaded flags when needed
    function resetLoadedFlags() {
      booksLoaded = false;
      storiesLoaded = false;
    }

    // Helper functions to get counts
    function getBooksCount() {
      const { database, ref, get } = window.firebase;
      const booksRef = ref(database, 'Books');
      
      get(booksRef).then((snapshot) => {
        const books = snapshot.val();
        const count = books ? Object.keys(books).length : 0;
        const booksTab = document.getElementById('books-tab');
        if (booksTab) {
          booksTab.innerHTML = `<i class="fa fa-book"></i> Sách (${count})`;
        }
      }).catch((error) => {
        console.error('Error getting books count:', error);
      });
      
      return '...';
    }

    function getStoriesCount() {
      const { database, ref, get } = window.firebase;
      const storiesRef = ref(database, 'Stories');
      
      get(storiesRef).then((snapshot) => {
        const stories = snapshot.val();
        const count = stories ? Object.keys(stories).length : 0;
        const storiesTab = document.getElementById('stories-tab');
        if (storiesTab) {
          storiesTab.innerHTML = `<i class="fa fa-file-text"></i> Truyện (${count})`;
        }
      }).catch((error) => {
        console.error('Error getting stories count:', error);
      });
      
      return '...';
    }

    // Action functions for books
    window.viewBookDetails = function(bookId) {
      const { database, ref, get } = window.firebase;
      const bookRef = ref(database, `Books/${bookId}`);
      
      // Show loading in modal
      document.getElementById('bookModalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('bookModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin sách...</p>
        </div>
      `;
      openBookModal();
      
      get(bookRef).then((snapshot) => {
        const book = snapshot.val();
        if (book) {
          const statusText = book.is_member_only ? 'VIP' : book.is_featured ? 'Nổi bật' : 'Thường';
          const statusColor = book.is_member_only ? 'var(--danger)' : book.is_featured ? 'var(--warning)' : 'var(--success)';
          
          document.getElementById('bookModalTitle').textContent = `Chi tiết sách: ${book.title}`;
          document.getElementById('bookModalBody').innerHTML = `
            <div class="book-header">
              <img src="${book.cover_image}" alt="${book.title}" class="book-cover" onerror="this.src='images/books/img-01.jpg'">
              <div class="book-details">
                <h1>${book.title}</h1>
                <p>${book.author}</p>
                <p>${book.genre}</p>
                <span class="status-badge" style="color: ${statusColor}; border-color: ${statusColor}; background: ${statusColor}20;">
                  <i class="fa fa-${book.is_member_only ? 'star' : book.is_featured ? 'star' : 'book'}"></i>
                  ${statusText}
                </span>
              </div>
            </div>
            
            <div class="author-info-grid">
              <div class="info-section">
                <h3><i class="fa fa-info-circle"></i> Thông tin cơ bản</h3>
                <div class="info-item">
                  <span class="info-label">Tác giả</span>
                  <span class="info-value">${book.author}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Thể loại</span>
                  <span class="info-value">${book.genre}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Giá</span>
                  <span class="info-value">${book.is_free ? 'Miễn phí' : book.price?.toLocaleString('vi-VN') + 'đ'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Số trang</span>
                  <span class="info-value">${book.pages || 'Chưa có'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ngôn ngữ</span>
                  <span class="info-value">${book.language || 'Tiếng Việt'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Định dạng</span>
                  <span class="info-value">${book.format || 'Bìa mềm'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Kích thước</span>
                  <span class="info-value">${book.size || 'Chưa có'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Trọng lượng</span>
                  <span class="info-value">${book.weight ? book.weight + 'g' : 'Chưa có'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Nhà xuất bản</span>
                  <span class="info-value">${book.publisher || 'Chưa có'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ISBN</span>
                  <span class="info-value">${book.isbn || 'Chưa có'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Danh mục</span>
                  <span class="info-value">${book.category || 'Chưa có'}</span>
                </div>
              </div>
              
              <div class="info-section">
                <h3><i class="fa fa-chart-line"></i> Thống kê</h3>
                <div class="info-item">
                  <span class="info-label">Lượt xem</span>
                  <span class="info-value">${book.view_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Lượt tải</span>
                  <span class="info-value">${book.download_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Đánh giá</span>
                  <span class="info-value">${book.rating || 'Chưa có'} / 5</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Số đánh giá</span>
                  <span class="info-value">${book.review_count || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Tồn kho</span>
                  <span class="info-value">${book.stock || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Trạng thái</span>
                  <span class="info-value">${statusText}</span>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h3><i class="fa fa-calendar"></i> Thông tin xuất bản</h3>
              <div class="info-item">
                <span class="info-label">Ngày xuất bản</span>
                <span class="info-value">${book.publish_date || 'Chưa có'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Book ID</span>
                <span class="info-value">${book.book_id || bookId}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Mô tả</span>
                <span class="info-value">${book.description || 'Không có mô tả'}</span>
              </div>
            </div>
          `;
        } else {
          document.getElementById('bookModalBody').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
              <h3>Lỗi!</h3>
              <p>Không tìm thấy thông tin sách!</p>
            </div>
          `;
        }
      }).catch((error) => {
        console.error('Error fetching book details:', error);
        document.getElementById('bookModalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Không thể tải thông tin sách!</p>
          </div>
        `;
      });
    }

    window.editBook = function(bookId) {
      const { database, ref, get } = window.firebase;
      const bookRef = ref(database, `Books/${bookId}`);
      
      // Show loading in modal
      document.getElementById('editBookModalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('editBookModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin sách...</p>
        </div>
      `;
      openEditBookModal();
      
      get(bookRef).then((snapshot) => {
        const book = snapshot.val();
        if (book) {
          document.getElementById('editBookModalTitle').textContent = `Chỉnh sửa sách: ${book.title}`;
          document.getElementById('editBookModalBody').innerHTML = `
            <form id="editBookForm" style="text-align: left;">
              <div class="author-info-grid">
                <div class="info-section">
                  <h3><i class="fa fa-info-circle"></i> Thông tin cơ bản</h3>
                  <div class="form-group">
                    <label for="bookTitle">Tên sách *</label>
                    <input type="text" id="bookTitle" value="${book.title || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="bookAuthor">Tác giả *</label>
                    <input type="text" id="bookAuthor" value="${book.author || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="bookGenre">Thể loại *</label>
                    <input type="text" id="bookGenre" value="${book.genre || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="bookPrice">Giá (VNĐ)</label>
                    <input type="number" id="bookPrice" value="${book.price || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="bookPages">Số trang</label>
                    <input type="number" id="bookPages" value="${book.pages || ''}" min="1">
                  </div>
                  <div class="form-group">
                    <label for="bookLanguage">Ngôn ngữ</label>
                    <select id="bookLanguage">
                      <option value="Vietnamese" ${book.language === 'Vietnamese' ? 'selected' : ''}>Tiếng Việt</option>
                      <option value="English" ${book.language === 'English' ? 'selected' : ''}>Tiếng Anh</option>
                      <option value="Chinese" ${book.language === 'Chinese' ? 'selected' : ''}>Tiếng Trung</option>
                      <option value="Korean" ${book.language === 'Korean' ? 'selected' : ''}>Tiếng Hàn</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="bookFormat">Định dạng</label>
                    <select id="bookFormat">
                      <option value="Paperback" ${book.format === 'Paperback' ? 'selected' : ''}>Bìa mềm</option>
                      <option value="Hardcover" ${book.format === 'Hardcover' ? 'selected' : ''}>Bìa cứng</option>
                      <option value="Ebook" ${book.format === 'Ebook' ? 'selected' : ''}>Ebook</option>
                      <option value="Audiobook" ${book.format === 'Audiobook' ? 'selected' : ''}>Audiobook</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="bookSize">Kích thước</label>
                    <input type="text" id="bookSize" value="${book.size || ''}" placeholder="VD: 16x24cm">
                  </div>
                  <div class="form-group">
                    <label for="bookWeight">Trọng lượng (g)</label>
                    <input type="number" id="bookWeight" value="${book.weight || ''}" min="0" placeholder="VD: 400">
                  </div>
                  <div class="form-group">
                    <label>Ảnh bìa</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                                              <button type="button" onclick="openImageUpload()" class="btn" style="background: var(--primary);">
                          <i class="fa fa-cloud-upload"></i> Upload ảnh
                        </button>
                        <div id="imagePreview" style="flex: 1;">
                          ${book.cover_image ? `<img src="${book.cover_image}" alt="Current cover" style="max-width: 100px; max-height: 60px; border-radius: 4px;">` : '<span style="color: var(--muted);">Chưa có ảnh</span>'}
                        </div>
                    </div>
                    <input type="hidden" id="bookCoverImage" value="${book.cover_image || ''}">
                  </div>
                </div>
                
                <div class="info-section">
                  <h3><i class="fa fa-cog"></i> Cài đặt</h3>
                  <div class="form-group">
                    <label for="bookPublisher">Nhà xuất bản</label>
                    <input type="text" id="bookPublisher" value="${book.publisher || ''}">
                  </div>
                  <div class="form-group">
                    <label for="bookIsbn">ISBN</label>
                    <input type="text" id="bookIsbn" value="${book.isbn || ''}">
                  </div>
                  <div class="form-group">
                    <label for="bookPublishDate">Ngày xuất bản</label>
                    <input type="date" id="bookPublishDate" value="${book.publish_date || ''}">
                  </div>
                  <div class="form-group">
                    <label for="bookStock">Tồn kho</label>
                    <input type="number" id="bookStock" value="${book.stock || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="bookCategory">Danh mục</label>
                    <select id="bookCategory">
                      <option value="Featured Books" ${book.category === 'Featured Books' ? 'selected' : ''}>Featured Books</option>
                      <option value="New Books" ${book.category === 'New Books' ? 'selected' : ''}>New Books</option>
                      <option value="Best Sellers" ${book.category === 'Best Sellers' ? 'selected' : ''}>Best Sellers</option>
                      <option value="Classic Books" ${book.category === 'Classic Books' ? 'selected' : ''}>Classic Books</option>
                      <option value="Educational" ${book.category === 'Educational' ? 'selected' : ''}>Educational</option>
                      <option value="Fiction" ${book.category === 'Fiction' ? 'selected' : ''}>Fiction</option>
                      <option value="Non-Fiction" ${book.category === 'Non-Fiction' ? 'selected' : ''}>Non-Fiction</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="bookStatus">Trạng thái</label>
                    <select id="bookStatus">
                      <option value="normal" ${!book.is_member_only && !book.is_featured ? 'selected' : ''}>Thường</option>
                      <option value="featured" ${book.is_featured ? 'selected' : ''}>Nổi bật</option>
                      <option value="vip" ${book.is_member_only ? 'selected' : ''}>VIP</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="info-section">
                <h3><i class="fa fa-file-text"></i> Mô tả & Thống kê</h3>
                <div class="form-group">
                  <label for="bookDescription">Mô tả</label>
                  <textarea id="bookDescription" rows="4" style="width: 100%; resize: vertical;">${book.description || ''}</textarea>
                </div>
                <div class="form-group">
                  <label for="bookViewCount">Lượt xem</label>
                  <input type="number" id="bookViewCount" value="${book.view_count || 0}" min="0">
                </div>
                <div class="form-group">
                  <label for="bookDownloadCount">Lượt tải</label>
                  <input type="number" id="bookDownloadCount" value="${book.download_count || 0}" min="0">
                </div>
                <div class="form-group">
                  <label for="bookRating">Đánh giá</label>
                  <input type="number" id="bookRating" value="${book.rating || 0}" min="0" max="5" step="0.1">
                </div>
                <div class="form-group">
                  <label for="bookReviewCount">Số đánh giá</label>
                  <input type="number" id="bookReviewCount" value="${book.review_count || 0}" min="0">
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 24px;">
                <button type="button" onclick="closeEditBookModal()" class="btn" style="margin-right: 10px; background: var(--muted);">
                  <i class="fa fa-times"></i> Hủy
                </button>
                <button type="submit" class="btn" style="background: var(--success);">
                  <i class="fa fa-save"></i> Lưu thay đổi
                </button>
              </div>
            </form>
          `;
          
          // Add form submit handler
          document.getElementById('editBookForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveBookChanges(bookId);
          });
        } else {
          document.getElementById('editBookModalBody').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
              <h3>Lỗi!</h3>
              <p>Không tìm thấy thông tin sách!</p>
            </div>
          `;
        }
      }).catch((error) => {
        console.error('Error fetching book details:', error);
        document.getElementById('editBookModalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Không thể tải thông tin sách!</p>
          </div>
        `;
      });
    }

    window.deleteBook = function(bookId, title) {
      const { database, ref, remove } = window.firebase;
      
      Swal.fire({
        title: 'Xác nhận xóa sách',
        html: `
          <p>Bạn có chắc chắn muốn xóa sách <strong>"${title}"</strong>?</p>
          <p style="color: #ff5e73; font-size: 0.9rem; margin-top: 10px;">
            <i class="fa fa-exclamation-triangle"></i> 
            Hành động này không thể hoàn tác!
          </p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa vĩnh viễn',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang xóa...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Delete from Firebase (main data only)
          remove(ref(database, `Books/${bookId}`)).then(() => {
            // Try to delete related data silently (don't fail if they don't exist)
            const relatedDataPaths = [
              `BookComments/${bookId}`,
              `BookRatings/${bookId}`,
              `BookViews/${bookId}`
            ];
            
            // Delete related data without waiting for completion
            relatedDataPaths.forEach(path => {
              remove(ref(database, path)).catch(() => {
                // Silently ignore errors for related data
              });
            });
            
            loadingSwal.close();
            Swal.fire({
              title: 'Xóa thành công!',
              text: `Sách "${title}" đã được xóa khỏi hệ thống.`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            }).then(() => {
              // Reload data
              loadBooksData();
            });
          }).catch((error) => {
            console.error('Error deleting book:', error);
            loadingSwal.close();
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể xóa sách. Vui lòng thử lại.',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
            });
          });
          
          Promise.all(deletePromises).then(() => {
            loadingSwal.close();
            Swal.fire({
              title: 'Xóa thành công!',
              text: `Sách "${title}" đã được xóa khỏi hệ thống.`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            }).then(() => {
              // Reload data
              loadBooksData();
            });
          }).catch((error) => {
            console.error('Error deleting book:', error);
            loadingSwal.close();
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể xóa sách. Vui lòng thử lại.',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    }

    // Action functions for stories
    window.viewStoryDetails = function(storyId) {
      const { database, ref, get } = window.firebase;
      const storyRef = ref(database, `Stories/${storyId}`);
      
      // Show loading in modal
      document.getElementById('storyModalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('storyModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin truyện...</p>
        </div>
      `;
      openStoryModal();
      
      get(storyRef).then((snapshot) => {
        const story = snapshot.val();
        if (story) {
          const statusText = story.is_member_only ? 'VIP' : story.is_featured ? 'Nổi bật' : 'Thường';
          const statusColor = story.is_member_only ? 'var(--danger)' : story.is_featured ? 'var(--warning)' : 'var(--success)';
          
          document.getElementById('storyModalTitle').textContent = `Chi tiết truyện: ${story.title}`;
          document.getElementById('storyModalBody').innerHTML = `
            <div class="story-header">
              <img src="${story.cover_image}" alt="${story.title}" class="story-cover" onerror="this.src='images/books/img-01.jpg'">
              <div class="story-details">
                <h1>${story.title}</h1>
                <p>${story.author}</p>
                <p>${story.genre}</p>
                <span class="status-badge" style="color: ${statusColor}; border-color: ${statusColor}; background: ${statusColor}20;">
                  <i class="fa fa-${story.is_member_only ? 'star' : story.is_featured ? 'star' : 'file-text'}"></i>
                  ${statusText}
                </span>
              </div>
            </div>
            
            <div class="author-info-grid">
              <div class="info-section">
                <h3><i class="fa fa-info-circle"></i> Thông tin cơ bản</h3>
                <div class="info-item">
                  <span class="info-label">Tác giả</span>
                  <span class="info-value">${story.author}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Thể loại</span>
                  <span class="info-value">${story.genre}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Giá</span>
                  <span class="info-value">${story.price > 0 ? story.price.toLocaleString('vi-VN') + 'đ' : 'Miễn phí'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Số chương</span>
                  <span class="info-value">${story.chapters}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Trạng thái</span>
                  <span class="info-value">${story.status || 'Đang cập nhật'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ngôn ngữ</span>
                  <span class="info-value">${story.language || 'Tiếng Việt'}</span>
                </div>
              </div>
              
              <div class="info-section">
                <h3><i class="fa fa-chart-line"></i> Thống kê</h3>
                <div class="info-item">
                  <span class="info-label">Lượt xem</span>
                  <span class="info-value">${story.view_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Lượt thích</span>
                  <span class="info-value">${story.favorite_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Bình luận</span>
                  <span class="info-value">${story.comment_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Đánh giá</span>
                  <span class="info-value">${story.rating || 'Chưa có'} / 5</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Số đánh giá</span>
                  <span class="info-value">${story.review_count || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Số từ</span>
                  <span class="info-value">${story.word_count?.toLocaleString('vi-VN') || 0}</span>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h3><i class="fa fa-calendar"></i> Thông tin xuất bản</h3>
              <div class="info-item">
                <span class="info-label">Ngày xuất bản</span>
                <span class="info-value">${story.publish_date || 'Chưa có'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Cập nhật lần cuối</span>
                <span class="info-value">${story.last_updated ? new Date(story.last_updated).toLocaleDateString('vi-VN') : 'Chưa có'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Story ID</span>
                <span class="info-value">${story.story_id || storyId}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Mô tả</span>
                <span class="info-value">${story.description || 'Không có mô tả'}</span>
              </div>
            </div>
          `;
        } else {
          document.getElementById('storyModalBody').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
              <h3>Lỗi!</h3>
              <p>Không tìm thấy thông tin truyện!</p>
            </div>
          `;
        }
      }).catch((error) => {
        console.error('Error fetching story details:', error);
        document.getElementById('storyModalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Không thể tải thông tin truyện!</p>
          </div>
        `;
      });
    }

    window.editStory = function(storyId) {
      const { database, ref, get } = window.firebase;
      const storyRef = ref(database, `Stories/${storyId}`);
      
      // Show loading in modal
      document.getElementById('editStoryModalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('editStoryModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin truyện...</p>
        </div>
      `;
      openEditStoryModal();
      
      get(storyRef).then((snapshot) => {
        const story = snapshot.val();
        if (story) {
          document.getElementById('editStoryModalTitle').textContent = `Chỉnh sửa truyện: ${story.title}`;
          document.getElementById('editStoryModalBody').innerHTML = `
            <form id="editStoryForm" style="text-align: left;">
              <div class="author-info-grid">
                <div class="info-section">
                  <h3><i class="fa fa-info-circle"></i> Thông tin cơ bản</h3>
                  <div class="form-group">
                    <label for="storyTitle">Tên truyện *</label>
                    <input type="text" id="storyTitle" value="${story.title || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="storyAuthor">Tác giả *</label>
                    <input type="text" id="storyAuthor" value="${story.author || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="storyCategoryCode">Mã danh mục</label>
                    <select id="storyCategoryCode">
                      <option value="">Chọn danh mục</option>
                      <option value="TM001" ${story.category_code === 'TM001' ? 'selected' : ''}>TM001 - Truyện mới</option>
                      <option value="TNB002" ${story.category_code === 'TNB002' ? 'selected' : ''}>TNB002 - Truyện nổi bật</option>
                      <option value="THV004" ${story.category_code === 'THV004' ? 'selected' : ''}>THV004 - Truyện hội viên</option>
                      <option value="TMF003" ${story.category_code === 'TMF003' ? 'selected' : ''}>TMF003 - Truyện miễn phí</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="storyCategoryName">Tên danh mục</label>
                    <input type="text" id="storyCategoryName" value="${story.category_name || ''}" placeholder="VD: New Stories, Featured Stories...">
                  </div>
                  <div class="form-group">
                    <label for="storyGenre">Thể loại *</label>
                    <select id="storyGenre" required>
                      <option value="">Chọn thể loại</option>
                      <option value="Thơ" ${story.genre === 'Thơ' ? 'selected' : ''}>Thơ</option>
                      <option value="Cổ tích" ${story.genre === 'Cổ tích' ? 'selected' : ''}>Cổ tích</option>
                      <option value="Truyện ngắn" ${story.genre === 'Truyện ngắn' ? 'selected' : ''}>Truyện ngắn</option>
                      <option value="Tình cảm" ${story.genre === 'Tình cảm' ? 'selected' : ''}>Tình cảm</option>
                      <option value="Tiểu thuyết" ${story.genre === 'Tiểu thuyết' ? 'selected' : ''}>Tiểu thuyết</option>
                      <option value="Phiêu lưu" ${story.genre === 'Phiêu lưu' ? 'selected' : ''}>Phiêu lưu</option>
                      <option value="Trinh thám" ${story.genre === 'Trinh thám' ? 'selected' : ''}>Trinh thám</option>
                      <option value="Kinh dị" ${story.genre === 'Kinh dị' ? 'selected' : ''}>Kinh dị</option>
                      <option value="Hài hước" ${story.genre === 'Hài hước' ? 'selected' : ''}>Hài hước</option>
                      <option value="Lịch sử" ${story.genre === 'Lịch sử' ? 'selected' : ''}>Lịch sử</option>
                      <option value="Thiếu nhi" ${story.genre === 'Thiếu nhi' ? 'selected' : ''}>Thiếu nhi</option>
                      <option value="Tùy bút" ${story.genre === 'Tùy bút' ? 'selected' : ''}>Tùy bút</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="storyTags">Tags</label>
                    <input type="text" id="storyTags" value="${Array.isArray(story.tags) ? story.tags.join(', ') : ''}" placeholder="VD: thơ, Nguyễn Du, văn học cổ điển (phân cách bằng dấu phẩy)">
                  </div>
                  <div class="form-group">
                    <label for="storyPrice">Giá (VNĐ)</label>
                    <input type="number" id="storyPrice" value="${story.price || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="storyOriginalPrice">Giá gốc (VNĐ)</label>
                    <input type="number" id="storyOriginalPrice" value="${story.original_price || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="storyChapters">Số chương</label>
                    <input type="number" id="storyChapters" value="${story.chapters || 0}" min="1">
                  </div>
                  <div class="form-group">
                    <label for="storyWordCount">Số từ</label>
                    <input type="number" id="storyWordCount" value="${story.word_count || 0}" min="0">
                        </div>
                  <div class="form-group">
                    <label for="storyLanguage">Ngôn ngữ</label>
                    <select id="storyLanguage">
                      <option value="Vietnamese" ${story.language === 'Vietnamese' ? 'selected' : ''}>Tiếng Việt</option>
                      <option value="English" ${story.language === 'English' ? 'selected' : ''}>Tiếng Anh</option>
                      <option value="Chinese" ${story.language === 'Chinese' ? 'selected' : ''}>Tiếng Trung</option>
                      <option value="Korean" ${story.language === 'Korean' ? 'selected' : ''}>Tiếng Hàn</option>
                      <option value="Japanese" ${story.language === 'Japanese' ? 'selected' : ''}>Tiếng Nhật</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="storyStatus">Trạng thái</label>
                    <select id="storyStatus">
                      <option value="Ongoing" ${story.status === 'Ongoing' ? 'selected' : ''}>Đang cập nhật</option>
                      <option value="Completed" ${story.status === 'Completed' ? 'selected' : ''}>Hoàn thành</option>
                      <option value="Paused" ${story.status === 'Paused' ? 'selected' : ''}>Tạm dừng</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="storyPublishDate">Ngày xuất bản</label>
                    <input type="date" id="storyPublishDate" value="${story.publish_date || ''}">
                  </div>
                  <div class="form-group">
                    <label for="storyLastUpdated">Cập nhật lần cuối</label>
                    <input type="date" id="storyLastUpdated" value="${story.last_updated || ''}">
                  </div>
                  <div class="form-group">
                    <label for="storyPublisher">Nhà xuất bản</label>
                    <input type="text" id="storyPublisher" value="${story.publisher || ''}" placeholder="VD: AnBok Collection, Tác giả tự xuất bản...">
                  </div>
                  <div class="form-group">
                    <label for="storyStoryId">Mã truyện</label>
                    <input type="text" id="storyStoryId" value="${story.story_id || ''}" placeholder="VD: ST001, ST002...">
                  </div>
                  <div class="form-group">
                    <label>Ảnh bìa</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                      <button type="button" onclick="openImageUpload()" class="btn" style="background: var(--primary);">
                        <i class="fa fa-cloud-upload"></i> Upload ảnh
                      </button>
                      <div id="imagePreview" style="flex: 1;">
                        ${story.cover_image ? `<img src="${story.cover_image}" alt="Current cover" style="max-width: 100px; max-height: 60px; border-radius: 4px;">` : '<span style="color: var(--muted);">Chưa có ảnh</span>'}
                      </div>
                    </div>
                    <input type="hidden" id="storyCoverImage" value="${story.cover_image || ''}">
                  </div>
                </div>
                
                <div class="info-section">
                  <h3><i class="fa fa-cog"></i> Cài đặt & Thống kê</h3>
                  <div class="form-group">
                    <label for="storyDisplayStatus">Hiển thị</label>
                    <select id="storyDisplayStatus">
                      <option value="normal" ${!story.is_member_only && !story.is_featured ? 'selected' : ''}>Thường</option>
                      <option value="featured" ${story.is_featured ? 'selected' : ''}>Nổi bật</option>
                      <option value="vip" ${story.is_member_only ? 'selected' : ''}>VIP</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="storyRating">Đánh giá</label>
                    <input type="number" id="storyRating" value="${story.rating || 0}" min="0" max="5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label for="storyReviewCount">Số lượt đánh giá</label>
                    <input type="number" id="storyReviewCount" value="${story.review_count || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="storyViewCount">Lượt xem</label>
                    <input type="number" id="storyViewCount" value="${story.view_count || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="storyFavoriteCount">Lượt yêu thích</label>
                    <input type="number" id="storyFavoriteCount" value="${story.favorite_count || 0}" min="0">
                  </div>
                  <div class="form-group">
                    <label for="storyCommentCount">Số bình luận</label>
                    <input type="number" id="storyCommentCount" value="${story.comment_count || 0}" min="0">
                  </div>
                </div>
              </div>
              
              <div class="info-section">
                <h3><i class="fa fa-file-text"></i> Mô tả</h3>
                <div class="form-group">
                  <label for="storyDescription">Mô tả</label>
                  <textarea id="storyDescription" rows="4" style="width: 100%; resize: vertical;">${story.description || ''}</textarea>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 24px;">
                <button type="button" onclick="closeEditStoryModal()" class="btn" style="margin-right: 10px; background: var(--muted);">
                  <i class="fa fa-times"></i> Hủy
                </button>
                <button type="submit" class="btn" style="background: var(--success);">
                  <i class="fa fa-save"></i> Lưu thay đổi
                </button>
              </div>
            </form>
          `;
          
          // Add form submit handler
          document.getElementById('editStoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveStoryChanges(storyId);
          });
        } else {
          document.getElementById('editStoryModalBody').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
              <h3>Lỗi!</h3>
              <p>Không tìm thấy thông tin truyện!</p>
            </div>
          `;
        }
      }).catch((error) => {
        console.error('Error fetching story details:', error);
        document.getElementById('editStoryModalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Không thể tải thông tin truyện!</p>
          </div>
        `;
      });
    }

    window.deleteStory = function(storyId, title) {
      const { database, ref, remove } = window.firebase;
      
      Swal.fire({
        title: 'Xác nhận xóa truyện',
        html: `
          <p>Bạn có chắc chắn muốn xóa truyện <strong>"${title}"</strong>?</p>
          <p style="color: #ff5e73; font-size: 0.9rem; margin-top: 10px;">
            <i class="fa fa-exclamation-triangle"></i> 
            Hành động này không thể hoàn tác!
          </p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa vĩnh viễn',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang xóa...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          // Delete from Firebase (main data only)
          remove(ref(database, `Stories/${storyId}`)).then(() => {
            // Try to delete related data silently (don't fail if they don't exist)
            const relatedDataPaths = [
              `StoryComments/${storyId}`,
              `StoryRatings/${storyId}`,
              `StoryViews/${storyId}`,
              `StoryFavorites/${storyId}`
            ];
            
            // Delete related data without waiting for completion
            relatedDataPaths.forEach(path => {
              remove(ref(database, path)).catch(() => {
                // Silently ignore errors for related data
              });
            });
            
            loadingSwal.close();
            Swal.fire({
              title: 'Xóa thành công!',
              text: `Truyện "${title}" đã được xóa khỏi hệ thống.`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            }).then(() => {
              // Reload data
              loadStoriesData();
            });
          }).catch((error) => {
            console.error('Error deleting story:', error);
            loadingSwal.close();
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể xóa truyện. Vui lòng thử lại.',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    }

    // Save book changes
    function saveBookChanges(bookId) {
      const { database, ref, set } = window.firebase;
      
      // Get form values
      const title = document.getElementById('bookTitle').value;
      const author = document.getElementById('bookAuthor').value;
      const genre = document.getElementById('bookGenre').value;
      const price = parseInt(document.getElementById('bookPrice').value) || 0;
      const pages = parseInt(document.getElementById('bookPages').value) || 0;
      const language = document.getElementById('bookLanguage').value;
      const format = document.getElementById('bookFormat').value;
      const size = document.getElementById('bookSize').value;
      const weight = parseInt(document.getElementById('bookWeight').value) || 0;
      const publisher = document.getElementById('bookPublisher').value;
      const isbn = document.getElementById('bookIsbn').value;
      const publishDate = document.getElementById('bookPublishDate').value;
      const stock = parseInt(document.getElementById('bookStock').value) || 0;
      const category = document.getElementById('bookCategory').value;
      const status = document.getElementById('bookStatus').value;
      const description = document.getElementById('bookDescription').value;
      const coverImage = document.getElementById('bookCoverImage').value;
      const viewCount = parseInt(document.getElementById('bookViewCount').value) || 0;
      const downloadCount = parseInt(document.getElementById('bookDownloadCount').value) || 0;
      const rating = parseFloat(document.getElementById('bookRating').value) || 0;
      const reviewCount = parseInt(document.getElementById('bookReviewCount').value) || 0;

      // Validate required fields
      if (!title || !author || !genre) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng điền đầy đủ thông tin bắt buộc (*)',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang lưu...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Prepare update data
      const updateData = {
        title: title,
        author: author,
        genre: genre,
        price: price,
        pages: pages,
        language: language,
        format: format,
        size: size,
        weight: weight,
        publisher: publisher,
        isbn: isbn,
        publish_date: publishDate,
        stock: stock,
        category: category,
        description: description,
        cover_image: coverImage,
        view_count: viewCount,
        download_count: downloadCount,
        rating: rating,
        review_count: reviewCount,
        is_free: price === 0,
        is_featured: status === 'featured',
        is_member_only: status === 'vip'
      };

      // Update in Firebase
      try {
        set(ref(database, `Books/${bookId}`), updateData).then(() => {
          loadingSwal.close();
          Swal.fire({
            title: 'Thành công!',
            text: 'Thông tin sách đã được cập nhật',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          }).then(() => {
            closeEditBookModal();
            // Reload data
            loadBooksData();
          });
        }).catch((error) => {
          console.error('Error updating book:', error);
          loadingSwal.close();
          Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể cập nhật thông tin sách',
            icon: 'error',
            confirmButtonColor: '#ff5e73'
          });
        });
      } catch (error) {
        console.error('Error in saveBookChanges:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Có lỗi xảy ra khi lưu thông tin sách',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      }
    }

    // Save story changes
    function saveStoryChanges(storyId) {
      const { database, ref, set } = window.firebase;
      
      // Get form values
      const title = document.getElementById('storyTitle').value;
      const author = document.getElementById('storyAuthor').value;
      const categoryCode = document.getElementById('storyCategoryCode').value;
      const categoryName = document.getElementById('storyCategoryName').value;
      const genre = document.getElementById('storyGenre').value;
      const tags = document.getElementById('storyTags').value;
      const price = parseInt(document.getElementById('storyPrice').value) || 0;
      const originalPrice = parseInt(document.getElementById('storyOriginalPrice').value) || 0;
      const chapters = parseInt(document.getElementById('storyChapters').value) || 0;
      const wordCount = parseInt(document.getElementById('storyWordCount').value) || 0;
      const language = document.getElementById('storyLanguage').value;
      const status = document.getElementById('storyStatus').value;
      const publishDate = document.getElementById('storyPublishDate').value;
      const lastUpdated = document.getElementById('storyLastUpdated').value;
      const publisher = document.getElementById('storyPublisher').value;
      const storyIdField = document.getElementById('storyStoryId').value;
      const displayStatus = document.getElementById('storyDisplayStatus').value;
      const rating = parseFloat(document.getElementById('storyRating').value) || 0;
      const reviewCount = parseInt(document.getElementById('storyReviewCount').value) || 0;
      const viewCount = parseInt(document.getElementById('storyViewCount').value) || 0;
      const favoriteCount = parseInt(document.getElementById('storyFavoriteCount').value) || 0;
      const commentCount = parseInt(document.getElementById('storyCommentCount').value) || 0;
      const description = document.getElementById('storyDescription').value;
      const coverImage = document.getElementById('storyCoverImage').value;

      // Validate required fields
      if (!title || !author || !genre) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng điền đầy đủ thông tin bắt buộc (*)',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang lưu...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Process tags
      const tagsArray = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

      // Prepare update data
      const updateData = {
        title: title,
        author: author,
        category_code: categoryCode,
        category_name: categoryName,
        genre: genre,
        tags: tagsArray,
        price: price,
        original_price: originalPrice,
        chapters: chapters,
        word_count: wordCount,
        language: language,
        status: status,
        publish_date: publishDate,
        last_updated: lastUpdated || new Date().toISOString().split('T')[0],
        publisher: publisher || author, // Sử dụng tên tác giả làm nhà xuất bản nếu không có
        story_id: storyIdField,
        description: description,
        cover_image: coverImage,
        is_free: price === 0,
        is_featured: displayStatus === 'featured',
        is_member_only: displayStatus === 'vip',
        rating: rating,
        review_count: reviewCount,
        view_count: viewCount,
        favorite_count: favoriteCount,
        comment_count: commentCount
      };

      // Update in Firebase
      try {
        set(ref(database, `Stories/${storyId}`), updateData).then(() => {
          loadingSwal.close();
          Swal.fire({
            title: 'Thành công!',
            text: 'Thông tin truyện đã được cập nhật',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          }).then(() => {
            closeEditStoryModal();
            // Reload data
            loadStoriesData();
          });
        }).catch((error) => {
          console.error('Error updating story:', error);
          loadingSwal.close();
          Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể cập nhật thông tin truyện',
            icon: 'error',
            confirmButtonColor: '#ff5e73'
          });
        });
      } catch (error) {
        console.error('Error in saveStoryChanges:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Có lỗi xảy ra khi lưu thông tin truyện',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      }
    }

    // Initialize Firebase features
    document.addEventListener('DOMContentLoaded', function() {
      initFirebaseFeatures();
      loadOverviewData(); // Load real data for overview
    });
    
    // Load real data for Overview section
    function loadOverviewData() {
      const { database, ref, onValue, get } = window.firebase;
      
      // Load users count
      const usersRef = ref(database, 'users');
      onValue(usersRef, (snapshot) => {
        const users = snapshot.val();
        const totalUsers = users ? Object.keys(users).length : 0;
        updateKPICounter('users', totalUsers);
      });
      
      // Load total orders count from orders node
      const ordersRef = ref(database, 'orders');
      onValue(ordersRef, (snapshot) => {
        const orders = snapshot.val();
        let totalOrders = 0;
        
        if (orders) {
          // Count all orders from all users
          Object.values(orders).forEach(userOrders => {
            if (userOrders && typeof userOrders === 'object') {
              totalOrders += Object.keys(userOrders).length;
            }
          });
        }
        
        updateKPICounter('orders', totalOrders);
      });
      
      // Load total revenue from orders
      get(ordersRef).then((ordersSnapshot) => {
        let totalRevenue = 0;
        
        const orders = ordersSnapshot.val();
        if (orders) {
          Object.values(orders).forEach(userOrders => {
            if (userOrders && typeof userOrders === 'object') {
              Object.values(userOrders).forEach(order => {
                // Only count completed orders
                if (order.status === 'success' || order.paymentStatus === 'completed') {
                  // Use finalPrice if available, otherwise use totalPrice
                  const orderAmount = order.finalPrice || order.totalPrice || order.packagePrice || 0;
                  totalRevenue += orderAmount;
                }
              });
            }
          });
        }
        
        updateKPICounter('views', totalRevenue);
      });
      
      // Load total authors (all statuses) from authorRegistrations node
      const authorRegistrationsRef = ref(database, 'authorRegistrations');
      
      // Use both onValue for real-time updates and get for immediate data
      onValue(authorRegistrationsRef, (snapshot) => {
        const authorRegistrations = snapshot.val();
        let totalAuthors = 0;
        
        console.log('AuthorRegistrations data (onValue):', authorRegistrations);
        
        if (authorRegistrations) {
          Object.values(authorRegistrations).forEach(registration => {
            // Count all authors regardless of status
            totalAuthors++;
            console.log('Counting author:', registration.penName || registration.userEmail, 'Status:', registration.status);
          });
        }
        
        console.log('Total authors count (onValue):', totalAuthors);
        updateKPICounter('newAuthors', totalAuthors);
      });
      
      // Also get data immediately
      get(authorRegistrationsRef).then((snapshot) => {
        const authorRegistrations = snapshot.val();
        let totalAuthors = 0;
        
        console.log('AuthorRegistrations data (get):', authorRegistrations);
        
        if (authorRegistrations) {
          Object.values(authorRegistrations).forEach(registration => {
            // Count all authors regardless of status
            totalAuthors++;
            console.log('Counting author (get):', registration.penName || registration.userEmail, 'Status:', registration.status);
          });
        }
        
        console.log('Total authors count (get):', totalAuthors);
        updateKPICounter('newAuthors', totalAuthors);
        
        // Force update the display
        const kpiElement = document.getElementById('authors-kpi');
        if (kpiElement) {
          const valueElement = kpiElement.querySelector('.value');
          if (valueElement) {
            valueElement.textContent = totalAuthors;
            kpiElement.setAttribute('data-count', totalAuthors);
          }
        }
      }).catch((error) => {
        console.error('Error loading author registrations:', error);
      });
      
      // Update ticker with real data
      updateTicker();
      
      // Update area chart with real data (only if Firebase is available)
      if (window.firebase) {
        updateAreaChartWithRealData();
      }
    }
    
    // Update ticker with real data
    function updateTicker() {
      const { database, ref, get } = window.firebase;
      
      Promise.all([
        get(ref(database, 'users')),
        get(ref(database, 'Books')),
        get(ref(database, 'Stories')),
        get(ref(database, 'orders')),
        get(ref(database, 'authorRegistrations'))
      ]).then(([usersSnapshot, booksSnapshot, storiesSnapshot, ordersSnapshot, authorRegistrationsSnapshot]) => {
        const users = usersSnapshot.val();
        const books = booksSnapshot.val();
        const stories = storiesSnapshot.val();
        const orders = ordersSnapshot.val();
        const authorRegistrations = authorRegistrationsSnapshot.val();
        
        const totalUsers = users ? Object.keys(users).length : 0;
        const totalBooks = books ? Object.keys(books).length : 0;
        const totalStories = stories ? Object.keys(stories).length : 0;
        
        // Calculate total revenue from orders
        let totalRevenue = 0;
        if (orders) {
          Object.values(orders).forEach(userOrders => {
            if (userOrders && typeof userOrders === 'object') {
              Object.values(userOrders).forEach(order => {
                // Only count completed orders
                if (order.status === 'success' || order.paymentStatus === 'completed') {
                  // Use finalPrice if available, otherwise use totalPrice
                  const orderAmount = order.finalPrice || order.totalPrice || order.packagePrice || 0;
                  totalRevenue += orderAmount;
                }
              });
            }
          });
        }
        
        // Count total orders
        let totalOrders = 0;
        if (orders) {
          Object.values(orders).forEach(userOrders => {
            if (userOrders && typeof userOrders === 'object') {
              totalOrders += Object.keys(userOrders).length;
            }
          });
        }
        
        // Count orders today
        let ordersToday = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (orders) {
          Object.values(orders).forEach(userOrders => {
            if (userOrders && typeof userOrders === 'object') {
              Object.values(userOrders).forEach(order => {
                if (order.createdAt) {
                  const orderDate = new Date(order.createdAt);
                  orderDate.setHours(0, 0, 0, 0);
                  if (orderDate.getTime() === today.getTime()) {
                    ordersToday++;
                  }
                }
              });
            }
          });
        }
        
        // Count total authors (all statuses) from authorRegistrations
        let totalAuthors = 0;
        console.log('Ticker - AuthorRegistrations data:', authorRegistrations);
        if (authorRegistrations) {
          Object.values(authorRegistrations).forEach(registration => {
            // Count all authors regardless of status
            totalAuthors++;
            console.log('Ticker - Counting author:', registration.penName || registration.userEmail, 'Status:', registration.status);
          });
        }
        console.log('Ticker - Total authors count:', totalAuthors);
        
        // Update ticker content
        const tickerContent = document.getElementById('tickerContent');
        if (tickerContent) {
          tickerContent.innerHTML = `
            <span><i class="fa fa-bolt"></i> Máy chủ ổn định • uptime 99.99%</span>
            <span><i class="fa fa-money"></i> Tổng doanh thu: ${totalRevenue.toLocaleString('vi-VN')} VNĐ</span>
            <span><i class="fa fa-shopping-cart"></i> ${totalOrders} đơn hàng tổng cộng</span>
            <span><i class="fa fa-calendar"></i> ${ordersToday} đơn hàng hôm nay</span>
            <span><i class="fa fa-user"></i> ${totalAuthors} tác giả đã đăng ký</span>
            <span><i class="fa fa-shield"></i> Hệ thống bảo mật hoạt động bình thường</span>
            <span><i class="fa fa-bolt"></i> Máy chủ ổn định • uptime 99.99%</span>
            <span><i class="fa fa-money"></i> Tổng doanh thu: ${totalRevenue.toLocaleString('vi-VN')} VNĐ</span>
            <span><i class="fa fa-shopping-cart"></i> ${totalOrders} đơn hàng tổng cộng</span>
            <span><i class="fa fa-calendar"></i> ${ordersToday} đơn hàng hôm nay</span>
            <span><i class="fa fa-user"></i> ${totalAuthors} tác giả đã đăng ký</span>
            <span><i class="fa fa-shield"></i> Hệ thống bảo mật hoạt động bình thường</span>
          `;
        }
      });
    }
    
    // Update KPI counter with real data
    function updateKPICounter(type, value) {
      let kpiElement;
      
      switch(type) {
        case 'users':
          kpiElement = document.getElementById('users-kpi');
          break;
        case 'views':
          kpiElement = document.getElementById('views-kpi');
          break;
        case 'orders':
          kpiElement = document.getElementById('orders-kpi');
          break;
        case 'newAuthors':
          kpiElement = document.getElementById('authors-kpi');
          break;
        default:
          return;
      }
      
      if (kpiElement) {
        const valueElement = kpiElement.querySelector('.value');
        if (valueElement) {
          // Update the data-count attribute for animation
          kpiElement.setAttribute('data-count', value);
          
          // Animate the number
          animateNumber(valueElement, value);
        }
      }
    }

    // Manuscript Review Management Functions
    let manuscriptLoaded = false;

    // Load manuscript data from Firebase (from users' books and stories)
    function loadInventoryData() {
      const { database, ref, onValue, get } = window.firebase;
      const usersRef = ref(database, 'users');
      
      // Only set up listener if not already loaded
      if (!manuscriptLoaded) {
        manuscriptLoaded = true;
        
        // Set up listener for real-time updates
        onValue(usersRef, (snapshot) => {
          const users = snapshot.val();
          if (users) {
            const manuscripts = extractManuscriptsFromUsers(users);
            updateManuscriptTable(manuscripts);
            updateManuscriptStats(manuscripts);
          }
        });
      }
      
      // Always get current data for immediate display
      get(usersRef).then((snapshot) => {
        const users = snapshot.val();
        if (users) {
          const manuscripts = extractManuscriptsFromUsers(users);
          updateManuscriptTable(manuscripts);
          updateManuscriptStats(manuscripts);
        }
      }).catch((error) => {
        console.error('Error loading manuscript data:', error);
      });
    }

    // Extract books and stories from users data to create manuscripts list
    function extractManuscriptsFromUsers(users) {
      const manuscripts = {};
      
      Object.keys(users).forEach(userId => {
        const user = users[userId];
        const userProfile = user.profile || {};
        const authorInfo = user.authorRegistration || {};
        
        // Skip if user is not an approved author
        if (!authorInfo.status || authorInfo.status !== 'approved') {
          return;
        }
        
        console.log(`Processing author: ${userId}, status: ${authorInfo.status}`);
        
        // Process books
        if (user.books) {
          Object.keys(user.books).forEach(bookId => {
            const book = user.books[bookId];
            const bookStatus = book.status === 'review' ? 'pending' : 
                              book.status === 'approved' ? 'approved' :
                              book.status === 'rejected' ? 'rejected' :
                              book.isPublished ? 'approved' : 'pending';
            
            console.log(`Book: ${book.title}, Status: ${book.status} -> ${bookStatus}`);
            
            manuscripts[`book_${bookId}`] = {
              manuscriptId: `book_${bookId}`,
              originalId: bookId,
              title: book.title,
              author: book.authorName || book.penName || userProfile.displayName,
              authorId: userId,
              type: 'book',
              genre: book.category || 'N/A',
              description: book.description,
              coverImage: book.coverImage,
              submittedAt: book.createdAt,
              status: bookStatus,
              reviewer: book.reviewer || (book.isPublished ? 'System' : ''),
              reviewedAt: book.updatedAt,
              totalChapters: book.totalChapters || 0,
              totalViews: book.totalViews || 0,
              totalWords: book.totalWords || 0,
              isCompleted: book.isCompleted,
              isPublished: book.isPublished,
              userType: 'book'
            };
          });
        }
        
        // Process stories
        if (user.stories) {
          Object.keys(user.stories).forEach(storyId => {
            const story = user.stories[storyId];
            const storyStatus = story.status === 'review' ? 'pending' : 
                               story.status === 'approved' ? 'approved' :
                               story.status === 'rejected' ? 'rejected' :
                               story.isPublished ? 'approved' : 'pending';
            
            console.log(`Story: ${story.title}, Status: ${story.status} -> ${storyStatus}`);
            
            manuscripts[`story_${storyId}`] = {
              manuscriptId: `story_${storyId}`,
              originalId: storyId,
              title: story.title,
              author: story.authorName || story.penName || userProfile.displayName,
              authorId: userId,
              type: 'story',
              genre: story.category || 'N/A',
              description: story.description,
              coverImage: story.coverImage,
              submittedAt: story.createdAt,
              status: storyStatus,
              reviewer: story.reviewer || (story.isPublished ? 'System' : ''),
              reviewedAt: story.updatedAt,
              totalChapters: story.totalChapters || 0,
              totalViews: story.totalViews || 0,
              totalWords: story.totalWords || 0,
              isCompleted: story.isCompleted,
              isPublished: story.isPublished,
              userType: 'story'
            };
          });
        }
      });
      
      return manuscripts;
    }

    // Update manuscript table
    function updateManuscriptTable(manuscripts) {
      const tbody = document.getElementById('manuscriptTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(manuscripts).forEach(manuscriptId => {
        const manuscript = manuscripts[manuscriptId];
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.08)';
        
        // Determine status
        let statusText, statusColor;
        switch(manuscript.status) {
          case 'approved':
            statusText = 'Đã duyệt';
            statusColor = 'var(--success)';
            break;
          case 'rejected':
            statusText = 'Từ chối';
            statusColor = 'var(--danger)';
            break;
          case 'pending':
          default:
            statusText = 'Chờ duyệt';
            statusColor = 'var(--warning)';
            break;
        }
        
        // Get type display name
        const typeDisplay = {
          'book': 'Sách',
          'story': 'Truyện',
          'poem': 'Thơ',
          'article': 'Bài viết'
        }[manuscript.type] || manuscript.type;
        
        // Format date safely
        const submittedDate = manuscript.submittedAt ? 
          new Date(manuscript.submittedAt).toLocaleDateString('vi-VN') : 'N/A';
        
        row.innerHTML = `
          <td style="padding:16px 12px;">
            <img src="${manuscript.coverImage || 'images/books/img-01.jpg'}" alt="${manuscript.title}" style="width:50px;height:70px;object-fit:cover;border-radius:8px;border:1px solid var(--stroke);" onerror="this.src='images/books/img-01.jpg'">
          </td>
          <td style="padding:16px 12px;">
            <strong>${manuscript.title}</strong>
            <br><small style="color:var(--muted);">${manuscript.genre || 'N/A'}</small>
            <br><small style="color:var(--accent);">
              <i class="fa fa-list"></i> ${manuscript.totalChapters} chương | 
              <i class="fa fa-eye"></i> ${manuscript.totalViews} lượt xem
            </small>
          </td>
          <td style="padding:16px 12px;">
            <strong>${manuscript.author}</strong>
            <br><small style="color:var(--muted);">ID: ${manuscript.authorId}</small>
          </td>
          <td style="padding:16px 12px;">
            <span style="background: ${manuscript.type === 'book' ? 'var(--primary)' : 'var(--accent)'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${typeDisplay}</span>
            <br><small style="color:var(--muted); margin-top: 4px;">
              ${manuscript.isCompleted ? '✅ Hoàn thành' : '⏳ Đang viết'}
            </small>
          </td>
          <td style="padding:16px 12px;">${submittedDate}</td>
          <td style="padding:16px 12px;">
            <span style="color:${statusColor};font-weight:600;">${statusText}</span>
            <br><small style="color:var(--muted);">
              ${manuscript.isPublished ? '📚 Đã xuất bản' : '📝 Chưa xuất bản'}
            </small>
          </td>
          <td style="padding:16px 12px;">${manuscript.reviewer || 'Chưa duyệt'}</td>
          <td style="padding:16px 12px;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn" onclick="viewManuscriptDetails('${manuscriptId}')" style="flex: 1; min-width: 60px; justify-content: center;" title="Xem chi tiết">
                <i class="fa fa-eye"></i>
              </button>
              ${manuscript.status === 'pending' ? `
                <button class="btn" onclick="approveManuscript('${manuscriptId}', '${manuscript.title}', '${manuscript.authorId}', '${manuscript.originalId}', '${manuscript.userType}')" style="flex: 1; min-width: 60px; justify-content: center; background: rgba(34,211,163,.1); border-color: var(--success); color: var(--success);" title="Duyệt">
                  <i class="fa fa-check"></i>
                </button>
                <button class="btn" onclick="rejectManuscript('${manuscriptId}', '${manuscript.title}', '${manuscript.authorId}', '${manuscript.originalId}', '${manuscript.userType}')" style="flex: 1; min-width: 60px; justify-content: center; background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);" title="Từ chối">
                  <i class="fa fa-times"></i>
                </button>
              ` : `
                <button class="btn" style="flex: 1; min-width: 60px; justify-content: center; background: rgba(255,255,255,.05); border-color: var(--muted); color: var(--muted); cursor: not-allowed;" title="Đã duyệt" disabled>
                  <i class="fa fa-check"></i>
                </button>
                <button class="btn" style="flex: 1; min-width: 60px; justify-content: center; background: rgba(255,255,255,.05); border-color: var(--muted); color: var(--muted); cursor: not-allowed;" title="Đã xử lý" disabled>
                  <i class="fa fa-times"></i>
                </button>
              `}
              <button class="btn" onclick="publishManuscript('${manuscriptId}', '${manuscript.title}', '${manuscript.authorId}', '${manuscript.originalId}', '${manuscript.userType}')" style="flex: 1; min-width: 60px; justify-content: center; background: rgba(124,92,255,.1); border-color: var(--primary); color: var(--primary);" title="${manuscript.isPublished ? 'Hủy xuất bản' : 'Xuất bản'}">
                <i class="fa fa-${manuscript.isPublished ? 'eye-slash' : 'globe'}"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Update manuscript statistics
    function updateManuscriptStats(manuscripts) {
      let approved = 0;
      let pending = 0;
      let rejected = 0;
      let total = 0;

      Object.keys(manuscripts).forEach(manuscriptId => {
        const manuscript = manuscripts[manuscriptId];
        total++;
        
        switch(manuscript.status) {
          case 'approved':
            approved++;
            break;
          case 'rejected':
            rejected++;
            break;
          case 'pending':
          default:
            pending++;
            break;
        }
      });

      // Update KPI values
      document.getElementById('approvedManuscripts').textContent = approved;
      document.getElementById('pendingManuscripts').textContent = pending;
      document.getElementById('rejectedManuscripts').textContent = rejected;
      document.getElementById('totalManuscripts').textContent = total;
    }

    // Load books for inventory selection
    function loadBooksForInventory() {
      const { database, ref, get } = window.firebase;
      const booksRef = ref(database, 'Books');
      
      get(booksRef).then((snapshot) => {
        const books = snapshot.val();
        const select = document.getElementById('inventoryBookSelect');
        if (select && books) {
          select.innerHTML = '<option value="">Chọn sách từ danh sách</option>';
          Object.keys(books).forEach(bookId => {
            const book = books[bookId];
            const option = document.createElement('option');
            option.value = bookId;
            option.textContent = `${book.title} - ${book.author}`;
            select.appendChild(option);
          });
        }
      }).catch((error) => {
        console.error('Error loading books for inventory:', error);
      });
    }

    // Load book info when selected
    function loadBookInfo() {
      const bookId = document.getElementById('inventoryBookSelect').value;
      if (!bookId) return;

      const { database, ref, get } = window.firebase;
      const bookRef = ref(database, `Books/${bookId}`);
      
      get(bookRef).then((snapshot) => {
        const book = snapshot.val();
        if (book) {
          // Auto-fill some fields
          document.getElementById('inventorySellingPrice').value = book.price || 0;
        }
      }).catch((error) => {
        console.error('Error loading book info:', error);
      });
    }

    // Add manuscript
    function addManuscript(event) {
      event.preventDefault();
      
      const { database, ref, set } = window.firebase;
      
      // Get form values
      const title = document.getElementById('manuscriptTitle').value;
      const author = document.getElementById('manuscriptAuthor').value;
      const type = document.getElementById('manuscriptType').value;
      const genre = document.getElementById('manuscriptGenre').value;
      const language = document.getElementById('manuscriptLanguage').value;
      const wordCount = parseInt(document.getElementById('manuscriptWordCount').value) || 0;
      const description = document.getElementById('manuscriptDescription').value;
      const content = document.getElementById('manuscriptContent').value;
      const quality = document.getElementById('manuscriptQuality').value;
      const notes = document.getElementById('manuscriptNotes').value;

      // Validate required fields
      if (!title || !author || !type) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng điền đầy đủ thông tin bắt buộc (*)',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang thêm bản thảo...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Generate manuscript ID
      const manuscriptId = `ms_${Date.now()}`;

      // Prepare manuscript data
      const manuscriptData = {
        manuscriptId: manuscriptId,
        title: title,
        author: author,
        type: type,
        genre: genre,
        language: language,
        wordCount: wordCount,
        description: description,
        content: content,
        quality: quality,
        notes: notes,
        status: 'pending',
        submittedAt: new Date().toISOString(),
        createdAt: new Date().toISOString()
      };

      // Add to Firebase
      set(ref(database, `Manuscripts/${manuscriptId}`), manuscriptData).then(() => {
        loadingSwal.close();
        Swal.fire({
          title: 'Thành công!',
          text: 'Bản thảo đã được thêm thành công',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        }).then(() => {
          closeAddManuscriptModal();
          // Reload data
          loadInventoryData();
        });
      }).catch((error) => {
        console.error('Error adding manuscript:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể thêm bản thảo',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    }

    // Export inventory data
    function exportInventory() {
      const { database, ref, get } = window.firebase;
      const inventoryRef = ref(database, 'Inventory');
      
      get(inventoryRef).then((snapshot) => {
        const inventory = snapshot.val();
        if (inventory) {
          // Convert to CSV format
          let csv = 'Tên sách,Tác giả,Thể loại,Số lượng,Vị trí,Giá nhập,Giá bán,Nhà cung cấp,Trạng thái\n';
          
          Object.keys(inventory).forEach(inventoryId => {
            const item = inventory[inventoryId];
            const status = item.quantity <= 0 ? 'Hết hàng' : 
                          item.quantity <= item.minStock ? 'Sắp hết' : 'Còn hàng';
            
            csv += `"${item.title}","${item.author}","${item.genre || ''}","${item.quantity}","${item.location}","${item.costPrice}","${item.sellingPrice}","${item.supplier || ''}","${status}"\n`;
          });
          
          // Download CSV file
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `inventory_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          Swal.fire({
            title: 'Thành công!',
            text: 'Dữ liệu kho đã được xuất thành file CSV',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          });
        } else {
          Swal.fire({
            title: 'Thông báo',
            text: 'Không có dữ liệu kho để xuất',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
        }
      }).catch((error) => {
        console.error('Error exporting inventory:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể xuất dữ liệu kho',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    }

    // Handle file selection for import
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('selectedFileName').textContent = file.name;
      }
    }

    // Import Excel data (simplified version)
    function importExcelData() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      
      if (!file) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng chọn file Excel',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang import dữ liệu...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Simulate import process (in real implementation, you'd use a library like SheetJS)
      setTimeout(() => {
        loadingSwal.close();
        Swal.fire({
          title: 'Thành công!',
          text: 'Dữ liệu đã được import thành công',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        }).then(() => {
          closeImportModal();
          // Reload data
          loadInventoryData();
        });
      }, 2000);
    }

    // Manuscript action functions
    window.viewManuscriptDetails = function(manuscriptId) {
      // Parse manuscript ID to get author and original ID
      const [type, originalId] = manuscriptId.split('_').slice(1); // Remove first part
      const authorId = manuscriptId.includes('book_') ? 
        manuscriptId.replace('book_', '').split('_')[0] : 
        manuscriptId.replace('story_', '').split('_')[0];
      
      // Show loading in modal
      document.getElementById('manuscriptModalTitle').textContent = 'Đang tải thông tin...';
      document.getElementById('manuscriptModalBody').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="width: 40px; height: 40px; border: 3px solid var(--primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="color: var(--muted);">Đang tải thông tin bản thảo...</p>
        </div>
      `;
      openManuscriptModal();
      
      // Find the manuscript in current data
      const { database, ref, get } = window.firebase;
      get(ref(database, 'users')).then((snapshot) => {
        const users = snapshot.val();
        if (users) {
          const manuscripts = extractManuscriptsFromUsers(users);
          const manuscript = manuscripts[manuscriptId];
          
          if (manuscript) {
            // Get additional user info
            const user = users[manuscript.authorId];
            const userProfile = user?.profile || {};
            
            document.getElementById('manuscriptModalTitle').textContent = `Chi tiết: ${manuscript.title}`;
            document.getElementById('manuscriptModalBody').innerHTML = `
              <div style="text-align: left;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                  <img src="${manuscript.coverImage || 'images/books/img-01.jpg'}" 
                       style="width: 120px; height: 160px; object-fit: cover; border-radius: 8px; border: 1px solid var(--stroke);" 
                       onerror="this.src='images/books/img-01.jpg'">
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0; color: var(--text);">${manuscript.title}</h3>
                    <p><strong>Tác giả:</strong> ${manuscript.author}</p>
                    <p><strong>Email:</strong> ${userProfile.email || 'N/A'}</p>
                    <p><strong>Loại:</strong> ${manuscript.type === 'book' ? 'Sách' : 'Truyện'}</p>
                    <p><strong>Thể loại:</strong> ${manuscript.genre}</p>
                    <p><strong>Trạng thái:</strong> 
                      <span style="color: ${manuscript.status === 'approved' ? 'var(--success)' : manuscript.status === 'rejected' ? 'var(--danger)' : 'var(--warning)'};">
                        ${manuscript.status === 'approved' ? 'Đã duyệt' : manuscript.status === 'rejected' ? 'Từ chối' : 'Chờ duyệt'}
                      </span>
                    </p>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                  <div>
                    <h4 style="color: var(--primary); margin: 0 0 8px 0;">📊 Thống kê</h4>
                    <p><strong>Số chương:</strong> ${manuscript.totalChapters}</p>
                    <p><strong>Lượt xem:</strong> ${manuscript.totalViews}</p>
                    <p><strong>Tổng từ:</strong> ${manuscript.totalWords}</p>
                    <p><strong>Hoàn thành:</strong> ${manuscript.isCompleted ? 'Có' : 'Chưa'}</p>
                  </div>
                  <div>
                    <h4 style="color: var(--primary); margin: 0 0 8px 0;">📅 Thời gian</h4>
                    <p><strong>Ngày tạo:</strong> ${new Date(manuscript.submittedAt).toLocaleDateString('vi-VN')}</p>
                    <p><strong>Cập nhật:</strong> ${manuscript.reviewedAt ? new Date(manuscript.reviewedAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                    <p><strong>Người duyệt:</strong> ${manuscript.reviewer || 'Chưa duyệt'}</p>
                    <p><strong>Xuất bản:</strong> ${manuscript.isPublished ? 'Đã xuất bản' : 'Chưa xuất bản'}</p>
                  </div>
                </div>
                
                <hr style="border: 1px solid var(--stroke); margin: 20px 0;">
                <h4 style="color: var(--primary); margin: 0 0 8px 0;">📝 Mô tả</h4>
                <p style="line-height: 1.6;">${manuscript.description || 'Không có mô tả'}</p>
                
                <div style="background: rgba(124,92,255,.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                  <h4 style="color: var(--primary); margin: 0 0 8px 0;">🔗 Liên kết</h4>
                  <p><strong>ID tác phẩm:</strong> ${manuscript.originalId}</p>
                  <p><strong>ID tác giả:</strong> ${manuscript.authorId}</p>
                </div>
              </div>
            `;
          } else {
            document.getElementById('manuscriptModalBody').innerHTML = `
              <div style="text-align: center; padding: 40px; color: var(--danger);">
                <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                <h3>Lỗi!</h3>
                <p>Không tìm thấy thông tin bản thảo!</p>
              </div>
            `;
          }
        }
      }).catch((error) => {
        console.error('Error getting manuscript details:', error);
        document.getElementById('manuscriptModalBody').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3>Lỗi!</h3>
            <p>Không thể tải thông tin bản thảo!</p>
          </div>
        `;
      });
    };

    window.approveManuscript = function(manuscriptId, title, authorId, originalId, userType) {
      Swal.fire({
        title: 'Xác nhận duyệt',
        text: `Bạn có chắc chắn muốn duyệt "${title}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Duyệt',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          const { database, ref, set } = window.firebase;
          
          // Update status in the user's books or stories
          const dataPath = `users/${authorId}/${userType === 'book' ? 'books' : 'stories'}/${originalId}`;
          
          console.log(`Approving manuscript: ${dataPath}`);
          console.log(`Current data:`, { authorId, originalId, userType });
          
          // Set status to approved (isPublished can remain false until publishing)
          const updates = {
            [`${dataPath}/status`]: 'approved',
            [`${dataPath}/reviewer`]: 'Admin',
            [`${dataPath}/reviewedAt`]: new Date().toISOString()
          };
          
          console.log(`Updates to apply:`, updates);
          
          // Apply all updates
          const updatePromises = Object.keys(updates).map(path => 
            set(ref(database, path), updates[path])
          );
          
          Promise.all(updatePromises).then(() => {
            // Force reload data to update the table
            loadInventoryData();
            
            Swal.fire({
              title: 'Đã duyệt!',
              html: `
                <p>"${title}" đã được chấp nhận.</p>
                <p><small>Tác phẩm đã sẵn sàng để xuất bản.</small></p>
              `,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error approving manuscript:', error);
            Swal.fire('Lỗi!', 'Không thể duyệt bản thảo.', 'error');
          });
        }
      });
    };

    window.rejectManuscript = function(manuscriptId, title, authorId, originalId, userType) {
      Swal.fire({
        title: 'Xác nhận từ chối',
        text: `Bạn có chắc chắn muốn từ chối "${title}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          const { database, ref, set } = window.firebase;
          
          // Update status in the user's books or stories
          const dataPath = `users/${authorId}/${userType === 'book' ? 'books' : 'stories'}/${originalId}`;
          
          const updates = {
            [`${dataPath}/status`]: 'rejected',
            [`${dataPath}/reviewer`]: 'Admin',
            [`${dataPath}/reviewedAt`]: new Date().toISOString(),
            [`${dataPath}/isPublished`]: false
          };
          
          // Apply all updates
          const updatePromises = Object.keys(updates).map(path => 
            set(ref(database, path), updates[path])
          );
          
          Promise.all(updatePromises).then(() => {
            // Force reload data to update the table
            loadInventoryData();
            
            Swal.fire({
              title: 'Đã từ chối!',
              html: `
                <p>"${title}" đã bị từ chối.</p>
                <p><small>Tác giả có thể chỉnh sửa và gửi lại để duyệt.</small></p>
              `,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error rejecting manuscript:', error);
            Swal.fire('Lỗi!', 'Không thể từ chối bản thảo.', 'error');
          });
        }
      });
    };

    // Publish/Unpublish manuscript
    window.publishManuscript = function(manuscriptId, title, authorId, originalId, userType) {
      const { database, ref, get, set, remove } = window.firebase;
      const dataPath = `users/${authorId}/${userType === 'book' ? 'books' : 'stories'}/${originalId}`;
      const globalPath = userType === 'book' ? 'Books' : 'Stories';
      
      // Get current publish status and data
      get(ref(database, `${dataPath}/isPublished`)).then((snapshot) => {
        const isCurrentlyPublished = snapshot.val();
        const action = isCurrentlyPublished ? 'hủy xuất bản' : 'xuất bản';
        
        Swal.fire({
          title: `Xác nhận ${action}`,
          text: `Bạn có chắc chắn muốn ${action} "${title}"?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: action.charAt(0).toUpperCase() + action.slice(1),
          cancelButtonText: 'Hủy',
          confirmButtonColor: isCurrentlyPublished ? '#ff5e73' : '#22d3a3',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            if (!isCurrentlyPublished) {
              // Publishing - Get full data and copy to global nodes
              get(ref(database, dataPath)).then((dataSnapshot) => {
                const manuscriptData = dataSnapshot.val();
                if (manuscriptData) {
                  // Prepare data for global Books/Stories
                  const globalData = {
                    title: manuscriptData.title,
                    author: manuscriptData.authorName || manuscriptData.penName,
                    description: manuscriptData.description,
                    cover_image: manuscriptData.coverImage,
                    genre: manuscriptData.category || manuscriptData.genre,
                    is_free: manuscriptData.price === 0,
                    is_featured: false,
                    is_member_only: false,
                    publish_date: new Date().toISOString().split('T')[0],
                    created_at: new Date().toISOString(),
                    published_by: 'Admin',
                    original_user_id: authorId,
                    original_manuscript_id: originalId,
                    publisher: manuscriptData.authorName || manuscriptData.penName || 'AnBok Collection' // Lưu tên người viết làm nhà xuất bản
                  };
                  
                  // Generate sequential ID for Books/Stories
                  const getNextId = async (type) => {
                    const refPath = type === 'book' ? 'Books' : 'Stories';
                    const snapshot = await get(ref(database, refPath));
                    const data = snapshot.val();
                    if (!data) return `${type}_001`;
                    
                    const existingIds = Object.keys(data);
                    const numbers = existingIds
                      .filter(id => id.startsWith(`${type}_`))
                      .map(id => parseInt(id.replace(`${type}_`, '')))
                      .filter(num => !isNaN(num));
                    
                    const nextNumber = numbers.length > 0 ? Math.max(...numbers) + 1 : 1;
                    return `${type}_${nextNumber.toString().padStart(3, '0')}`;
                  };
                  
                  // Get next available ID and continue with publishing
                  getNextId(userType).then((newId) => {
                    console.log(`Generated ID: ${newId} for ${userType}`);
                    
                    // Add book-specific fields
                    if (userType === 'book') {
                      globalData.pages = manuscriptData.totalPages || 0;
                      globalData.price = manuscriptData.price || 0;
                      globalData.publisher = manuscriptData.authorName || manuscriptData.penName || 'AnBok Collection'; // Lưu tên người viết làm nhà xuất bản
                      globalData.isbn = `ANB-${Date.now()}`;
                      globalData.stock = 100;
                    }
                    
                    // Add story-specific fields
                    if (userType === 'story') {
                      globalData.chapters = manuscriptData.totalChapters || 0;
                      globalData.language = 'Vietnamese';
                      globalData.status = manuscriptData.isCompleted ? 'Completed' : 'Ongoing';
                      globalData.word_count = manuscriptData.totalWords || 0;
                      globalData.view_count = 0;
                      globalData.favorite_count = 0;
                      globalData.comment_count = 0;
                      globalData.rating = 0;
                      globalData.review_count = 0;
                      globalData.story_id = newId;
                      globalData.publisher = manuscriptData.authorName || manuscriptData.penName || 'AnBok Collection'; // Lưu tên người viết làm nhà xuất bản
                    }
                    
                    console.log(`Publishing to ${globalPath}/${newId}:`, globalData);
                    
                    // Update user's manuscript and copy to global with new ID
                    const updates = {
                      [`${dataPath}/isPublished`]: true,
                      [`${dataPath}/publishedAt`]: new Date().toISOString(),
                      [`${dataPath}/publishedBy`]: 'Admin',
                      [`${dataPath}/globalId`]: newId, // Store the global ID reference
                      [`${globalPath}/${newId}`]: globalData
                    };
                    
                    // Apply all updates
                    const updatePromises = Object.keys(updates).map(path => 
                      set(ref(database, path), updates[path])
                    );
                    
                    Promise.all(updatePromises).then(() => {
                      loadInventoryData();
                      Swal.fire({
                        title: 'Xuất bản thành công!',
                        html: `
                          <p>"${title}" đã được xuất bản.</p>
                          <p><strong>Tác giả:</strong> ${globalData.author}</p>
                          <p><strong>Nhà xuất bản:</strong> ${globalData.publisher}</p>
                          <p><small>Dữ liệu đã được lưu vào ${globalPath}/${newId}.</small></p>
                        `,
                        icon: 'success',
                        confirmButtonColor: '#22d3a3'
                      });
                    }).catch((error) => {
                      console.error('Error publishing manuscript:', error);
                      Swal.fire('Lỗi!', 'Không thể xuất bản tác phẩm.', 'error');
                    });
                  }).catch((error) => {
                    console.error('Error generating ID:', error);
                    Swal.fire('Lỗi!', 'Không thể tạo ID cho tác phẩm.', 'error');
                  });
                }
              }).catch((error) => {
                console.error('Error getting manuscript data:', error);
                Swal.fire('Lỗi!', 'Không thể lấy dữ liệu tác phẩm.', 'error');
              });
                         } else {
               // Unpublishing - Get globalId and remove from global nodes
               get(ref(database, `${dataPath}/globalId`)).then((globalIdSnapshot) => {
                 const globalId = globalIdSnapshot.val();
                 
                 if (globalId) {
                   const updates = {
                     [`${dataPath}/isPublished`]: false,
                     [`${dataPath}/publishedAt`]: null,
                     [`${dataPath}/publishedBy`]: null,
                     [`${dataPath}/globalId`]: null
                   };
                   
                   // Remove from global Books/Stories using globalId
                   remove(ref(database, `${globalPath}/${globalId}`)).then(() => {
                     // Update user's manuscript
                     const updatePromises = Object.keys(updates).map(path => 
                       set(ref(database, path), updates[path])
                     );
                     
                     Promise.all(updatePromises).then(() => {
                       loadInventoryData();
                       Swal.fire({
                         title: 'Hủy xuất bản thành công!',
                         html: `
                           <p>"${title}" đã được hủy xuất bản.</p>
                           <p><small>Dữ liệu đã được xóa khỏi ${globalPath}/${globalId}.</small></p>
                         `,
                         icon: 'success',
                         confirmButtonColor: '#22d3a3'
                       });
                     });
                   }).catch((error) => {
                     console.error('Error unpublishing manuscript:', error);
                     Swal.fire('Lỗi!', 'Không thể hủy xuất bản tác phẩm.', 'error');
                   });
                 } else {
                   // No globalId found, just update user's manuscript
                   const updates = {
                     [`${dataPath}/isPublished`]: false,
                     [`${dataPath}/publishedAt`]: null,
                     [`${dataPath}/publishedBy`]: null
                   };
                   
                   const updatePromises = Object.keys(updates).map(path => 
                     set(ref(database, path), updates[path])
                   );
                   
                   Promise.all(updatePromises).then(() => {
                     loadInventoryData();
                     Swal.fire({
                       title: 'Hủy xuất bản thành công!',
                       text: `"${title}" đã được hủy xuất bản.`,
                       icon: 'success',
                       confirmButtonColor: '#22d3a3'
                     });
                   });
                 }
               }).catch((error) => {
                 console.error('Error getting globalId:', error);
                 Swal.fire('Lỗi!', 'Không thể lấy thông tin xuất bản.', 'error');
               });
             }
          }
        });
      }).catch((error) => {
        console.error('Error getting publish status:', error);
        Swal.fire('Lỗi!', 'Không thể lấy thông tin tác phẩm.', 'error');
      });
    };

    // Bulk approve function
    window.bulkApprove = function() {
      Swal.fire({
        title: 'Duyệt hàng loạt',
        text: 'Tính năng này sẽ duyệt tất cả bản thảo đang chờ duyệt. Bạn có chắc chắn?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Duyệt tất cả',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('Thành công!', 'Đã duyệt tất cả bản thảo chờ duyệt.', 'success');
        }
      });
    };

    // Export manuscripts function
    window.exportManuscripts = function() {
      const { database, ref, get } = window.firebase;
      const manuscriptRef = ref(database, 'Manuscripts');
      
      get(manuscriptRef).then((snapshot) => {
        const manuscripts = snapshot.val();
        if (manuscripts) {
          // Convert to CSV format
          let csv = 'Tên tác phẩm,Tác giả,Loại,Thể loại,Trạng thái,Ngày gửi,Người duyệt\n';
          
          Object.keys(manuscripts).forEach(manuscriptId => {
            const manuscript = manuscripts[manuscriptId];
            csv += `"${manuscript.title}","${manuscript.author}","${manuscript.type}","${manuscript.genre || ''}","${manuscript.status}","${new Date(manuscript.submittedAt).toLocaleDateString('vi-VN')}","${manuscript.reviewer || ''}"\n`;
          });
          
          // Download CSV file
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `manuscripts_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          Swal.fire({
            title: 'Thành công!',
            text: 'Báo cáo bản thảo đã được xuất thành file CSV',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          });
        } else {
          Swal.fire({
            title: 'Thông báo',
            text: 'Không có dữ liệu bản thảo để xuất',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
        }
      }).catch((error) => {
        console.error('Error exporting manuscripts:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể xuất báo cáo bản thảo',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    // Modal functions for manuscript
    function openAddManuscriptModal() {
      // Show modal
      document.getElementById('addManuscriptModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeAddManuscriptModal() {
      document.getElementById('addManuscriptModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openImportModal() {
      // Clear file input
      document.getElementById('excelFile').value = '';
      document.getElementById('selectedFileName').textContent = 'Chưa chọn file nào';
      
      // Show modal
      document.getElementById('importModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Manuscript modal functions
    function openManuscriptModal() {
      document.getElementById('manuscriptModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeManuscriptModal() {
      document.getElementById('manuscriptModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

  // Tilt interactions removed per request

    // Animate counters
    function animateNumber(el, to, dur=1200){
      const start = performance.now();
      const from = 0;
      const fmt = (n) => n.toLocaleString('vi-VN');
      function step(t){
        const p = clamp((t - start) / dur, 0, 1);
        const eased = p<.5 ? 2*p*p : -1+(4-2*p)*p; // easeInOutQuad
        const val = Math.round(from + (to - from) * eased);
        el.textContent = fmt(val);
        if(p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    document.querySelectorAll('.kpi').forEach(k => {
      const to = Number(k.getAttribute('data-count')) || 0;
      const el = k.querySelector('.value');
      animateNumber(el, to);
    });

    

    // KPI Sparklines
    (function sparklines(){
      document.querySelectorAll('.kpi').forEach((card, idx)=>{
        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
        svg.setAttribute('class','spark');
        svg.setAttribute('viewBox','0 0 130 64');
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const base = 54;
        const pts = Array.from({length: 14}, (_,i)=>{
          const x = Math.round((i/13)*124)+3;
          const y = base - Math.round(20 + 12*Math.sin((i+idx)/2) + 10*Math.random());
          return [x, clamp(y, 8, base)];
        });
        const d = ['M', 0, base, 'L', pts[0][0], pts[0][1]]
          .concat(pts.slice(1).flatMap(p=>['L', p[0], p[1]])).concat(['L', 130, base, 'Z']).join(' ');
        path.setAttribute('d', d);
        path.setAttribute('fill', 'url(#gradSpark'+idx+')');
        const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
        const grad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
        grad.setAttribute('id','gradSpark'+idx);
        grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
        const s1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#7c5cff'); s1.setAttribute('stop-opacity','0.8');
        const s2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#22e4ff'); s2.setAttribute('stop-opacity','0.08');
        grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad);
        svg.appendChild(defs); svg.appendChild(path); card.appendChild(svg);
        const stroke = document.createElementNS('http://www.w3.org/2000/svg','path');
        stroke.setAttribute('d', d.replace('Z',''));
        stroke.setAttribute('fill','none'); stroke.setAttribute('stroke','#cfcff9'); stroke.setAttribute('stroke-width','1.5');
        stroke.style.filter = 'drop-shadow(0 4px 8px rgba(124,92,255,.35))';
        svg.appendChild(stroke);
        const len = 320;
        stroke.style.strokeDasharray = String(len);
        stroke.style.strokeDashoffset = String(len);
        stroke.animate([{ strokeDashoffset: len }, { strokeDashoffset: 0 }], { duration: 900, delay: 200+idx*80, easing: 'ease-out', fill: 'forwards' });
      });
    })();

    // Area chart with real data
    function updateAreaChartWithRealData(){
      const el = document.getElementById('areaStroke'); 
      if(!el) return;
      
      // Check if Firebase is available
      if (!window.firebase) {
        console.log('Firebase not available yet, skipping area chart update');
        return;
      }
      
      const { database, ref, get } = window.firebase;
      
      Promise.all([
        get(ref(database, 'Books')),
        get(ref(database, 'Stories'))
      ]).then(([booksSnapshot, storiesSnapshot]) => {
        const books = booksSnapshot.val();
        const stories = storiesSnapshot.val();
        
        // Calculate daily views for last 24 days
        const dailyViews = [];
        const currentDate = new Date();
        
        for (let i = 23; i >= 0; i--) {
          const date = new Date(currentDate);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          
          let dayViews = 0;
          
          // Sum views from books for this day
          if (books) {
            Object.values(books).forEach(book => {
              // Simulate daily views based on total views and publish date
              const publishDate = new Date(book.publish_date || book.created_at);
              const daysSincePublish = Math.floor((date - publishDate) / (1000 * 60 * 60 * 24));
              
              if (daysSincePublish >= 0 && daysSincePublish <= 30) {
                // Simulate daily views (this is a simplified calculation)
                const dailyAverage = (book.view_count || 0) / 30;
                dayViews += Math.round(dailyAverage * (1 + Math.random() * 0.5));
              }
            });
          }
          
          // Sum views from stories for this day
          if (stories) {
            Object.values(stories).forEach(story => {
              const publishDate = new Date(story.publish_date || story.created_at);
              const daysSincePublish = Math.floor((date - publishDate) / (1000 * 60 * 60 * 24));
              
              if (daysSincePublish >= 0 && daysSincePublish <= 30) {
                const dailyAverage = (story.view_count || 0) / 30;
                dayViews += Math.round(dailyAverage * (1 + Math.random() * 0.5));
              }
            });
          }
          
          dailyViews.push(dayViews);
        }
        
        // Create chart points
        const W = 600, H = 220, base = 220;
        const maxViews = Math.max(...dailyViews);
        const scale = maxViews > 0 ? 160 / maxViews : 1;
        
        const points = dailyViews.map((views, i) => {
        const x = Math.round((W-10) * (i/23));
          const y = Math.round(base - (40 + views * scale));
        return [x, clamp(y, 40, base-10)];
      });
        
      // Build polyline with baseline to fill
      const pts = [[0, base], ...points, [W, base]].map(p=>p.join(',')).join(' ');
      el.setAttribute('points', pts);
      el.style.strokeDasharray = '1200';
      el.style.strokeDashoffset = '1200';
      el.animate([
        { strokeDashoffset: 1200 },
        { strokeDashoffset: 0 }
      ], { duration: 1400, easing: 'ease-out', fill:'forwards' });
      });
    }
    
    // Initialize area chart with real data (moved to loadOverviewData)
    // updateAreaChartWithRealData();

    // Donut percentage pulse
  (function donut(){
      const d = document.getElementById('donut'); if(!d) return;
      const val = Number(d.getAttribute('data-label')) || 72;
      d.style.setProperty('--val', val);
      // gentle pulse
      d.animate([
        { filter: 'drop-shadow(0 10px 20px rgba(124,92,255,.35))' },
        { filter: 'drop-shadow(0 18px 40px rgba(34,228,255,.35))' },
        { filter: 'drop-shadow(0 10px 20px rgba(124,92,255,.35))' }
      ], { duration: 4000, iterations: Infinity });
    })();

    // Gentle parallax on scroll for orbs
    (function parallax(){
      const o1 = document.querySelector('.orb.one');
      const o2 = document.querySelector('.orb.two');
      const o3 = document.querySelector('.orb.three');
      if(!o1||!o2||!o3) return;
      const onScroll = ()=>{
        const y = window.scrollY || 0;
        o1.style.transform = `translateY(${y*0.04}px)`;
        o2.style.transform = `translateY(${y*-0.03}px)`;
        o3.style.transform = `translateY(${y*0.02}px)`;
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();
  </script>

  <!-- Author Details Modal -->
  <div id="authorModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Chi tiết tác giả</h2>
        <span class="close" onclick="closeAuthorModal()">&times;</span>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Book Details Modal -->
  <div id="bookModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="bookModalTitle">Chi tiết sách</h2>
        <span class="close" onclick="closeBookModal()">&times;</span>
      </div>
      <div class="modal-body" id="bookModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Story Details Modal -->
  <div id="storyModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="storyModalTitle">Chi tiết truyện</h2>
        <span class="close" onclick="closeStoryModal()">&times;</span>
      </div>
      <div class="modal-body" id="storyModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Edit Book Modal -->
  <div id="editBookModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="editBookModalTitle">Chỉnh sửa sách</h2>
        <span class="close" onclick="closeEditBookModal()">&times;</span>
      </div>
      <div class="modal-body" id="editBookModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Edit Story Modal -->
  <div id="editStoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="editStoryModalTitle">Chỉnh sửa truyện</h2>
        <span class="close" onclick="closeEditStoryModal()">&times;</span>
      </div>
      <div class="modal-body" id="editStoryModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add Book Modal -->
  <div id="addBookModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Thêm sách mới</h2>
        <span class="close" onclick="closeAddBookModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form onsubmit="addNewBook(event)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Thông tin cơ bản</h4>
              
              <div class="form-group">
                <label for="addBookTitle">Tên sách *</label>
                <input type="text" id="addBookTitle" required>
              </div>
              
              <div class="form-group">
                <label for="addBookAuthor">Tác giả *</label>
                <input type="text" id="addBookAuthor" required>
              </div>
              
              <div class="form-group">
                <label for="addBookGenre">Thể loại *</label>
                <select id="addBookGenre" required>
                  <option value="">Chọn thể loại</option>
                  <option value="Tiểu thuyết">Tiểu thuyết</option>
                  <option value="Kỹ năng sống">Kỹ năng sống</option>
                  <option value="Fantasy">Fantasy</option>
                  <option value="Thơ">Thơ</option>
                  <option value="Công nghệ">Công nghệ</option>
                  <option value="Nấu ăn">Nấu ăn</option>
                  <option value="Chiến lược">Chiến lược</option>
                  <option value="Thành công">Thành công</option>
                  <option value="Khoa học">Khoa học</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addBookPrice">Giá (VNĐ)</label>
                <input type="number" id="addBookPrice" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addBookPages">Số trang</label>
                <input type="number" id="addBookPages" min="1">
              </div>
              
              <div class="form-group">
                <label for="addBookLanguage">Ngôn ngữ</label>
                <select id="addBookLanguage">
                  <option value="Vietnamese">Tiếng Việt</option>
                  <option value="English">Tiếng Anh</option>
                  <option value="Chinese">Tiếng Trung</option>
                  <option value="Korean">Tiếng Hàn</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addBookFormat">Định dạng</label>
                <select id="addBookFormat">
                  <option value="Paperback">Bìa mềm</option>
                  <option value="Hardcover">Bìa cứng</option>
                  <option value="Ebook">Ebook</option>
                  <option value="Audiobook">Audiobook</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addBookSize">Kích thước</label>
                <input type="text" id="addBookSize" placeholder="VD: 16x24cm">
              </div>
              
              <div class="form-group">
                <label for="addBookWeight">Trọng lượng (g)</label>
                <input type="number" id="addBookWeight" min="0" placeholder="VD: 400">
              </div>
              
              <div class="form-group">
                <label for="addBookPublisher">Nhà xuất bản</label>
                <input type="text" id="addBookPublisher">
              </div>
              
              <div class="form-group">
                <label for="addBookIsbn">ISBN</label>
                <input type="text" id="addBookIsbn">
              </div>
              
              <div class="form-group">
                <label for="addBookPublishDate">Ngày xuất bản</label>
                <input type="date" id="addBookPublishDate">
              </div>
              
              <div class="form-group">
                <label for="addBookStock">Số lượng tồn kho</label>
                <input type="number" id="addBookStock" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addBookDescription">Mô tả</label>
                <textarea id="addBookDescription" rows="4"></textarea>
              </div>
            </div>
            
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Cài đặt & Thống kê</h4>
              
              <div class="form-group">
                <label for="addBookCategory">Danh mục</label>
                <select id="addBookCategory">
                  <option value="Featured Books">Featured Books</option>
                  <option value="New Books">New Books</option>
                  <option value="Best Sellers">Best Sellers</option>
                  <option value="Classic Books">Classic Books</option>
                  <option value="Educational">Educational</option>
                  <option value="Fiction">Fiction</option>
                  <option value="Non-Fiction">Non-Fiction</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addBookStatus">Trạng thái</label>
                <select id="addBookStatus">
                  <option value="Thường">Thường</option>
                  <option value="Nổi bật">Nổi bật</option>
                  <option value="VIP">VIP</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addBookViewCount">Lượt xem</label>
                <input type="number" id="addBookViewCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addBookDownloadCount">Lượt tải</label>
                <input type="number" id="addBookDownloadCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addBookRating">Đánh giá</label>
                <input type="number" id="addBookRating" min="0" max="5" step="0.1" value="0">
              </div>
              
              <div class="form-group">
                <label for="addBookReviewCount">Số đánh giá</label>
                <input type="number" id="addBookReviewCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label>Ảnh bìa</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <button type="button" onclick="openImageUpload()" class="btn" style="background: var(--primary);">
                    <i class="fa fa-cloud-upload"></i> Upload ảnh
                  </button>
                  <div id="addBookImagePreview" style="flex: 1;">
                    <span style="color: var(--muted);">Chưa có ảnh</span>
                  </div>
                </div>
                <input type="hidden" id="addBookCoverImage" value="">
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" onclick="closeAddBookModal()" class="btn" style="background: var(--muted);">
              Hủy
            </button>
            <button type="submit" class="btn" style="background: var(--success); color: white;">
              Thêm sách
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Story Modal -->
  <div id="addStoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Thêm truyện mới</h2>
        <span class="close" onclick="closeAddStoryModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form onsubmit="addNewStory(event)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Thông tin cơ bản</h4>
              
              <div class="form-group">
                <label for="addStoryTitle">Tên truyện *</label>
                <input type="text" id="addStoryTitle" required>
              </div>
              
              <div class="form-group">
                <label for="addStoryAuthor">Tác giả *</label>
                <input type="text" id="addStoryAuthor" required>
              </div>
              
              <div class="form-group">
                <label for="addStoryCategoryCode">Mã danh mục</label>
                <select id="addStoryCategoryCode">
                  <option value="">Chọn danh mục</option>
                  <option value="TM001">TM001 - Truyện mới</option>
                  <option value="TNB002">TNB002 - Truyện nổi bật</option>
                  <option value="THV004">THV004 - Truyện hội viên</option>
                  <option value="TMF003">TMF003 - Truyện miễn phí</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addStoryCategoryName">Tên danh mục</label>
                <input type="text" id="addStoryCategoryName" placeholder="VD: New Stories, Featured Stories...">
              </div>
              
              <div class="form-group">
                <label for="addStoryGenre">Thể loại *</label>
                <select id="addStoryGenre" required>
                  <option value="">Chọn thể loại</option>
                  <option value="Thơ">Thơ</option>
                  <option value="Cổ tích">Cổ tích</option>
                  <option value="Truyện ngắn">Truyện ngắn</option>
                  <option value="Tình cảm">Tình cảm</option>
                  <option value="Tiểu thuyết">Tiểu thuyết</option>
                  <option value="Phiêu lưu">Phiêu lưu</option>
                  <option value="Trinh thám">Trinh thám</option>
                  <option value="Kinh dị">Kinh dị</option>
                  <option value="Hài hước">Hài hước</option>
                  <option value="Lịch sử">Lịch sử</option>
                  <option value="Thiếu nhi">Thiếu nhi</option>
                  <option value="Tùy bút">Tùy bút</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addStoryTags">Tags</label>
                <input type="text" id="addStoryTags" placeholder="VD: thơ, Nguyễn Du, văn học cổ điển (phân cách bằng dấu phẩy)">
              </div>
              
              <div class="form-group">
                <label for="addStoryPrice">Giá (VNĐ)</label>
                <input type="number" id="addStoryPrice" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryOriginalPrice">Giá gốc (VNĐ)</label>
                <input type="number" id="addStoryOriginalPrice" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryChapters">Số chương</label>
                <input type="number" id="addStoryChapters" min="1" value="1">
              </div>
              
              <div class="form-group">
                <label for="addStoryWordCount">Số từ</label>
                <input type="number" id="addStoryWordCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryLanguage">Ngôn ngữ</label>
                <select id="addStoryLanguage">
                  <option value="Vietnamese">Tiếng Việt</option>
                  <option value="English">Tiếng Anh</option>
                  <option value="Chinese">Tiếng Trung</option>
                  <option value="Korean">Tiếng Hàn</option>
                  <option value="Japanese">Tiếng Nhật</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addStoryStatus">Trạng thái</label>
                <select id="addStoryStatus">
                  <option value="Ongoing">Đang cập nhật</option>
                  <option value="Completed">Hoàn thành</option>
                  <option value="Paused">Tạm dừng</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addStoryPublishDate">Ngày xuất bản</label>
                <input type="date" id="addStoryPublishDate">
              </div>
              
              <div class="form-group">
                <label for="addStoryLastUpdated">Cập nhật lần cuối</label>
                <input type="date" id="addStoryLastUpdated">
              </div>
              
              <div class="form-group">
                <label for="addStoryPublisher">Nhà xuất bản</label>
                <input type="text" id="addStoryPublisher" placeholder="VD: AnBok Collection, Tác giả tự xuất bản...">
              </div>
              
              <div class="form-group">
                <label for="addStoryDescription">Mô tả</label>
                <textarea id="addStoryDescription" rows="4"></textarea>
              </div>
            </div>
            
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Cài đặt & Thống kê</h4>
              
              <div class="form-group">
                <label for="addStoryDisplayStatus">Hiển thị</label>
                <select id="addStoryDisplayStatus">
                  <option value="normal">Thường</option>
                  <option value="featured">Nổi bật</option>
                  <option value="vip">VIP</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="addStoryRating">Đánh giá</label>
                <input type="number" id="addStoryRating" min="0" max="5" step="0.1" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryReviewCount">Số lượt đánh giá</label>
                <input type="number" id="addStoryReviewCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryViewCount">Lượt xem</label>
                <input type="number" id="addStoryViewCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryFavoriteCount">Lượt yêu thích</label>
                <input type="number" id="addStoryFavoriteCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryCommentCount">Số bình luận</label>
                <input type="number" id="addStoryCommentCount" min="0" value="0">
              </div>
              
              <div class="form-group">
                <label for="addStoryStoryId">Mã truyện</label>
                <input type="text" id="addStoryStoryId" placeholder="VD: ST001, ST002...">
              </div>
              
              <div class="form-group">
                <label>Ảnh bìa</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <button type="button" onclick="openImageUpload()" class="btn" style="background: var(--primary);">
                    <i class="fa fa-cloud-upload"></i> Upload ảnh
                  </button>
                  <div id="addStoryImagePreview" style="flex: 1;">
                    <span style="color: var(--muted);">Chưa có ảnh</span>
                  </div>
                </div>
                <input type="hidden" id="addStoryCoverImage" value="">
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" onclick="closeAddStoryModal()" class="btn" style="background: var(--muted);">
              Hủy
            </button>
            <button type="submit" class="btn" style="background: var(--success); color: white;">
              Thêm truyện
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Manuscript Modal -->
  <div id="addManuscriptModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Thêm Bản thảo</h2>
        <span class="close" onclick="closeAddManuscriptModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form onsubmit="addManuscript(event)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Thông tin tác phẩm</h4>
              
              <div class="form-group">
                <label for="manuscriptTitle">Tên tác phẩm *</label>
                <input type="text" id="manuscriptTitle" required>
              </div>
              
              <div class="form-group">
                <label for="manuscriptAuthor">Tác giả *</label>
                <input type="text" id="manuscriptAuthor" required>
              </div>
              
              <div class="form-group">
                <label for="manuscriptType">Loại tác phẩm *</label>
                <select id="manuscriptType" required>
                  <option value="">Chọn loại</option>
                  <option value="book">Sách</option>
                  <option value="story">Truyện</option>
                  <option value="poem">Thơ</option>
                  <option value="article">Bài viết</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="manuscriptGenre">Thể loại</label>
                <input type="text" id="manuscriptGenre" placeholder="VD: Tiểu thuyết, Kỹ năng sống...">
              </div>
              
              <div class="form-group">
                <label for="manuscriptLanguage">Ngôn ngữ</label>
                <select id="manuscriptLanguage">
                  <option value="Vietnamese">Tiếng Việt</option>
                  <option value="English">Tiếng Anh</option>
                  <option value="Chinese">Tiếng Trung</option>
                  <option value="Korean">Tiếng Hàn</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="manuscriptWordCount">Số từ</label>
                <input type="number" id="manuscriptWordCount" min="0" placeholder="Số từ ước tính">
              </div>
            </div>
            
            <div>
              <h4 style="margin: 0 0 16px 0; color: var(--text);">Nội dung & Đánh giá</h4>
              
              <div class="form-group">
                <label for="manuscriptDescription">Mô tả tác phẩm</label>
                <textarea id="manuscriptDescription" rows="3" placeholder="Tóm tắt nội dung tác phẩm"></textarea>
              </div>
              
              <div class="form-group">
                <label for="manuscriptContent">Nội dung chính</label>
                <textarea id="manuscriptContent" rows="6" placeholder="Nội dung tác phẩm hoặc link file"></textarea>
              </div>
              
              <div class="form-group">
                <label for="manuscriptQuality">Chất lượng nội dung</label>
                <select id="manuscriptQuality">
                  <option value="excellent">Xuất sắc</option>
                  <option value="good">Tốt</option>
                  <option value="average">Trung bình</option>
                  <option value="poor">Kém</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="manuscriptNotes">Ghi chú đánh giá</label>
                <textarea id="manuscriptNotes" rows="3" placeholder="Nhận xét, góp ý về tác phẩm"></textarea>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" onclick="closeAddManuscriptModal()" class="btn" style="background: var(--muted);">
              Hủy
            </button>
            <button type="submit" class="btn" style="background: var(--success); color: white;">
              Thêm bản thảo
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Manuscript Details Modal -->
  <div id="manuscriptModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="manuscriptModalTitle">Chi tiết bản thảo</h2>
        <span class="close" onclick="closeManuscriptModal()">&times;</span>
      </div>
      <div class="modal-body" id="manuscriptModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Promotion Management Modal -->
  <div id="promotionModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="promotionModalTitle">Chi tiết mã khuyến mãi</h2>
        <span class="close" onclick="closePromotionModal()">&times;</span>
      </div>
      <div class="modal-body" id="promotionModalBody">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Import Excel Modal -->
  <div id="importModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import dữ liệu kho từ Excel</h2>
        <span class="close" onclick="closeImportModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div style="text-align: center; padding: 20px;">
          <div style="margin-bottom: 20px;">
            <i class="fa fa-file-excel-o" style="font-size: 48px; color: var(--success); margin-bottom: 16px;"></i>
            <h3>Upload file Excel</h3>
            <p style="color: var(--muted);">Chọn file Excel (.xlsx) chứa thông tin kho sách</p>
          </div>
          
          <div style="border: 2px dashed var(--stroke); border-radius: 12px; padding: 40px; margin-bottom: 20px;">
            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
            <button onclick="document.getElementById('excelFile').click()" class="btn" style="background: var(--primary); color: white; margin-bottom: 16px;">
              <i class="fa fa-upload"></i> Chọn file Excel
            </button>
            <p id="selectedFileName" style="color: var(--muted); font-size: 14px;">Chưa chọn file nào</p>
          </div>
          
          <div style="text-align: left; background: rgba(255,255,255,.04); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px 0; color: var(--text);">Cấu trúc file Excel cần có:</h4>
            <ul style="color: var(--muted); font-size: 14px; line-height: 1.6;">
              <li><strong>Tên sách:</strong> Tên đầy đủ của sách</li>
              <li><strong>Tác giả:</strong> Tên tác giả</li>
              <li><strong>Số lượng:</strong> Số lượng nhập kho</li>
              <li><strong>Vị trí:</strong> Vị trí trong kho</li>
              <li><strong>Giá nhập:</strong> Giá nhập (VNĐ)</li>
              <li><strong>Giá bán:</strong> Giá bán (VNĐ)</li>
              <li><strong>Nhà cung cấp:</strong> Tên nhà cung cấp (tùy chọn)</li>
            </ul>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button type="button" onclick="closeImportModal()" class="btn" style="background: var(--muted);">
              Hủy
            </button>
            <button onclick="importExcelData()" class="btn" style="background: var(--success); color: white;">
              <i class="fa fa-upload"></i> Import dữ liệu
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      backdrop-filter: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-3d);
      margin: 5% auto;
      padding: 0;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(124,92,255,.1);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text);
      font-size: 20px;
      font-weight: 700;
    }

    .close {
      color: var(--muted);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255,255,255,.1);
    }

    .close:hover {
      color: var(--danger);
      background: rgba(255,94,115,.1);
    }

    .modal-body {
      padding: 24px;
    }

    .author-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .info-section {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 20px;
    }

    .info-section h3 {
      margin: 0 0 16px 0;
      color: var(--primary);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }

    .info-value {
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      text-align: right;
      max-width: 200px;
      word-break: break-word;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pending {
      background: rgba(255,176,32,.2);
      color: var(--warning);
      border: 1px solid rgba(255,176,32,.3);
    }

    .status-approved {
      background: rgba(34,211,163,.2);
      color: var(--success);
      border: 1px solid rgba(34,211,163,.3);
    }

    .status-blocked {
      background: rgba(255,94,115,.2);
      color: var(--danger);
      border: 1px solid rgba(255,94,115,.3);
    }

    .author-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 8px 24px rgba(124,92,255,.3);
    }

    .author-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(124,92,255,.08);
      border-radius: 12px;
      border: 1px solid rgba(124,92,255,.2);
    }

    .author-details h1 {
      margin: 0 0 8px 0;
      color: var(--text);
      font-size: 24px;
      font-weight: 700;
    }

    .author-details p {
      margin: 0;
      color: var(--muted);
    }

    /* Book and Story Modal Styles */
    .book-header, .story-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(124,92,255,.08);
      border-radius: 12px;
      border: 1px solid rgba(124,92,255,.2);
    }

    .book-cover, .story-cover {
      width: 120px;
      height: 160px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 8px 24px rgba(124,92,255,.3);
    }

    .book-details h1, .story-details h1 {
      margin: 0 0 8px 0;
      color: var(--text);
      font-size: 24px;
      font-weight: 700;
    }

    .book-details p, .story-details p {
      margin: 0 0 4px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .book-details .status-badge, .story-details .status-badge {
      margin-top: 8px;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 8px;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,.12);
      box-shadow: 0 0 0 3px rgba(124,92,255,.1);
    }

    /* Dropdown options styling */
    .form-group select option {
      background: var(--bg-2);
      color: var(--text);
      padding: 8px 12px;
      border: none;
    }

    .form-group select option:hover {
      background: var(--primary);
      color: white;
    }

    .form-group select option:checked {
      background: var(--primary);
      color: white;
    }

    .form-group input[type="number"] {
      appearance: textfield;
      -moz-appearance: textfield;
    }

    .form-group input[type="number"]::-webkit-outer-spin-button,
    .form-group input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      .author-info-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .author-header {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>

  <script>
    // Modal functions
    function openAuthorModal() {
      document.getElementById('authorModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeAuthorModal() {
      document.getElementById('authorModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openBookModal() {
      document.getElementById('bookModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeBookModal() {
      document.getElementById('bookModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openStoryModal() {
      document.getElementById('storyModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeStoryModal() {
      document.getElementById('storyModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openEditBookModal() {
      document.getElementById('editBookModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeEditBookModal() {
      document.getElementById('editBookModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openEditStoryModal() {
      document.getElementById('editStoryModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeEditStoryModal() {
      document.getElementById('editStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Open add book modal
    function openAddBookModal() {
      // Clear form fields
      document.getElementById('addBookTitle').value = '';
      document.getElementById('addBookAuthor').value = '';
      document.getElementById('addBookGenre').value = '';
      document.getElementById('addBookPrice').value = '';
      document.getElementById('addBookPages').value = '';
      document.getElementById('addBookLanguage').value = 'Vietnamese';
      document.getElementById('addBookFormat').value = 'Paperback';
      document.getElementById('addBookSize').value = '';
      document.getElementById('addBookWeight').value = '';
      document.getElementById('addBookPublisher').value = '';
      document.getElementById('addBookIsbn').value = '';
      document.getElementById('addBookPublishDate').value = '';
      document.getElementById('addBookStock').value = '0';
      document.getElementById('addBookCategory').value = 'Featured Books';
      document.getElementById('addBookStatus').value = 'Thường';
      document.getElementById('addBookViewCount').value = '0';
      document.getElementById('addBookDownloadCount').value = '0';
      document.getElementById('addBookRating').value = '0';
      document.getElementById('addBookReviewCount').value = '0';
      document.getElementById('addBookDescription').value = '';
      document.getElementById('addBookCoverImage').value = '';
      document.getElementById('addBookImagePreview').innerHTML = '<span style="color: var(--muted);">Chưa có ảnh</span>';
      
      // Show modal
      document.getElementById('addBookModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    // Close add book modal
    function closeAddBookModal() {
      document.getElementById('addBookModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Open add story modal
    function openAddStoryModal() {
      // Clear form fields
      document.getElementById('addStoryTitle').value = '';
      document.getElementById('addStoryAuthor').value = '';
      document.getElementById('addStoryCategoryCode').value = '';
      document.getElementById('addStoryCategoryName').value = '';
      document.getElementById('addStoryGenre').value = '';
      document.getElementById('addStoryTags').value = '';
      document.getElementById('addStoryPrice').value = '';
      document.getElementById('addStoryOriginalPrice').value = '';
      document.getElementById('addStoryChapters').value = '';
      document.getElementById('addStoryWordCount').value = '';
      document.getElementById('addStoryLanguage').value = 'Vietnamese';
      document.getElementById('addStoryStatus').value = 'Ongoing';
      document.getElementById('addStoryPublishDate').value = '';
      document.getElementById('addStoryLastUpdated').value = '';
      document.getElementById('addStoryPublisher').value = '';
      document.getElementById('addStoryDisplayStatus').value = 'normal';
      document.getElementById('addStoryRating').value = '0';
      document.getElementById('addStoryReviewCount').value = '0';
      document.getElementById('addStoryViewCount').value = '0';
      document.getElementById('addStoryFavoriteCount').value = '0';
      document.getElementById('addStoryCommentCount').value = '0';
      document.getElementById('addStoryStoryId').value = '';
      document.getElementById('addStoryDescription').value = '';
      document.getElementById('addStoryCoverImage').value = '';
      document.getElementById('addStoryImagePreview').innerHTML = '<span style="color: var(--muted);">Chưa có ảnh</span>';
      
      // Show modal
      document.getElementById('addStoryModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    // Close add story modal
    function closeAddStoryModal() {
      document.getElementById('addStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Add new book
    function addNewBook(event) {
      event.preventDefault();
      
      const { database, ref, push } = window.firebase;
      
      // Get form values
      const title = document.getElementById('addBookTitle').value;
      const author = document.getElementById('addBookAuthor').value;
      const genre = document.getElementById('addBookGenre').value;
      const price = parseInt(document.getElementById('addBookPrice').value) || 0;
      const pages = parseInt(document.getElementById('addBookPages').value) || 0;
      const language = document.getElementById('addBookLanguage').value;
      const format = document.getElementById('addBookFormat').value;
      const size = document.getElementById('addBookSize').value;
      const weight = parseInt(document.getElementById('addBookWeight').value) || 0;
      const publisher = document.getElementById('addBookPublisher').value;
      const isbn = document.getElementById('addBookIsbn').value;
      const publishDate = document.getElementById('addBookPublishDate').value;
      const stock = parseInt(document.getElementById('addBookStock').value) || 0;
      const category = document.getElementById('addBookCategory').value;
      const status = document.getElementById('addBookStatus').value;
      const viewCount = parseInt(document.getElementById('addBookViewCount').value) || 0;
      const downloadCount = parseInt(document.getElementById('addBookDownloadCount').value) || 0;
      const rating = parseFloat(document.getElementById('addBookRating').value) || 0;
      const reviewCount = parseInt(document.getElementById('addBookReviewCount').value) || 0;
      const description = document.getElementById('addBookDescription').value;
      const coverImage = document.getElementById('addBookCoverImage').value;

      // Validate required fields
      if (!title || !author || !genre) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng điền đầy đủ thông tin bắt buộc (*)',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang thêm sách...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Generate book ID
      const bookId = `book_${Date.now()}`;

      // Prepare book data
      const bookData = {
        book_id: bookId,
        title: title,
        author: author,
        genre: genre,
        price: price,
        pages: pages,
        language: language,
        format: format,
        size: size,
        weight: weight,
        publisher: publisher,
        isbn: isbn,
        publish_date: publishDate,
        stock: stock,
        category: category,
        description: description,
        cover_image: coverImage || 'images/books/img-01.jpg',
        view_count: viewCount,
        download_count: downloadCount,
        rating: rating,
        review_count: reviewCount,
        is_free: price === 0,
        is_featured: status === 'Nổi bật',
        is_member_only: status === 'VIP',
        created_at: new Date().toISOString()
      };

      // Add to Firebase
      try {
        set(ref(database, `Books/${bookId}`), bookData).then(() => {
          loadingSwal.close();
          Swal.fire({
            title: 'Thành công!',
            text: 'Sách đã được thêm thành công',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          }).then(() => {
            closeAddBookModal();
            // Reload data
            loadBooksData();
          });
        }).catch((error) => {
          console.error('Error adding book:', error);
          loadingSwal.close();
          Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể thêm sách',
            icon: 'error',
            confirmButtonColor: '#ff5e73'
          });
        });
      } catch (error) {
        console.error('Error in addNewBook:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Có lỗi xảy ra khi thêm sách',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      }
    }

    // Add new story
    function addNewStory(event) {
      event.preventDefault();
      
      const { database, ref, set } = window.firebase;
      
      // Get form values
      const title = document.getElementById('addStoryTitle').value;
      const author = document.getElementById('addStoryAuthor').value;
      const categoryCode = document.getElementById('addStoryCategoryCode').value;
      const categoryName = document.getElementById('addStoryCategoryName').value;
      const genre = document.getElementById('addStoryGenre').value;
      const tags = document.getElementById('addStoryTags').value;
      const price = parseInt(document.getElementById('addStoryPrice').value) || 0;
      const originalPrice = parseInt(document.getElementById('addStoryOriginalPrice').value) || 0;
      const chapters = parseInt(document.getElementById('addStoryChapters').value) || 1;
      const wordCount = parseInt(document.getElementById('addStoryWordCount').value) || 0;
      const language = document.getElementById('addStoryLanguage').value;
      const status = document.getElementById('addStoryStatus').value;
      const publishDate = document.getElementById('addStoryPublishDate').value;
      const lastUpdated = document.getElementById('addStoryLastUpdated').value;
      const publisher = document.getElementById('addStoryPublisher').value;
      const displayStatus = document.getElementById('addStoryDisplayStatus').value;
      const rating = parseFloat(document.getElementById('addStoryRating').value) || 0;
      const reviewCount = parseInt(document.getElementById('addStoryReviewCount').value) || 0;
      const viewCount = parseInt(document.getElementById('addStoryViewCount').value) || 0;
      const favoriteCount = parseInt(document.getElementById('addStoryFavoriteCount').value) || 0;
      const commentCount = parseInt(document.getElementById('addStoryCommentCount').value) || 0;
      const storyId = document.getElementById('addStoryStoryId').value;
      const description = document.getElementById('addStoryDescription').value;
      const coverImage = document.getElementById('addStoryCoverImage').value;

      // Validate required fields
      if (!title || !author || !genre) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Vui lòng điền đầy đủ thông tin bắt buộc (*)',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }

      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang thêm truyện...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Generate story ID if not provided
      const finalStoryId = storyId || `story_${Date.now()}`;

      // Process tags
      const tagsArray = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

      // Prepare story data
      const storyData = {
        story_id: finalStoryId,
        title: title,
        author: author,
        category_code: categoryCode,
        category_name: categoryName,
        genre: genre,
        tags: tagsArray,
        price: price,
        original_price: originalPrice,
        chapters: chapters,
        word_count: wordCount,
        language: language,
        status: status,
        publish_date: publishDate,
        last_updated: lastUpdated || new Date().toISOString().split('T')[0],
        publisher: publisher || author, // Sử dụng tên tác giả làm nhà xuất bản nếu không có
        description: description,
        cover_image: coverImage || 'images/books/img-01.jpg',
        is_free: price === 0,
        is_featured: displayStatus === 'featured',
        is_member_only: displayStatus === 'vip',
        rating: rating,
        review_count: reviewCount,
        view_count: viewCount,
        favorite_count: favoriteCount,
        comment_count: commentCount,
        created_at: new Date().toISOString()
      };

      // Add to Firebase
      try {
        set(ref(database, `Stories/${storyId}`), storyData).then(() => {
          loadingSwal.close();
          Swal.fire({
            title: 'Thành công!',
            text: 'Truyện đã được thêm thành công',
            icon: 'success',
            confirmButtonColor: '#22d3a3'
          }).then(() => {
            closeAddStoryModal();
            // Reload data
            loadStoriesData();
          });
        }).catch((error) => {
          console.error('Error adding story:', error);
          loadingSwal.close();
          Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể thêm truyện',
            icon: 'error',
            confirmButtonColor: '#ff5e73'
          });
        });
      } catch (error) {
        console.error('Error in addNewStory:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Có lỗi xảy ra khi thêm truyện',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const authorModal = document.getElementById('authorModal');
      const bookModal = document.getElementById('bookModal');
      const storyModal = document.getElementById('storyModal');
      const editBookModal = document.getElementById('editBookModal');
      const editStoryModal = document.getElementById('editStoryModal');
      const addBookModal = document.getElementById('addBookModal');
      const addStoryModal = document.getElementById('addStoryModal');
      const addManuscriptModal = document.getElementById('addManuscriptModal');
      const manuscriptModal = document.getElementById('manuscriptModal');
      const importModal = document.getElementById('importModal');
      
      if (event.target === authorModal) {
        closeAuthorModal();
      }
      if (event.target === bookModal) {
        closeBookModal();
      }
      if (event.target === storyModal) {
        closeStoryModal();
      }
      if (event.target === editBookModal) {
        closeEditBookModal();
      }
      if (event.target === editStoryModal) {
        closeEditStoryModal();
      }
      if (event.target === addBookModal) {
        closeAddBookModal();
      }
      if (event.target === addStoryModal) {
        closeAddStoryModal();
      }
      if (event.target === addManuscriptModal) {
        closeAddManuscriptModal();
      }
      if (event.target === manuscriptModal) {
        closeManuscriptModal();
      }
      if (event.target === importModal) {
        closeImportModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAuthorModal();
        closeBookModal();
        closeStoryModal();
        closeEditBookModal();
        closeEditStoryModal();
        closeAddBookModal();
        closeAddStoryModal();
        closeAddManuscriptModal();
        closeManuscriptModal();
        closeImportModal();
        closeAddNewsModal();
        closeEditNewsModal();
      }
    });

    // News Management Functions
    function loadNewsData() {
      const { database, ref, onValue, get, set } = window.firebase;
      const newsRef = ref(database, 'news');
      
      // Set up listener for real-time updates
      onValue(newsRef, (snapshot) => {
        const news = snapshot.val();
        if (news) {
          updateNewsTable(news);
          updateNewsStats(news);
        }
      });
      
      // Get current data for immediate display
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (news) {
          updateNewsTable(news);
          updateNewsStats(news);
        } else {
          // Create sample news if none exists
          createSampleNews();
        }
      }).catch((error) => {
        console.error('Error loading news data:', error);
      });
    }
    
    function createSampleNews() {
      const { database, ref, push } = window.firebase;
      const newsRef = ref(database, 'news');
      
      const sampleNews = [
        {
          title: 'Chào mừng đến với AnBok Collection',
          excerpt: 'Khám phá thế giới sách và truyện đầy màu sắc tại AnBok Collection',
          content: 'AnBok Collection là nền tảng đọc sách và truyện trực tuyến hàng đầu Việt Nam. Chúng tôi cung cấp hàng nghìn đầu sách và truyện chất lượng cao, từ các tác phẩm kinh điển đến những câu chuyện mới nhất. Hãy tham gia cùng chúng tôi để khám phá thế giới văn học đầy thú vị!',
          author: 'Admin',
          category: 'Tin tức',
          status: 'published',
          imageUrl: 'images/img-01.jpg',
          isFeatured: true,
          createdAt: Date.now() - 86400000, // 1 day ago
          updatedAt: Date.now() - 86400000,
          viewCount: 156,
          likes: 23,
          comments: 8
        },
        {
          title: 'Cập nhật hệ thống mới',
          excerpt: 'AnBok Collection ra mắt giao diện mới với nhiều tính năng hấp dẫn',
          content: 'Chúng tôi vui mừng thông báo về việc ra mắt giao diện mới của AnBok Collection. Giao diện mới được thiết kế với trải nghiệm người dùng tốt hơn, tốc độ tải nhanh hơn và nhiều tính năng mới hấp dẫn. Hãy trải nghiệm ngay hôm nay!',
          author: 'Admin',
          category: 'Công nghệ',
          status: 'published',
          imageUrl: 'images/img-02.jpg',
          isFeatured: false,
          createdAt: Date.now() - 172800000, // 2 days ago
          updatedAt: Date.now() - 172800000,
          viewCount: 89,
          likes: 15,
          comments: 5
        },
        {
          title: 'Sự kiện đọc sách mùa hè',
          excerpt: 'Tham gia sự kiện đọc sách mùa hè với nhiều phần thưởng hấp dẫn',
          content: 'Mùa hè này, AnBok Collection tổ chức sự kiện đọc sách đặc biệt dành cho tất cả độc giả. Tham gia đọc sách, viết review và nhận nhiều phần thưởng giá trị. Sự kiện diễn ra từ ngày 1/6 đến 31/8 với nhiều hoạt động thú vị.',
          author: 'Admin',
          category: 'Sự kiện',
          status: 'draft',
          imageUrl: 'images/img-03.jpg',
          isFeatured: true,
          createdAt: Date.now() - 259200000, // 3 days ago
          updatedAt: Date.now() - 259200000,
          viewCount: 0,
          likes: 0,
          comments: 0
        }
      ];
      
      // Add sample news to database
      sampleNews.forEach(newsItem => {
        push(newsRef, newsItem);
      });
      
      console.log('Sample news created successfully');
    }

    function updateNewsTable(news) {
      const tbody = document.getElementById('newsTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(news).forEach(newsId => {
        const newsItem = news[newsId];
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.08)';
        
        const statusColor = getNewsStatusColor(newsItem.status);
        const statusText = getNewsStatusText(newsItem.status);
        const featuredBadge = newsItem.isFeatured ? '<span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">Nổi bật</span>' : '';
        
        row.innerHTML = `
          <td style="padding:16px 12px;">
            <img src="${newsItem.imageUrl || 'images/img-01.jpg'}" alt="${newsItem.title}" style="width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid var(--stroke);" onerror="this.src='images/img-01.jpg'">
          </td>
          <td style="padding:16px 12px;">
            <strong>${newsItem.title}</strong>
            <br><small style="color:var(--muted);">${newsItem.excerpt || newsItem.content?.substring(0, 80) || 'Không có mô tả'}...</small>
            ${featuredBadge}
          </td>
          <td style="padding:16px 12px;">${newsItem.author || 'Admin'}</td>
          <td style="padding:16px 12px;">${newsItem.category || 'Tin tức'}</td>
          <td style="padding:16px 12px;">${new Date(newsItem.createdAt || Date.now()).toLocaleDateString('vi-VN')}</td>
          <td style="padding:16px 12px;">
            <span style="color:${statusColor};font-weight:600;">${statusText}</span>
          </td>
          <td style="padding:16px 12px;">${newsItem.viewCount || 0}</td>
          <td style="padding:16px 12px;">
            <button class="btn" onclick="viewNewsDetails('${newsId}')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
            <button class="btn" onclick="editNews('${newsId}')" style="margin-right:8px;"><i class="fa fa-edit"></i></button>
            <button class="btn" onclick="toggleNewsStatus('${newsId}', '${newsItem.status}')" style="margin-right:8px;">
              <i class="fa fa-${getNewsActionIcon(newsItem.status)}"></i>
            </button>
            <button class="btn" onclick="deleteNews('${newsId}', '${newsItem.title}')" style="background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function updateNewsStats(news) {
      let published = 0, draft = 0, hidden = 0, total = 0;
      
      Object.keys(news).forEach(newsId => {
        const newsItem = news[newsId];
        total++;
        
        switch(newsItem.status) {
          case 'published':
            published++;
            break;
          case 'draft':
            draft++;
            break;
          case 'hidden':
            hidden++;
            break;
        }
      });
      
      // Update KPI values
      const publishedEl = document.getElementById('publishedNews');
      const draftEl = document.getElementById('draftNews');
      const hiddenEl = document.getElementById('hiddenNews');
      const totalEl = document.getElementById('totalNews');
      
      if (publishedEl) publishedEl.textContent = published;
      if (draftEl) draftEl.textContent = draft;
      if (hiddenEl) hiddenEl.textContent = hidden;
      if (totalEl) totalEl.textContent = total;
    }

    function getNewsStatusColor(status) {
      switch(status) {
        case 'published': return 'var(--success)';
        case 'draft': return 'var(--warning)';
        case 'hidden': return 'var(--danger)';
        default: return 'var(--muted)';
      }
    }

    function getNewsStatusText(status) {
      switch(status) {
        case 'published': return 'Đã xuất bản';
        case 'draft': return 'Bản nháp';
        case 'hidden': return 'Đã ẩn';
        default: return 'Không xác định';
      }
    }

    function getNewsActionIcon(status) {
      switch(status) {
        case 'published': return 'eye-slash';
        case 'draft': return 'globe';
        case 'hidden': return 'globe';
        default: return 'globe';
      }
    }

    // Global functions for news actions
    window.openAddNewsModal = function() {
      Swal.fire({
        title: 'Thêm tin tức mới',
        html: `
          <div style="text-align: left; max-width: 500px;">
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">Tiêu đề *</label>
              <input type="text" id="newsTitle" placeholder="Nhập tiêu đề tin tức" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">Mô tả ngắn</label>
              <textarea id="newsExcerpt" placeholder="Mô tả ngắn gọn về tin tức" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); height: 60px; resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">Nội dung *</label>
              <textarea id="newsContent" placeholder="Nội dung chi tiết của tin tức" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); height: 120px; resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">Danh mục</label>
              <select id="newsCategory" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                <option value="Tin tức">Tin tức</option>
                <option value="Sự kiện">Sự kiện</option>
                <option value="Giải trí">Giải trí</option>
                <option value="Công nghệ">Công nghệ</option>
                <option value="Giáo dục">Giáo dục</option>
                <option value="Khác">Khác</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">Ảnh đại diện</label>
              <button type="button" onclick="openImageUpload()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--stroke); background: var(--primary); color: white; cursor: pointer;">
                <i class="fa fa-upload"></i> Chọn ảnh
              </button>
              <div id="newsImagePreview" style="margin-top: 10px;"></div>
              <input type="hidden" id="newsImageUrl" value="">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text);">
                <input type="checkbox" id="newsFeatured" style="margin-right: 8px;"> Tin tức nổi bật
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Thêm tin tức',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73',
        width: '600px',
        preConfirm: () => {
          const title = document.getElementById('newsTitle').value.trim();
          const content = document.getElementById('newsContent').value.trim();
          const excerpt = document.getElementById('newsExcerpt').value.trim();
          const category = document.getElementById('newsCategory').value;
          const imageUrl = document.getElementById('newsImageUrl').value;
          const isFeatured = document.getElementById('newsFeatured').checked;
          
          if (!title || !content) {
            Swal.showValidationMessage('Tiêu đề và nội dung là bắt buộc!');
            return false;
          }
          
          return {
            title,
            content,
            excerpt,
            category,
            imageUrl,
            isFeatured
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          addNews(result.value);
        }
      });
    };

    window.addNews = function(newsData) {
      const { database, ref, push } = window.firebase;
      
      const newsItem = {
        ...newsData,
        author: 'Admin',
        status: 'draft',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        viewCount: 0,
        likes: 0,
        comments: 0
      };
      
      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang thêm tin tức...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Add to Firebase
      push(ref(database, 'news'), newsItem).then(() => {
        loadingSwal.close();
        Swal.fire({
          title: 'Thành công!',
          text: 'Tin tức đã được thêm thành công',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error adding news:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể thêm tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.viewNewsDetails = function(newsId) {
      const { database, ref, get } = window.firebase;
      const newsRef = ref(database, `news/${newsId}`);
      
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (news) {
          Swal.fire({
            title: news.title,
            html: `
              <div style="text-align: left; max-width: 600px;">
                <img src="${news.imageUrl || 'images/img-01.jpg'}" alt="${news.title}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;" onerror="this.src='images/img-01.jpg'">
                <div style="margin-bottom: 15px;">
                  <strong>Mô tả:</strong> ${news.excerpt || 'Không có mô tả'}
                </div>
                <div style="margin-bottom: 15px;">
                  <strong>Nội dung:</strong><br>
                  <div style="max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(255,255,255,.05); border-radius: 6px; margin-top: 5px;">
                    ${news.content}
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px; color: var(--muted);">
                  <div><strong>Tác giả:</strong> ${news.author}</div>
                  <div><strong>Danh mục:</strong> ${news.category}</div>
                  <div><strong>Trạng thái:</strong> ${getNewsStatusText(news.status)}</div>
                  <div><strong>Ngày tạo:</strong> ${new Date(news.createdAt).toLocaleString('vi-VN')}</div>
                  <div><strong>Lượt xem:</strong> ${news.viewCount || 0}</div>
                  <div><strong>Nổi bật:</strong> ${news.isFeatured ? 'Có' : 'Không'}</div>
                </div>
              </div>
            `,
            width: '700px',
            confirmButtonText: 'Đóng',
            confirmButtonColor: '#22d3a3'
          });
        }
      }).catch((error) => {
        console.error('Error fetching news details:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể tải thông tin tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.editNews = function(newsId) {
      const { database, ref, get, set } = window.firebase;
      const newsRef = ref(database, `news/${newsId}`);
      
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (news) {
          Swal.fire({
            title: 'Chỉnh sửa tin tức',
            html: `
              <div style="text-align: left; max-width: 500px;">
                <div class="form-group" style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; color: var(--text);">Tiêu đề *</label>
                  <input type="text" id="editNewsTitle" value="${news.title}" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; color: var(--text);">Mô tả ngắn</label>
                  <textarea id="editNewsExcerpt" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); height: 60px; resize: vertical;">${news.excerpt || ''}</textarea>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                  <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text);">Nội dung *</label>
                    <textarea id="editNewsContent" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); height: 120px; resize: vertical;">${news.content}</textarea>
                  </div>
                  <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text);">Danh mục</label>
                    <select id="editNewsCategory" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                      <option value="Tin tức" ${news.category === 'Tin tức' ? 'selected' : ''}>Tin tức</option>
                      <option value="Sự kiện" ${news.category === 'Sự kiện' ? 'selected' : ''}>Sự kiện</option>
                      <option value="Giải trí" ${news.category === 'Giải trí' ? 'selected' : ''}>Giải trí</option>
                      <option value="Công nghệ" ${news.category === 'Công nghệ' ? 'selected' : ''}>Công nghệ</option>
                      <option value="Giáo dục" ${news.category === 'Giáo dục' ? 'selected' : ''}>Giáo dục</option>
                      <option value="Khác" ${news.category === 'Khác' ? 'selected' : ''}>Khác</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text);">
                      <input type="checkbox" id="editNewsFeatured" ${news.isFeatured ? 'checked' : ''} style="margin-right: 8px;"> Tin tức nổi bật
                    </label>
                  </div>
                </div>
              </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Cập nhật',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#22d3a3',
            cancelButtonColor: '#ff5e73',
            width: '600px',
            preConfirm: () => {
              const title = document.getElementById('editNewsTitle').value.trim();
              const content = document.getElementById('editNewsContent').value.trim();
              const excerpt = document.getElementById('editNewsExcerpt').value.trim();
              const category = document.getElementById('editNewsCategory').value;
              const isFeatured = document.getElementById('editNewsFeatured').checked;
              
              if (!title || !content) {
                Swal.showValidationMessage('Tiêu đề và nội dung là bắt buộc!');
                return false;
              }
              
              return {
                title,
                content,
                excerpt,
                category,
                isFeatured
              };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              updateNews(newsId, result.value);
            }
          });
        }
      });
    };

    window.updateNews = function(newsId, newsData) {
      const { database, ref, set } = window.firebase;
      
      const updateData = {
        ...newsData,
        updatedAt: Date.now()
      };
      
      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang cập nhật...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Update in Firebase
      set(ref(database, `news/${newsId}`), updateData, { merge: true }).then(() => {
        loadingSwal.close();
        Swal.fire({
          title: 'Thành công!',
          text: 'Tin tức đã được cập nhật thành công',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error updating news:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể cập nhật tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.toggleNewsStatus = function(newsId, currentStatus) {
      const { database, ref, set } = window.firebase;
      let newStatus;
      
      switch(currentStatus) {
        case 'published':
          newStatus = 'hidden';
          break;
        case 'draft':
        case 'hidden':
          newStatus = 'published';
          break;
        default:
          newStatus = 'published';
      }
      
      const actionText = newStatus === 'published' ? 'xuất bản' : 'ẩn';
      
      Swal.fire({
        title: 'Xác nhận hành động',
        text: `Bạn có chắc chắn muốn ${actionText} tin tức này?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Xác nhận',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73'
      }).then((result) => {
        if (result.isConfirmed) {
          set(ref(database, `news/${newsId}/status`), newStatus).then(() => {
            Swal.fire({
              title: 'Thành công!',
              text: `Đã ${actionText} tin tức thành công`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error updating news status:', error);
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể cập nhật trạng thái tin tức',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
        });
          });
        }
      });
    };

    window.deleteNews = function(newsId, newsTitle) {
      const { database, ref, remove } = window.firebase;
      
      Swal.fire({
        title: 'Xác nhận xóa tin tức',
        html: `
          <div style="text-align: left;">
            <p><strong>Bạn có chắc chắn muốn xóa tin tức này?</strong></p>
            <p><strong>Tiêu đề:</strong> ${newsTitle}</p>
            <br>
            <p style="color: #ff5e73; font-weight: bold;">⚠️ Hành động này không thể hoàn tác!</p>
          </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa vĩnh viễn',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#6c757d',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          const loadingSwal = Swal.fire({
            title: 'Đang xóa...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          remove(ref(database, `news/${newsId}`)).then(() => {
            loadingSwal.close();
            Swal.fire({
              icon: 'success',
              title: 'Đã xóa thành công!',
              text: `Tin tức "${newsTitle}" đã được xóa vĩnh viễn.`,
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error deleting news:', error);
            loadingSwal.close();
            Swal.fire({
              icon: 'error',
              title: 'Lỗi khi xóa!',
              text: `Có lỗi xảy ra trong quá trình xóa: ${error.message}`,
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    };

    window.bulkPublishNews = function() {
      const { database, ref, get, set } = window.firebase;
      const newsRef = ref(database, 'news');
      
      // Get all draft news
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (!news) {
          Swal.fire({
            title: 'Không có tin tức',
            text: 'Không có tin tức nào để xuất bản',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
          return;
        }
        
        const draftNews = Object.keys(news).filter(newsId => 
          news[newsId].status === 'draft'
        );
        
        if (draftNews.length === 0) {
          Swal.fire({
            title: 'Không có bản nháp',
            text: 'Tất cả tin tức đã được xuất bản hoặc không có bản nháp',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
          return;
        }
        
        Swal.fire({
          title: 'Xuất bản hàng loạt',
          html: `
            <div style="text-align: left;">
              <p><strong>Tìm thấy ${draftNews.length} bản nháp:</strong></p>
              <div style="max-height: 200px; overflow-y: auto; margin: 15px 0; padding: 10px; background: rgba(255,255,255,.05); border-radius: 6px;">
                ${draftNews.map(newsId => `<div style="margin-bottom: 8px;">• ${news[newsId].title}</div>`).join('')}
              </div>
              <p style="color: var(--warning); font-size: 14px;">
                <i class="fa fa-exclamation-triangle"></i> Tất cả bản nháp sẽ được xuất bản cùng lúc.
              </p>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Xuất bản tất cả',
          cancelButtonText: 'Hủy',
          confirmButtonColor: '#22d3a3',
          cancelButtonColor: '#ff5e73'
        }).then((result) => {
          if (result.isConfirmed) {
            const loadingSwal = Swal.fire({
              title: 'Đang xuất bản...',
              text: 'Vui lòng chờ trong giây lát',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });
            
            // Update all draft news to published
            const updatePromises = draftNews.map(newsId => 
              set(ref(database, `news/${newsId}/status`), 'published')
            );
            
            Promise.all(updatePromises).then(() => {
              loadingSwal.close();
              Swal.fire({
                title: 'Thành công!',
                text: `Đã xuất bản ${draftNews.length} tin tức thành công`,
                icon: 'success',
                confirmButtonColor: '#22d3a3'
              });
            }).catch((error) => {
              console.error('Error bulk publishing news:', error);
              loadingSwal.close();
              Swal.fire({
                title: 'Lỗi!',
                text: 'Có lỗi xảy ra khi xuất bản hàng loạt',
                icon: 'error',
                confirmButtonColor: '#ff5e73'
              });
            });
          }
        });
      }).catch((error) => {
        console.error('Error fetching news for bulk publish:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể tải danh sách tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.exportNewsReport = function() {
      const { database, ref, get } = window.firebase;
      const newsRef = ref(database, 'news');
      
      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang tạo báo cáo...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        loadingSwal.close();
        
        if (!news) {
          Swal.fire({
            title: 'Không có dữ liệu',
            text: 'Không có tin tức nào để xuất báo cáo',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
          return;
        }
        
        // Generate CSV content
        const csvContent = generateNewsCSV(news);
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `bao-cao-tin-tuc-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        Swal.fire({
          title: 'Xuất báo cáo thành công!',
          text: 'Báo cáo đã được tải về máy tính của bạn',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error exporting news report:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể xuất báo cáo tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };
    
    function generateNewsCSV(news) {
      const headers = ['ID', 'Tiêu đề', 'Tác giả', 'Danh mục', 'Trạng thái', 'Ngày tạo', 'Lượt xem', 'Nổi bật', 'Mô tả'];
      const rows = [headers];
      
      Object.keys(news).forEach(newsId => {
        const item = news[newsId];
        rows.push([
          newsId,
          `"${item.title}"`,
          item.author || 'Admin',
          item.category || 'Tin tức',
          getNewsStatusText(item.status),
          new Date(item.createdAt || Date.now()).toLocaleDateString('vi-VN'),
          item.viewCount || 0,
          item.isFeatured ? 'Có' : 'Không',
          `"${item.excerpt || item.content?.substring(0, 100) || 'Không có mô tả'}"`
        ]);
      });
      
      return rows.map(row => row.join(',')).join('\n');
    }

    // Helper function to close news modals
    function closeAddNewsModal() {
      // This function is called by the modal close button
    }

    function closeEditNewsModal() {
      // This function is called by the modal close button
    }
    
    // News search and filter functionality
    function initNewsSearchAndFilter() {
      const searchInput = document.getElementById('newsSearch');
      const filterSelect = document.getElementById('newsFilter');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          filterNews();
        });
      }
      
      if (filterSelect) {
        filterSelect.addEventListener('change', function() {
          filterNews();
        });
      }
    }
    
    function filterNews() {
      const searchTerm = document.getElementById('newsSearch')?.value.toLowerCase() || '';
      const filterValue = document.getElementById('newsFilter')?.value || '';
      const { database, ref, get } = window.firebase;
      
      get(ref(database, 'news')).then((snapshot) => {
        const news = snapshot.val();
        if (!news) return;
        
        let filteredNews = {};
        
        Object.keys(news).forEach(newsId => {
          const newsItem = news[newsId];
          let shouldInclude = true;
          
          // Apply search filter
          if (searchTerm) {
            const searchFields = [
              newsItem.title,
              newsItem.excerpt,
              newsItem.content,
              newsItem.author,
              newsItem.category
            ].join(' ').toLowerCase();
            
            if (!searchFields.includes(searchTerm)) {
              shouldInclude = false;
            }
          }
          
          // Apply status filter
          if (filterValue && newsItem.status !== filterValue) {
            shouldInclude = false;
          }
          
          if (shouldInclude) {
            filteredNews[newsId] = newsItem;
          }
        });
        
        updateNewsTable(filteredNews);
        updateNewsStats(filteredNews);
      }).catch((error) => {
        console.error('Error filtering news:', error);
      });
    }
    
    // Initialize news search and filter when news panel is shown
    function initNewsPanel() {
      // Small delay to ensure DOM elements are ready
      setTimeout(() => {
        initNewsSearchAndFilter();
        loadNewsAnalytics();
      }, 100);
    }
    
    // Load news analytics and trending data
    function loadNewsAnalytics() {
      const { database, ref, get } = window.firebase;
      const newsRef = ref(database, 'news');
      
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (!news) return;
        
        // Calculate trending news (most viewed in last 7 days)
        const trendingNews = Object.keys(news)
          .map(newsId => ({ id: newsId, ...news[newsId] }))
          .filter(item => item.status === 'published')
          .sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0))
          .slice(0, 5);
        
        // Update trending news display if element exists
        const trendingContainer = document.getElementById('trendingNews');
        if (trendingContainer && trendingNews.length > 0) {
          trendingContainer.innerHTML = trendingNews.map(item => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; background: rgba(255,255,255,.05); margin-bottom: 8px;">
              <img src="${item.imageUrl || 'images/img-01.jpg'}" alt="${item.title}" style="width: 40px; height: 30px; object-fit: cover; border-radius: 4px;" onerror="this.src='images/img-01.jpg'">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.title}</div>
                <div style="font-size: 11px; color: var(--muted);">${item.viewCount || 0} lượt xem</div>
              </div>
            </div>
          `).join('');
        }
        
        // Calculate category distribution
        const categoryStats = {};
        Object.values(news).forEach(item => {
          const category = item.category || 'Khác';
          categoryStats[category] = (categoryStats[category] || 0) + 1;
        });
        
        // Calculate additional statistics
        const today = new Date().toDateString();
        const todayNews = Object.values(news).filter(item => 
          new Date(item.createdAt).toDateString() === today
        ).length;
        
        const totalViews = Object.values(news).reduce((sum, item) => sum + (item.viewCount || 0), 0);
        const avgViews = news ? Math.round(totalViews / Object.keys(news).length) : 0;
        
        const featuredNews = Object.values(news).filter(item => item.isFeatured).length;
        const featuredRatio = news ? Math.round((featuredNews / Object.keys(news).length) * 100) : 0;
        
        // Update statistics display
        const todayNewsEl = document.getElementById('todayNews');
        const avgViewsEl = document.getElementById('avgViews');
        const featuredRatioEl = document.getElementById('featuredRatio');
        
        if (todayNewsEl) todayNewsEl.textContent = todayNews;
        if (avgViewsEl) avgViewsEl.textContent = avgViews;
        if (featuredRatioEl) featuredRatioEl.textContent = featuredRatio + '%';
        
        console.log('News analytics loaded:', { trendingNews, categoryStats, todayNews, avgViews, featuredRatio });
      }).catch((error) => {
        console.error('Error loading news analytics:', error);
      });
    }
    
    // News scheduling functionality
    function scheduleNews(newsId, publishDate) {
      const { database, ref, set } = window.firebase;
      
      if (new Date(publishDate) <= new Date()) {
        Swal.fire({
          title: 'Lỗi!',
          text: 'Ngày xuất bản phải trong tương lai',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
        return;
      }
      
      set(ref(database, `news/${newsId}/scheduledPublish`), publishDate).then(() => {
        Swal.fire({
          title: 'Thành công!',
          text: 'Tin tức đã được lên lịch xuất bản',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error scheduling news:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể lên lịch xuất bản tin tức',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    }
    
    // Check for scheduled news to publish
    function checkScheduledNews() {
      const { database, ref, get, set } = window.firebase;
      const newsRef = ref(database, 'news');
      
      get(newsRef).then((snapshot) => {
        const news = snapshot.val();
        if (!news) return;
        
        const now = new Date();
        Object.keys(news).forEach(newsId => {
          const newsItem = news[newsId];
          if (newsItem.scheduledPublish && newsItem.status === 'draft') {
            const scheduledDate = new Date(newsItem.scheduledPublish);
            if (scheduledDate <= now) {
              // Auto-publish scheduled news
              set(ref(database, `news/${newsId}/status`), 'published').then(() => {
                console.log(`Auto-published scheduled news: ${newsItem.title}`);
              }).catch((error) => {
                console.error('Error auto-publishing scheduled news:', error);
              });
            }
          }
        });
      }).catch((error) => {
        console.error('Error checking scheduled news:', error);
      });
    }
    
    // Run scheduled news check every minute
    setInterval(checkScheduledNews, 60000);
    
    // Promotion Management Functions
    let promotionLoaded = false;

    // Load promotion data from Firebase
    function loadPromotionData() {
      const { database, ref, onValue, get } = window.firebase;
      const couponsRef = ref(database, 'coupons');
      
      // Only set up listener if not already loaded
      if (!promotionLoaded) {
        promotionLoaded = true;
        
        // Set up listener for real-time updates
        onValue(couponsRef, (snapshot) => {
          const coupons = snapshot.val();
          if (coupons) {
            updatePromotionTable(coupons);
            updatePromotionStats(coupons);
            updateTopPromotions(coupons);
          }
        });
      }
      
      // Always get current data for immediate display
      get(couponsRef).then((snapshot) => {
        const coupons = snapshot.val();
        if (coupons) {
          updatePromotionTable(coupons);
          updatePromotionStats(coupons);
          updateTopPromotions(coupons);
        } else {
          // Initialize with sample data if no coupons exist
          createSampleCoupons();
        }
      }).catch((error) => {
        console.error('Error loading coupon data:', error);
      });
    }

    // Create sample coupons for demonstration
    function createSampleCoupons() {
      const { database, ref, push } = window.firebase;
      const couponsRef = ref(database, 'coupons');
      
      const sampleCoupons = [
        {
          code: 'WELCOME2025',
          name: 'Chào mừng năm mới 2025',
          description: 'Giảm giá 20% cho đơn hàng đầu tiên',
          discountType: 'percentage',
          discountValue: 20,
          minOrderValue: 100000,
          maxDiscount: 200000,
          validFrom: new Date().toISOString(),
          validUntil: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          isActive: true,
          usageLimit: 1000,
          usedCount: 0,
          applicableCategories: ['all'],
          applicableUsers: ['all'],
          createdAt: new Date().toISOString(),
          createdBy: 'admin'
        },
        {
          code: 'VIP2025',
          name: 'Ưu đãi VIP 2025',
          description: 'Giảm giá 15% cho thành viên VIP',
          discountType: 'percentage',
          discountValue: 15,
          minOrderValue: 500000,
          maxDiscount: 300000,
          validFrom: new Date().toISOString(),
          validUntil: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          isActive: true,
          usageLimit: 500,
          usedCount: 0,
          applicableCategories: ['all'],
          applicableUsers: ['vip'],
          createdAt: new Date().toISOString(),
          createdBy: 'admin'
        }
      ];
      
      // Add sample coupons to database
      sampleCoupons.forEach(coupon => {
        push(couponsRef, coupon);
      });
      
      console.log('Sample coupons created successfully');
    }

    // Update promotion table
    function updatePromotionTable(promotions) {
      const tbody = document.getElementById('promotionTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';
      
      Object.keys(promotions).forEach(promotionId => {
        const promotion = promotions[promotionId];
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,.05)';
        row.style.transition = 'all 0.3s ease';
        row.addEventListener('mouseenter', () => {
          row.style.background = 'rgba(255,255,255,0.03)';
          row.style.transform = 'translateX(4px)';
        });
        row.addEventListener('mouseleave', () => {
          row.style.background = 'transparent';
          row.style.transform = 'translateX(0)';
        });
        
        // Handle both old and new data structure
        const isActive = promotion.isActive !== undefined ? promotion.isActive : (promotion.status === 'active');
        const discountType = promotion.discountType || promotion.type;
        const discountValue = promotion.discountValue || promotion.value;
        const minOrderValue = promotion.minOrderValue || promotion.minOrder;
        const validFrom = promotion.validFrom || promotion.startDate;
        const validUntil = promotion.validUntil || promotion.endDate;
        
        const statusColor = getPromotionStatusColor(isActive ? 'active' : 'inactive');
        const statusText = getPromotionStatusText(isActive ? 'active' : 'inactive');
        const typeText = discountType === 'percentage' ? `${discountValue}%` : `${discountValue?.toLocaleString('vi-VN')}đ`;
        const featuredBadge = promotion.isFeatured ? '<span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">Nổi bật</span>' : '';
        
        row.innerHTML = `
          <td style="padding:16px 12px;">
            <strong style="color: var(--primary); font-family: monospace; font-size: 16px;">${promotion.code}</strong>
            ${featuredBadge}
          </td>
          <td style="padding:16px 12px;">
            <strong>${promotion.name || promotion.description}</strong>
            <br><small style="color:var(--muted);">${promotion.description}</small>
            <br><small style="color:var(--muted);">Đơn hàng tối thiểu: ${minOrderValue?.toLocaleString('vi-VN')}đ</small>
          </td>
          <td style="padding:16px 12px;">
            <span style="background: ${discountType === 'percentage' ? 'var(--primary)' : 'var(--accent)'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
              ${discountType === 'percentage' ? 'Giảm %' : 'Giảm tiền'}
            </span>
          </td>
          <td style="padding:16px 12px;">
            <strong style="color: var(--success);">${typeText}</strong>
            <br><small style="color:var(--muted);">Tối đa: ${promotion.maxDiscount?.toLocaleString('vi-VN')}đ</small>
          </td>
          <td style="padding:16px 12px;">${new Date(validFrom).toLocaleDateString('vi-VN')}</td>
          <td style="padding:16px 12px;">${new Date(validUntil).toLocaleDateString('vi-VN')}</td>
          <td style="padding:16px 12px;">
            <span style="color:${statusColor};font-weight:600;">${statusText}</span>
          </td>
          <td style="padding:16px 12px;">
            ${promotion.usedCount || 0} / ${promotion.usageLimit || '∞'}
          </td>
          <td style="padding:16px 12px;">
            <button class="btn" onclick="viewPromotionDetails('${promotionId}')" style="margin-right:8px;"><i class="fa fa-eye"></i></button>
            <button class="btn" onclick="editPromotion('${promotionId}')" style="margin-right:8px;"><i class="fa fa-edit"></i></button>
            <button class="btn" onclick="togglePromotionStatus('${promotionId}', '${isActive}')" style="margin-right:8px;">
              <i class="fa fa-${getPromotionActionIcon(isActive ? 'active' : 'inactive')}"></i>
            </button>
            <button class="btn" onclick="deletePromotion('${promotionId}', '${promotion.code}')" style="background: rgba(255,94,115,.1); border-color: var(--danger); color: var(--danger);">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Update promotion statistics
    function updatePromotionStats(promotions) {
      let active = 0, expiring = 0, expired = 0, total = 0;
      const now = new Date();
      const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      Object.keys(promotions).forEach(promotionId => {
        const promotion = promotions[promotionId];
        total++;
        
        // Handle both old and new data structure
        const isActive = promotion.isActive !== undefined ? promotion.isActive : (promotion.status === 'active');
        const endDate = new Date(promotion.validUntil || promotion.endDate);
        
        if (isActive) {
          if (endDate > now) {
            active++;
            if (endDate <= sevenDaysFromNow) {
              expiring++;
            }
          } else {
            expired++;
          }
        } else {
          expired++;
        }
      });
      
      // Update KPI values
      const activeEl = document.getElementById('activePromotions');
      const expiringEl = document.getElementById('expiringPromotions');
      const expiredEl = document.getElementById('expiredPromotions');
      const totalEl = document.getElementById('totalPromotions');
      
      if (activeEl) activeEl.textContent = active;
      if (expiringEl) expiringEl.textContent = expiring;
      if (expiredEl) expiredEl.textContent = expired;
      if (totalEl) totalEl.textContent = total;
    }

    // Update top promotions
    function updateTopPromotions(promotions) {
      const container = document.getElementById('topPromotions');
      if (!container) return;
      
      const topPromotions = Object.keys(promotions)
        .map(promotionId => ({ id: promotionId, ...promotions[promotionId] }))
        .filter(promotion => {
          const isActive = promotion.isActive !== undefined ? promotion.isActive : (promotion.status === 'active');
          return isActive && promotion.isFeatured;
        })
        .sort((a, b) => (b.usedCount || 0) - (a.usedCount || 0))
        .slice(0, 5);
      
      if (topPromotions.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <i class="fa fa-star" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3; color: var(--accent);"></i>
            <p style="font-size: 14px; margin: 0;">Chưa có mã nổi bật</p>
            <small style="opacity: 0.7;">Các mã được đánh dấu nổi bật sẽ hiển thị ở đây</small>
          </div>
        `;
        return;
      }
      
      container.innerHTML = topPromotions.map(promotion => {
        // Handle both old and new data structure
        const discountType = promotion.discountType || promotion.type;
        const discountValue = promotion.discountValue || promotion.value;
        
        return `
          <div style="background: linear-gradient(135deg, rgba(255,122,217,0.1) 0%, rgba(255,122,217,0.05) 100%); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,122,217,0.2); box-shadow: 0 4px 16px rgba(255,122,217,0.1); transition: all 0.3s ease;">
            <div style="font-weight: 700; color: var(--primary); margin-bottom: 8px; font-size: 16px; font-family: monospace;">${promotion.code}</div>
            <div style="font-size: 13px; color: var(--text); margin-bottom: 6px; line-height: 1.4;">${promotion.description}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
              <div style="font-size: 11px; color: var(--accent);">
                <i class="fa fa-users"></i> ${promotion.usedCount || 0} lượt sử dụng
              </div>
              <div style="font-size: 11px; color: var(--success); font-weight: 600;">
                <i class="fa fa-star"></i> Nổi bật
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Helper functions for promotion status
    function getPromotionStatusColor(status) {
      switch(status) {
        case 'active': return 'var(--success)';
        case 'expired': return 'var(--danger)';
        case 'inactive': return 'var(--muted)';
        default: return 'var(--muted)';
      }
    }

    function getPromotionStatusText(status) {
      switch(status) {
        case 'active': return 'Đang hoạt động';
        case 'expired': return 'Đã hết hạn';
        case 'inactive': return 'Không hoạt động';
        default: return 'Không xác định';
      }
    }

    function getPromotionActionIcon(status) {
      switch(status) {
        case 'active': return 'pause';
        case 'expired': case 'inactive': return 'play';
        default: return 'play';
      }
    }

    // Initialize promotion panel
    function initPromotionPanel() {
      // Small delay to ensure DOM elements are ready
      setTimeout(() => {
        initPromotionSearchAndFilter();
      }, 100);
    }
    
    // Promotion search and filter functionality
    function initPromotionSearchAndFilter() {
      const searchInput = document.getElementById('promotionSearch');
      const filterSelect = document.getElementById('promotionFilter');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          filterPromotions();
        });
      }
      
      if (filterSelect) {
        filterSelect.addEventListener('change', function() {
          filterPromotions();
        });
      }
    }
    
    function filterPromotions() {
      const searchTerm = document.getElementById('promotionSearch')?.value.toLowerCase() || '';
      const filterValue = document.getElementById('promotionFilter')?.value || '';
      const { database, ref, get } = window.firebase;
      
      get(ref(database, 'promotions')).then((snapshot) => {
        const promotions = snapshot.val();
        if (!promotions) return;
        
        let filteredPromotions = {};
        
        Object.keys(promotions).forEach(promotionId => {
          const promotion = promotions[promotionId];
          let shouldInclude = true;
          
          // Apply search filter
          if (searchTerm) {
            const searchFields = [
              promotion.code,
              promotion.description,
              promotion.type
            ].join(' ').toLowerCase();
            
            if (!searchFields.includes(searchTerm)) {
              shouldInclude = false;
            }
          }
          
          // Apply type filter
          if (filterValue && promotion.type !== filterValue) {
            shouldInclude = false;
          }
          
          if (shouldInclude) {
            filteredPromotions[promotionId] = promotion;
          }
        });
        
        updatePromotionTable(filteredPromotions);
        updatePromotionStats(filteredPromotions);
      }).catch((error) => {
        console.error('Error filtering promotions:', error);
      });
    }

    // Global functions for promotion actions
    window.openAddPromotionModal = function() {
      Swal.fire({
        title: 'Thêm mã khuyến mãi mới',
        html: `
          <div style="text-align: left; max-width: 700px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Mã khuyến mãi *</label>
                <input type="text" id="promotionCode" placeholder="VD: VIP2025" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); font-family: monospace; font-weight: bold;">
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Tên mã khuyến mãi *</label>
                <input type="text" id="promotionName" placeholder="VD: Ưu đãi VIP 2025" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
              <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Mô tả *</label>
              <textarea id="promotionDescription" placeholder="Mô tả chi tiết mã khuyến mãi" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text); height: 80px; resize: vertical;"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Loại giảm giá *</label>
                <select id="promotionType" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                  <option value="percentage">Giảm theo phần trăm (%)</option>
                  <option value="fixed">Giảm theo số tiền (VNĐ)</option>
                </select>
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Giá trị giảm *</label>
                <input type="number" id="promotionValue" placeholder="20 hoặc 50000" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Đơn hàng tối thiểu</label>
                <input type="number" id="promotionMinOrder" placeholder="100000" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Giảm giá tối đa</label>
                <input type="number" id="promotionMaxDiscount" placeholder="50000" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Ngày bắt đầu *</label>
                <input type="date" id="promotionStartDate" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Ngày kết thúc *</label>
                <input type="date" id="promotionEndDate" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Giới hạn sử dụng</label>
                <input type="number" id="promotionUsageLimit" placeholder="100 (0 = không giới hạn)" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Danh mục áp dụng</label>
                <select id="promotionCategories" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                  <option value="all">Tất cả danh mục</option>
                  <option value="books">Sách</option>
                  <option value="stories">Truyện</option>
                  <option value="vip">VIP</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Người dùng áp dụng</label>
                <select id="promotionUsers" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                  <option value="all">Tất cả người dùng</option>
                  <option value="vip">Chỉ thành viên VIP</option>
                  <option value="new">Chỉ khách hàng mới</option>
                  <option value="premium">Chỉ thành viên Premium</option>
                </select>
              </div>
              <div class="form-group">
                <label style="display: block; margin-bottom: 5px; color: var(--text); font-weight: 600;">Mã nổi bật</label>
                <select id="promotionFeatured" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,.08); color: var(--text);">
                  <option value="false">Không</option>
                  <option value="true">Có</option>
                </select>
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Thêm mã',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73',
        width: '700px',
        preConfirm: () => {
          const code = document.getElementById('promotionCode').value.trim();
          const name = document.getElementById('promotionName').value.trim();
          const description = document.getElementById('promotionDescription').value.trim();
          const discountType = document.getElementById('promotionType').value;
          const discountValue = parseInt(document.getElementById('promotionValue').value);
          const minOrderValue = parseInt(document.getElementById('promotionMinOrder').value) || 0;
          const maxDiscount = parseInt(document.getElementById('promotionMaxDiscount').value) || 0;
          const usageLimit = parseInt(document.getElementById('promotionUsageLimit').value) || 0;
          const validFrom = document.getElementById('promotionStartDate').value;
          const validUntil = document.getElementById('promotionEndDate').value;
          const applicableCategories = [document.getElementById('promotionCategories').value];
          const applicableUsers = [document.getElementById('promotionUsers').value];
          const isFeatured = document.getElementById('promotionFeatured').value === 'true';
          
          if (!code || !name || !description || !discountType || !discountValue || !validFrom || !validUntil) {
            Swal.showValidationMessage('Vui lòng điền đầy đủ thông tin bắt buộc!');
            return false;
          }
          
          if (new Date(validFrom) >= new Date(validUntil)) {
            Swal.showValidationMessage('Ngày kết thúc phải sau ngày bắt đầu!');
            return false;
          }
          
          return {
            code,
            name,
            description,
            discountType,
            discountValue,
            minOrderValue,
            maxDiscount,
            usageLimit,
            validFrom,
            validUntil,
            applicableCategories,
            applicableUsers,
            isFeatured
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          addPromotion(result.value);
        }
      });
    };

    window.addPromotion = function(promotionData) {
      const { database, ref, push } = window.firebase;
      
      // Convert date strings to ISO format
      const validFrom = new Date(promotionData.validFrom).toISOString();
      const validUntil = new Date(promotionData.validUntil).toISOString();
      
      const promotion = {
        ...promotionData,
        validFrom,
        validUntil,
        isActive: true,
        usedCount: 0,
        createdAt: new Date().toISOString(),
        createdBy: 'admin', // You can get this from current user auth
        updatedAt: new Date().toISOString()
      };
      
      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang thêm mã khuyến mãi...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Add to Firebase
      push(ref(database, 'coupons'), promotion).then(() => {
        loadingSwal.close();
        Swal.fire({
          title: 'Thành công!',
          text: 'Mã khuyến mãi đã được thêm thành công',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error adding promotion:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể thêm mã khuyến mãi',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.bulkActivatePromotions = function() {
      Swal.fire({
        title: 'Kích hoạt hàng loạt',
        text: 'Tính năng này sẽ kích hoạt tất cả mã khuyến mãi đã hết hạn. Bạn có chắc chắn?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Kích hoạt tất cả',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('Thành công!', 'Đã kích hoạt tất cả mã khuyến mãi hết hạn.', 'success');
        }
      });
    };

    window.exportPromotionReport = function() {
      const { database, ref, get } = window.firebase;
      const couponsRef = ref(database, 'coupons');
      
      // Show loading
      const loadingSwal = Swal.fire({
        title: 'Đang tạo báo cáo...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      get(couponsRef).then((snapshot) => {
        const coupons = snapshot.val();
        loadingSwal.close();
        
        if (!coupons) {
          Swal.fire({
            title: 'Không có dữ liệu',
            text: 'Không có mã khuyến mãi nào để xuất báo cáo',
            icon: 'info',
            confirmButtonColor: '#22d3a3'
          });
          return;
        }
        
        // Generate CSV content
        const csvContent = generatePromotionCSV(coupons);
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `bao-cao-ma-khuyen-mai-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        Swal.fire({
          title: 'Xuất báo cáo thành công!',
          text: 'Báo cáo đã được tải về máy tính của bạn',
          icon: 'success',
          confirmButtonColor: '#22d3a3'
        });
      }).catch((error) => {
        console.error('Error exporting promotion report:', error);
        loadingSwal.close();
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể xuất báo cáo mã khuyến mãi',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };
    
    function generatePromotionCSV(coupons) {
      const headers = ['Mã', 'Tên', 'Mô tả', 'Loại', 'Giá trị', 'Đơn hàng tối thiểu', 'Giảm tối đa', 'Ngày bắt đầu', 'Ngày kết thúc', 'Trạng thái', 'Lượt sử dụng', 'Giới hạn sử dụng', 'Danh mục áp dụng', 'Người dùng áp dụng'];
      const rows = [headers];
      
      Object.keys(coupons).forEach(couponId => {
        const item = coupons[couponId];
        // Handle both old and new data structure
        const discountType = item.discountType || item.type;
        const discountValue = item.discountValue || item.value;
        const minOrderValue = item.minOrderValue || item.minOrder;
        const validFrom = item.validFrom || item.startDate;
        const validUntil = item.validUntil || item.endDate;
        const isActive = item.isActive !== undefined ? item.isActive : (item.status === 'active');
        
        rows.push([
          item.code,
          `"${item.name || 'Không có tên'}"`,
          `"${item.description}"`,
          discountType === 'percentage' ? 'Giảm %' : 'Giảm tiền',
          discountType === 'percentage' ? `${discountValue}%` : discountValue?.toLocaleString('vi-VN'),
          minOrderValue?.toLocaleString('vi-VN') || '0',
          item.maxDiscount?.toLocaleString('vi-VN') || '0',
          new Date(validFrom).toLocaleDateString('vi-VN'),
          new Date(validUntil).toLocaleDateString('vi-VN'),
          getPromotionStatusText(isActive ? 'active' : 'inactive'),
          item.usedCount || 0,
          item.usageLimit || 'Không giới hạn',
          item.applicableCategories?.join(', ') || 'Tất cả',
          item.applicableUsers?.join(', ') || 'Tất cả'
        ]);
      });
      
      return rows.map(row => row.join(',')).join('\n');
    }

    // Placeholder functions for other promotion actions
    window.viewPromotionDetails = function(promotionId) {
      const { database, ref, get } = window.firebase;
      const couponRef = ref(database, `coupons/${promotionId}`);
      
      get(couponRef).then((snapshot) => {
        const coupon = snapshot.val();
        if (coupon) {
          Swal.fire({
            title: `Chi tiết mã: ${coupon.code}`,
            html: `
              <div style="text-align: left; max-width: 600px;">
                <div style="margin-bottom: 15px;">
                  <strong>Tên:</strong> ${coupon.name || 'Không có tên'}
                </div>
                <div style="margin-bottom: 15px;">
                  <strong>Mô tả:</strong> ${coupon.description}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                  <div><strong>Loại:</strong> ${(coupon.discountType || coupon.type) === 'percentage' ? 'Giảm theo %' : 'Giảm theo số tiền'}</div>
                  <div><strong>Giá trị:</strong> ${(coupon.discountType || coupon.type) === 'percentage' ? (coupon.discountValue || coupon.value) + '%' : (coupon.discountValue || coupon.value)?.toLocaleString('vi-VN') + 'đ'}</div>
                  <div><strong>Đơn hàng tối thiểu:</strong> ${(coupon.minOrderValue || coupon.minOrder)?.toLocaleString('vi-VN') || '0'}đ</div>
                  <div><strong>Giảm tối đa:</strong> ${coupon.maxDiscount?.toLocaleString('vi-VN') || '0'}đ</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                  <div><strong>Ngày bắt đầu:</strong> ${new Date(coupon.validFrom || coupon.startDate).toLocaleDateString('vi-VN')}</div>
                  <div><strong>Ngày kết thúc:</strong> ${new Date(coupon.validUntil || coupon.endDate).toLocaleDateString('vi-VN')}</div>
                  <div><strong>Trạng thái:</strong> ${getPromotionStatusText((coupon.isActive !== undefined ? coupon.isActive : coupon.status === 'active') ? 'active' : 'inactive')}</div>
                  <div><strong>Lượt sử dụng:</strong> ${coupon.usedCount || 0} / ${coupon.usageLimit || '∞'}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                  <div><strong>Danh mục áp dụng:</strong> ${coupon.applicableCategories?.join(', ') || 'Tất cả'}</div>
                  <div><strong>Người dùng áp dụng:</strong> ${coupon.applicableUsers?.join(', ') || 'Tất cả'}</div>
                </div>
                <div style="margin-top: 15px;">
                  <strong>Người tạo:</strong> ${coupon.createdBy || 'Admin'}
                </div>
              </div>
            `,
            width: '700px',
            confirmButtonText: 'Đóng',
            confirmButtonColor: '#22d3a3'
          });
        }
      }).catch((error) => {
        console.error('Error fetching coupon details:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể tải thông tin mã khuyến mãi',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.editPromotion = function(promotionId) {
      const { database, ref, get } = window.firebase;
      const couponRef = ref(database, `coupons/${promotionId}`);
      
      get(couponRef).then((snapshot) => {
        const coupon = snapshot.val();
        if (coupon) {
          Swal.fire({
            title: `Chỉnh sửa mã: ${coupon.code}`,
            html: `
              <div style="text-align: left; max-width: 600px;">
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tên mã khuyến mãi:</label>
                  <input type="text" id="editName" value="${coupon.name || ''}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600;">Mô tả:</label>
                  <textarea id="editDescription" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text); height: 80px;">${coupon.description}</textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Loại giảm giá:</label>
                    <select id="editDiscountType" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                      <option value="percentage" ${(coupon.discountType || coupon.type) === 'percentage' ? 'selected' : ''}>Giảm theo %</option>
                      <option value="fixed" ${(coupon.discountType || coupon.type) === 'fixed' ? 'selected' : ''}>Giảm theo số tiền</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Giá trị giảm:</label>
                    <input type="number" id="editDiscountValue" value="${coupon.discountValue || coupon.value}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Đơn hàng tối thiểu:</label>
                    <input type="number" id="editMinOrderValue" value="${coupon.minOrderValue || coupon.minOrder || 0}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Giảm tối đa:</label>
                    <input type="number" id="editMaxDiscount" value="${coupon.maxDiscount || 0}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ngày bắt đầu:</label>
                    <input type="date" id="editValidFrom" value="${(coupon.validFrom || coupon.startDate).split('T')[0]}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ngày kết thúc:</label>
                    <input type="date" id="editValidUntil" value="${(coupon.validUntil || coupon.endDate).split('T')[0]}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Giới hạn sử dụng:</label>
                    <input type="number" id="editUsageLimit" value="${coupon.usageLimit || 0}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Mã nổi bật:</label>
                    <select id="editIsFeatured" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: var(--text);">
                      <option value="false" ${!coupon.isFeatured ? 'selected' : ''}>Không</option>
                      <option value="true" ${coupon.isFeatured ? 'selected' : ''}>Có</option>
                    </select>
                  </div>
                </div>
              </div>
            `,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: 'Cập nhật',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#22d3a3',
            cancelButtonColor: '#ff5e73',
            preConfirm: () => {
              const updatedData = {
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                discountType: document.getElementById('editDiscountType').value,
                discountValue: parseFloat(document.getElementById('editDiscountValue').value),
                minOrderValue: parseFloat(document.getElementById('editMinOrderValue').value),
                maxDiscount: parseFloat(document.getElementById('editMaxDiscount').value),
                validFrom: new Date(document.getElementById('editValidFrom').value).toISOString(),
                validUntil: new Date(document.getElementById('editValidUntil').value).toISOString(),
                usageLimit: parseInt(document.getElementById('editUsageLimit').value),
                isFeatured: document.getElementById('editIsFeatured').value === 'true',
                updatedAt: new Date().toISOString()
              };
              
              if (!updatedData.name || !updatedData.description || !updatedData.discountValue || !updatedData.minOrderValue) {
                Swal.showValidationMessage('Vui lòng điền đầy đủ thông tin bắt buộc');
                return false;
              }
              
              return updatedData;
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const { database, ref, update } = window.firebase;
              const couponRef = ref(database, `coupons/${promotionId}`);
              
              update(couponRef, result.value).then(() => {
                Swal.fire({
                  title: 'Thành công!',
                  text: 'Mã khuyến mãi đã được cập nhật',
                  icon: 'success',
                  confirmButtonColor: '#22d3a3'
                });
              }).catch((error) => {
                console.error('Error updating coupon:', error);
                Swal.fire({
                  title: 'Lỗi!',
                  text: 'Không thể cập nhật mã khuyến mãi',
                  icon: 'error',
                  confirmButtonColor: '#ff5e73'
                });
              });
            }
          });
        }
      }).catch((error) => {
        console.error('Error fetching coupon for edit:', error);
        Swal.fire({
          title: 'Lỗi!',
          text: 'Không thể tải thông tin mã khuyến mãi',
          icon: 'error',
          confirmButtonColor: '#ff5e73'
        });
      });
    };

    window.togglePromotionStatus = function(promotionId, currentStatus) {
      const { database, ref, update } = window.firebase;
      const couponRef = ref(database, `coupons/${promotionId}`);
      
      const newStatus = !currentStatus;
      const statusText = newStatus ? 'kích hoạt' : 'tạm dừng';
      const statusIcon = newStatus ? 'play' : 'pause';
      
      Swal.fire({
        title: 'Thay đổi trạng thái',
        text: `Bạn có chắc chắn muốn ${statusText} mã khuyến mãi này?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Xác nhận',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#22d3a3',
        cancelButtonColor: '#ff5e73'
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang cập nhật...',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          update(couponRef, {
            isActive: newStatus,
            updatedAt: new Date().toISOString()
          }).then(() => {
            loadingSwal.close();
            Swal.fire({
              title: 'Thành công!',
              text: `Mã khuyến mãi đã được ${statusText}`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error updating coupon status:', error);
            loadingSwal.close();
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể cập nhật trạng thái mã khuyến mãi',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    };

    window.deletePromotion = function(promotionId, code) {
      Swal.fire({
        title: 'Xóa mã khuyến mãi',
        text: `Bạn có chắc chắn muốn xóa mã "${code}"? Hành động này không thể hoàn tác.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#ff5e73',
        cancelButtonColor: '#22d3a3',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          const loadingSwal = Swal.fire({
            title: 'Đang xóa...',
            text: 'Vui lòng chờ trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          const { database, ref, remove } = window.firebase;
          const couponRef = ref(database, `coupons/${promotionId}`);
          
          remove(couponRef).then(() => {
            loadingSwal.close();
            Swal.fire({
              title: 'Đã xóa!',
              text: `Mã khuyến mãi "${code}" đã được xóa thành công`,
              icon: 'success',
              confirmButtonColor: '#22d3a3'
            });
          }).catch((error) => {
            console.error('Error deleting coupon:', error);
            loadingSwal.close();
            Swal.fire({
              title: 'Lỗi!',
              text: 'Không thể xóa mã khuyến mãi',
              icon: 'error',
              confirmButtonColor: '#ff5e73'
            });
          });
        }
      });
    };

    // Helper function to close promotion modal
    function closePromotionModal() {
      document.getElementById('promotionModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  </script>
</body>
</html>

