<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc sách - AnBok Collection</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Source+Serif+Pro:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4A6366;
            --primary-dark: #3A4F52;
            --accent-color: #F4A261;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-muted: #95a5a6;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-dark: #2c3e50;
            --border-color: #e9ecef;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, #4A6366 0%, #3A4F52 100%);
            --gradient-accent: linear-gradient(135deg, #F4A261 0%, #E8944A 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Floating Navigation */
        .floating-nav {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .floating-nav:hover {
            box-shadow: var(--shadow-hover);
            transform: translateX(-50%) translateY(-2px);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        /* Reading Progress */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-accent);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 0 3px 3px 0;
            box-shadow: 0 0 20px rgba(244, 162, 97, 0.5);
        }

        /* Main Container */
        .reading-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 120px 40px 60px;
        }
        
        /* Book Header */
        .book-header {
            background: var(--bg-primary);
            border-radius: 25px;
            padding: 50px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .book-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
        }
        
        .book-title {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.2;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .book-author {
            font-size: 1.4rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-weight: 500;
            font-family: 'Crimson Text', serif;
        }
        
        .book-meta {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 15px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            transition: var(--transition);
        }

        .meta-item:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
        }

        .meta-item .material-icons {
            font-size: 18px;
        }
        
        /* Reading Controls */
        .reading-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .control-btn:hover::before {
            left: 100%;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .control-btn.secondary {
            background: #6c757d;
        }
        
        .control-btn.secondary:hover {
            background: #5a6268;
        }
        
        .control-btn.accent {
            background: var(--gradient-accent);
        }

        /* Book Content */
        .book-content {
            background: var(--bg-primary);
            border-radius: 25px;
            padding: 60px;
            box-shadow: var(--shadow);
            line-height: 2;
            font-size: 1.25rem;
            color: var(--text-primary);
            white-space: pre-line;
            position: relative;
            overflow: hidden;
        }

        .book-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
        }
        
        .chapter-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 50px 0 25px 0;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent-color);
            position: relative;
        }
        
        .chapter-title:first-child {
            margin-top: 0;
        }
        
        .chapter-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--gradient-accent);
        }

        /* Chapter Sections */
        .chapter-section {
            margin-bottom: 60px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
        }

        .chapter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .chapter-text {
            font-size: 1.25rem;
            line-height: 2;
            color: var(--text-primary);
            margin-bottom: 30px;
            text-align: justify;
            hyphens: auto;
        }

        .chapter-text p {
            margin-bottom: 1.5em;
        }

        .chapter-text p:first-letter {
            font-size: 3.5em;
            font-weight: 700;
            float: left;
            line-height: 1;
            margin: 0.1em 0.1em 0 0;
            color: var(--accent-color);
            font-family: 'Playfair Display', serif;
        }

        /* Chapter Images */
        .chapter-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .image-container {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .image-container:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .chapter-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: 20px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
            font-style: italic;
            background: var(--bg-primary);
        }

        /* Dark theme for images */
        body.dark-theme .image-container {
            background: #3a3a3a;
        }

        body.dark-theme .image-caption {
            background: #2c2c2c;
            color: #cccccc;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--gradient-accent);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-hover);
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 15px 35px rgba(244, 162, 97, 0.4);
        }

        /* Reading Stats */
        .reading-stats {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Loading Animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 500px;
            flex-direction: column;
            gap: 30px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 18px;
            color: var(--text-muted);
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error Container */
        .error-container {
            text-align: center;
            padding: 80px 40px;
            color: #dc3545;
            background: var(--bg-primary);
            border-radius: 25px;
            box-shadow: var(--shadow);
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 30px;
            color: #dc3545;
        }
        
        .error-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .error-message {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Typography Enhancements */
        .book-content p {
            margin-bottom: 1.5em;
            text-align: justify;
            hyphens: auto;
        }

        .book-content p:first-letter {
            font-size: 3.5em;
            font-weight: 700;
            float: left;
            line-height: 1;
            margin: 0.1em 0.1em 0 0;
            color: var(--accent-color);
            font-family: 'Playfair Display', serif;
        }

        /* Dark Theme Styles */
        body.dark-theme {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
        }

        body.dark-theme .book-header,
        body.dark-theme .book-content,
        body.dark-theme .error-container {
            background: #2c2c2c;
            color: #ffffff;
        }

        body.dark-theme .book-title {
            background: linear-gradient(135deg, #F4A261 0%, #E8944A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.dark-theme .meta-item {
            background: #3a3a3a;
            color: #cccccc;
        }

        body.dark-theme .meta-item:hover {
            background: var(--gradient-accent);
            color: white;
        }

        body.dark-theme .floating-nav {
            background: rgba(44, 44, 44, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .reading-stats {
            background: rgba(44, 44, 44, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        body.dark-theme .nav-btn {
            color: #cccccc;
        }

        body.dark-theme .nav-btn:hover,
        body.dark-theme .nav-btn.active {
            background: var(--gradient-accent);
            color: white;
        }

        body.dark-theme .stat-item {
            color: #cccccc;
        }

        body.dark-theme .stat-value {
            color: var(--accent-color);
        }

        body.dark-theme .book-content p:first-letter {
            color: var(--accent-color);
        }

        body.dark-theme .chapter-title {
            color: var(--accent-color);
        }

        body.dark-theme .chapter-title::after {
            background: var(--gradient-accent);
        }

        body.dark-theme ::-webkit-scrollbar-track {
            background: #2c2c2c;
        }

        body.dark-theme ::-webkit-scrollbar-thumb {
            background: var(--gradient-accent);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .reading-container {
                padding: 100px 20px 40px;
            }

            .book-title {
                font-size: 2.5rem;
            }

            .book-content {
                padding: 40px 30px;
                font-size: 1.1rem;
            }

            .book-header {
                padding: 40px 30px;
            }

            .floating-nav {
                padding: 10px 20px;
                gap: 12px;
            }

            .nav-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .reading-stats {
                bottom: 20px;
                left: 20px;
                padding: 15px;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .meta-item {
                padding: 10px 15px;
                font-size: 14px;
            }

            .control-btn {
                padding: 14px 24px;
                font-size: 14px;
            }

            .chapter-images {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chapter-image {
                height: 200px;
            }

            .image-caption {
                padding: 15px;
                font-size: 0.9rem;
            }

            .chapter-text {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .book-title {
                font-size: 2rem;
            }
            
            .book-content {
                padding: 30px 20px;
                font-size: 1rem;
            }

            .floating-nav {
                flex-direction: column;
                border-radius: 20px;
                padding: 15px;
            }
            
            .reading-controls {
                flex-direction: column;
                align-items: center;
            }

            .chapter-images {
                gap: 15px;
            }

            .chapter-image {
                height: 180px;
            }

            .image-caption {
                padding: 12px;
                font-size: 0.85rem;
            }

            .chapter-text {
                font-size: 1rem;
            }

            .chapter-title {
                font-size: 1.5rem;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .book-header,
        .book-content {
            animation: fadeInUp 0.8s ease-out;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-accent);
        }
    </style>
</head>
<body>
    <!-- Reading Progress -->
    <div class="reading-progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Floating Navigation -->
    <nav class="floating-nav">
        <button class="nav-btn" onclick="goBack()">
        <span class="material-icons">arrow_back</span>
        Quay lại
    </button>
        <button class="nav-btn" onclick="toggleFontSize()">
            <span class="material-icons">text_fields</span>
            Font
        </button>
        <button class="nav-btn" onclick="toggleTheme()">
            <span class="material-icons">dark_mode</span>
            Theme
        </button>
        <button class="nav-btn" onclick="toggleFullscreen()">
            <span class="material-icons">fullscreen</span>
            Full
        </button>
    </nav>

    <!-- Main Content -->
    <div class="reading-container">
        <div id="reading-content">
            <!-- Loading state -->
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">Đang tải nội dung sách...</div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="scrollToTop()">
        <span class="material-icons">keyboard_arrow_up</span>
    </button>

    <!-- Reading Stats -->
    <div class="reading-stats">
        <div class="stat-item">
            <span class="material-icons" style="color: var(--accent-color);">timer</span>
            <span>Thời gian: <span class="stat-value" id="readingTime">0:00</span></span>
        </div>
        <div class="stat-item">
            <span class="material-icons" style="color: var(--accent-color);">trending_up</span>
            <span>Tiến độ: <span class="stat-value" id="readingProgress">0%</span></span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYLKQprHcGWDUo4TNOvDzTqTbqUFG4FkA",
            authDomain: "anbok-collection.firebaseapp.com",
            databaseURL: "https://anbok-collection-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anbok-collection",
            storageBucket: "anbok-collection.firebasestorage.app",
            messagingSenderId: "835844957818",
            appId: "1:835844957818:web:33fc3d03875d49fc5c3dc3",
            measurementId: "G-MS5FT355WW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebase = {
            database: () => database,
            auth: () => auth
        };
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseGet = get;
        window.firebaseAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    
    <script>
        // Firebase is already initialized in the module script above

        // Reading variables
        let startTime = Date.now();
        let wordCount = 0;
        let isReading = false;

        // Get book ID from URL
        function getBookIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load book content
        async function loadBookContent() {
            const bookId = getBookIdFromUrl();
            
            if (!bookId) {
                showError('Không tìm thấy ID sách');
                return;
            }

            try {
                console.log('Loading book content for ID:', bookId);
                
                // Search for book in all books
                const booksRef = window.firebaseRef(window.firebase.database(), 'Books');
                const snapshot = await window.firebaseGet(booksRef);
                const allBooks = snapshot.val();
                
                if (allBooks) {
                    const bookEntries = Object.entries(allBooks);
                    const foundBook = bookEntries.find(([key, bookData]) => 
                        bookData.book_id === bookId || key === bookId
                    );
                    
                    if (foundBook) {
                        const book = foundBook[1];
                        console.log('Found book:', book);
                        displayBookContent(book);
                        
                        // Load reading progress and scroll to position
                        await loadReadingProgressAndScroll(bookId);
                    } else {
                        showError('Không tìm thấy sách');
                    }
                } else {
                    showError('Không có dữ liệu sách');
                }
            } catch (error) {
                console.error('Error loading book content:', error);
                showError('Lỗi khi tải nội dung sách');
            }
        }

        // Display book content
        function displayBookContent(book) {
            const container = document.getElementById('reading-content');
            
            // Store book data globally for other functions
            window.currentBookData = book;
            
            // Check if content exists and determine content type
            const hasContent = book.content && (
                typeof book.content === 'string' || 
                (typeof book.content === 'object' && Object.keys(book.content).length > 0)
            );
            
            if (!hasContent) {
                container.innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">
                            <span class="material-icons" style="font-size: 4rem; color: #dc3545;">book_outline</span>
                        </div>
                        <h3 class="error-title">Sách chưa có nội dung</h3>
                        <p class="error-message">Sách "${book.title}" chưa có nội dung để đọc.</p>
                        <button class="control-btn secondary" onclick="goBack()">
                            <span class="material-icons">arrow_back</span>
                            Quay lại
                        </button>
                    </div>
                `;
                return;
            }

            // Calculate word count based on content type
            if (typeof book.content === 'string') {
                // Book content is a single string
                wordCount = book.content.split(/\s+/).length;
            } else {
                // Story content with chapters
                wordCount = 0;
                Object.values(book.content).forEach(chapter => {
                    if (chapter.text) {
                        wordCount += chapter.text.split(/\s+/).length;
                    }
                });
            }

            // Generate content HTML based on content type
            let contentHTML = '';
            if (typeof book.content === 'string') {
                // Book content is a single string
                contentHTML = book.content;
            } else {
                // Story content with chapters
                Object.entries(book.content).forEach(([chapterKey, chapter]) => {
                    contentHTML += `
                        <div class="chapter-section">
                            <h2 class="chapter-title">${chapter.title}</h2>
                            <div class="chapter-text">
                                ${chapter.text.replace(/\n/g, '<br>')}
                            </div>
                            ${chapter.images && chapter.images.length > 0 ? `
                                <div class="chapter-images">
                                    ${chapter.images.map(image => `
                                        <div class="image-container">
                                            <img src="${image.url}" alt="${image.description}" 
                                                 onerror="this.style.display='none'"
                                                 class="chapter-image">
                                            <div class="image-caption">${image.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            container.innerHTML = `
                <div class="book-header">
                    <h1 class="book-title">${book.title}</h1>
                    <div class="book-author">Tác giả: ${book.author}</div>
                    <div class="book-meta">
                        <div class="meta-item">
                            <span class="material-icons">star</span>
                            <span>${book.rating || 0} (${book.review_count || 0} đánh giá)</span>
                        </div>
                        <div class="meta-item">
                            <span class="material-icons">menu_book</span>
                            <span>${typeof book.content === 'object' ? Object.keys(book.content).length + ' chương' : (book.pages || 'N/A') + ' trang'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="material-icons">category</span>
                            <span>${book.genre || 'Chưa phân loại'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="material-icons">text_fields</span>
                            <span>${wordCount.toLocaleString()} từ</span>
                        </div>
                    </div>
                    <div class="reading-controls">
                        <button class="control-btn secondary" onclick="goBack()">
                            <span class="material-icons">arrow_back</span>
                            Quay lại
                        </button>
                        <button class="control-btn accent" onclick="startReading()">
                            <span class="material-icons">play_arrow</span>
                            Bắt đầu đọc
                        </button>
                    </div>
                </div>
                
                <div class="book-content" id="bookContent">
                    ${contentHTML}
                </div>
            `;

            // Initialize reading features
            initializeReadingFeatures();
        }

        // Initialize reading features
        function initializeReadingFeatures() {
            const progressBar = document.getElementById('progressBar');
            const bookContent = document.getElementById('bookContent');
            
            if (!progressBar || !bookContent) return;
            
            // Reading progress
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset;
                const docHeight = document.body.offsetHeight - window.innerHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                
                progressBar.style.width = scrollPercent + '%';
                document.getElementById('readingProgress').textContent = Math.round(scrollPercent) + '%';
                
                // Update reading progress in Firebase
                updateReadingProgress(Math.round(scrollPercent));
            });

            // Reading time tracking
            setInterval(() => {
                if (isReading) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('readingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Start reading
        async function startReading() {
            isReading = true;
            startTime = Date.now();
            
            // Get current user
            let user = null;
            try {
                user = window.firebase.auth().currentUser;
            } catch (error) {
                console.error('Error getting current user:', error);
            }
            
            if (!user) {
                Swal.fire({
                    title: 'Cần đăng nhập',
                    text: 'Vui lòng đăng nhập để lưu lịch sử đọc',
                    icon: 'warning',
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Đọc không lưu'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'auth.html';
                    } else {
                        // Continue reading without saving
                        document.getElementById('bookContent').scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                });
                return;
            }

            // Get book information
            const bookId = getBookIdFromUrl();
            const bookData = window.currentBookData;
            
            if (!bookData) {
                console.error('No book data available');
                Swal.fire({
                    title: 'Lỗi',
                    text: 'Không thể lấy thông tin sách. Vui lòng thử lại.',
                    icon: 'error',
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
                return;
            }

            try {
                // Save reading history to Firebase
                const readingHistoryRef = window.firebaseRef(window.firebase.database(), `users/${user.uid}/bookReadingHistory/${bookId}`);
                const historyData = {
                    bookId: bookId,
                    bookTitle: bookData.title,
                    bookAuthor: bookData.author,
                    bookCover: bookData.cover_image,
                    startTime: Date.now(),
                    lastReadTime: Date.now(),
                    readingProgress: 0,
                    totalWords: wordCount,
                    isCurrentlyReading: true
                };

                await window.firebaseSet(readingHistoryRef, historyData);
                
                console.log('Reading history saved successfully');
                
                // Show success message
                Swal.fire({
                    title: 'Bắt đầu đọc',
                    text: 'Đã lưu lịch sử đọc sách',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });

            } catch (error) {
                console.error('Error saving reading history:', error);
                
                // Check if it's a permission error
                if (error.message && error.message.includes('PERMISSION_DENIED')) {
                    Swal.fire({
                        title: 'Quyền truy cập bị từ chối',
                        text: 'Không thể lưu lịch sử đọc. Vui lòng liên hệ admin.',
                        icon: 'warning',
                        timer: 3000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                } else {
                    Swal.fire({
                        title: 'Lỗi',
                        text: 'Không thể lưu lịch sử đọc',
                        icon: 'error',
                        timer: 2000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                }
                
                // Continue reading even if saving fails
                console.log('Continuing to read without saving history');
            }
            
            // Smooth scroll to content
            document.getElementById('bookContent').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Toggle font size
        function toggleFontSize() {
            const content = document.getElementById('bookContent');
            if (content) {
                const currentSize = parseInt(window.getComputedStyle(content).fontSize);
                const sizes = [16, 18, 20, 22, 24];
                const currentIndex = sizes.indexOf(currentSize);
                const nextIndex = (currentIndex + 1) % sizes.length;
                content.style.fontSize = sizes[nextIndex] + 'px';
                
                Swal.fire({
                    title: 'Kích thước chữ',
                    text: `Đã thay đổi thành ${sizes[nextIndex]}px`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');
            
            if (isDark) {
                body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            }
            
            Swal.fire({
                title: 'Giao diện',
                text: isDark ? 'Đã chuyển sang chế độ sáng' : 'Đã chuyển sang chế độ tối',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('reading-content');
            container.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">
                        <span class="material-icons" style="font-size: 4rem; color: #dc3545;">error_outline</span>
                    </div>
                    <h3 class="error-title">${message}</h3>
                    <p class="error-message">Vui lòng kiểm tra lại hoặc quay về trang chủ.</p>
                    <button class="control-btn secondary" onclick="goBack()">
                        <span class="material-icons">arrow_back</span>
                        Quay lại
                    </button>
                </div>
            `;
        }

        // Go back function
        function goBack() {
            saveReadingSession();
            window.location.href = 'book.html';
        }

        // Load saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
        }

        // Load reading progress and scroll to saved position
        async function loadReadingProgressAndScroll(bookId) {
            try {
                const user = window.firebase.auth().currentUser;
                if (!user) return;

                const readingHistoryRef = window.firebaseRef(window.firebase.database(), `users/${user.uid}/bookReadingHistory/${bookId}`);
                const snapshot = await window.firebaseGet(readingHistoryRef);
                
                if (snapshot.exists()) {
                    const readingData = snapshot.val();
                    console.log('Found reading history:', readingData);
                    
                    // Check if this is a "read again" action (completed book)
                    const isReadAgain = readingData.readingProgress === 100;
                    
                    if (isReadAgain) {
                        // Reset progress for completed books
                        await resetReadingProgress(bookId);
                        
                        // Show notification for read again
                        Swal.fire({
                            title: 'Đọc lại',
                            text: 'Bắt đầu đọc lại từ đầu',
                            icon: 'info',
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                        
                        return;
                    }
                    
                    // Update progress bar and stats for incomplete books
                    if (readingData.readingProgress) {
                        const progressBar = document.getElementById('progressBar');
                        const progressText = document.getElementById('readingProgress');
                        
                        if (progressBar) {
                            progressBar.style.width = readingData.readingProgress + '%';
                        }
                        if (progressText) {
                            progressText.textContent = readingData.readingProgress + '%';
                        }
                    }
                    
                    // Calculate scroll position based on progress
                    if (readingData.readingProgress && readingData.readingProgress > 0) {
                        setTimeout(() => {
                            const docHeight = document.body.offsetHeight - window.innerHeight;
                            const scrollPosition = (readingData.readingProgress / 100) * docHeight;
                            
                            window.scrollTo({
                                top: scrollPosition,
                                behavior: 'smooth'
                            });
                            
                            // Show notification
                            Swal.fire({
                                title: 'Tiếp tục đọc',
                                text: `Đã khôi phục tiến độ ${readingData.readingProgress}%`,
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false,
                                toast: true,
                                position: 'top-end'
                            });
                        }, 1000); // Wait for content to render
                    }
                    
                    // Restore reading time if available
                    if (readingData.readingTime) {
                        startTime = Date.now() - (readingData.readingTime * 1000);
                        isReading = true;
                    }
                }
            } catch (error) {
                console.error('Error loading reading progress:', error);
            }
        }

        // Reset reading progress for completed books
        async function resetReadingProgress(bookId) {
            try {
                const user = window.firebase.auth().currentUser;
                if (!user) return;

                const readingHistoryRef = window.firebaseRef(window.firebase.database(), `users/${user.uid}/bookReadingHistory/${bookId}`);
                const bookData = window.currentBookData;
                
                // Reset to initial state
                const resetData = {
                    bookId: bookId,
                    bookTitle: bookData.title,
                    bookAuthor: bookData.author,
                    bookCover: bookData.cover_image,
                    startTime: Date.now(),
                    lastReadTime: Date.now(),
                    readingProgress: 0,
                    totalWords: wordCount,
                    readingTime: 0,
                    isCurrentlyReading: true
                };

                await window.firebaseSet(readingHistoryRef, resetData);
                
                // Reset UI
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('readingProgress');
                const readingTimeText = document.getElementById('readingTime');
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressText) progressText.textContent = '0%';
                if (readingTimeText) readingTimeText.textContent = '0:00';
                
                // Reset reading variables
                startTime = Date.now();
                isReading = true;
                
                console.log('Reading progress reset successfully');
                
            } catch (error) {
                console.error('Error resetting reading progress:', error);
            }
        }

        // Update reading progress in Firebase
        async function updateReadingProgress(progress) {
            try {
                const user = window.firebase.auth().currentUser;
                if (!user || !isReading) return;

                const bookId = getBookIdFromUrl();
                if (!bookId) return;

                const readingHistoryRef = window.firebaseRef(window.firebase.database(), `users/${user.uid}/bookReadingHistory/${bookId}`);
                
                await window.firebaseUpdate(readingHistoryRef, {
                    readingProgress: progress,
                    lastReadTime: Date.now(),
                    readingTime: Math.floor((Date.now() - startTime) / 1000)
                });
            } catch (error) {
                console.error('Error updating reading progress:', error);
                
                // Don't show error for permission denied during scroll updates
                // Just log it silently to avoid spam
                if (!error.message || !error.message.includes('PERMISSION_DENIED')) {
                    console.warn('Non-permission error updating reading progress:', error);
                }
            }
        }

        // Save reading session when leaving page
        function saveReadingSession() {
            try {
                if (isReading) {
                    const user = window.firebase.auth().currentUser;
                    if (!user) return;

                    const bookId = getBookIdFromUrl();
                    if (!bookId) return;

                    const readingTime = Math.floor((Date.now() - startTime) / 1000);
                    const progress = parseInt(document.getElementById('readingProgress').textContent) || 0;

                    const readingHistoryRef = window.firebaseRef(window.firebase.database(), `users/${user.uid}/bookReadingHistory/${bookId}`);
                    
                    window.firebaseUpdate(readingHistoryRef, {
                        readingProgress: progress,
                        lastReadTime: Date.now(),
                        readingTime: readingTime,
                        isCurrentlyReading: false
                    }).catch(error => {
                        console.error('Error saving reading session:', error);
                        
                        // Log permission errors but don't show to user
                        if (error.message && error.message.includes('PERMISSION_DENIED')) {
                            console.warn('Permission denied when saving reading session');
                        }
                    });
                }
            } catch (error) {
                console.error('Error in saveReadingSession:', error);
            }
        }

        // Load book content when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
            loadBookContent();
        });

        // Save reading session when leaving page
        window.addEventListener('beforeunload', saveReadingSession);
        window.addEventListener('pagehide', saveReadingSession);

        // Show FAB on scroll
        window.addEventListener('scroll', () => {
            const fab = document.querySelector('.fab');
            if (window.pageYOffset > 300) {
                fab.style.opacity = '1';
                fab.style.visibility = 'visible';
            } else {
                fab.style.opacity = '0';
                fab.style.visibility = 'hidden';
            }
        });
    </script>
</body>
</html> 